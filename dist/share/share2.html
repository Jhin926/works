<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <meta name = "format-detection" content = "telephone=no">
    <title>分享</title>
    <script>
      var deviceWidth = document.documentElement.clientWidth;
      if(deviceWidth > 640) deviceWidth = 640;
      document.documentElement.style.fontSize = deviceWidth/6.4 + 'px';
    </script>
    <style rel="stylesheet">
      * {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: Arial, Helvetica, sans-serif, '微软雅黑';
        line-height: 1.2;
      }
      html,body {
        max-width: 640px;
        margin: auto;
        width: 100%;
        height: 100%;
      }
      li {
        list-style: none;
      }
      input {
        border: none;
        outline: none;
      }
      button {
        border: none;
        background: none;
      }
      #container {
        width: 100%;
        height: 100%;
        padding-top: .3rem;
        background: url('./img/bg-share.png') no-repeat;
        background-size: 100% auto;
        position: relative;
      }
      .inviter {
        font-size: .24rem;
        color: #fff;
      }
      .inviter p {
        display: inline-block;
        padding: .08rem .2rem .08rem .25rem;
        background-color: rgba(0, 0, 0, .4);
        border-bottom-right-radius: .8rem;
        border-top-right-radius: .8rem;
        -webkit-border-bottom-right-radius: .8rem;
        -webkit-border-top-right-radius: .8rem;
        -moz-border-bottom-right-radius: .8rem;
        -moz-border-top-right-radius: .8rem;
        margin-left: -.15rem;
      }
      .inviter span {
        color: #ffb600;
      }
      .invite-input {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        padding: 1.6rem 0 .3rem 0;
        background: url("./img/bg-bag.png") no-repeat;
        background-size: 100%;
      }
      .input-box {
        position: relative;
        margin-top: .2rem;
        text-align: center;
      }
      .input-box input {
        display: block;
        margin: auto;
        width: 4.6rem;
        height: .7rem;
        padding-left: .15rem;
        background-color: #fff;
        border-radius: 5px;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        font-size: .24rem;
      }
      .getcode {
        display: inline-block;
        position: absolute;
        padding: 0 .1rem;
        top: .15rem;
        right: 1.1rem;
        height: .4rem;
        color: #9b9b9b;
        border-radius: .07rem;
        -webkit-border-radius: .07rem;
        -moz-border-radius: .07rem;
        border: 1px solid #9b9b9b;
        outline: none;
      }
      .input-btn {
        margin-top: .2rem;
        text-align: center;
      }
      .input-btn button {
        display: block;
        margin: auto;
        width: 4.6rem;
        height: .7rem;
        background-color: #ffc200;
        border-radius: 5px;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        font-size: .24rem;
        color: #e52e2e;
      }
      .qrcode {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, .6);
      }
      .qrcode-img {
        width: 5rem;
        margin: 2.5rem auto 0 auto;
        text-align: center;
        font-size: .48rem;
        color: #fff;
      }
      @keyframes loadin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @-webkit-keyframes loadin {
        from {
          -webkit-transform: rotate(0deg);
        }
        to {
          -webkit-transform: rotate(360deg);
        }
      }
      @-moz-keyframes loadin {
        from {
          -moz-transform: rotate(0deg);
        }
        to {
          -moz-transform: rotate(360deg);
        }
      }
      .loading {
        display: none;
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 99999;
        background-color: rgba(0, 0, 0, .4);
      }
      .loading-inner {
        position: absolute;
        top: calc(50% - 1.6rem);
        top: -webkit-calc(50% - 1.6rem);
        top: -moz-calc(50% - 1.6rem);
        left: calc(50% - 1.3rem);
        left: -webkit-calc(50% - 1.3rem);
        left: -moz-calc(50% - 1.3rem);
        width: 2.6rem;
        height: 3.2rem;
        background-color: #fff;
        border-radius: .08rem;
        -webkit-border-radius: .08rem;
        -moz-border-radius: .08rem;
      }
      .loading-img {
        width: .80rem;
        height: .80rem;
        margin: .8rem auto .6rem auto;
      }
      .loading-img img {
        animation: loadin 1s linear infinite;
        -webkit-animation: loadin 1s linear infinite;
        -moz-animation: loadin 1s linear infinite;
      }
      .loading-text {
        text-align: center;
        font-size: .28rem;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div class="inviter"><p><span></span>邀您</p></div>
      <ul class="invite-input">
        <li class="input-box"><input class="phone" type="tel" placeholder="请输入您的手机号" readonly /></li>
        <li class="input-box">
          <input class="sms" type="tel" placeholder="请输入短信验证码" />
          <button class="getcode">获取</button>
        </li>
        <li class="input-btn"><button>提交</button></li>
      </ul>
      <div class="qrcode">
        <p class="qrcode-img">
          注册成功
          <img src="./img/qrcode.png" width="100%" />
        </p>
      </div>
    </div>
    <div class="loading">
      <div class="loading-inner">
        <p class="loading-img"><img src="./img/loading.png" width="100%" height="100%" /></p>
        <p class="loading-text">正在提交</p>
      </div>
    </div>
    <script src="./js/jquery-3.0.0.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script>
      $(function(){
        var resData = {};
        var wxName = '', mobile = '';
        var ser = location.search.substring(1);
        var serArr = ser.split('&');
        for (var i = 0; i < serArr.length; i++) {
          var oneSer = serArr[i].split('=');
          if (oneSer[0] === 'phone') {
            resData.mobileNumber = oneSer[1];
            $('.phone').val(oneSer[1]);
          }else if(oneSer[0] === 'name'){
            wxName = decodeURI(oneSer[1])
            $('.inviter span').text(decodeURI(oneSer[1]));
          }else if(oneSer[0] === 'mobile'){
            resData.referrer = oneSer[1];
            mobile = oneSer[1]
          }
        }
        $.get('/api/wx/config', function (res) {
          if (res.code === 0) {
            const infoObj = res.data
            wx.config({
              debug: false,
              appId: infoObj.appId,
              timestamp: infoObj.timestamp,
              nonceStr: infoObj.nonceStr,
              signature: infoObj.signature,
              jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage']
            })
            wx.ready(function () {
              wx.onMenuShareTimeline({
                title: wxName + '邀请您喝茶', // 分享标题
                link: 'http://ns.sankoubudai.com/share/share1.html?mobile=' + mobile + '&name=' + wxName, // 分享链接
                imgUrl: 'http://ns.sankoubudai.com/share/img/share.png', // 分享图标
                success: function () {
                  // window.alert('分享成功!!!!!!!!!')
                },
                cancel: function () {
                  // window.alert('取消分享')
                }
              })
              wx.onMenuShareAppMessage({
                title: wxName + '邀请您喝茶', // 分享标题
                desc: '', // 分享描述
                link: 'http://ns.sankoubudai.com/share/share1.html?mobile=' + mobile + '&name=' + wxName, // 分享链接
                imgUrl: 'http://ns.sankoubudai.com/share/img/share.png', // 分享图标
                success: function () {
                  this.$data.showModal = false
                },
                cancel: function () {
                  // window.alert('取消分享')
                }
              })
            })
          }
        })
        var count = 59;
        $('.getcode').click(function(){
          var $this = $(this);
          if(count == 59){//第一次计时或者重新发送
            var t = setInterval(function () {
              if (count > 1) {
                count--
                $this.text(count + 's后重新发送')
              } else {
                count = 59
                $this.text('重新发送')
                clearInterval(t)
              }
            }, 1000);
            $('.loading').show();
            $.ajax({
              type: 'get',
              url: '/api/sms/v1/send/code?mobileNumber='+$('.phone').val() + '&bizType=2&codeType=1',
              success: function (res) {
                $('.loading').hide();
                if(res.code === 0) {
                  resData.codeKey = res.data;
                } else {
                  alert(res.message)
                }
              }
            });
          }
        });
        $('.input-btn button').click(function () {
          resData.smsCode = $('.sms').val();
          $('.loading').show();
          $.ajax({
            type: 'post',
            url: '/api/user/h5/register',
            data: resData,
            success: function (res) {
              $('.loading').hide();
              if (res.code === 0) {
                $('.qrcode').show();
              } else {
                alert(res.message);
              }
            }
          })
        });
      })
    </script>
  </body>
</html>
