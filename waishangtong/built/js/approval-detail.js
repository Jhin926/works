require(["common"],function(){require(["maintab","angular","angularAnimate","ZeroClipboard","ueditorLang","jqform","blockUI","datetimepickerCN"],function(e){e.init();var a=parseInt($.GetQueryString("id")),t=parseInt($.GetQueryString("type")),r=(parseInt($.GetQueryString("bizId")),angular.module("approvalDetailModule",[]));r.filter("myFilter",function(){return function(e){return e.indexOf("http://")<0?"http://"+e:e}}),r.controller("approvalDetail",["$scope","$http",function(e,r){function i(a){var t=a.status;a.bizType;1==t?(e.statusText="待审批",$(".approval-btn-group").show(),$("#emailAttachment").show(),$(".approval-waiting textarea").show(),$(".status").css("background","#8E8F93")):2==t?(e.statusText="通过",$(".approval-theme").show(),$("#emailAttachment").hide(),$(".approval-btn-group").hide(),$("#added-appendix").hide(),$(".approval-waiting textarea").hide(),$(".status").css("background","#37C173")):3==t&&(e.statusText="不通过",$(".approval-theme").show(),$(".approval-waiting textarea").hide(),$("#emailAttachment").hide(),$(".approval-btn-group").hide(),$("#added-appendix").hide(),$(".status").css("background","#FF605D"))}function p(){r({method:"post",url:Base.sitUrl+"/api/approval/v1/details",params:{data:JSON.stringify({id:a})}}).success(function(a){if(!a.success)return void $.Alert(a.message);e.approvalDetailList=a.data;var t=a.data;t=i(t);var r=e.approvalDetailList.bizId,p=e.approvalDetailList.bizType;1==p?$(".approval_detail").attr("src","../../pop-quotation-detail.html?showbtn=1&id="+r):2==p?$(".approval_detail").attr("src","../../pop-pi-detail.html?showbtn=1&id="+r):3==p&&$(".approval_detail").attr("src","../../pop-order-detail.html?showbtn=1&id="+r)})}function n(a,t,r){$("#form_file").ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(r){if(!r.success)return void $.unLogin(r);if(t<1){t=1024*t;var i=parseInt(t);t+="KB"}else t+="MB";var p=r.data,n='<li data-url="'+p+'"><i class="pub-icon fujian-excl-iocn"></i><span>'+a+'</span> <span class="att-size">( '+t+' )</span> <span class="removeLi">删除</span><span class="previewEml">预览</span></li>';$("#added-appendix").show().prepend(n);var o=a;a.substring(a.indexOf(".")+1);e.uploaddata=[{name:o,url:p,size:i,contentType:1}]}}).submit()}function o(e){var a=!0,t=e.prop("files"),r=Math.round(t[0].size/1024*100)/100/1024;return r>20&&($.Alert("上传附件需小于20MB"),a=!1),{flag:a,name:t[0].name,size:r}}function s(){r({method:"get",url:Base.sitUrl+"/api/approval/v1/approval",params:{data:JSON.stringify(e.postData)}}).success(function(e){return e.success?(p(),void parent.location.reload()):void $.Alert(e.message)})}e.approvalDetailList={},e.statusText="",e.uploaddata=[],1==t?$(".approval_person").html("发起人："):$(".approval_person").html("审批人："),p(),e.addAttachment=function(){$("#up-files").click()},$("input[name=upFiles]").on("change",function(e){$.EventFn(e);var a=o($(this));a.flag&&n(a.name,a.size)}),$("#added-appendix").on("click",".removeLi",function(){$(this).parents("li").remove()}),$("#added-appendix").on("click",".previewEml",function(){var e=$(this).parents("li").attr("data-url"),a=$(this).prev().prev().prev().text(),t=e.lastIndexOf("."),r=e.substring(t,e.length).toUpperCase();if(".PNG"==r||".JPG"==r||".JPEG"==r||".SVG"==r||".GIF"==r)var i='<img src="'+e+'" alt="" class="previewImg previewContent">';else if(".TXT"==r||".JS"==r||".CSS"==r)var i='<iframe src="'+e+'" frameborder="0" class="previewIframe previewContent"></iframe>';else{if(".DOC"!=r&&".DOCX"!=r&&".XLS"!=r&&".XLSX"!=r&&".ET"!=r&&".PPT"!=r&&".PPTX"!=r&&".WPS"!=r&&".ZIP"!=r&&".RAR"!=r&&".7Z"!=r&&".PDF"!=r)return void $.Alert(r.toLowerCase()+"格式暂不支持预览");var p=Base.sitUrl+"/api/export/v1/file/preview?data={file: '"+e+"'}",i='<iframe src="'+p+'" frameborder="0" class="previewIframe previewContent"></iframe>'}$("#preview").find("h3").text(a),$("#preview").find(".previewContent").remove(),$("#preview").append(i),$("#preview").show()}),$("#previewClose").bind("click",function(){$("#preview").hide(),$("#preview").find(".previewContent").remove()}),e.appendixShow=function(e){var a="http://"+e.url,t=a.lastIndexOf("."),r=(a.substring(7),e.bizId,a.substring(t,a.length).toUpperCase());if(".PNG"==r||".JPG"==r||".JPEG"==r||".SVG"==r||".GIF"==r)var i='<img src="'+a+'" alt="" class="previewImg previewContent">';else{if(".TXT"!=r&&".JS"!=r&&".CSS"!=r)return".DOC"==r||".DOCX"==r||".XLS"==r||".XLSX"==r||".ET"==r||".PPT"==r||".PPTX"==r||".WPS"==r||".ZIP"==r||".RAR"==r||".7Z"==r||".PDF"==r?void $.Alert(r.toLowerCase()+"格式暂不支持预览"):void $.Alert(r.toLowerCase()+"格式暂不支持预览");var i='<iframe src="'+a+'" frameborder="0" class="previewIframe previewContent"></iframe>'}$("#preview").show(),$("#preview h3").text(e.name),$("#preview").find(".previewContent").remove(),$("#preview").append(i)},e.approvalPass=function(){var t=$(".approval-remark").val(),r=e.approvalDetailList.bizId;e.postData={id:a,status:2,approver:r,approvalOpinions:t,approvalAttachmentEnters:e.uploaddata},s()},e.approvalNoPass=function(){var t=$(".approval-remark").val(),r=e.approvalDetailList.bizId;e.postData={id:a,status:3,approver:r,approvalOpinions:t,approvalAttachmentEnters:e.uploaddata},s()}}]),angular.bootstrap(document.body,["approvalDetailModule"])})});