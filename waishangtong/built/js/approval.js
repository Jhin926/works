require(["common"],function(){require(["maintab","angular","angularAnimate","blockUI","datetimepickerCN"],function(a){a.init(),jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({format:"yyyy-mm-dd hh:mm",language:"zh-CN",todayBtn:1,autoclose:1,bootcssVer:3});var t=angular.module("approvalListModule",[]);t.config(["$httpProvider",function(a){a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",a.defaults.transformRequest.unshift(function(a,t){var e,r=[];for(e in a)a.hasOwnProperty(e)&&r.push(encodeURIComponent(e)+"="+encodeURIComponent(a[e]));return r.join("&")})}]),t.controller("approvalList",["$scope","$http",function(t,e){function r(){$.BlockUI();var a={data:t.approvalListRequestParams};e({method:"get",url:Base.sitUrl+"/api/approval/v1/list",params:a}).success(function(a){if($.UnblockUI(),!a.success)return void $.unLogin(a);var e=a.data;""==e.results?$(".trNone").show():$(".trNone").hide();var s=e.totalItem,p=Math.ceil(s/t.approvalListRequestParams.pageSize);$.Page({total:s,_class:".page",nowNum:e.currentPage,allNum:p,callback:function(a,e){t.approvalListRequestParams.currentPage=a,r()}}),t.approvalItem=t.approvalList=o(e.results)})}function o(a){for(var t={k_1:"待审批",k_2:"通过",k_3:"不通过"},e={k_1:"报价",k_2:"PI",k_3:"订单"},r=0;r<a.length;r++)a[r].subject.length>50?a[r].shortSubject=a[r].subject.substring(0,50)+"...":a[r].shortSubject=a[r].subject,a[r].statusText=t["k_"+a[r].status],a[r].bizTypeText=e["k_"+a[r].bizType];return a}t.isMyApproval=!1,t.showToolbar=!1,t.checkedItem=[],t.approvalList=[],t.statusList={},t.checkedAll=!1,t.approvalListRequestParams={initiatorType:2,subject:"",bizType:0,status:0,approver:0,startDate:"",endDate:"",currentPage:1,pageSize:20},t.principalList=[],t.approvalItem=[],r(),t.switchApprovalList=function(a){t.isMyApproval=2==a,2==a?($(".positon-change").html("审批人"),$(".approval-person").html("审核人"),$(".approval-person").attr("data-id",2),$(".m_batch1").attr("data-id",2)):($(".positon-change").html("发起人"),$(".approval-person").html("发起人"),$(".approval-person").attr("data-id",1),$(".m_batch1").attr("data-id",1)),t.approvalListRequestParams.approvalType=a,r()},e({method:"get",url:Base.sitUrl+"/api/org/v1/org/principal/list"}).success(function(a){return a.success?void(t.principalList=a.data):void $.Alert(a.message)}),t.approvalSort=function(a){var t=$(".approval-sort p");t.hasClass("s-orderList")?(t.removeClass("s-orderList").addClass("s-reorderList"),a.sort(function(a,t){var e=parseInt(t.updateTime.replace(/-|:| /g,"")),r=parseInt(a.updateTime.replace(/-|:| /g,""));return r-e})):(t.removeClass("s-reorderList").addClass("s-orderList"),a.sort(function(a,t){var e=parseInt(t.updateTime.replace(/-|:| /g,"")),r=parseInt(a.updateTime.replace(/-|:| /g,""));return e-r}))},t.checkAll=function(a){a.stopPropagation();var e=$(a.target);t.checkedAll=e.prop("checked")},t.checkItem=function(a,e){var r=$(e.target);1==r.prop("checked")?(r.parent().addClass("checked"),t.checkedItem.indexOf(a.id)<0&&t.checkedItem.push(a.id)):(r.parent().removeClass("checked"),t.checkedItem.indexOf(_file)>=0&&t.checkedItem.splice(t.checkedItem.indexOf(a.id),1))},t.approvalSearch=function(){var a=$("#approvalType option:selected").val(),o=$("#approvalStatus option:selected").val(),s=$("#approvalThrough option:selected").val(),p=$("input[name=start-date]").val(),i=$("input[name=end-date]").val();s=s.substring(7);var n=$(".approval-person").attr("data-id");t.data={initiator:"",subject:"",bizType:a,status:o,approver:"",startDate:p,endDate:i,approvalType:1,currentPage:1,pageSize:20},1==n?(t.data.initiator=s,t.data.approvalType=1,t.data.approver=""):(t.data.initiator="",t.data.approver=s,t.data.approvalType=2),e({method:"post",url:Base.sitUrl+"/api/approval/v1/list",data:{data:JSON.stringify(t.data)}}).success(function(a){""==a.data.results?$(".trNone").show():$(".trNone").hide(),t.approvalListRequestParams=t.data,r()})},$("#inputQuick").on("keyup",function(){var a=$("#inputQuick").val();t.approvalListRequestParams.subject=a,13==event.keyCode&&r()}),t.getDetail=function(t){var e=t.id,r=t.bizId,o=$(".m_batch1").attr("data-id");isNaN(e)||a.showTab(Base.url+"/html/approval/view/approval-detail.html?id="+e+"&type="+o+"&bizId="+r+"&v="+window.ver,"审批详情")}}]),angular.bootstrap(document.body,["approvalListModule"])})});