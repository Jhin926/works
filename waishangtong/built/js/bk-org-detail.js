require(["common"],function(){require(["maintab","blockUI","ztree"],function(e){function t(){$.ajax({type:"GET",url:Base.sitUrl+"/api/org/v1/org/role/list",success:function(e){for(var t="",a=0;a<e.data.length;a++)t+='<option value="'+e.data[a].id+'">'+e.data[a].name+"</option>";$("#popEditRole").append(t)}})}function a(e,t){return!1}function d(e,t){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/organization/list",dataType:"json",success:function(e){if(!e.success)return void $.Alert(e.message);var a=e.data;$("#treeDemo").find("a");if(!t.parentNode||2==t.parentNode.id)for(var d=$("#"+t.tId+m),i=0;i<a.length;i++)t.id==a[i].id&&$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/list",dataType:"json",data:{department:t.id},success:function(e){if(!e.success)return void $.Alert(e.message);var a=e.data,i="<span class='ztreepopNum' id='diyBtn_"+t.id+"' title='"+t.name+"'>"+a.length+"</span>";d.after(i)}})}})}function i(e,t,a){n("[ "+o()+" onRename ]&nbsp;&nbsp;&nbsp;&nbsp; "+a.name)}function n(e){u||(u=$("#log")),u.append("<li class='"+f+"'>"+e+"</li>"),u.children("li").length>8&&u.get(0).removeChild(u.children("li")[0])}function o(){var e=new Date,t=e.getHours(),a=e.getMinutes(),d=e.getSeconds(),i=e.getMilliseconds();return t+":"+a+":"+d+" "+i}function r(){var e=$.fn.zTree.getZTreeObj("treeDemo");e.setting.edit.editNameSelectAll=$("#selectAll").attr("checked")}function s(e){return null==e?"":e}var l=$.GetQueryString("id"),p=[];t();var c="";$("#pop-add-edit").on("click",function(){$.ajax({type:"Get",url:Base.sitUrl+"/api/org/v1/org/staff/list/detail",data:{id:l},success:function(e){if(!e.success)return void $.Alert(e.message);var t=e.data;p=t,c=t.gender,$("#popEditRole option[value='"+p.roleId+"']").attr("selected",!0),1==t.gender?($("#man").attr("checked",!0).parent().addClass("checked"),$("#woman").attr("checked",!1).parent().removeClass("checked")):($("#woman").attr("checked",!0).parent().addClass("checked"),$("#man").attr("checked",!1).parent().removeClass("checked")),0==t.isAdmin?$("#staff").prop("checked",!0).parent().addClass("checked"):$("#department").prop("checked",!0).parent().addClass("checked")}}),$("#panel-modal-pop").hide(),$("#edit-modal").show(),$("#popEditName").val($("#pop-name").text()),$("#popEditEmail").val($("#pop-email").text()),$("#edit-pop-dep").val($("#pop-status").text()),$("#edit-modal .popId").text($("#panel-modal-pop .popId").text())}),$("#pop-edit-save").on("click",function(){var e=$("#popEditName").val(),t=$("#popEditEmail").val(),a=($("#edit-modal .depId").text(),$("#edit-modal .popId").text(),$("#popEditRole").find("option:selected").val());$("#edit-modal .gender").attr("checked")?c=$(this).data("num"):$("#edit-modal .gender").find("input[type=radio]").each(function(){$(this).is(":checked")&&(c=$(this).data("num"))}),$("#edit-modal .gender1").find("input[type=radio]").each(function(){$(this).is(":checked")&&(popEditGender1=$(this).data("num"))});var d=$("#edit-pop-dep").val(),i=$.fn.zTree.getZTreeObj("treeDemoDetail"),n=i.getSelectedNodes();""==e||""==t||""==d?$.Alert("请填写带星号的内容"):$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/edit",dataType:"json",data:{id:l,name:e,email:t,isAdmin:popEditGender1,gender:c,roleId:a,department:n[0].id},success:function(e){return e.success?void(e.success?(parent.location.reload(),$.DestroyPopInPop()):$.Alert(e.message)):void $.Alert(e.message)}})}),$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/list/detail",dataType:"json",data:{id:l},success:function(e){if(!e.success)return void $.Alert(e.message);var t=e.data,a="";1==t.status?a="已激活":2==t.status?a="已禁用":3==t.status?a="已邀请":4==t.status?a="未激活":5==t.status?a="已离职":0==t.status&&(a="未知"),1==t.gender?gender="男":gender="女",$("#pop-name").text(s(t.name)),$("#pop-email").text(s(t.email)),$("#pop-gender").text(s(gender)),$("#pop-role").text(s(t.roleName)),$("#pop-status").text(s(a)),$("#client-num").text(s(t.customerNum)),$("#pop-time").text(s(t.lastLoginTime)),$("#panel-modal-pop .depId").text(s(t.id)),$("#panel-modal-pop .popId").text(s(t.department));var d=$.fn.zTree.getZTreeObj("treeDemoDetail"),n=d.getNodeByParam("id",t.department);d.selectNode(n),g.callback.onClick=i}});var u,m="_a",g={view:{addDiyDom:d,selectedMulti:!1},edit:{enable:!0,editNameSelectAll:!0},data:{simpleData:{enable:!0}},callback:{beforeDrag:a}},f="dark",v=new Array;$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/organization/list",dataType:"json",async:!1,success:function(e){if(!e.success)return void $.Alert(e.message);for(var t=e.data,a=0;a<t.length;a++)v[a]={id:t[a].id,pId:t[a].pid,name:t[a].name,open:!0};$.fn.zTree.init($("#treeDemoDetail"),g,v),$("#selectAll").bind("click",r)}})})});