require(["common"],function(){require(["maintab","ztree","blockUI"],function(e){function t(e,t){return!1}function a(){var e;return $.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/organization/list",dataType:"json",async:!1,success:function(t){return t.success?void(e=t.data):void $.Alert(t.message)}}),e}function d(e,t){var a=j;$("#treeDemo").find("a");if(!t.parentNode||2==t.parentNode.id)for(var d=$("#"+t.tId+x),n=0;n<a.length;n++)if(t.id==a[n].id){var i="<span class='ztreepopNum' id='diyBtn_"+t.id+"' title='"+t.name+"'>"+a[n].staffSum+"</span>";d.after(i)}}function n(e,t){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/list",dataType:"json",data:{department:t.id},success:function(e){if(!e.success)return void $.Alert(e.message);var t=e.data,a=$("#pageLeftUserName",parent.document).attr("data-admin");$(".table tbody").children().remove();for(var d=0;d<t.length;d++){if(1==t[d].status?statusName="已激活":2==t[d].status?statusName="已禁用":3==t[d].status?statusName="已邀请":4==t[d].status?statusName="未激活":5==t[d].status?statusName="已离职":0==t[d].status&&(statusName="未知"),1==t[d].isAdmin?isAdmin="部门管理员":isAdmin="普通员工",a==t[d].id)var n="disabled";else var n="";var i='<tr data-id="'+t[d].id+'"><td><div class="checker" id="uniform-allCheckbox"><span><input type="checkbox" id="allCheckbox" data-id="'+t[d].id+'" data-roleId="'+t[d].roleId+'" data-dep="'+t[d].department+'"'+n+'></span></div></td><td><a class="pop-name blue" href="bk-org-detail.html?id='+t[d].id+"&v="+window.ver+'" data-maintab>'+y(t[d].name)+"</a></td><td>"+y(t[d].departmentName)+"</td><td>"+y(t[d].email)+'</td><td><label class="supervisor blue">'+y(isAdmin)+'</label></td><td class="blue">'+y(t[d].roleName)+"</td><td>"+y(statusName)+"</td><td>"+y(t[d].lastLoginTime)+"</td></tr>";$(".table tbody").append(i)}return t.length}})}function i(e,t,a){u("[ "+p()+" onRename ]&nbsp;&nbsp;&nbsp;&nbsp; "+a.name)}function s(e,t){N="dark"===N?"":"dark",u("[ "+p()+" beforeEditName ]&nbsp;&nbsp;&nbsp;&nbsp; "+t.name);var a=$.fn.zTree.getZTreeObj("treeDemo");return a.selectNode(t),confirm("确认进入编辑 "+t.name+" 状态？")}function r(e,t){N="dark"===N?"":"dark",u("[ "+p()+" beforeRemove ]&nbsp;&nbsp;&nbsp;&nbsp; "+t.name);var a=$.fn.zTree.getZTreeObj("treeDemo");a.selectNode(t);var d=!1;return parseInt(t.staffSum)>0?($.Alert("不能删除有员工的部门"),!1):(confirm("确定删除 "+t.name+" 吗")&&($.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/organization/delete",dataType:"json",data:{id:t.id},success:function(e){return e.success?($.Alert("删除成功"),void v()):void $.Alert(e.message)}}),d=!0),d)}function o(e,t,a){u("[ "+p()+" onRemove ]&nbsp;&nbsp;&nbsp;&nbsp; "+a.name)}function l(e,t,a){if(N="dark"===N?"":"dark",u("[ "+p()+" beforeRename ]&nbsp;&nbsp;&nbsp;&nbsp; "+t.name),0==a.length){alert("内容不能为空.");var d=$.fn.zTree.getZTreeObj("treeDemo");return setTimeout(function(){d.editName(t)},10),!1}return $.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/organization/edit",dataType:"json",data:{id:t.id,name:a},success:function(e){return e.success?void $.Alert("编辑成功"):void $.Alert(e.message)}}),!0}function c(e,t,a){u("[ "+p()+" onRename ]&nbsp;&nbsp;&nbsp;&nbsp; "+a.name)}function u(e){k||(k=$("#log")),k.append("<li class='"+N+"'>"+e+"</li>"),k.children("li").length>8&&k.get(0).removeChild(k.children("li")[0])}function p(){var e=new Date,t=e.getHours(),a=e.getMinutes(),d=e.getSeconds(),n=e.getMilliseconds();return t+":"+a+":"+d+" "+n}function m(e,t){var a=$("#"+t.tId+"_span");if(!(t.editNameFlag||$("#addBtn_"+t.id).length>0)){var d="<span class='button add' id='addBtn_"+t.id+"' title='add node' onfocus='this.blur();'></span>";a.after(d);var n=$("#addBtn_"+t.id);n&&n.on("click",function(){$(".addAll").show(),$("input[name=addDep]").val(""),$("input[name=ztreeEmail]").val(""),$("input[name=ztreeName]").val(""),$("#addBtnDep").unbind("click").on("click",function(){var e=$("input[name=addDep]").val(),a=t.id,d=$.fn.zTree.getZTreeObj("treeDemo");d.addNodes(t,{id:100+U,pId:t.id,name:e,staffSum:0}),""==e?$.Alert("请填写完整"):$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/organization/save",dataType:"json",data:{name:e,pid:a},success:function(e){return e.success?(window.location.reload(),void $(".addAll").hide()):void $.Alert(e.message)}})}),$("#addBtnUser").unbind("click").on("click",function(){var e=$("input[name=ztreeEmail]").val(),a=$("input[name=ztreeName]").val(),d=$("#ztreeGender option:selected").val(),n=t.id;""==e||""==a?$.Alert("请填写完整"):$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/save",dataType:"json",data:{name:a,email:e,gender:d,department:n},success:function(e){return e.success?($.Alert("添加成功"),v(),void $(".addAll").hide()):void $.Alert(e.message)}})})})}}function f(e,t){$("#addBtn_"+t.id).parent().siblings(".ztreepopNum").show(),$("#addBtn_"+t.id).unbind().remove()}function b(){var e=$.fn.zTree.getZTreeObj("treeDemo");e.setting.edit.editNameSelectAll=$("#selectAll").attr("checked")}function v(){for(var e=new Array,t=a(),d=0;d<t.length;d++)e[d]={id:t[d].id,pId:t[d].pid,name:t[d].name,staffSum:t[d].staffSum,open:!0};$.fn.zTree.init($("#treeDemo"),A,e),$("#selectAll").bind("click",b)}function h(){$(".table tbody tr").remove(),$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/list",dataType:"json",success:function(e){if(!e.success)return void $.Alert(e.message);var t=e.data;$(".list-group").children().remove();for(var a=0;a<t.length;a++){1==t[a].status?statusName="已激活":2==t[a].status?statusName="已禁用":3==t[a].status?statusName="已邀请":4==t[a].status?statusName="未激活":5==t[a].status?statusName="已离职":0==t[a].status&&(statusName="未知"),1==t[a].isAdmin?isAdmin="部门管理员":isAdmin="普通员工";var d='<tr><td><div class="checker" id="uniform-allCheckbox"><span><input type="checkbox" id="allCheckbox"  data-admin="'+t[a].isAdmin+'" data-id="'+t[a].id+'" data-roleId="'+t[a].roleId+'" data-dep="'+t[a].department+'"></span></div></td><td><a class="pop-name blue" href="bk-org-detail.html?id='+t[a].id+"&v="+window.ver+'" data-maintab>'+y(t[a].name)+"</a></td><td>"+y(t[a].departmentName)+"</td><td>"+y(t[a].email)+'</td><td><label class="supervisor blue">'+y(isAdmin)+'</label></td><td class="blue">'+y(t[a].roleName)+"</td><td>"+y(statusName)+"</td><td>"+y(t[a].lastLoginTime)+"</td></tr>";$(".table tbody").append(d)}}})}function y(e){return null==e?"":e}var g=top.funcList;$("[data-code]").each(function(){for(var e=0;e<g.length;e++)g[e].code==$(this).attr("data-code")&&$(this).removeClass("none")}),e.init();for(var k,x="_a",A={view:{addHoverDom:m,removeHoverDom:f,addDiyDom:d,selectedMulti:!1},edit:{enable:!0,editNameSelectAll:!0},data:{simpleData:{enable:!0}},callback:{beforeDrag:t,beforeEditName:s,beforeRemove:r,beforeRename:l,onRemove:o,onRename:c}},T={view:{addHoverDom:m,removeHoverDom:f,addDiyDom:d,selectedMulti:!1},edit:{enable:!0,editNameSelectAll:!0},data:{simpleData:{enable:!0}},callback:{beforeDrag:t,beforeEditName:s,beforeRemove:r,beforeRename:l,beforeClick:n,onRemove:o,onRename:c,onClick:i}},N="dark",j=a(),D=new Array,w=j,S=0;S<w.length;S++)D[S]={id:w[S].id,pId:w[S].pid,name:w[S].name,staffSum:w[S].staffSum,open:!0};$.fn.zTree.init($("#treeDemo"),T,D),$.fn.zTree.init($("#treeDemoBtn"),A,D),$.fn.zTree.init($("#treeDemoAdd"),A,D),$("#selectAll").bind("click",b);var U=1;$(".addAll-close").on("click",function(){$(".addAll").hide()}),$("#pop-add").on("click",function(){$("#add-modal").animate({right:"0"})}),$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/list",dataType:"json",success:function(e){if(!e.success)return void $.Alert(e.message);var t=e.data,a=$("#pageLeftUserName",parent.document).attr("data-admin");$(".table tbody").children().remove();for(var d=0;d<t.length;d++){if(1==t[d].status?statusName="已激活":2==t[d].status?statusName="已禁用":3==t[d].status?statusName="已邀请":4==t[d].status?statusName="未激活":5==t[d].status?statusName="已离职":0==t[d].status&&(statusName="未知"),1==t[d].isAdmin?isAdmin="部门管理员":isAdmin="普通员工",a==t[d].id)var n="disabled";else var n="";var i='<tr><td><div class="checker" id="uniform-allCheckbox"><span><input type="checkbox" id="allCheckbox" data-id="'+t[d].id+'" data-roleId="'+t[d].roleId+'" data-dep="'+t[d].department+'"'+n+'></span></div></td><td><a class="pop-name blue" href="bk-org-detail.html?id='+t[d].id+"&v="+window.ver+'" data-maintab>'+y(t[d].name)+"</a></td><td>"+y(t[d].departmentName)+"</td><td>"+y(t[d].email)+'</td><td><label class="supervisor blue">'+y(isAdmin)+'</label></td><td class="blue">'+y(t[d].roleName)+"</td><td>"+y(statusName)+"</td><td>"+y(t[d].lastLoginTime)+"</td></tr>";$(".table tbody").append(i)}}}),$(".table thead tr input[type=checkbox]").on("click",function(){var e=$("#pageLeftUserName",parent.document).attr("data-admin");if($(".table thead tr input[type=checkbox]")[0].checked)for(var t=0;t<$(".table tbody tr input[type=checkbox]").length;t++){var a=$(".table tbody tr input[type=checkbox]").eq(t),d=$(".table tbody tr input[type=checkbox]").eq(t).attr("data-id");e!=d&&(a.parents("tr").addClass("active"),a.parents("span").addClass("checked"),a.checked=!0)}else for(var t=0;t<$(".table tbody tr input[type=checkbox]").length;t++){var a=$(".table tbody tr input[type=checkbox]").eq(t);a.parents("span").removeClass("checked"),a.parents("tr").removeClass("active"),a.checked=!1}}),"1"!=$("#pageLeftUserName",parent.document).attr("data-admin")&&($("#depManageNot").remove(),$(".depManage").remove()),$("#delete").on("click",function(){for(var e="",t="",a=new Array,d=$("tbody").find("input[type='checkbox']").length,n=0;n<d;n++){var i=$("tbody").find("input[type='checkbox']")[n],s=$("tbody").find("input[type='checkbox']").eq(n);t=s.attr("data-dep"),i.checked&&(e+=s.attr("data-id")+",",a.push(s.attr("data-id")))}var r=$("#pageLeftUserName",parent.document).attr("data-admin");e=e.substr(0,e.length-1);for(var n=0;n<a.length;n++)if(a[n]==r)return void $.Alert("不能删除自己");return""==e?void $.Alert("请选择人员"):void $.Confirm("确认删除？","",function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/set",dataType:"json",data:{ids:e,setType:"delete",department:t},success:function(e){return e.success?void window.location.reload():void $.Alert(e.message)}})})}),$("#allotRole").on("click",function(){for(var e="",t="",a="",d="",n=0,i=$("tbody").find("input[type='checkbox']").length,s=0;s<i;s++){var r=$("tbody").find("input[type='checkbox']")[s],o=$("tbody").find("input[type='checkbox']").eq(s),l=$("tbody").find(".pop-name").eq(s);a=o.attr("data-dep"),r.checked&&(e+=o.attr("data-id")+",",d+=l.text()+" , ",n+=1)}return e=e.substr(0,e.length-1),d=d.substr(0,d.length-1),""==e?void $.Alert("请选择人员"):($("#allot-modal").show(),$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/role/list",dataType:"json",success:function(e){if(!e.success)return void $.Alert(e.message);for(var t=e.data,a="",i=0;i<t.length;i++)a+='<li data-roleNum="'+t[i].id+'"><input type="radio" name="rolesId" class="roleCheckbox"><label class="roleNameLabel" >'+t[i].name+"</label></li>";$("ul.roles-list").empty(),$("ul.roles-list").append(a),$("#rolesName").text(d),$("#roleNUM").text(n)}}),void $("#allot-modal-save").on("click",function(){for(var a=0;a<$(".roles-list li input[type=radio]").length;a++)$(".roles-list li input[type=radio]")[a].checked&&(t=$(".roles-list li input[type=radio]").eq(a).parent().attr("data-roleNUM"));$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/set",dataType:"json",data:{ids:e,setType:"setRole",roleId:t},success:function(e){return e.success?(window.location.reload(),void $("#allot-modal").hide()):void $.Alert(e.message)}})}))}),$("#depManage").on("click",function(){for(var e="",t=$("tbody").find("input[type='checkbox']").length,a=0;a<t;a++){var d=$("tbody").find("input[type='checkbox']")[a],n=$("tbody").find("input[type='checkbox']").eq(a);depId=n.attr("data-dep"),d.checked&&(e+=n.attr("data-id")+",")}return e=e.substr(0,e.length-1),""==e?void $.Alert("请选择人员"):void $.Confirm("确认设置？","",function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/set",dataType:"json",data:{ids:e,setType:"setAdmin"},success:function(e){return e.success?void h():void $.Alert(e.message)}})})}),$("#depManageNot").on("click",function(){for(var e="",t=$("tbody").find("input[type='checkbox']").length,a=0;a<t;a++){var d=$("tbody").find("input[type='checkbox']")[a],n=$("tbody").find("input[type='checkbox']").eq(a);depId=n.attr("data-dep"),d.checked&&(e+=n.attr("data-id")+",")}return e=e.substr(0,e.length-1),""==e?void $.Alert("请选择人员"):void $.Confirm("确认取消？","",function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/set",dataType:"json",data:{ids:e,setType:"setAdminNot"},success:function(e){return e.success?void h():void $.Alert(e.message)}})})}),$("#btnEditDep").on("click",function(){for(var e="",t="",a="",d=0,n=$("tbody").find("input[type='checkbox']").length,i=0;i<n;i++){var s=$("tbody").find("input[type='checkbox']")[i],r=$("tbody").find("input[type='checkbox']").eq(i),o=$("tbody").find("label.pop-name").eq(i);s.checked&&(e+=r.attr("data-id")+",",a+=o.text()+"，",d+=1)}return e=e.substr(0,e.length-1),a=a.substr(0,a.length-1),""==e?void $.Alert("请选择人员"):($("#depEdit-modal").show(),void $("#editDep-modal-save").on("click",function(){t=$("#depEdit-modal input[name=editDepModal]");var a=$.fn.zTree.getZTreeObj("treeDemoBtn"),d=a.getSelectedNodes();$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/set",dataType:"json",data:{ids:e,setType:"setDepartment",department:d[0].id},success:function(e){return e.success?(window.location.reload(),void $("#depEdit-modal").hide()):void $.Alert(e.message)}})}))}),$("#invite").on("click",function(){for(var e,t="",a="",d=0,n=$("tbody").find("input[type='checkbox']").length,i=0;i<n;i++){var s=$("tbody").find("input[type='checkbox']")[i],r=$("tbody").find("input[type='checkbox']").eq(i);if(a=r.attr("data-dep"),s.checked){if(""==r.parents("tr").find("td:nth-child(6)").text()){e=r.parents("tr").find("td:nth-child(2)").find("a").text(),d=1;break}if("已激活"==r.parents("tr").find("td:nth-child(7)").text()){e=r.parents("tr").find("td:nth-child(2)").find("a").text(),d=2;break}t+=r.attr("data-id")+","}}return 1==d?void $.Alert(e+"未分配角色，不能发送邀请"):2==d?void $.Alert(e+"已激活"):(t=t.substr(0,t.length-1),""==t?void $.Alert("请选择人员"):void $.Confirm("确认发送激活邀请？","",function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/set",dataType:"json",data:{ids:t,setType:"activate"},success:function(e){return e.success?void h():void $.Alert(e.message)}})}))}),$("#rePassword").on("click",function(){for(var e="",t="",a=$("tbody").find("input[type='checkbox']").length,d=0;d<a;d++){var n=$("tbody").find("input[type='checkbox']")[d],i=$("tbody").find("input[type='checkbox']").eq(d);t=i.attr("data-dep"),n.checked&&(e+=i.attr("data-id")+",")}return e=e.substr(0,e.length-1),""==e?void $.Alert("请选择人员"):void $.Confirm("确认发送密码重置邮件？","",function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/set",dataType:"json",data:{ids:e,setType:"reset"},success:function(e){return e.success?void h():void $.Alert(e.message)}})})}),$("#leavePos").on("click",function(){for(var e="",t="",a=$("tbody").find("input[type='checkbox']").length,d=0;d<a;d++){var n=$("tbody").find("input[type='checkbox']")[d],i=$("tbody").find("input[type='checkbox']").eq(d);t=i.attr("data-dep"),n.checked&&(e+=i.attr("data-id")+",")}return e=e.substr(0,e.length-1),""==e?void $.Alert("请选择人员"):void $.Confirm("确认设置为离职？","",function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/set",dataType:"json",data:{ids:e,setType:"setLeave"},success:function(e){return e.success?void h():void $.Alert(e.message)}})})}),$("#disabled").on("click",function(){for(var e="",t="",a=$("tbody").find("input[type='checkbox']").length,d=0;d<a;d++){var n=$("tbody").find("input[type='checkbox']")[d],i=$("tbody").find("input[type='checkbox']").eq(d);t=i.attr("data-dep"),n.checked&&(e+=i.attr("data-id")+",")}return e=e.substr(0,e.length-1),""==e?void $.Alert("请选择人员"):void $.Confirm("确认设置为禁用？","",function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/set",dataType:"json",data:{ids:e,setType:"setDisable",department:t},success:function(e){return e.success?void h():void $.Alert(e.message)}})})}),$("#start").on("click",function(){for(var e="",t="",a=$("tbody").find("input[type='checkbox']").length,d=0;d<a;d++){var n=$("tbody").find("input[type='checkbox']")[d],i=$("tbody").find("input[type='checkbox']").eq(d);t=i.attr("data-dep"),n.checked&&(e+=i.attr("data-id")+",")}return e=e.substr(0,e.length-1),""==e?void $.Alert("请选择人员"):void $.Confirm("确认设置为启用？","",function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/staff/set",dataType:"json",data:{ids:e,setType:"setActivate"},success:function(e){return e.success?void h():void $.Alert(e.message)}})})}),$(".addAll .newDep-a").on("click",function(){$(this).addClass("blue"),$(this).siblings().removeClass("blue"),$(".newDep").show(),$(".newUser").hide()}),$(".addAll .newUser-a").on("click",function(){$(this).addClass("blue"),$(this).siblings().removeClass("blue"),$(".newDep").hide(),$(".newUser").show()}),$(".role-modal-close").on("click",function(){$("#allot-modal").hide(),$("#depEdit-modal").hide()})})});