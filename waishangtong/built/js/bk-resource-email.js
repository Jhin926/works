require(["common"],function(){require(["maintab","ZeroClipboard","ueditorLang","blockUI","jqform"],function(e,t){function a(){var e=[];e.push(c.getContent()),contentText=e.join("\n")}function n(e){c.setContent(e)}function i(e,t){$("#form_img").ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(e){if(!e.success)return void $.unLogin(e);var t="http://"+e.data;UE.getEditor("addEditor").execCommand("insertimage",{src:t,width:"300"})}}).submit()}function o(){var e={};return $.ajax({url:Base.sitUrl+"/api/email/setting/v1/templates/search",type:"GET",success:function(e){if(!e.success)return void $.unLogin(e);for(var t=e.data,a="",n=0;n<t.length;n++)a+='<li data-value="'+t[n].value+'">'+t[n].name+"</li>";$(".modelDwon").empty().append(a)}}),e}function s(e){var t=!0,a=e.prop("files"),n=Math.round(a[0].size/1024*100)/100/1024;return n>1&&($.Alert("上传附件需小于1MB"),t=!1),{flag:t,name:a[0].name}}var r=top.funcList;$("[data-code]").each(function(){for(var e=0;e<r.length;e++)r[e].code==$(this).attr("data-code")&&$(this).removeClass("none")}),e.init(),$(".return").on("click",function(){$("#tem-set").hide(),$("#list-set").show()}),$.ajax({url:Base.sitUrl+"/api/org/v1/org/template/list",type:"POST",dataType:"json",data:{templateType:0},success:function(e){if(!e.success)return void $.Alert(e.message);for(var t=e.data,a=0;a<t.length;a++){var t=e.data;t[a].template=t[a].template.replace(/&#39;/g,'"');var n='<tr data-id="'+t[a].id+'"><td><label class="ashen temName">'+t[a].name+'</label></td><td class="content">'+t[a].template+'</td><td><a href="#" class="ashen temClose">删除</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" class="ashen temEdit">编辑</a><a href="#" class="ashen temCopy" style="margin-left:15px;">复制</a></td></tr>';$(".table tbody").append(n)}}}),$("#new-tem").on("click",function(){$("#tem-set").show(),$("#list-set").hide(),$("#tem-name").val("");var e="";n(e),$("#tem-add").on("click",function(){a(),contentText=contentText.replace(/"/g,"&#39;");var e=$("#tem-name").val(),t='{"templateType":0,"keyValueType":{"key":"","value":"'+e+'",valueI:"'+contentText+'","type":"1"}}';""==e?$.Alert("请填写名称"):$.ajax({url:Base.sitUrl+"/api/org/v1/org/template/edit",type:"POST",dataType:"json",data:{data:t},success:function(e){return e.success?void window.location.reload():void $.Alert(e.message)}})})}),$(document).on("click",".temClose",function(){a();var e=$(this).parents("tr").find(".temName").text(),t=$(this).parents("tr").attr("data-id"),n='{"templateType":0,"keyValueType":{"key":"'+t+'","value":"'+e+'",valueI:"'+contentText+'","type":"2"}}';$.Confirm("确认删除？","",function(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/template/edit",type:"POST",dataType:"json",data:{data:n},success:function(e){return e.success?void window.location.reload():void $.Alert(e.message)}})})}),$(document).on("click",".temEdit",function(){$("#tem-set").show(),$("#list-set").hide();var e=$(this).parents("tr").find(".temName").text(),t=$(this).parents("tr").attr("data-id");$("#tem-name").val(e);var i=$(this).parents("tr").find(".content").html();"null"==i&&(i=""),n(i),$("#tem-add").on("click",function(){a(),contentText=contentText.replace(/"/g,"&#39;");var e=$("#tem-name").val(),n='{"templateType":0,"keyValueType":{"key":"'+t+'","value":"'+e+'",valueI:"'+contentText+'","type":"3"}}';""==e?$.Alert("请填写名称"):$.ajax({url:Base.sitUrl+"/api/org/v1/org/template/edit",type:"POST",dataType:"json",data:{data:n},success:function(e){return e.success?void window.location.reload():void $.Alert(e.message)}})})}),$(document).on("click",".temCopy",function(){$("#tem-set").show(),$("#list-set").hide();var e=$(this).parents("tr").find(".temName").text()+"拷贝";$(this).parents("tr").attr("data-id");$("#tem-name").val(e);var t=$(this).parents("tr").find(".content").html();"null"==t&&(t=""),n(t),$("#tem-add").on("click",function(){a(),contentText=contentText.replace(/"/g,"&#39;");var e=$("#tem-name").val(),t='{"templateType":0,"keyValueType":{"key":"","value":"'+e+'",valueI:"'+contentText+'","type":"1"}}';""==e?$.Alert("请填写名称"):$.ajax({url:Base.sitUrl+"/api/org/v1/org/template/edit",type:"POST",dataType:"json",data:{data:t},success:function(e){return e.success?void window.location.reload():void $.Alert(e.message)}})})}),window.ZeroClipboard=t,$(".add-images").click(function(){return $("input[name=upImgs]").click()}),$("input[name=upImgs]").on("change",function(e){$.EventFn(e);var t=s($(this));t.flag&&i(t.name)}),$(".add-files").on("click",".add-model",function(e){$.EventFn(e),$(".modelDwon").slideToggle(),o()}),$(".add-files").on("click",".add-model>.modelDwon>li",function(e){$.EventFn(e);var t=$(this).attr("data-value");UE.getEditor("addEditor").execCommand("inserthtml",t),$(".modelDwon").hide()});var l=[["fontfamily","fontsize","forecolor","backcolor","|","bold","italic","|","underline","formatmatch","insertorderedlist","insertunorderedlist","justifyleft","justifyright","justifycenter","justifyjustify","|","link","unlink","inserttable","fullscreen","cleardoc","emotion","source"]],c=UE.getEditor("addEditor",{toolbars:l,initialFrameWidth:"100%",initialFrameHeight:200})})});