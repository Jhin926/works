require(["common"],function(){require(["maintab","ZeroClipboard","ueditorLang","blockUI","jqform"],function(t,e){function a(){var t=[];t.push(c.getContent()),contentText=t.join("\n")}function n(t){c.setContent(t)}function i(t,e){$("#form_img").ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(t){if(!t.success)return void $.unLogin(t);var e="http://"+t.data;UE.getEditor("addEditor").execCommand("insertimage",{src:e,width:"300"})}}).submit()}function o(){var t={};return $.ajax({url:Base.sitUrl+"/api/email/setting/v1/templates/search",type:"GET",success:function(t){if(!t.success)return void $.unLogin(t);for(var e=t.data,a="",n=0;n<e.length;n++)a+='<li data-value="'+e[n].value+'">'+e[n].name+"</li>";$(".modelDwon").empty(),$(".modelDwon").append(a)}}),t}function s(t){var e=!0,a=t.prop("files"),n=Math.round(a[0].size/1024*100)/100/1024;return n>1&&($.Alert("上传附件需小于1MB"),e=!1),{flag:e,name:a[0].name}}var r=top.funcList;$("[data-code]").each(function(){for(var t=0;t<r.length;t++)r[t].code==$(this).attr("data-code")&&$(this).removeClass("none")}),t.init(),$(".return").on("click",function(){$("#tem-set").hide(),$("#list-set").show()}),$.ajax({url:Base.sitUrl+"/api/org/v1/org/template/list",type:"POST",dataType:"json",data:{templateType:3},success:function(t){if(!t.success)return void $.Alert(t.message);for(var e=t.data,a=0;a<e.length;a++){var e=t.data;e[a].content=e[a].content.replace(/&#39;/g,'"');var n='<tr data-id="'+e[a].id+'"><td><label class="ashen temName">'+e[a].name+'</label></td><td class="content">'+e[a].content+'</td><td><a href="#" class="ashen temClose">删除</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" class="ashen temEdit">编辑</a><a href="#" class="ashen temCopy" style="margin-left:15px;">复制</a></td></tr>';$(".table tbody").append(n)}}}),$("#new-tem").on("click",function(){$("#tem-set").show(),$("#list-set").hide(),$("#tem-name").val("");var t="";n(t),$("#tem-add").on("click",function(){a(),contentText=contentText.replace(/"/g,"&#39;");var t=$("#tem-name").val(),e='{"templateType":3,"keyValueType":{"key":"","value":"'+t+'",valueI:"'+contentText+'","type":"1"}}';""==t?$.Alert("请填写名称"):$.ajax({url:Base.sitUrl+"/api/org/v1/org/template/edit",type:"POST",dataType:"json",data:{data:e},success:function(t){return t.success?void window.location.reload():void $.Alert(t.message)}})})}),$(document).on("click",".temClose",function(){a();var t=$(this).parents("tr").find(".temName").text(),e=$(this).parents("tr").attr("data-id"),n='{"templateType":3,"keyValueType":{"key":"'+e+'","value":"'+t+'",valueI:"'+contentText+'","type":"2"}}';$.Confirm("确认删除？","",function(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/template/edit",type:"POST",dataType:"json",data:{data:n},success:function(t){return t.success?void window.location.reload():void $.Alert(t.message)}})})}),$(document).on("click",".temEdit",function(){$("#tem-set").show(),$("#list-set").hide();var t=$(this).parents("tr").find(".temName").text(),e=$(this).parents("tr").attr("data-id");$("#tem-name").val(t);var i=$(this).parents("tr").find(".content").html();"null"==i&&(i=""),n(i),$("#tem-add").on("click",function(){a(),contentText=contentText.replace(/"/g,"&#39;");var t=$("#tem-name").val(),n='{"templateType":3,"keyValueType":{"key":"'+e+'","value":"'+t+'",valueI:"'+contentText+'","type":"3"}}';$.ajax({url:Base.sitUrl+"/api/org/v1/org/template/edit",type:"POST",dataType:"json",data:{data:n},success:function(t){return t.success?void window.location.reload():void $.Alert(t.message)}})})}),$(document).on("click",".temCopy",function(){$("#tem-set").show(),$("#list-set").hide();var t=$(this).parents("tr").find(".temName").text()+"拷贝";$(this).parents("tr").attr("data-id");$("#tem-name").val(t);var e=$(this).parents("tr").find(".content").html();"null"==e&&(e=""),n(e),$("#tem-add").on("click",function(){a(),contentText=contentText.replace(/"/g,"&#39;");var t=$("#tem-name").val(),e='{"templateType":3,"keyValueType":{"key":"","value":"'+t+'",valueI:"'+contentText+'","type":"1"}}';$.ajax({url:Base.sitUrl+"/api/org/v1/org/template/edit",type:"POST",dataType:"json",data:{data:e},success:function(t){return t.success?void window.location.reload():void $.Alert(t.message)}})})}),window.ZeroClipboard=e,$(".add-images").click(function(){return $("input[name=upImgs]").click()}),$("input[name=upImgs]").on("change",function(t){$.EventFn(t);var e=s($(this));e.flag&&i(e.name)}),$(".add-files").on("click",".add-model",function(t){$.EventFn(t),$(".modelDwon").slideToggle(),o()}),$(".add-files").on("click",".add-model>.modelDwon>li",function(t){$.EventFn(t);var e=$(this).attr("data-value");UE.getEditor("addEditor").execCommand("inserthtml",e),$(".modelDwon").hide()});var l=[["fontfamily","fontsize","forecolor","backcolor","|","bold","italic","|","underline","formatmatch","insertorderedlist","insertunorderedlist","justifyleft","justifyright","justifycenter","justifyjustify","|","link","unlink","inserttable","fullscreen","cleardoc","emotion"]],c=UE.getEditor("addEditor",{toolbars:l,initialFrameWidth:"100%",initialFrameHeight:200})})});