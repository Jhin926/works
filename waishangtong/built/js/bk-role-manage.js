require(["common"],function(){require(["maintab","ztree"],function(e){function a(){$("#list-group").children().remove(),$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/role/list",dataType:"json",success:function(e){var a=e.data;$(".list-group").empty();for(var i=0;i<a.length;i++){var t='<li class="list-group-item" data-roleId="'+a[i].id+'"><label class="popPSname" data-roleId="'+a[i].id+'">'+a[i].name+'</label><label class="pop-set"><a href="javascript:" class="editPOP"><i class="i-edit"></i></a><a href="javascript:" class="removePOP"><i class="group-remove"></i></a></label></li>';$(".list-group").append(t)}}})}function i(){for(var e=$.fn.zTree.getZTreeObj("treeDemo"),a=e.getCheckedNodes(!0),i=e.getCheckedNodes(!1),t="",s="",r=0;r<a.length;r++)0==a[r].rolePermissionId&&(t+=a[r].id+",");for(var r=0;r<i.length;r++)0!==i[r].rolePermissionId&&(s+=i[r].rolePermissionId+",");t=t.substring(0,t.length-1),s=s.substring(0,s.length-1);var o=$("#list-group").find(".active").attr("data-roleid");$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/role/permission/save/batch",dataType:"json",data:{roleId:o,permissionIds:t,ids:s},beforeSend:function(e){$.BlockUI()},complete:function(e,a){$.UnblockUI()},success:function(e){return e.success?($("label.popPSname.active").click(),void $.Alert("保存成功")):void $.Alert(e.message)}})}function t(e){var a=new Array,i="";$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/role/permission/list",dataType:"json",data:{roleId:e},beforeSend:function(e){$.BlockUI()},complete:function(e,a){$.UnblockUI()},success:function(t){function r(){var e=$.fn.zTree.getZTreeObj("treeDemo"),a=($("#py").attr("checked")?"p":"",$("#sy").attr("checked")?"s":"",$("#pn").attr("checked")?"p":"",$("#sn").attr("checked")?"s":"",{Y:"ps",N:"s"});e.setting.check.chkboxType=a,o('setting.check.chkboxType = { "Y" : "'+a.Y+'", "N" : "'+a.N+'" };')}function o(e){c||(c=$("#code")),c.empty(),c.append("<li>"+e+"</li>")}for(var l=t.data,n=0;n<l.length;n++)i=1==l[n].hasRight,a[n]={id:l[n].permissionId,pId:l[n].permissionPid,name:l[n].name,roleId:e,rolePermissionId:l[n].rolePermissionId,checked:i};var c;$.fn.zTree.init($("#treeDemo"),s,a);var d=$.fn.zTree.getZTreeObj("treeDemo"),p=d.getNodesByParam("level","0",null);p=p.concat(d.getNodesByParam("level","1",null));for(var n=0;n<p.length;n++)d.expandNode(p[n],!0,!1,!1);r(),$("#py").bind("change",r),$("#sy").bind("change",r),$("#pn").bind("change",r),$("#sn").bind("change",r)}})}e.init();var s={check:{enable:!0},data:{simpleData:{enable:!0,roleId:0}},callback:{}};$(document).on("mouseenter",".list-group-item",function(){$(this).children("label.pop-set").show()}),$(document).on("mouseleave",".list-group-item",function(){$(this).children("label.pop-set").hide()}),$("#pop-add").on("click",function(){$("#add-modal").animate({right:"0"})}),$(".modal-close-a").on("click",function(){$(".panel-modal").animate({right:"-900px"})}),$(".popSearch").on("click",function(){var e=$(".manege-search").val();$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/role/list",dataType:"json",data:{name:e},success:function(e){if(!e.success)return void $.Alert(e.message);var a=e.data;$(".list-group").children().remove(),$(".list-group").empty();for(var i=0;i<a.length;i++){var t='<li class="list-group-item" data-roleId="'+a[i].id+'"><label class="popPSname" data-roleId="'+a[i].id+'">'+a[i].name+'</label><label class="pop-set"><a href="javascript:" class="editPOP"><i class="i-edit"></i></a><a href="javascript:" class="removePOP"><i class="group-remove"></i></a></label></li>';$(".list-group").append(t)}}})}),$.list=function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/role/list",dataType:"json",success:function(e){var a=e.data;if(!e.success)return void $.Alert(e.message);$("#list-group").empty();for(var i=0;i<a.length;i++){if(0==i)var s='<li class="list-group-item" data-roleId="'+a[i].id+'"><label class="popPSname active" style="color:#4c73ec" data-roleId="'+a[i].id+'">'+a[i].name+'</label><label class="pop-set"><a href="javascript:" class="editPOP"><i class="i-edit"></i></a><a href="javascript:" class="removePOP"><i class="group-remove"></i></a></label></li>';else var s='<li class="list-group-item" data-roleId="'+a[i].id+'"><label class="popPSname" data-roleId="'+a[i].id+'">'+a[i].name+'</label><label class="pop-set"><a href="javascript:" class="editPOP"><i class="i-edit"></i></a><a href="javascript:" class="removePOP"><i class="group-remove"></i></a></label></li>';$("#list-group").append(s)}t(a[0].id)}})};var r=[];$.ajax({type:"get",url:Base.sitUrl+"/api/org/v1/org/role/list",success:function(e){return e.success?void(r=e.data):void $.Alert(result.message)}}),$(document).on("click",".editPOP",function(){$("#edit-modal").animate({right:"0"});var e=$(this).parents(".list-group-item").find(".popPSname").text(),a=($(this).parents(".list-group-item").find(".popPSname").attr("data-roleId"),$(this).parents(".list-group-item").index());$("#edit-remark").val(r[a].remark),$("#pop-edit-name").val(e)}),$("#pop-edit-save").on("click",function(){var e=$("#pop-edit-name").val(),a=$("#edit-remark").val();""==e?$.Alert("角色名不能为空"):$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/role/edit",dataType:"json",data:{id:roleId,name:e,remark:a},success:function(e){return e.success?($.Alert("添加成功！"),void window.location.reload()):void $.Alert(e.message)}})}),$(document).on("click",".removePOP",function(){var e=$(this).parents(".list-group-item").find(".popPSname").attr("data-roleId");$.Confirm("确认删除？","",function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/role/delete",dataType:"json",data:{id:e},success:function(e){return e.success?void a():void $.Alert(e.message)}})})}),$("#saveTree").unbind("click").bind("click",function(){i()}),$.list(),$(document).on("click","label.popPSname",function(){$(this).addClass("active"),$(this).css("color","#4c73ec"),$(this).parents("li").siblings().find("label.popPSname").removeClass("active"),$(this).parents("li").siblings().find("label.popPSname").css("color","#3c3c3c");var e=$(this).attr("data-roleId"),a=new Array,i="";$.ajax({type:"POST",url:Base.sitUrl+"/api/org/v1/org/role/permission/list",dataType:"json",data:{roleId:e},beforeSend:function(e){$.BlockUI()},complete:function(e,a){$.UnblockUI()},success:function(t){function r(){var e=$.fn.zTree.getZTreeObj("treeDemo"),a=($("#py").attr("checked")?"p":"",$("#sy").attr("checked")?"s":"",$("#pn").attr("checked")?"p":"",$("#sn").attr("checked")?"s":"",{Y:"ps",N:"s"});e.setting.check.chkboxType=a,o('setting.check.chkboxType = { "Y" : "'+a.Y+'", "N" : "'+a.N+'" };')}function o(e){c||(c=$("#code")),c.empty(),c.append("<li>"+e+"</li>")}for(var l=t.data,n=0;n<l.length;n++)i=1==l[n].hasRight,a[n]={id:l[n].permissionId,pId:l[n].permissionPid,name:l[n].name,roleId:e,rolePermissionId:l[n].rolePermissionId,checked:i,open:!1};var c;$.fn.zTree.init($("#treeDemo"),s,a),r(),$("#py").bind("change",r),$("#sy").bind("change",r),$("#pn").bind("change",r),$("#sn").bind("change",r)}})})})});