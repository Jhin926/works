require(["common"],function(){require(["maintab","angular","angularAnimate","blockUI"],function(e){e.init();var i=$("#pageLeftUserName",parent.document).attr("data-id"),t=$.GetQueryString("type"),s=angular.module("All",[]);s.controller("fileList",["$scope","$http",function(s,l){function r(e){for(var i=0;i<e.length;i++)e[i].name.length>50?e[i].subName=e[i].name.substring(0,50)+"...":e[i].subName=e[i].name,0==e[i].type?e[i].imgSrc="../../images/new/cloudfile0.png":1==e[i].type?e[i].imgSrc="../../images/new/cloudfile1.png":e[i].imgSrc="../../images/new/cloudfile0.png";return e}function o(){$.BlockUI(),l({method:"post",url:Base.sitUrl+"/api/disk/v1/root/folder/list",params:{data:{view:s.view,userId:s.userId}}}).success(function(e){if($.UnblockUI(),!e.success)return void $.unLogin(e);var i=e.data;i.length>0?(s.isEmpty=!1,s.files=s.rootFiles=r(i)):s.isEmpty=!0})}function n(){$.BlockUI(),l({method:"post",url:Base.sitUrl+"/api/org/v1/org/staff/list"}).success(function(e){if($.UnblockUI(),!e.success)return void $.unLogin(e);var i=e.data;i.length>0?(s.isEmpty=!1,s.files=s.rootFiles=r(i)):s.isEmpty=!0})}s.view=1==t?"1":"0",s.cloudTitle=1==t?"成员云盘":"我的云盘",s.userId=i,s.showHandle=!1,s.currentId=0,s.stepList=[],s.title="全部文件",s.isShow=!1,s.isEmpty=!1,s.btnArr={isDownload:!0,isSendEml:!0,isEditName:!0,isDel:!0},s.checkFile=[],s.uploadHref="pop-cloud-upload.html?userId="+i+"&v="+window.ver,s.diskHref="pop-cloud-new.html?userId="+i+"&v="+window.ver,s.isMycloud=!0,s.isMange=1==t,s.isRoot=!0,s.isMange?n():o(),s.prev=function(){s.isRoot?$.Alert("已经是根目录了"):(s.isEmpty=!1,s.title=s.title.substring(0,s.title.lastIndexOf(">")),s.stepList.length<=0?(s.isRoot=!0,s.files=s.rootFiles):1==s.stepList.length?s.isMange&&s.isMycloud?(s.currentId=s.stepList.pop(),s.reload()):(s.isRoot=!0,s.files=s.rootFiles):(s.currentId=s.stepList.pop(),s.reload()))},s.reload=function(){s.isRoot?s.files=s.rootFiles:($.BlockUI(),l({method:"post",url:Base.sitUrl+"/api/disk/v1/sub/file/list",params:{data:{view:s.view,userId:s.userId,pid:s.currentId}}}).success(function(e){if($.UnblockUI(),!e.success)return void $.unLogin(e);var i=e.data;i.length>0?(s.isEmpty=!1,s.files=r(i)):s.isEmpty=!0}))},s.homePage=function(){s.isRoot=!0,s.currentId=0,s.title="全部文件",s.stepList=[],s.rootFiles&&s.rootFiles.length>0&&(s.isEmpty=!1,s.files=s.rootFiles)},s.getDetail=function(e,i){if(s.isMange&&s.isMycloud&&s.isRoot)s.isRoot=!1,s.userId=e.id,s.currentId=0,s.title+=">"+e.name,s.reload(),s.checkFile=[];else if(0==e.type)s.isRoot=!1,s.currentId=e.id,s.stepList.push(e.pid),s.title+=">"+e.name,s.reload(),s.checkFile=[];else{var t=e.file,l=e.name,r=e.id,o=t.lastIndexOf("."),n=t.substring(o,t.length).toUpperCase();if(".PNG"==n||".JPG"==n||".JPEG"==n||".SVG"==n||".GIF"==n)if(t.indexOf("http")>=0)var a='<img src="'+t+'" alt="" class="previewImg previewContent">';else var a='<img src="http://'+t+'" alt="" class="previewImg previewContent">';else if(".TXT"==n||".JS"==n||".CSS"==n)var a='<iframe src="'+t+'" frameborder="0" class="previewIframe previewContent"></iframe>';else{if(".DOC"!=n&&".DOCX"!=n&&".XLS"!=n&&".XLSX"!=n&&".ET"!=n&&".PPT"!=n&&".PPTX"!=n&&".WPS"!=n&&".ZIP"!=n&&".RAR"!=n&&".7Z"!=n)return void $.Alert(n.toLowerCase()+"格式暂不支持预览");var c=Base.sitUrl+"/api/disk/v1/file/preview?data={id:"+r+"}",a='<iframe src="'+c+'" frameborder="0" class="previewIframe previewContent"></iframe>'}$("#preview").find("h3").text(l),$("#preview").find(".previewContent").remove(),$("#preview").append(a).show()}},s.check=function(e,i){i.stopPropagation();var t=$(i.target);if(1==t.prop("checked")?(t.parent().addClass("checked"),s.checkFile.indexOf(e)<0&&s.checkFile.push(e)):(t.parent().removeClass("checked"),s.checkFile.indexOf(e)>=0&&s.checkFile.splice(s.checkFile.indexOf(e),1)),1==s.checkFile.length)0==s.checkFile[0].type||void 0==s.checkFile[0].type?s.btnArr={isDownload:!0,isSendEml:!0,isEditName:!1,isDel:!1}:s.btnArr={isDownload:!1,isSendEml:!1,isEditName:!1,isDel:!1};else if(s.checkFile.length>1){var l=[];for(var r in s.checkFile)0==s.checkFile[r].type&&l.push(s.checkFile[r]);l.length<=0?s.btnArr={isDownload:!0,isSendEml:!1,isEditName:!0,isDel:!1}:s.btnArr={isDownload:!0,isSendEml:!0,isEditName:!0,isDel:!1}}s.showHandle=s.checkFile.length>0},s.delete=function(){$.Confirm("确认删除？","",function(){var e=[];for(var i in s.checkFile)e.push(s.checkFile[i].id);$.BlockUI(),l({method:"post",url:Base.sitUrl+"/api/disk/v1/file/delete",params:{data:{ids:e.join()}}}).success(function(e){if($.UnblockUI(),e.success){$.Alert("删除成功");for(var i in s.checkFile)s.files.splice(s.files.indexOf(s.checkFile[i]),1);s.checkFile=[],s.showHandle=!1}else $.Alert(e.message)})})},s.confirm=function(){var e={id:s.checkFile[0].id,view:s.view,name:s.checkFile[0].name,pid:s.checkFile[0].pid};s.isMycloud||(e.shareType=2,e.operatetype=0,e.usertype=0),$.BlockUI(),l({method:"get",url:Base.sitUrl+"/api/disk/v1/file/edit",params:{data:e}}).success(function(e){$.UnblockUI(),e.success?($.Alert("操作成功"),s.files[s.files.indexOf(s.checkFile[0])].name=s.checkFile[0].name,s.files=r(s.files),s.isShow=!1):$.unLogin(e)})},s.closePreview=function(){$("#preview").hide().find(".previewContent").remove()},s.sendEmail=function(){var i=[];for(var t in s.checkFile){var l={name:s.checkFile[t].name,value:s.checkFile[t].file};i.push(l)}e.showTab(Base.url+"/html/pop-email-new.html?typeCloud=11&data="+JSON.stringify(i)+"&v="+window.ver,"新建邮件")},s.download=function(){var e={name:s.checkFile[0].name,value:s.checkFile[0].file},i="data="+JSON.stringify(e);window.location.href=Base.sitUrl+"/api/file/download?"+i},s.switchCloud=function(e){s.isMycloud=e,s.title="全部文件",s.isRoot=!0,s.currentId=0,s.stepList=[],s.isMange?(s.diskHref="pop-cloud-newShare-bk.html?userId=0&v="+window.ver,s.uploadHref="pop-cloud-uploadShare-bk.html?userId=0&v="+window.ver,e?n():(s.userId="0",o())):(e?(s.userId=i,s.uploadHref="pop-cloud-upload.html?userId="+i+"&v="+window.ver):(s.userId="0",s.uploadHref="pop-cloud-uploadShare.html?userId="+i+"&v="+window.ver),o())}}]),angular.bootstrap(document.body,["All"])})});