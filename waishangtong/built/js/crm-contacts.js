require(["common"],function(){require(["maintab","blockUI","datetimepickerCN","countries"],function(t){function a(t,a){var e="";$.each(t,function(t,a){var s="",n="",i="",r="",o="";1==a.starLevel?(s="s-star3",n="s-unstar2",i="s-unstar2",r="s-unstar2",o="s-unstar2"):2==a.starLevel?(s="s-star3",n="s-star3",i="s-unstar2",r="s-unstar2",o="s-unstar2"):3==a.starLevel?(s="s-star3",n="s-star3",i="s-star3",r="s-unstar2",o="s-unstar2"):4==a.starLevel?(s="s-star3",n="s-star3",i="s-star3",r="s-star3",o="s-unstar2"):5==a.starLevel?(s="s-star3",n="s-star3",i="s-star3",r="s-star3",o="s-star3"):(s="s-unstar2",n="s-unstar2",i="s-unstar2",r="s-unstar2",o="s-unstar2");var l="",c="";if(""==a.customerContactTags)l="none";else if(l="",a.customerContactTags.length>2)for(var p=0;p<2;p++)a.customerContactTags[p].tagName&&a.customerContactTags[p].tagName.length>8&&(a.customerContactTags[p].tagName=a.customerContactTags[p].tagName.substring(0,7)+"..."),c+='<li class="tags-li" style="margin-right:5px;margin-top:5px;"><span data-tagId="'+a.customerContactTags[p].id+'">'+d(a.customerContactTags[p].tagName)+'</span><i class="s-updownBg s-dels3"></i></li>';else for(var p=0;p<a.customerContactTags.length;p++)a.customerContactTags[p].tagName&&a.customerContactTags[p].tagName.length>8&&(a.customerContactTags[p].tagName=a.customerContactTags[p].tagName.substring(0,7)+"..."),c+='<li class="tags-li" style="margin-right:5px;margin-top:5px;"><span data-tagId="'+a.customerContactTags[p].id+'">'+d(a.customerContactTags[p].tagName)+'</span><i class="s-updownBg s-dels3"></i></li>';if(""!==a.followUpUsers&&null!==a.followUpUsers)for(var p=0;p<a.followUpUsers.length;p++){if(u==a.followUpUsers[p].userId){var g=a.followUpUsers[p].userName;break}var g=a.followUpUsers[0].userName}else var g="";""!==a.followUpUser&&a.followUpUser.length>4&&(a.followUpUser=a.followUpUser.substring(0,3)+"..."),""!==a.position&&null!==a.position&&a.position.length>4&&(a.position=a.position.substring(0,3)+"..."),""!==a.name&&null!==a.position&&a.name.length>17&&(a.name=a.name.substring(0,15)+"..."),null!==a.workingCompany&&""!==a.workingCompany&&void 0!==a.workingCompany&&$.GetLength(a.workingCompany)>26&&(a.workingCompany=a.workingCompany.substring(0,19)+"..."),e+='<tr data-id="'+a.id+'" data-highSeas="'+a.highSeas+'"><td><div class="checker"><span><input name="batch" type="checkbox" data-id="'+a.id+'"></span></div></td><td class="sortsName"><a href="../html/pop-relation-detail.html?id='+a.id+"&v="+window.ver+'" data-maintab><span  class="s-special">'+d(a.name)+'</span></a><br><span class="recentNews">'+d(a.recentNews)+"</span></td></td><td>"+d(a.workingCompany)+'</td><td class="starLevelOp"><i class="s-updownBg '+s+'"></i><i class="s-updownBg '+n+'"></i><i class="s-updownBg '+i+'"></i><i class="s-updownBg '+r+'"></i><i class="s-updownBg '+o+'"></i></td><td><span>'+d(g)+'</span></td><td style="position:relative;"><span>'+(a.position||"")+'</span><ul class="'+l+'">'+c+'</ul></td><td class="sortsTime">'+d(a.createTime)+"</td></tr>"}),$(".trNone").remove(),$(".page_info>table>tbody").empty().html(e);var s=a,n=v.pageSize,i=Math.ceil(s/n);v.lastpage=i,$.Page({total:s,_class:".page",nowNum:v.currentPage,allNum:i,callback:function(t,a){if(v.currentPage=t,console.log(t),$("#conFilter .label-list li.active").length>0){var e={currentPage:t,pageSize:v.pageSize},s=$("#conFilter .label-list li.active").attr("data-value"),n=JSON.stringify(e),i='[{"filedName":"tagId","operateType":"=","filedValue":"'+s+'"}]',r=n.substring(0,n.length-1)+',"conditions":'+i+"}";l(r)}else m.filter()}})}function e(){var t="";return $(".page_info .table tbody td input[type=checkbox]:checked").each(function(){var a=$(this).attr("data-id");t+=a+","}),t=t.substring(0,t.length-1)}function s(){$.ajax({url:Base.sitUrl+"/api/user/v1/user/tag/list",type:"POST",dataType:"json",data:{tagType:2},success:function(t){if(!t.success)return void $.unLogin(t);for(var a=t.data,e="",s=0;s<a.length;s++)e+='<li data-value="'+a[s].id+'">'+a[s].name+"</li>";$(".label-list").empty().append(e),$("#tagsModal").find("ul").empty().append(e)}})}function n(t){$.ajax({url:Base.sitUrl+"/api/user/v1/user/tag/save",type:"POST",dateType:"json",data:{tagType:2,name:t},success:function(t){return t.success?($.Alert("添加成功！"),s(),$(".addTags").hide(),$(".s-close").addClass("s-add"),void $(".s-add").removeClass("s-close")):void $.unLogin(t)}})}function i(){$.ajax({url:Base.sitUrl+"/api/customer/v1/underling/customer",type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);for(var a=t.data,e='<option value="0">不限</option>',s="",n=0;n<a.length;n++)e+='<option value="'+a[n].id+'">'+a[n].name+"</option>",s+='<li data-value="'+a[n].id+'">'+a[n].name+"</li>";$("#followList").empty().append(e),$("#myModal .modal-body>ul").empty().append(s)}})}function r(){$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/assign/list",type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);for(var a=t.data,e='<option value="0">不限</option>',s=0;s<a.length;s++)e+='<option value="'+a[s].id+'">'+a[s].name+"</option>";$("#companyList").empty().append(e)}})}function o(){$.ajax({url:Base.sitUrl+"/api/user/v1/user/tag/list?tagType=2",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);for(var a=t.data,e="",s=0;s<a.length;s++)e+='<li data-id="'+a[s].id+'">'+a[s].name+"</li>";$("#filter-tag .tag-list").empty().append(e)}})}function l(t){$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/list/query",type:"POST",dataType:"json",data:{data:t},beforeSend:function(t){$.BlockUI()},complete:function(t,a){$.UnblockUI()},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data.results,s=t.data.totalItem;if(""==e){var n='<div class="trNone"><div class="trnone-info"><img src="../images/empty-contact.png" width="60" height="80" alt="" /><p class="trnone-text">暂无联系人</p></div><a href="pop-contacts-add.html" class="trnone-btn btn btn-primary" data-code="contact_add" data-maintab></i><span>创建联系人</span></a></div>';$(".page_info>table>tbody").empty(),$(".page_info>table").after(n)}else a(e,s)}})}function c(t){$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/list/query",type:"POST",dataType:"json",data:{data:t},success:function(t){if(!t.success)return void $.unLogin(t);$("#filterModal").is(":hidden")||$("#filterModal").modal("hide");var e=t.data.results,s=t.data.totalItem;if(a(e,s),""==e){var n='<div class="trNone"><div class="trnone-info"><img src="../images/empty-contact.png" alt="" /><p class="trnone-text">暂无联系人</p></div><a href="pop-contacts-add.html" class="trnone-btn btn btn-primary" data-code="contact_add" data-maintab></i><span>创建联系人</span></a></div>';$(".page_info>table>tbody").empty(),$(".page_info>table").after(n)}}})}function d(t){return null==t?"":t}var p=top.funcList;$("[data-code]").each(function(){for(var t=0;t<p.length;t++)p[t].code==$(this).attr("data-code")&&$(this).removeClass("none")}),t.init(),$(".r-titles").hide(),jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({format:"yyyy-mm-dd hh:ii",todayBtn:!0,language:"zh-CN",pickerPosition:"bottom-right",autoclose:!0});var u=parent.document.getElementById("pageLeftUserName").innerText;$(document).on("click",".starLevelOp>i",function(t){var a=$(this).parent().children("i");$(this).hasClass("s-unstar2")?g.goodFn(a,$(this).index()):g.nagativeFn(a,$(this).index());var e=$(this).parents("tr").attr("data-id"),s=$(this).parents(".starLevelOp").find(".s-star3").length,n={id:e,starLevel:s,setType:"setStar"};$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/set",type:"POST",dataType:"json",async:!1,data:{data:JSON.stringify(n)},success:function(t){return t.success?void m.filter():void $.unLogin(t)}})});var g={index:1,goodFn:function(t,a){for(var e=0;e<t.length;e++){if(e>a)return;t.eq(e).removeClass("s-unstar2").addClass("s-star3")}},nagativeFn:function(t,a){for(var e=0;e<t.length;e++)e>a?t.eq(e).removeClass("s-star3").addClass("s-unstar2"):t.eq(e).removeClass("s-unstar2").addClass("s-star3")},mFn:function(t){for(var a=t,e=0;e<a.length;e++)(e+1)%2==0&&a.eq(e).css("margin-right",0)}};$("#conFilter li a").on("click",function(t){$.EventFn(t),"group-list"==$(this).parent().find("ul").attr("class")||"label-list"==$(this).parent().find("ul").attr("class")?($(this).parent().find("ul").addClass("active"),$(this).parent().find(".s-up2").addClass("s-down2"),$(this).parent().find(".s-down2").removeClass("s-up2")):($(this).parent().find("ul").removeClass("active"),$(this).parent().find(".s-up2").removeClass("s-down2"),$(this).parent().find(".s-down2").addClass("s-up2"))}),$(".page-left").on("click","#conFilter .s-up2",function(t){$.EventFn(t),$(this).parents("li").find("ul").addClass("active"),$(this).addClass("s-down2"),$(this).parents("li").find(".s-down2").removeClass("s-up2")}),$(".page-left").on("click","#conFilter .s-down2",function(t){$.EventFn(t),$(this).parents("li").find("ul").removeClass("active"),$(this).addClass("s-up2"),$(this).parents("li").find(".s-up2").removeClass("s-down2")}),$(".page-left").on("click","#conFilter .s-add",function(t){$.EventFn(t),$(this).parents("li").find("ul").addClass("active"),$(this).parents("li").find(".addTags").show(),$(this).addClass("s-close"),$(this).parents("li").find(".s-close").removeClass("s-add")}),$(".page-left").on("click","#conFilter .s-close",function(t){$.EventFn(t),$(this).parents("li").find("ul").addClass("active"),$(this).parents("li").find(".addTags").hide(),$(this).addClass("s-add"),$(this).parents("li").find(".s-add").removeClass("s-close")}),$(".page-left").on("click","#conFilter .addTags",function(t){$.EventFn(t),$(this).show()}),$("#batchClose").on("mouseenter",function(){$(this).addClass("s-updownBg s-dels4").removeClass("fa fa-times")}),$("#batchClose").on("mouseleave",function(){$(this).addClass("fa fa-times").removeClass("s-updownBg s-dels4")}),$(".mclose").on("click",function(){$(".modals").removeClass("active"),$("#assigns").val(""),$("#btn-assign").hide(),f={arr:[],tmp:[]}}),$(".page_info>table>tbody").delegate("input[name=batch]","click",function(t){var a=t||window.event;a.stopPropagation();var e=custObj.getAllChecked();e.dist.indexOf("0")!=-1&&$("#btn-assigns").attr("disabled","disabled"),e.share.indexOf("0")!=-1&&$("#btn-shares").attr("disabled","disabled"),e.del.indexOf("0")!=-1&&$("#btn-dels").attr("disabled","disabled")}),$(".btn-addLabel").on("click",function(){$(".u-labels").hasClass("active")?($(this).find("i").removeClass("fa-times").addClass("fa-plus"),$(".u-labels").removeClass("active")):($(this).find("i").addClass("fa-times").removeClass("fa-plus"),$("#labelName").val(""),$(".u-labels").addClass("active"))}),$("#btn-assigns,#btn-shares").on("click",function(){f={arr:[],tmp:[]}});var f={arr:[],tmp:[]};$("#btn-tags").on("click",function(){$("#tagsModal").addClass("active"),$("#tagsModal").siblings().removeClass("active")});var v={homepage:1,currentPage:1,lastpage:null,pageSize:20},m={filter:function(){var t={currentPage:v.currentPage,pageSize:v.pageSize};$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/list/query",data:{data:JSON.stringify(t)},type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data.results,s=t.data.totalItem;if(e.length>0)a(e,s);else{var n='<div class="trNone"><div class="trnone-info"><img src="../images/empty-contact.png" width="60" height="80" alt="" /><p class="trnone-text">暂无联系人</p></div><a href="pop-contacts-add.html" class="trnone-btn btn btn-primary" data-code="contact_add" data-maintab></i><span>创建联系人</span></a></div>';$(".page_info>table>tbody").empty(),$(".page_info>table").after(n)}}})}};$.reHtml=function(){var t={currentPage:v.currentPage,pageSize:v.pageSize};$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/list/query",data:{data:JSON.stringify(t)},type:"POST",dataType:"json",beforeSend:function(t){$.BlockUI()},complete:function(t,a){$.UnblockUI()},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data.results,s=t.data.totalItem;if(e.length>0)a(e,s);else{var n='<div class="trNone"><div class="trnone-info"><img src="../images/empty-contact.png" width="60" height="80" alt="" /><p class="trnone-text">暂无联系人</p></div><a href="pop-contacts-add.html" class="trnone-btn btn btn-primary" data-code="contact_add" data-maintab></i><span>创建联系人</span></a></div>';$(".page_info>table>tbody").empty().after(n),$(".page_info>table").after(n)}}})},$("#inputQuick").on("keyup",function(){var t=$("#inputQuick").val();if("none"==$("#btn-underling-pop").css("display"))var e={currentPage:1,pageSize:20,keyword:t};else var s=$("#btn-underling-pop").attr("data-id"),e={id:s,currentPage:1,pageSize:20,keyword:t};13==event.keyCode&&(""==t?m.filter():$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/list/query/keyword",type:"POST",dataType:"json",data:{data:JSON.stringify(e)},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data.results,s=t.data.totalItem;a(e,s)}}))}),$("#tagsModal").on("click","ul li",function(){var t=$(this).attr("data-value"),a=e(),s={ids:a,tagId:t,setType:"tag"};$(".page_info .table tbody td input[type=checkbox]:checked").length<1?$.Alert("请选择标记人员"):$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/set",type:"POST",dataType:"json",data:{data:JSON.stringify(s)},success:function(t){return t.success?($("#tagsModal").removeClass("active"),void m.filter()):void $.unLogin(t)}})}),$(document).on("click",".tags-li .s-dels3",function(t){$.EventFn(t);var a=$(this).parent().find("span").attr("data-tagid"),e={id:a,setType:"delTag"};$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/set",type:"POST",dataType:"json",data:{data:JSON.stringify(e)},success:function(t){return t.success?void m.filter():void $.unLogin(t)}})}),$("#tagsAdd").on("click",function(){var t=$("#labelNames").val();""==t?$.Alert("标签不能为空"):n(t)}),$("#btn-addLabel").on("click",function(){var t=$("#labelName").val();""==t?$.Alert("标签不能为空"):n(t)}),$("#btn-underling").on("click",function(t){$(this).hasClass("on")&&(m.filter(),$("#btn-underling-pop").hide(),$(this).removeClass("on"),$(this).attr("data-toggle","modal"),$(this).attr("data-target","#myModal"),$.EventFn(t))}),$("#myModal .modal-body>ul").on("click",">li",function(){var t=$(this).attr("data-value"),a=$(this).text();$("#btn-underling").attr("data-toggle",""),$("#btn-underling").attr("data-target",""),$("#btn-underling").addClass("on"),$("#btn-underling-pop").text(a),$("#btn-underling-pop").attr("data-id",t),$("#btn-underling-pop").show(),$("#underling-close").click();var e='{"currentPage":1,"pageSize":20,"conditions":[{"filedName":"followUpUser","operateType":"=","filedValue":"'+t+'"}]}';c(e)}),$("#btn-filter").on("click",function(){r(),i(),o();for(var t=countries,a='<option value="0">选择国家地区</option>',e=0;e<t.length;e++)a+='<option value="'+t[e].id+'">'+t[e].cn+" - "+t[e].en+"</option>";$("#countryList").empty().append(a)}),$("#inlineCheckbox").change(function(){var t=$(this).prop("checked");1==t?($("input[name=checkstar]").prop("checked",!0),$("input[name=checkstar]").parent().addClass("checked")):($("input[name=checkstar]").prop("checked",!1),$("input[name=checkstar]").parent().removeClass("checked"))}),$("input[name=checkstar]").change(function(){var t=$(this).prop("checked");if(1==t){for(var a=0;a<$("input[name=checkstar]").length;a++)if(!$("input[name=checkstar]").eq(a).prop("checked")&&0!=a)return;$("#inlineCheckbox").prop("checked",!0).parent().addClass("checked")}else $("#inlineCheckbox").prop("checked",!1).parent().removeClass("checked")}),$("#filterModal").on("click",".checked-tags",function(){$(this).next().toggle()}),$("#filterModal").on("click",".tag-list li",function(){var t=$(this);t.parent().hide();for(var a=t.parent().prev(".checked-tags").find(".tag-cont"),e=0;e<a.length;e++)if(t.attr("data-id")==a.eq(e).attr("data-id"))return;var s='<span class="tag-cont" data-id="'+$(this).attr("data-id")+'"><span class="mark ellipsis">'+$(this).text()+'</span><i class="close-icon"></i></span>';t.parent().prev(".checked-tags").append(s)}),$("#filterModal").on("click",".checked-tags .mark",function(t){$.EventFn(t)}),$("#filterModal").on("click",".checked-tags .close-icon",function(t){$.EventFn(t),$(this).parent().remove()}),$("#reset").click(function(){$("#keyword,#position").val(""),$("input[name=checkstar]").prop("checked",!1).parent().removeClass("checked"),$("input[name=checktag]").prop("checked",!1).parent().removeClass("checked"),$(".checked-tags").empty(),$("#companyList,#followList,#countryList").val("0")}),$("#screen").unbind("click").on("click",function(){var t=$("#keyword").val(),a=$("input[name=checktag]:checked").val(),e="",s="",n=$("#companyList").val(),i=$("#followList option:selected").val(),r=$("#position").val(),o=$("#countryList").val();if($(".checkstar").find("input[type=checkbox]:checked").length>0)if(1==$("#inlineCheckbox").prop("checked"))e="1,2,3,4,5,";else for(var l=0;l<$(".checkstar").find("input[type=checkbox]:checked").length;l++)e+=$(".checkstar").find("input[type=checkbox]:checked").eq(l).val()+",";var d=e.substring(0,e.length-1);if($(".checked-tags").children("span.tag-cont").length>0)for(var l=0;l<$(".checked-tags").children("span.tag-cont").length;l++)s+=$(".checked-tags").children("span.tag-cont").eq(l).attr("data-id")+",";else s+="0";var p=s.substring(0,s.length-1);""!=d&&(v.starLevels=d),""!=p&&(v.containsTags=a?a:1,v.tagIds=p),""!=n&&0!=n&&(v.customerId=n),""!=i&&0!=i&&(v.followUpUser=i),v.conditions=[];var u="";""!=t&&(u={filedName:"name",operateType:"like",filedValue:t},v.conditions.push(u)),""!=r&&(u={filedName:"position",operateType:"like",filedValue:r},v.conditions.push(u)),""!=o&&0!=o&&(u={filedName:"countries",operateType:"=",filedValue:o},v.conditions.push(u)),v.currentPage=1,c(JSON.stringify(v))}),$("#conFilter").on("click",".label-list li",function(){$(this).addClass("active").siblings("li").removeClass("active"),v.currentPage=1;var t=$(this).attr("data-value"),a=JSON.stringify(v),e='[{"filedName":"tagId","operateType":"=","filedValue":"'+t+'"}]',s=a.substring(0,a.length-1)+',"conditions":'+e+"}";l(s)}),$("#btn-dels").on("click",function(){var t=0;if($(".page_info .table tbody td input[type=checkbox]:checked").each(function(){var a=$(this).parents("tr").attr("data-highSeas");1==a&&($.Alert($(this).parents("tr").find(".sortsName span").text()+"是公海联系人,您不能删除"),t=1)}),1!=t){var a=e(),s="delete",n={ids:a,setType:s};n=JSON.stringify(n),$.Confirm("确认删除？","",function(){$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/set",type:"POST",dataType:"json",data:{data:n},success:function(t){return t.success?($(".m_batch").stop().animate({left:"-100%"},function(){$(this).removeClass("active")}),$.Alert("删除成功！"),void m.filter()):void $.unLogin(t)}})})}}),$(".table thead th").on("click",function(){var t=$(this),a=$(".table:first tbody tr");"sortsName"==t.attr("id")?t.find(".s-updownBg").hasClass("s-reorderList")?(t.find(".s-updownBg").removeClass("s-reorderList").addClass("s-orderList"),a=a.sort(function(t,a){return $(t).find(".s-special").text().localeCompare($(a).find(".s-special").text())})):(t.find(".s-updownBg").addClass("s-reorderList").removeClass("s-orderList"),a=a.sort(function(t,a){return $(a).find(".s-special").text().localeCompare($(t).find(".s-special").text())})):"sortsTime"==t.attr("id")?t.hasClass("up")?(t.find(".s-updownBg").addClass("s-reorderList").removeClass("s-orderList"),t.removeClass("up"),a=a.sort(function(t,a){return new Date($(t).find(".sortsTime").text()).getTime()-new Date($(a).find(".sortsTime").text()).getTime()})):(t.find(".s-updownBg").addClass("s-orderList").removeClass("s-reorderList"),t.addClass("up"),a=a.sort(function(t,a){return new Date($(a).find(".sortsTime").text()).getTime()-new Date($(t).find(".sortsTime").text()).getTime()})):"sortsStar"==$(this).attr("id")&&(t.hasClass("up")?(t.find(".s-updownBg").addClass("s-orderList").removeClass("s-reorderList"),t.removeClass("up"),a=a.sort(function(t,a){return $(a).find(".starLevelOp .s-star3").length-$(t).find(".starLevelOp .s-star3").length})):(t.find(".s-updownBg").addClass("s-reorderList").removeClass("s-orderList"),t.addClass("up"),a=a.sort(function(t,a){return $(t).find(".starLevelOp .s-star3").length-$(a).find(".starLevelOp .s-star3").length}))),$(".table:first tbody").empty().append(a)}),$(document).on("click","tbody tr td",function(){var t=$(this).find("div.checker");1!=t.length&&$(this).parent().find(".sortsName a").click()}),m.filter(),s(),i()})});