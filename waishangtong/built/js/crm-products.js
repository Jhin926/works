require(["common"],function(){require(["maintab","blockUI","datetimepickerCN"],function(t){var e=top.funcList;$("[data-code1]").each(function(){for(var t=0;t<e.length;t++)e[t].code!=$(this).attr("data-code1")&&e[t].code!=$(this).attr("data-code2")||$(this).removeClass("none")}),jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({language:"zh-CN",todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,format:"yyyy-mm-dd",bootcssVer:3}),t.init(),$(".r-titles").hide();var a=$(".page-content"),i=$("#filterModal");a.on("click",".m_batch>button",function(e){$.EventFn(e);var a=$(this).attr("data-type");if("group"==a)$.modalsFn($("#groupsModal"));else if("dels"==a)$.modalsFn($("#delsModal"),$(this));else if("recover"==a){var i=s.getAllChecked().ids,n=JSON.stringify({ids:i});$.ajax({url:Base.sitUrl+"/api/product/v1/product/recovery?data="+n,success:function(t){return t.success?void location.reload():void $.unLogin(t,"恢复失败,")}})}else if("email"==a){var i=s.getAllChecked().ids,r="";if(i.length>=2)return void $.Alert("只能单个文件发送");for(var r="",o=0;o<i.length;o++)r+=i[o]+",";r=r.substring(0,r.length-1),t.showTab(Base.url+"/html/pop-email-new.html?showType=right&modelType=99&ids="+r+"&v="+window.ver,"新建邮件")}}),a.on("click",".mclose,#btn-del-no",function(t){$.EventFn(t),$(".modals").removeClass("active")}),$("#batchClose").on("mouseenter",function(){$(this).addClass("s-updownBg s-dels4").removeClass("fa fa-times")}),$("#batchClose").on("mouseleave",function(){$(this).addClass("fa fa-times").removeClass("s-updownBg s-dels4")}),a.on("mouseenter",".page_info .product-img",function(){var t=$(".page_info .product-img").index(this);$(".big_img").hide(),$(".big_img").eq(t).show()}).on("mouseleave",".page_info .product-img",function(){$(".big_img").hide()}),a.on("click",".u-group>ul>li",function(t){$.EventFn(t);var e=$(this).attr("data-id"),a=s.getAllChecked();s.groupFn(a.ids,e)}),a.on("click","#btn-del-ok",function(t){$.EventFn(t);var e=s.getAllChecked();s.deleteFn(e.ids)}),a.on("click","#proFilter>li",function(t){if($.EventFn(t),!$(this).hasClass("active")){var e=$(this).find("a").text();$(".r-titles>span.i_task").text(e),$(this).addClass("active").siblings("li").removeClass("active"),n.currentPage=1;var a=parseInt($(this).attr("data-id"));a==-1?($("#btn-groups").attr("disabled",!0),$("#btn-dels").attr("disabled",!0),$("#btn-email").attr("disabled",!0),$("#btn-recover").attr("disabled",!1)):($("#btn-groups").attr("disabled",!1),$("#btn-dels").attr("disabled",!1),$("#btn-email").attr("disabled",!1),$("#btn-recover").attr("disabled",!0)),s.filter({catelogName:a})}}),i.on("click","#reset",function(t){$("#proName").val(""),$("#proGroup").val(""),$("#proDateBeg").val(""),$("#proDateEnd").val(""),$("#proType").val("")}),i.on("click","#screen",function(t){n.currentPage=1;var e=$("#proName"),a=$("#proGroup"),i=$("#proDateBeg"),o=$("#proDateEnd"),l=$("#proType");""!=e.val()&&""!=$.trim(e.val())&&(r.name=e.val()),a.val()!=-1&&(r.catelogName=a.val()),l.val()!=-1&&(r.productType=l.val()),""!=i.val()&&""!=$.trim(i.val())&&(r.startDate=i.val()),""!=o.val()&&""!=$.trim(o.val())&&(r.endDate=o.val()),""==e.val()&&a.val()==-1&&l.val()==-1&&""==i.val()&&""==o.val()||s.filter(r),$("#filterModal").modal("hide")}),a.on("click",".page_info tbody>tr",function(e){$.EventFn(e),$(".big_img").hide();var a=parseInt($(this).find("input[name=batch]").attr("data-id"));isNaN(a)||t.showTab(Base.url+"/html/pop-product-detail.html?id="+a+"&v="+window.ver,"产品详情")}),a.on("click",".page_info thead>tr>th",function(t){$.EventFn(t);var e=$(this).index(),a=$.filterObj.list;if(4==e){var i=$(this).children("i");i.hasClass("s-orderList")?($.filterObj.type=1,i.removeClass("s-orderList").addClass("s-reorderList")):($.filterObj.type=0,i.removeClass("s-reorderList").addClass("s-orderList")),s.filterShow(a,$.filterObj.total)}}),a.on("input","#inputQuick",function(t){$.EventFn(t);for(var e=$(this).val(),a=$.filterObj.list,i=[],n=$.filterObj.total,r=0;r<a.length;r++)a[r].name.indexOf(e)!=-1&&i.push(a[r]);n=e?0:$.filterObj.total,s.filterShow(i,n)});var n={homepage:1,currentPage:1,lastpage:null,pageSize:20},r={},s={filter:function(t){var e={pageSize:n.pageSize,currentPage:n.currentPage};void 0!=t&&Object.keys(t).length>0&&($.extend(e,t),t.createTime&&(e.type=t.type||1)),$.ajax({url:Base.sitUrl+"/api/product/v1/product/list",data:e,type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data.results;$.filterObj.list=e,$.filterObj.total=t.data.totalItem,s.filterShow(e,t.data.totalItem)}})},filterShow:function(t,e){var a="";if(t.length>0){1==$.filterObj.type?t.sort(function(t,e){return new Date(t.updateTime).getTime()-new Date(e.updateTime).getTime()}):0==$.filterObj.type&&t.sort(function(t,e){return new Date(e.updateTime).getTime()-new Date(t.updateTime).getTime()});for(var i=0;i<t.length;i++){var o=t[i],l=o.productTradeInfoEnter,d="../images/user.jpg";if(o.pictures.length>0){var c=o.pictures[0].url,p="@58w";d=c.replace(p,"")}var u="未分组";o.catalogName&&o.catalogName.length>0&&(u=o.catalogName);var v="",f="",m="",g=0,h=0,b=0;if(o.fobPriceCurrencyName?(f=o.fobPriceCurrencyName,m=f.substr(f.lastIndexOf("<>")+2)):m="$",l&&l.fomPriceMin&&(g=l.fomPriceMin),l&&l.fomPriceMax&&(h=l.fomPriceMax),l&&l.minOrderQuantity&&(b=l.minOrderQuantity),o.name)if(v=o.name,v.length>=60)var y=v.substr(0,60)+"...";else var y=v;a+='<tr><td><div class="checker"><span><input name="batch" data-id="'+o.id+'" type="checkbox"></span></div></td>                            <td>                            <div class="product-img"><img src="'+d+'" alt="头像" />                            <div class="big_img"><img src="'+d+'" alt="头像" /></div>                            </div>                            <div class="product-survey" title="'+v+'">                            <p class="product-name">'+y+"</p>                            <div><span>编号:"+(o.productNo||"")+"</span><span>价格:$"+g+"-"+h+"</span><span>最小采购量:"+b+"</span></div></td>                            <td><span>"+u+"</span></td>                            <td><span>"+(o.typeName||"无品类")+'</span></td>                            <td style="position: relative;">                            <span class="sp-time">'+o.updateTime+'</span><span class="product-count" style="right: 70px;"><i class="s-menuBg s-menu10"></i><span>'+t[i].quotationCount+'</span></span><span class="product-count"><i class="s-updownBg s-pi"></i><span>'+t[i].piCount+"</span></span></td></tr>"}}else{var j='<div class="trNone"><div class="trnone-info"><img src="../images/empty-doc.png" alt="" /><p class="trnone-text">暂无产品</p></div><a href="pop-product-add.html" class="trnone-btn btn btn-primary" data-code1="product_add" data-code2="product_import" data-maintab></i><span>新建/导入产品</span></a></div>';$(".trNone").remove(),$(".page_info>table>tbody").empty(),$(".page_info>table").after(j)}""!=a&&($(".trNone").remove(),$(".page_info>table>tbody").empty(),$(".page_info>table>tbody").append(a)),$(".page_info>table>tbody img").error(function(){$(this).attr("src","../images/user.jpg")});var C=n.pageSize,T=Math.ceil(e/C);$.Page({total:e,_class:".page",nowNum:n.currentPage,allNum:T,callback:function(t,e){if(n.currentPage=parseInt(t),$("#proFilter li.active").length>0){var a=parseInt($("#proFilter li.active").attr("data-id"));s.filter({catelogName:a})}else r=={}?s.filter():s.filter(r)}})},getTypes:function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/type/list",type:"POST",dataType:"json",success:function(t){if(!t.success)return console.log(t),void $.unLogin(t);var e=t.data,a="";if(e.length>0){a='<option value="-1">请选择类型</option>';for(var i=0;i<e.length;i++)a+='<option value="'+e[i].id+'">'+e[i].name+"</option>";$("#proType").empty().append(a)}}})},getGroups:function(t,e){$.ajax({url:Base.sitUrl+"/api/product/v1/product/catelog/list",type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data,i="",n="",r='<li data-id="0"><a href="javascript:;" style="font-weight:bold;">全部产品</a></li><li data-id="0"><a href="javascript:;"style="font-weight:bold;">全部分组</a></li><li data-id="1"><a href="javascript:;">未分组</a></li>';if(e.length>0){i='<option value="-1">请选择分组</option>';for(var s=0;s<e.length;s++)i+='<option value="'+e[s].id+'">'+e[s].name+"</option>",n+='<li data-id="'+e[s].id+'">'+e[s].name+"</li>",r+='<li data-id="'+e[s].id+'"><a href="javascript:;">'+e[s].name+"</a></li>";r+='<li data-id="-1" class="btn_delete"><a href="javascript:;" style="font-weight:bold;">已删除</a></li>',a.find("#proGroup,.u-group>ul").empty(),$("#proGroup").append(i),a.find(".u-group>ul").append(n),a.find("#proFilter").empty().append(r)}}})},addGroups:function(t){$.ajax({url:Base.sitUrl+"/api/product/v1/product/catelog/save",data:{data:JSON.stringify({name:t})},type:"POST",dataType:"json",success:function(t){return t.success?(a.find("#typeNames").val(""),a.find(".type-add").removeClass("active"),void s.getGroups()):void $.unLogin(t,"添加失败,")}})},deleteFn:function(t){$.ajax({url:Base.sitUrl+"/api/product/v1/product/delete",data:{id:t.join(";")},type:"POST",dataType:"json",success:function(t){return t.success?($(".modals").removeClass("active"),$(".m_batch").stop().animate({left:"-100%"},function(){$(this).removeClass("active")}),void s.filter()):void $.unLogin(t,"删除失败,")}})},groupFn:function(t,e){$.ajax({url:Base.sitUrl+"/api/product/v1/product/catelog/edit",data:{id:t.join(";"),productCatelog:e},type:"POST",dataType:"json",success:function(t){return t.success?($(".modals").removeClass("active"),$(".m_batch").stop().animate({left:"-100%"},function(){$(this).removeClass("active")}),void s.filter()):void $.unLogin(t,"分组失败,")}})},getAllChecked:function(){var t={ids:[]};return $("input[name=batch]:checked").each(function(){var e=$(this).attr("data-id");t.ids.push(parseInt(e))}),t}};s.filter(),s.getGroups(),s.getTypes()})});