require(["common"],function(){require(["maintab","blockUI","datetimepickerCN"],function(t){function e(t){var e={};e.status=t,s.currentPage=1,r.filter(e)}function a(t){return null==t?"":t}function i(){var t="";return $(".page_info .table tbody td input[type=checkbox]:checked").each(function(){var e=$(this).attr("data-id");t+=e+";"}),t=t.substring(0,t.length-1)}var n=top.funcList;$("[data-code]").each(function(){for(var t=0;t<n.length;t++)n[t].code==$(this).attr("data-code")&&$(this).removeClass("none")}),t.init(),$(".r-titles").hide(),jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({format:"yyyy-mm-dd hh:ii",todayBtn:!0,language:"zh-CN",pickerPosition:"bottom-right",autoclose:!0});var s=($(".page-content"),{homepage:1,currentPage:1,lastpage:null,pageSize:20});$("#taskType li").on("click",function(){$(this).addClass("active"),$(this).siblings().removeClass("active");var t=$(this).attr("data-value");e(t)}),$("#batchClose").on("mouseenter",function(){$(this).addClass("s-updownBg s-dels4").removeClass("fa fa-times")}),$("#batchClose").on("mouseleave",function(){$(this).addClass("fa fa-times").removeClass("s-updownBg s-dels4")});var r={filter:function(t){var e=s;"object"==typeof t&&(e=$.extend({},s,t)),$.ajax({url:Base.sitUrl+"/api/task/v1/task/list",type:"POST",dataType:"json",data:e,beforeSend:function(t){$.BlockUI()},complete:function(t,e){$.UnblockUI()},success:function(e){if(!e.success)return void $.unLogin(e);var i=e.data.results,n="";if(i.length>0){for(var o=0;o<i.length;o++){var l=(new Date(i[o].createTime).format("yyyy-MM-dd hh:mm:ss"),""),d="",c="",u="",m="";1==i[o].status?(l="未完成",d="none",c="inline-block"):2==i[o].status?(l="已超时",d="none",c="inline-block"):3==i[o].status?(l="已完成",d="inline-block",c="none",u="<del>",m="</del>"):(l="未知",d="none",c="inline-block"),""!==i[o].executionTime&&null!==i[o].executionTime&&($.GetLength(i[o].executionTime)>26?i[o].executionTime=i[o].executionTime.substring(0,12)+"...":i[o].executionTime=i[o].executionTime),""!==i[o].name&&null!==i[o].name&&(i[o].name.length>26?i[o].name=i[o].name.substring(0,23)+"...":i[o].name=i[o].name),""!==i[o].customerName&&null!==i[o].customerName&&i[o].customerName.length>20&&(i[o].customerName=i[o].customerName.substring(0,19)+"..."),""!==i[o].principalName&&null!==i[o].principalName&&i[o].principalName.length>20&&(i[o].principalName=i[o].principalName.substring(0,19)+"..."),n+='<tr data-id="'+i[o].id+'"><td><div class="checker"><span><input name="batch" type="checkbox" data-id="'+i[o].id+'"></span></div></td><td><label><i class="complete" style="display:'+d+'"></i><span class="overtime" style="display:'+c+'"></span></label> <label class="executionTime createTime">'+u+i[o].executionTime+m+'</label></td><td><a href="pop-detail.html?taskId='+i[o].id+"&v="+window.ver+'" data-maintab><label class="description">'+u+a(i[o].name)+m+'</label></a></td><td><label class="customerName">'+a(i[o].customerName)+'</label></td><td><label class="principalName">'+a(i[o].principalName)+'</label></td><td><label class="status">'+l+"</label></td></tr>"}$(".page_info>table>tbody").empty().append(n);var p=e.data.totalItem,v=s.pageSize,f=Math.ceil(p/v);s.lastpage=f,$.Page({total:p,_class:".page",nowNum:s.currentPage,allNum:f,callback:function(e,a){s.currentPage=e,r.filter(t)}})}else{var b='<div class="trNone"><div class="trnone-info"><img src="../images/empty-task.png" alt="" /><p class="trnone-text">暂无任务</p></div><a href="pop-task.html" class="trnone-btn btn btn-primary" data-code="task_add" data-maintab></i><span>创建任务</span></a></div>';$(".page_info>table").after(b)}}})}};r.filter(),$.ajax({url:Base.sitUrl+"/api/customer/v1/underling/customer",type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.Alert(t.message);for(var e=t.data,a="",i="",n=0;n<e.length;n++)a+='<option data-id="'+e[n].id+'">'+e[n].name+"</option>",i+='<li data-id="'+e[n].id+'">'+e[n].name+"</li>";var s='<option data-id="">请选择负责人</option>';$("#headName").empty(),$("#headName").append(s),$("#headName").append(a),$(".modal-body>ul").empty().append(i)}}),$("#btn-underling").on("click",function(t){$(this).hasClass("on")&&($.EventFn(t),r.filter(),$("#btn-underling-pop").hide(),$(this).removeClass("on").attr({"data-toggle":"modal","data-target":"#myModal"}))}),$(".modal-body>ul").on("click",">li",function(){var t=$(this).attr("data-id"),e=$(this).text();$("#btn-underling").attr({"data-toggle":"","data-target":""}).addClass("on"),$("#btn-underling-pop").text(e).attr("data-id",t).show(),$("#underling-close").click();var a=$.extend({},s,{id:t});r.filter(a)}),$("#targetName").on("keyup",function(){if(13==event.keyCode){var t={customerName:$("#targetName").val()};s.currentPage=1,r.filter(t)}}),$("#taskStatus").on("click",function(){var t=$(this).val();e(t)}),$("#headName").unbind("change").on("change",function(){var t=$(this).val();"请选择负责人"==t&&(t="");var e={};e.principalName=t,s.currentPage=1,r.filter(e)}),$("#timeNumTask,#timeListTask").on("change",function(){var t={};t.executionTime=$("#timeNumTask").val(),t.executionType=$("#timeListTask option:selected").val(),s.currentPage=1,r.filter(t)}),$("#timeNum,#timeList").on("change",function(){var t={};t.createTime=$("#timeNum").val(),t.type=$("#timeList option:selected").val(),s.currentPage=1,r.filter(t)}),$("#inputQuick,#taskName").on("keyup",function(){var t=$("#inputQuick").val()||$("#taskName").val();if("none"!=$("#btn-underling-pop").css("display")&&(s.id=id),13==event.keyCode){var e={};e.name=t,s.currentPage=1,r.filter(e)}}),$("#del").on("click",function(){var t=i();""==t?$.Alert("请选择删除对象!"):$.Confirm("确认删除？","",function(){$.ajax({url:Base.sitUrl+"/api/task/v1/task/delete",type:"POST",dataType:"json",data:{ids:t},success:function(t){return t.success?void $(".page_info .table tbody td input[type=checkbox]:checked").each(function(){$(this).parents("tr").remove()}):void $.Alert(t.message)}})})}),$(document).on("click",".overtime",function(t){$.EventFn(t);var e=$(this).parents("tr").attr("data-id");$.ajax({url:Base.sitUrl+"/api/task/v1/task/sign",type:"POST",dataType:"json",data:{id:e,status:3},success:function(t){return t.success?void r.filter():void $.unLogin(t)}})}),$(document).on("click",".complete",function(t){$.EventFn(t);var e=$(this).parents("tr").attr("data-id");$.ajax({url:Base.sitUrl+"/api/task/v1/task/sign",type:"POST",dataType:"json",data:{id:e,status:1},success:function(t){return t.success?void r.filter():void $.unLogin(t)}})}),$("#tag").on("click",function(){$("#tags").addClass("active"),$("#tags").siblings(".modals").removeClass("active")}),$("#selTag").on("click",">li",function(){var t=$(this).attr("data-value"),e=i();""==e?$.Alert("请选择人员"):$.ajax({url:Base.sitUrl+"/api/task/v1/task/sign",type:"POST",dataType:"json",data:{id:e,status:t},success:function(t){return t.success?($("#tags").removeClass("active"),$("#uniform-all").find("span").removeClass("checked"),$("#uniform-all").find("input[type=checkbox]").attr("checked",!1),void r.filter()):void $.unLogin(t)}})}),$(".mclose,#btn-del-no").on("click",function(){$(this).closest(".modals").removeClass("active"),headArr=[],headObj={},$("#distrib").val(""),$("#btn-distrib").hide()}),$(".btn-group .btn").on("click",function(){$(this).removeClass("active"),$(this).siblings().addClass("active")}),$(document).on("click","tbody tr td",function(){var t=$(this).find("div.checker");1!=t.length&&$(this).parent().find(".description").click()}),$("#sortsTime").on("click",function(){for(var t=new Array,e=$(".table tbody tr"),a="",i=0;i<e.length;i++){var n=$(".table tbody tr").eq(i).find(".createTime").text(),s=Date.parse(n);a+=s+$(".table tbody tr").eq(i).attr("data-id")+","}a=a.substring(0,a.length-1),t=a.split(","),t=t.sort(function(t,e){return t-e});var r;if("sortsTime"==$(this).attr("id"))if($("#sortsTime").find(".s-orderList").addClass("s-reorderList"),$("#sortsTime").find(".s-reorderList").removeClass("s-orderList"),"up"==$("#sortsTime").attr("class")){$("#sortsTime").find(".s-reorderList").addClass("s-orderList"),$("#sortsTime").find(".s-orderList").removeClass("s-reorderList"),$("#sortsTime").removeClass("up");for(var i=0;i<e.length;i++)for(var o=0;o<e.length;o++){var l=t[i].substring(13,t[i].length);$(".table tbody tr").eq(o).attr("data-id")==l&&(r+='<tr data-id="'+$(".table tbody tr").eq(o).attr("data-id")+'">'+$(".table tbody tr").eq(o).html()+"</tr>")}$(".table tbody").empty().append(r)}else if(""==$("#sortsTime").attr("class")||void 0==$("#sortsTime").attr("class")){$("#sortsTime").addClass("up");for(var d=e.length,i=0;i<d;i++)for(var o=0;o<d;o++){var c=d-i,l=t[c-1].substring(13,t[c-1].length);$(".table tbody tr").eq(o).attr("data-id")==l&&(r+='<tr data-id="'+$(".table tbody tr").eq(o).attr("data-id")+'">'+$(".table tbody tr").eq(o).html()+"</tr>")}$(".table tbody").empty().append(r)}}),$("#taskList").bind("click",function(){window.location.href=Base.url+"/html/crm-task.html?&v="+window.ver}),$("#taskCalendar").bind("click",function(){window.location.href=Base.url+"/html/pop-task-calendar.html?&v="+window.ver})})});