require(["common"],function(){require(["maintab","blockUI","selectPick"],function(e){function n(e){return null==e?"":e}function i(){var e=echarts.init(document.getElementById("sales")),t=echarts.init(document.getElementById("dev"));$.ajax({url:Base.sitUrl+"/api/home/v1/edm/situation",type:"GET",dataType:"json",beforeSend:function(e){$.BlockUI()},complete:function(e,t){$.UnblockUI()},success:function(e){if(!e.success)return void $.unLogin(e);var n=e.data;if(n.sendNum<1){var i='<img src="../images/edmNone.png" style="position:absolute;margin-left:-76px;margin-top:-76px;top:50%;left:50%">';$("#dev").empty(),$("#dev").append(i)}else{var a={tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c}"},legend:{top:10,data:["营销发送条数","营销送达条数","营销"]},calculable:!0,series:[{name:"漏斗图",type:"funnel",top:60,bottom:60,width:"80%",min:0,max:n.sendNum,minSize:"1%",maxSize:"80%",sort:"descending",gap:2,label:{normal:{show:!0,position:"left"},emphasis:{textStyle:{fontSize:20}}},labelLine:{normal:{length:10,lineStyle:{width:1,type:"solid"}}},itemStyle:{normal:{borderColor:"#fff",borderWidth:1}},data:[{value:n.openNum,name:"营销打开条数"},{value:n.deliveryNum,name:"营销送达条数"},{value:n.sendNum,name:"营销发送条数"}]}]};t.setOption(a)}}}),$.ajax({url:Base.sitUrl+"/api/home/v1/sales/funnel",type:"GET",dataType:"json",beforeSend:function(e){$.BlockUI()},complete:function(e,t){$.UnblockUI()},success:function(t){if(!t.success)return void $.unLogin(t);var i=t.data;if(i.length<1){var a='<img src="../images/statusNone.png" style="position:absolute;margin-left:-76px;margin-top:-76px;top:50%;left:50%">';$("#sales").empty(),$("#sales").append(a)}else{for(var o=new Array,s=new Array,c=new Array,l=0;l<i.length;l++){var r={value:i[l].num,name:n(i[l].name)},d=i[l].num;s.push(d),c.push(r),o.push(name)}var u=Math.max.apply(null,s),m={tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c}"},legend:{top:10,data:o},calculable:!0,series:[{name:"漏斗图",type:"funnel",top:60,bottom:60,width:"72%",min:0,max:u,minSize:"1%",maxSize:"80%",sort:"descending",gap:2,label:{normal:{show:!0,position:"left"},emphasis:{textStyle:{fontSize:20}}},labelLine:{normal:{length:20,lineStyle:{width:1,type:"solid"}}},itemStyle:{normal:{borderColor:"#fff",borderWidth:1}},data:c}]};e.setOption(m)}}})}function a(){$.ajax({url:Base.sitUrl+"/api/home/v1/pending/task/list",type:"GET",dataType:"json",beforeSend:function(e){$.BlockUI()},complete:function(e,t){$.UnblockUI()},success:function(e){if(!e.success)return void $.unLogin(e);var t,i=e.data,a="";if(t=i.length>5?6:i.length,i.length<1){var o='<img src="../images/taskNone.png" style="position:absolute;margin-left:-76px;margin-top:-76px;top:50%;left:50%">';$("#task").empty(),$("#task").append(o)}else{for(var s=0;s<t;s++)a+='<li data-id="'+i[s].id+'"><div class="contLeft"><i class="clock"></i><span>'+i[s].executionTime+'</span></div><div class="contRight"><p>'+n(i[s].name)+'</p><a style="width:100%">'+n(i[s].description)+"</a></div></li>";$("#task").empty(),$("#task").append(a)}}})}function o(){$.ajax({url:Base.sitUrl+"/api/home/v1/new/customer/dynamics",type:"GET",dataType:"json",beforeSend:function(e){$.BlockUI()},complete:function(e,t){$.UnblockUI()},success:function(e){if(!e.success)return void $.unLogin(e);var t,i=e.data,a="";if(t=i.length>5?6:i.length,i.length<1){var o='<img src="../images/custNone.png" style="position:absolute;margin-left:-76px;margin-top:-76px;top:50%;left:50%">';$("#cust").empty().append(o)}else{for(var s=0;s<t;s++){if(""!==i[s].customerName&&null!==i[s].customerName)if(i[s].customerName.length>20)var c=i[s].customerName.substring(0,19)+"...";else var c=i[s].customerName;a+='<li data-contentType="'+i[s].contentType+'" data-customerId="'+i[s].customerId+'" data-contactId="'+i[s].customerContactsId+'" data-relationId="'+i[s].relationId+'"><div class="contLeft"><p class="blue" title="'+i[s].customerName+'">'+n(c)+'</p><p><i class="clock"></i><span>'+i[s].createTime+'</span></p></div><div class="contRight"><p><span>'+n(i[s].createUserName)+"</span>&nbsp;&nbsp;&nbsp;<span>"+n(i[s].relationName)+'</span></p><a class="blue">'+n(i[s].content)+"</a></div></li>"}$("#cust").empty(),$("#cust").append(a)}}})}function s(){$.ajax({url:Base.sitUrl+"/api/home/v1/new/customer",type:"GET",dataType:"json",beforeSend:function(e){$.BlockUI()},complete:function(e,t){$.UnblockUI()},success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data;$("#newCust").text(t.count),$("#newCustP").text(t.subCount)}})}function c(){$.ajax({url:Base.sitUrl+"/api/home/v1/new/contacts",type:"GET",dataType:"json",beforeSend:function(e){$.BlockUI()},complete:function(e,t){$.UnblockUI()},success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data;$("#newCon").text(t.count),$("#newConP").text(t.subCount)}})}function l(){$.ajax({url:Base.sitUrl+"/api/home/v1/new/email",type:"GET",dataType:"json",beforeSend:function(e){$.BlockUI()},complete:function(e,t){$.UnblockUI()},success:function(e){return e.success?void $("#newEmail").text(e.data):void $.unLogin(e)}})}function r(e){var t=new Date,n=t.getTime()+6e4*t.getTimezoneOffset()+60*Number(e)*6e4;t=new Date(n);var i=0,a=0,o=0,s="";return i=t.getFullYear(),a=t.getMonth()+1,o=t.getDate(),Hour=t.getHours(),Minute=t.getMinutes(),Second=t.getSeconds(),s+=i+"年",s+=a>=10?a+"月":"0"+a+"月",s+=o>=10?o+"日":"0"+o+"日"}function d(e){var n=new Date,i=n.getTime()+6e4*n.getTimezoneOffset()+60*Number(e)*6e4;n=new Date(i);var a=n.getHours(),o=n.getMinutes(),s=n.getSeconds();o=u(o),s=u(s),document.getElementById("newTime").innerHTML=a+":"+o+":"+s,t=setTimeout(function(){d(e)},500)}function u(e){return e<10&&(e="0"+e),e}function m(){new Date;$("#newDate").text(r(8))}$(".i-alert",parent.document).css("right","40px"),e.init(),$("#task").on("click",">li",function(){var t=$(this).attr("data-id"),n=$(this).find(".contRight").text();e.showTab(Base.sitUrl+"/html/pop-detail.html?taskId="+t,n)}),$("#cust").on("click",">li",function(){var t=$(this).attr("data-customerId");t>0&&e.showTab(Base.sitUrl+"/html/pop-customer-detail.html?id="+t,"客户详情")}),$(".card1").bind("click",function(){$(window.parent.document).find("#sideMenu").find("li").removeClass("active"),$(window.parent.document).find("#sideMenu").children("li").eq(3).addClass("active").find("li").eq(0).addClass("active"),window.location.href="/html/crm-customer.html?&v="+window.ver}),$(".card2").bind("click",function(){$(window.parent.document).find("#sideMenu").find("li").removeClass("active"),$(window.parent.document).find("#sideMenu").children("li").eq(3).addClass("active").find("li").eq(1).addClass("active"),window.location.href="/html/crm-contacts.html?&v="+window.ver}),$(".card3").bind("click",function(){$(window.parent.document).find("#sideMenu").find("li").removeClass("active"),$(window.parent.document).find("#sideMenu").children("li").eq(2).addClass("active").find("li").eq(1).addClass("active"),window.location.href="/html/email-inbox.html?&v="+window.ver}),$(".check-time").selectpick({container:"#check-time",onSelect:function(e,n){clearTimeout(t),d($(".check-time").val()),r($(".check-time").val())}}),s(),c(),l(),m(),a(),o(),i(),d(8)})});