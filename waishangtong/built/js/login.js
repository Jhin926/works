require(["common"],function(){require(["validationLang","cookiehandle","setpassword","rsa"],function(e,t,a){function n(e,t){$.AjaxFun({data:{_mt:"userSecurity_sendMsgCode",content:e,dictMsgCodeType:t},success:function(e){e.success||$.Alert(e.message)}})}function o(e,t){0==g?(e.prop("disabled",!1),t.removeClass("active").text(60),g=60):(e.prop("disabled",!0),t.addClass("active").text(g),g--,setTimeout(function(){o(e,t)},1e3))}var s=$("#loginBtn"),i=$("#loginFrom"),r=i.find('[name="username"]'),l=i.find('[name="password"]');$("#rememberme");r.val("i-zhanggt@foxmail.com"),i.validate();var c=$("#kaptchaImage"),d=$(".changeCode");d.click(function(){c.hide().attr("src",Base.url+"/security/getKaptchaImage.jhtml?"+Math.floor(100*Math.random())).fadeIn(),event.cancelBubble=!0});var u=$("#sendCodeWrap"),m=u.find(".code-tips>b"),f=$('[name="imgcode"]'),p=$("#getPasswordForm"),v=p.find('[name="username"]'),h=p.find('[name="sendcode"]');u.on("click","button.btn",function(){var e=$(this).data("type"),t=0,a=$.trim($(this).closest("form").find('[name="username"]').val()),s=/^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/;return"find"==e?t=s.test(a)?2:3:"register"==e&&(t=s.test(a)?0:1),o($(this),m),n(a,t),!1});var g=60;p.validate({errorPlacement:function(e,t){e.appendTo(t.closest(".form-main"))}}),p.on("click","button:submit",function(){return p.valid()&&$.AjaxFun({data:{_mt:"user_forgetPasswordByFind",username:$.trim(v.val()),kaptcha:$.trim(f.val()),verifCode:$.trim(h.val())},success:function(e){e.success?(localStorage.verifCode=$.trim(h.val()),localStorage.username=$.trim(v.val()),location.href=Base.url+"/html/setpassword.html?&v="+window.ver):$.Alert(e.message)}}),!1});var b=localStorage.username||"未知用户";$(".data-accout").text(b);var k=$("#setPsdFrom"),x=($("#setPsdFrom").find('[name="newpsd"]'),$("#setPsdFrom").find('[name="renewpsd"]'),$("#setPsdBtn"));k.validate(),s.on("click",function(){var e=i,a=$(this);if(null!=e.attr("method")&&"post"==e.attr("method").toLowerCase()&&0==e.find("input[name='token']").size()){var n=t.getCookie("token");null!=n&&e.append('<input type="hidden" name="token" value="'+n+'" />')}return i.valid()&&(a.prop("disabled",!0).text("登录中..."),$.ajax({url:Base.sitUrl+"/api/user/v1/login",type:"POST",data:{email:$.trim(r.val()),password:l.val()},cache:!1,success:function(e){if(!e.success)return $.unLogin(e),void a.prop("disabled",!1).text("登录");var t=e.data;localStorage.setItem("__userInfo",t.name+";"+t.id+";"+t.isMaster),location.href=Base.builtUrl+"/main.html"}})),!1});var y=$("#registerFrom"),w=y.find('[name="username"]'),C=y.find('[name="imgcode"]'),j=y.find('[name="sendcode"]'),T=y.find('[name="newpsd"]'),P=y.find('[name="renewpsd"]'),B=y.find("button:submit");y.validate({errorPlacement:function(e,t){e.appendTo(t.closest(".form-main"))}}),B.on("click",function(){var e=($(this),$.trim(T.val())),t=$.trim(P.val());return y.valid()&&(x.prop("disabled",!0).text("正在提交..."),$.ajax({url:Base.sitUrl+"/security/public_key.jhtml",type:"GET",dataType:"json",cache:!1,success:function(a){var n=new RSAKey;n.setPublic(b64tohex(a.data.modulus),b64tohex(a.data.exponent));var o=hex2b64(n.encrypt(e));hex2b64(n.encrypt(t));$.ajax({url:Base.reqUrl,type:"POST",data:{_mt:"user_userRegister",username:$.trim(w.val()),password:o,reNewPwd:o,kaptcha:C.val(),verifCode:j.val(),dictUserClientType:1},dataType:"json",success:function(e){e.success?$.Alert(e.message,"",function(){y.find("input").val(""),B.prop("disabled",!1).text("提交"),location.href=Base.builtUrl+"/login.html?&v="+window.ver}):$.Alert(e.message,"",function(){B.prop("disabled",!1).text("提交")})}})}})),!1});var S={base:"/",locale:"zh_CN"};!function(e){e.checkLogin=function(){var t=!1;return e.ajax({url:S.base+"/login/check.jhtml",type:"GET",dataType:"json",cache:!1,success:function(e){t=e}}),t},e.redirectLogin=function(t,a){var n=S.base+"/login.jhtml";null!=t&&(n+="?redirectUrl="+encodeURIComponent(t)),null!=a?(e.message("warn",a),setTimeout(function(){location.href=n},1e3)):location.href=n},e(document).ajaxSend(function(e,a,n){if(!n.crossDomain&&null!=n.type&&"post"==n.type.toLowerCase()){var o=t.getCookie("token");null!=o&&a.setRequestHeader("token",o)}}),e(document).ajaxComplete(function(a,n,o){var s=n.getResponseHeader("loginStatus"),i=n.getResponseHeader("tokenStatus");if("accessDenied"==s){var r=S.base+"/login.jhtml";location.href=r}else if("accessDenied"==i){var l=t.getCookie("token");null!=l&&(e.extend(o,{global:!1,headers:{token:l}}),e.ajax(o))}})}(jQuery),$().ready(function(){$("form").submit(function(){console.log($(this));var e=$(this);if(null!=e.attr("method")&&"post"==e.attr("method").toLowerCase()&&0==e.find("input[name='token']").size()){var a=t.getCookie("token");null!=a&&e.append('<input type="hidden" name="token" value="'+a+'" />')}})})})});