require(["common"],function(){require(["maintab","blockUI","swfobject","web_socket"],function(maintab){function websocket(listener,url,group_id,user_id){null!=url&&""!=url||(url=defaultUrl),ws=new WebSocket(url),ws.onopen=function(){console.log("websocket onOpen : "+url)},ws.onmessage=function(e){var data=e.data,jsonObj=eval("("+e.data+")");if(1==jsonObj.type){var connectionId=jsonObj.data;void 0==user_id&&(user_id="");var uuid=generateUUID(),message='{"id":"'+uuid+'","type":1,"data":{"id":"'+connectionId+'","group_id":"'+group_id+'","user_id":"'+user_id+'"}}';ws.send(message)}else 2==jsonObj.type||100==jsonObj.type&&listener(jsonObj.data)},ws.onclose=function(){console.log("websocket onClose : "+url)},ws.onerror=function(){console.log("websocket onError : "+url)}}function send(e){var t=generateUUID(),i='{"id":"'+t+'","type":100,"data":"'+e+'"}';ws.send(i)}function generateUUID(){for(var e=[],t="0123456789abcdef",i=0;i<36;i++)e[i]=t.substr(Math.floor(16*Math.random()),1);e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-";var a=e.join("");return a}function tabActive(e){e.parent("li").hasClass("active")?e.parent("li").removeClass("active"):e.parent("li").addClass("active").siblings("li").removeClass("active")}function menuData(){var e;return $.ajax({url:Base.sitUrl+"/api/org/v1/org/right/menu/list",type:"GET",dataType:"json",async:!1,success:function(t){return t.success?void(e=t.data):void $.unLogin(t)}}),e}function output(str){var data=eval("("+str+")");if(data.inboxCount>0&&null!==data.inboxCount&&void 0!==data.inboxCount)for(var i=0;i<$(".sub-menu").find("a").length;i++)if("./email-inbox.html"==$(".sub-menu").find("a").eq(i).attr("data-href"))if($(".sub-menu").find("a").eq(i).find(".alertSocket").length>0){var num=parseInt($(".sub-menu").find("a").eq(i).find(".alertSocket").text())+data.inboxCount;$(".sub-menu").find("a").eq(i).find(".alertSocket").text(num)}else{var inboxCountHtml='<span class="alertSocket">'+data.inboxCount+"</span>";$(".sub-menu").find("a").eq(i).append(inboxCountHtml)}if(data.outboxCount>0&&null!==data.outboxCount&&void 0!==data.outboxCount)for(var i=0;i<$(".sub-menu").find("a").length;i++)if("./email-outbox.html"==$(".sub-menu").find("a").eq(i).attr("data-href"))if($(".sub-menu").find("a").eq(i).find(".alertSocket").length>0){var num=parseInt($(".sub-menu").find("a").eq(i).find(".alertSocket").text())+data.outboxCount;$(".sub-menu").find("a").eq(i).find(".alertSocket").text(num)}else{var outboxCountHtml='<span class="alertSocket">'+data.outboxCount+"</span>";$(".sub-menu").find("a").eq(i).append(outboxCountHtml)}}var socketId,socketVendorId;WEB_SOCKET_SWF_LOCATION="WebSocketMain.swf",WEB_SOCKET_DEBUG=!1;try{WebSocket.loadFlashPolicyFile("xmlsocket://"+host+":10843")}catch(e){}var host=window.location.host.split(":")[0],defaultUrl="ws://"+host+":8085/",ws,code=$.GetQueryString("code");code&&$.ajax({url:Base.sitUrl+"/api/facebook/auth/login",type:"POST",data:{code:code},success:function(e){!e.success}}),window.checkActive=function(e){for(var t,i=$("#sideMenu").find("a"),a=0;a<i.length;a++){var n=i.eq(a).attr("data-href");if(void 0!=n&&e.indexOf(n)>=0){t=i.eq(a),tabActive(t);break}}},$(document).on("click",".sub-menu>li>a,.side-footer-pop>li>a,.i-sidebar-menu>li>a",function(){$.disBlock();var e=$(this).attr("data-href"),t="",i=$(this);if(i.next("ul").length>0){tabActive(i);var a=$(".logo").outerHeight()+$("#sideMenu").outerHeight()+$("#sideFooter").outerHeight(),n=$(".i-sidebar").outerHeight();return a>=n?$(".side-footer").css("position","relative"):$(".side-footer").css("position","absolute"),!1}"./index.html"==e?t="./index.html?v="+window.ver:"./crm-task.html"==e?t="./crm-task.html?v="+window.ver:"./develop-letter.html"==e?t="./develop-letter.html?v="+window.ver:"./crm-customer.html"==e?t="./crm-customer.html?v="+window.ver:"./crm-contacts.html"==e?t="./crm-contacts.html?v="+window.ver:"../admin/bk-info.html"==e?t="./admin/bk-info.html?v="+window.ver:"../admin/bk-org.html"==e?t="./admin/bk-org.html?v="+window.ver:"../admin/bk-resource-set.html"==e?t="./admin/bk-resource-set.html?v="+window.ver:"../admin/bk-role-manage.html"==e?t="./admin/bk-role-manage.html?v="+window.ver:"../admin/bk-sales-set.html"==e?t="./admin/bk-sales-set.html?v="+window.ver:"./new-email.html"==e?t="./pop-email-new.html?v="+window.ver:"./email-inbox.html"==e?(t="./email-inbox.html?v="+window.ver,$(this).find(".alertSocket").remove()):"./email-outbox.html"==e?(t="./email-outbox.html?v="+window.ver,$(this).find(".alertSocket").remove()):t="./email-statistics.html"==e?"./email-statistics.html?v="+window.ver:"./email-trash.html"==e?"./email-trash.html?v="+window.ver:"./email-draft.html"==e?"./email-draft.html?v="+window.ver:"./crm-products.html"==e?"./crm-products.html?v="+window.ver:"./crm-quotation.html"==e?"./crm-quotation.html?v="+window.ver:"./crm-pi.html"==e?"./crm-pi.html?v="+window.ver:"./crm-order.html"==e?"./crm-order.html?v="+window.ver:"../statistics/underling.html"==e?"./statistics/underling.html?v="+window.ver:"./user-binding.html"==e?"./user-binding.html?v="+window.ver:"user-setting.html"==e?"./user-setting.html?v="+window.ver:"./statistics/underling.html"==e?"./statistics/underling.html?v="+window.ver:"./cloud/myCloud.html"==e?"./cloud/myCloud.html?v="+window.ver:"../cloud/myCloud.html"==e?"./cloud/myCloud.html?type=1&v="+window.ver:e+"?type=1&v="+window.ver;var s=$("#mainIframe").attr("src");s.indexOf("pop-email-new.html")>=0?$("#mainIframe")[0].contentWindow.window.saveDraft(t):($("#mainIframe").attr("src",t),tabActive(i))});var menuDataJson=menuData();$.menuPower=function(e){for(var t=menuDataJson,i=0,a=0;a<t.length;a++)t[a].permissionCode==e&&(i=1);return i};var menuObj={menuFn:function(e){for(var t=menuDataJson,i=new Array,a=new Array,n=0;n<t.length;n++)if("sendmail"!=t[n].permissionCode)if("inbox"!=t[n].permissionCode)if("outbox"!=t[n].permissionCode)if("emailaddress"!=t[n].permissionCode)if("emailtrash"!=t[n].permissionCode)if("emaildraft"!=t[n].permissionCode)if("customer"!=t[n].permissionCode)if("contact"!=t[n].permissionCode)if("task"!=t[n].permissionCode)if("product"!=t[n].permissionCode)if("quotation"!=t[n].permissionCode)if("pi"!=t[n].permissionCode)if("order"!=t[n].permissionCode)if("statistic"!=t[n].permissionCode)if("bindaccount"!=t[n].permissionCode)if("yunpan"!=t[n].permissionCode){if("approval"==t[n].permissionCode){var s={id:18,name:t[n].name,href:"./approval/view/approval.html",type:"工具"};i.push(s)}else if("foreigntrade"==t[n].permissionCode){var s={id:19,name:t[n].name,href:"./trade-tools/view/exchange-rate-list.html",type:"工具"};i.push(s)}else if("main"==t[n].permissionCode)var o='<li>                                            <a data-href="./index.html" href="javascript:;">                                                <i class="s-menuBg s-lgmenu"></i><span>首页</span>                                            </a>                                        </li>                                        ';else if("EDM"==t[n].permissionCode)var r='<li>                                            <a data-href="./develop-letter.html" href="javascript:;">                                                <i class="s-menuBg s-devLogo"></i><span>开发信</span>                                            </a>                                        </li>';else if("company"==t[n].permissionCode){var s={id:1,name:"企业资料",href:"../admin/bk-info.html"};a.push(s)}else if("resouce"==t[n].permissionCode){var s={id:4,name:"角色管理",href:"../admin/bk-role-manage.html"};a.push(s)}else if("organization"==t[n].permissionCode){var s={id:3,name:"组织架构",href:"../admin/bk-org.html"};a.push(s)}else if("role"==t[n].permissionCode){var s={id:2,name:"资源设置",href:"../admin/bk-resource-set.html"};a.push(s)}else if("EDMsetting"==t[n].permissionCode){var s={id:5,name:"营销分配",href:"../admin/bk-sales-set.html"};a.push(s)}else if("yunpan_bk"==t[n].permissionCode){var s={id:6,name:"网盘管理",href:"../cloud/myCloud.html"};a.push(s)}}else{var s={id:15,name:t[n].name,href:t[n].url,type:"工具"};i.push(s)}else{var s={id:14,name:t[n].name,href:t[n].url,type:"工具"};i.push(s)}else{var s={id:13,name:t[n].name,href:t[n].url,type:"工具"};i.push(s)}else{var s={id:12,name:t[n].name,href:t[n].url,type:"CRM"};i.push(s)}else{var s={id:11,name:t[n].name,href:t[n].url,type:"CRM"};i.push(s)}else{var s={id:10,name:t[n].name,href:t[n].url,type:"CRM"};i.push(s)}else{var s={id:9,name:t[n].name,href:t[n].url,type:"CRM"};i.push(s)}else{var s={id:8,name:t[n].name,href:t[n].url,type:"CRM"};i.push(s)}else{var s={id:7,name:t[n].name,href:t[n].url,type:"CRM"};i.push(s)}else{var s={id:6,name:t[n].name,href:t[n].url,type:"CRM"};i.push(s)}else{var s={id:17,name:t[n].name,href:t[n].url,type:"邮件"};i.push(s)}else{var s={id:16,name:t[n].name,href:t[n].url,type:"邮件"};i.push(s)}else{var s={id:5,name:t[n].name,href:t[n].url,type:"邮件"};i.push(s)}else{var s={id:3,name:t[n].name,href:t[n].url,type:"邮件"};i.push(s)}else{var s={id:2,name:t[n].name,href:t[n].url,type:"邮件"};i.push(s)}else{var s={id:1,name:t[n].name,href:"./new-email.html",type:"邮件"};i.push(s)}var l=[],d=localStorage.getItem("__currentPage"),m=localStorage.getItem("__userInfo"),u=0,c=-1;if(m&&(u=parseInt(m.substr(m.indexOf(";")+1)),c=parseInt(m.substr(m.lastIndexOf(";")+1))),d&&d.length>0&&$("#mainIframe").attr("src",d),e==-1&&1==c?($(".side-footer-pop").find("li").eq(0).remove(),$(".side-footer-pop").prepend('<li><a id="comeback" data-href="../admin/bk-info.html" href="javascript:;">企业后台</a></li>')):($(".side-footer-pop").find("li").eq(0).remove(),$(".side-footer-pop").prepend('<li><a id="comeback" data-href="../index.html" href="javascript:;">外贸通</a></li>')),location.pathname.indexOf("/activate.html")===-1){if(!m&&location.pathname.indexOf("/login.html")==-1)return void(parent.location.href=Base.builtUrl+"/login.html");if(e!=-1){l=a,h='<li class="active"><ul class="sub-menu" style="display: block;">';for(var n=0,f=l.length;n<f;n++)h+='<li><a data-href="'+l[n].href+'" href="javascript:;"><i class="s-menuBg s-admin'+l[n].id+'"></i><span>'+l[n].name+"</span></a></li>";h+="</ul></li>"}else{for(var l=i,p={},h=o+r,n=0;n<l.length;n++){var v=l[n];p[v.type]||(p[v.type]=[]),p[v.type].push(v)}for(var b in p){var g=p[b],n='<i class="s-menuBg s-lgmenu3"></i>';if("工具"==b?n='<i class="s-menuBg s-lgmenu4"></i>':"邮件"==b&&(n='<i class="s-menuBg s-lgmenu2"></i>'),0==g.length)h+='<li><a href="javascript:;">'+n+"<span>"+b+"</span></a></li>";else{for(var w="",C=0;C<g.length;C++)w+='<li><a data-href="'+g[C].href+'" href="javascript:;"><i class="s-menuBg s-menu'+g[C].id+'"></i><span>'+g[C].name+"</span></a></li>";h+="邮件"==b?'<li class="active"><a href="javascript:;">'+n+"<span>"+b+'</span><i class="s-menuBg s-menuUp"></i></a><ul class="sub-menu">'+w+"</ul></li>":'<li><a href="javascript:;">'+n+"<span>"+b+'</span><i class="s-menuBg s-menuUp"></i></a><ul class="sub-menu">'+w+"</ul></li>"}}}$("#sideMenu").empty().append(h)}}};menuObj.menuFn(-1);var $sideFooter=$("#sideFooter"),$sideFooterPop=$sideFooter.find(".side-footer-pop");$sideFooter.on("click","a.side-footer-btn",function(){$sideFooterPop.toggle()}),$sideFooter.on("click",".btn-loginout",function(e){e.preventDefault(),$.ajax({url:Base.sitUrl+"/api/user/v1/logout",type:"POST",success:function(e){return e.success?(location.href=Base.builtUrl+"/login.html?&v="+window.ver,localStorage.removeItem("__userInfo"),void localStorage.removeItem("__currentPage")):void $.unLogin(e,"退出失败,")}})}),$(".side-footer").on("click",".side-footer-pop>li>a",function(){"../admin/bk-info.html"==$(this).attr("data-href")?($("#mainIframe").attr("src","admin/bk-info.html"),menuObj.menuFn(1)):"../index.html"==$(this).attr("data-href")&&($("#mainIframe").attr("src","./index.html"),menuObj.menuFn(-1)),$sideFooterPop.hide()}),$.disNone=function(){$(".i-alert").hide()},$.disBlock=function(){$(".i-alert").show()},$.ajax({url:Base.sitUrl+"/api/user/v1/session",type:"POST",dataType:"json",async:!1,success:function(e){socketId=e.data.id,socketVendorId=e.data.vendorId;var t=e.data.name;if($.GetLength(t)>10&&(t=t.substring(0,7)+"..."),$("#pageLeftUserName").text(t).attr({title:e.data.name,"data-id":e.data.id,"data-admin":e.data.isAdmin}),escape(t).indexOf("%u")<0){var i=t.substring(0,2).toUpperCase();$(".useName").text(i)}else $(".useName").text(t.substring(0,1));var a=e.data.firstLogin;a&&$("#mainIframe").attr("src","./user-binding.html")}}),websocket(output,"ws://47.89.36.89:8085",socketVendorId,socketId),$.ajax({url:Base.sitUrl+"/api/org/v1/org/right/function/list",type:"GET",dataType:"json",success:function(e){return e.success?void(window.funcList=e.data):void $.unLogin(e)}})})});