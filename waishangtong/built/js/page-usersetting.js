require(["common"],function(){require(["setpassword","jqform"],function(e){var r=$(".page-content"),i=$(".user-forms");i.on("click","button",function(e){var r=$(this).attr("data-type"),s=i.find("#name"),t=!0;if("user"==r){if($.GetLength(s.val())>64)return void $.Alert("请输入小于64个字母或32个汉字的名称");var n={name:s.val()};t=$.errorsFn(s,s.attr("data-msg")),t&&a.editUserInfo(n)}else if("pwd"==r){var o=i.find("#pwd-old"),d=i.find("#pwd-new"),l=i.find("#pwd-re"),t=!0;if(t=$.errorsFn(o,o.attr("data-msg")),t=$.errorsFn(d,d.attr("data-msg")),t=$.errorsFn(l,l.attr("data-msg")),t=a.isAllowPwd(d),t=a.isAllowPwd(l),t&&a.isPwdConsistent()){var n={oldPassword:o.val(),newPassword:d.val(),newPasswordConfirm:l.val()};a.changePwd(n)}}}),i.on("blur",".box-input>input",function(e){$(this).attr("data-msg").length>0&&$.errorsFn($(this),$(this).attr("data-msg"))}),r.on("click",".user-box>ul>li",function(e){if($.EventFn(e),$(this).hasClass("active"))return!1;var s=$(this).children("i"),a=$(this).index(),t=s.prop("class");$(this).addClass("active").siblings("li").removeClass("active"),r.find(".user-box>ul>li").each(function(){var e=$(this).children("i"),r=e.prop("class");r.indexOf("2")!=-1&&(r=r.substr(0,r.length-1)),e.prop("class",r)}),t.indexOf(2)==-1&&s.prop("class",t+"2"),i.find(".errors").remove(),i.find(".box-input>input.error").each(function(){$(this).removeClass("error")}),i.find(".box-form").eq(a).addClass("active").siblings(".box-form").removeClass("active")}),i.on("change",".set-style>ul>li>input",function(){var e=$(this).prop("checked"),r=parseInt($(this).attr("data-id")),i=parseInt($(this).val()),s={subscribeId:i};e?a.setSubscribe(s,"add"):(s.id=r,a.setSubscribe(s,"del"))});var s=i.width()-$(".form-info>label").width();i.find(".box-input").width(s),$(window).resize(function(){var e=i.width()-$(".form-info>label").width()-20;i.find(".box-input").width(e)});var a={checkboxList:[{id:"c1",val:"1001",info:"别人给我分配了任务"},{id:"c2",val:"1002",info:"客户发送了新邮件"},{id:"c3",val:"1003",info:"任务超时"},{id:"c4",val:"1004",info:"公海客户有了新邮件"}],initCheckbox:function(){for(var e=a.checkboxList,r="",s=0;s<e.length;s++)r+='<li>                                <input type="checkbox" name="set-warn" id="'+e[s].id+'" value="'+e[s].val+'" />                                <label for="'+e[s].id+'">'+e[s].info+"</label>                            </li>";i.find(".set-style>ul").append(r)},getUserInfo:function(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/user/person/info",data:{data:JSON.stringify({})},type:"POST",dataType:"json",success:function(e){if(!e.success)return $.unLogin(e,"获取基本信息失败，"),!1;var r=e.data;i.find("#name").val(r.name||"匿名"),i.find("#department").val(r.departmentName||"默认部门"),i.find("#email").val(r.email||"未设置"),i.find("#role").val(r.roleName||"默认角色")}})},editUserInfo:function(e){$.ajax({url:Base.sitUrl+"/api/org/v1/org/user/person/info/edit",data:{data:JSON.stringify(e)},type:"POST",dataType:"json",success:function(e){return e.success?void $.Alert("编辑成功!"):($.unLogin(e,"编辑基本信息失败，"),!1)}})},changePwd:function(e){$.ajax({url:Base.sitUrl+"/api/org/v1/org/user/password/change",data:{data:JSON.stringify(e)},type:"POST",dataType:"json",success:function(e){return e.success?(i.find("form").eq(1)[0].reset(),void $.Alert("修改成功!")):($.unLogin(e,"修改密码失败，"),!1)}})},getSubscribeInfo:function(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/user/subscribe/list",data:{data:JSON.stringify({})},type:"POST",dataType:"json",success:function(e){if(!e.success)return $.unLogin(e,"查询用户订阅信息失败，"),!1;var r=e.data;r.length>0&&i.find(".set-style>ul>li").each(function(){for(var e=$(this).find("input"),i=0;i<r.length;i++)if(e.val()==r[i].subscribeId){e.attr("checked",!0),e.attr("data-id",r[i].id);break}})}})},setSubscribe:function(e,r){var i=Base.sitUrl;i+="add"==r?"/api/org/v1/org/user/subscribe/add":"/api/org/v1/org/user/subscribe/sub",$.ajax({url:i,data:{data:JSON.stringify(e)},type:"POST",dataType:"json",success:function(e){return e.success?void $.Alert("设置成功!"):($.unLogin(e,"设置失败，"),!1)}})},isPwdConsistent:function(){var e=!0,r=i.find("#pwd-new"),s=i.find("#pwd-re");return r.val()!=s.val()&&(0==s.next(".errors").length&&s.after('<div class="errors active"><span></span></div>'),s.addClass("error"),s.next(".errors").addClass("active").children("span").text("密码不一致"),e=!1),e},isAllowPwd:function(e){var r=!0,i=e.val();return i.length<6&&(0==e.next(".errors").length&&e.after('<div class="errors active"><span></span></div>'),e.addClass("error"),e.next(".errors").addClass("active").children("span").text("密码至少为6位"),r=!1),r}};a.initCheckbox(),a.getUserInfo(),a.getSubscribeInfo()})});