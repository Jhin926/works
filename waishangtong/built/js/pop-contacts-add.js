require(["common","countries"],function(){require(["blockUI","jqform","datetimepickerCN"],function(){function a(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/staff/defined/attribute/list",data:{data:JSON.stringify({bizType:2})},dataType:"json",type:"GET",success:function(a){if(!a.success)return void alert(a.message);for(var t=a.data,n=1,i=0;i<t.length;i++){var s=t[i],c="";1==s.removable&&(c=1==s.required?'<div class="form-groups c-add-list" data-isRequired="yes"><label for="c-add'+n+'"><i>*</i>'+s.name+'</label>                                <div class="form-input"><input type="text" name="c-add'+n+'" data-id="'+s.id+'" data-code="'+s.code+'" id="c-add'+n+'" class="input-style"></div><div class="clear"></div></div>':'<div class="form-groups c-add-list" data-isRequired="no"><label for="c-add'+n+'">'+s.name+'</label>                                <div class="form-input"><input type="text" name="c-add'+n+'" data-id="'+s.id+'" data-code="'+s.code+'" id="c-add'+n+'" class="input-style"></div><div class="clear"></div></div>',n++,$("#c-add").prepend(c))}e()}})}function t(){$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/assign/list",type:"POST",dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);for(var t=a.data,e="",n=0;n<t.length;n++)e+='<li data-id="'+t[n].id+'">'+t[n].name+"</li>";$("#c-cust").empty().append(e)}})}function e(){void 0!=l&&$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/detail",data:{data:JSON.stringify({id:l})},type:"POST",dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);$("#cust-add").text("保存");var t=a.data;$("#c-name").val(t.name||""),$("#c-email").val(t.email||""),$("#c-company").val(t.workingCompany||""),$("#c-phone").val(t.phone||""),$("#c-facebook").val(t.facebook||""),$("#c-position").val(t.position||""),$("#c-twitter").val(t.twitter||""),$("#c-linkin").val(t.linkedin||""),$("#c-birthday").val(t.birthday||""),$("#c-remark").val(t.remark||"");var e=t.contactDefinedValues;if(e.length>0)for(var n=$("#c-add"),i=0;i<e.length;i++){var s=e[i].attributeId,r=n.find("input[data-id="+s+"]");r.length>0&&r.val(e[i].value)}c=t.countries;for(var o=t.starLevel,d='<i class="s-updownBg s-star3"></i>',l=1;l<o;l++)d+='<i class="s-updownBg s-star3"></i>';for(var u=0;u<5-o;u++)d+='<i class="s-updownBg s-unstar2"></i>';$("#c-stars").empty().append(d)}})}function n(){void 0!=d&&$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/assign/list",type:"GET",dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);for(var t=a.data,e=0;e<t.length;e++)if(d==t[e].id){$("#c-company").val(t[e].name).attr("data-id",d);break}}})}function i(){$("#c-name").val(""),$("#c-email").val(o),$("#c-phone").val(""),$("#c-company").val(""),$("#c-facebook").val(""),$("#c-twitter").val(""),$("#c-linkedIn").val(""),$("#c-position").val(""),$("#c-remark").val(""),$("#c-birthday").val("");for(var e=countries,i='<option value="">请选择国家</option>',s=0;s<e.length;s++)i+=e[s].id==c?'<option selected value="'+e[s].id+'">'+e[s].cn+" - "+e[s].en+"</option>":'<option value="'+e[s].id+'">'+e[s].cn+" - "+e[s].en+"</option>";$("#c-country").empty().append(i),t(),a(),n()}function s(){var a=$("#c-company").attr("data-id"),t=$("#c-name").val(),e=$("#c-email").val(),n=$("#c-phone").val(),i=$("#c-company").val(),s=$("#c-facebook").val(),c=$("#c-twitter").val(),r=$("#c-linkin").val(),o=$("#c-position").val(),d=$("#c-remark").val(),u=$("#c-stars").find(".s-star3").length,v=$("#c-country").find("option:selected").val(),p=$("#c-birthday").val(),m={};void 0!=l&&(m.id=l,m.setType="edit"),m.customerId=a,m.name=t,m.email=e,m.position=o,m.workingCompany=i,m.phone=n,m.facebook=s,m.twitter=c,m.linkedIn=r,m.starLevel=parseInt(u),m.remark=d,m.countries=v,m.birthdayString=p;for(var f=[],y=0;y<$("#c-add input").length;y++)if(""!=$("#c-add input").eq(y).val()){var h={};h.attributeId=$("#c-add input").eq(y).attr("data-id"),h.code=$("#c-add input").eq(y).attr("data-code"),h.value=$("#c-add input").eq(y).val(),f.push(h)}return m.contactDefinedValues=f,m=JSON.stringify(m)}jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({format:"yyyy-mm-dd",todayBtn:!0,language:"zh-CN",pickerPosition:"bottom-right",autoclose:!0,minView:"month"});var c,r=$("#addCustForm"),o=$.GetQueryString("name"),d=$.GetQueryString("custId"),l=$.GetQueryString("id"),u=$.GetQueryString("type"),v=$.GetQueryString("index");r.on("click",".form-input>i",function(a){var t=$(this).parent().children("i");$(this).hasClass("s-unstar2")?p.goodFn(t,$(this).index()):p.nagativeFn(t,$(this).index())});var p={index:1,goodFn:function(a,t){for(var e=0;e<a.length;e++){if(e>t)return;a.eq(e).removeClass("s-unstar2").addClass("s-star3")}},nagativeFn:function(a,t){for(var e=0;e<a.length;e++)e>t?a.eq(e).removeClass("s-star3").addClass("s-unstar2"):a.eq(e).removeClass("s-unstar2").addClass("s-star3")},mFn:function(a){for(var t=a,e=0;e<t.length;e++)(e+1)%2==0&&t.eq(e).css("margin-right",0)}};$("#c-company").on("input",function(){$("#c-cust").parent().show();var a=$(this).val(),t=a.length;$(this).attr("data-id","");for(var e=$("#c-cust").find("li").length,n=0;n<e;n++){var i=$("#c-cust").find("li").eq(n).text(),s=i.substring(0,t);s!==a?$("#c-cust").find("li").eq(n).hide():$("#c-cust").find("li").eq(n).show()}}),$(document).on("click",function(a){$.EventFn(a),$("#c-cust").parent().hide()}),$("#c-company").on("click",function(a){$.EventFn(a),$("#c-cust").parent().show()}),$(document).on("click","#c-cust li",function(a){$.EventFn(a);var t=$(this).attr("data-id"),e=$(this).text();$("#c-company").val(e),$("#c-company").attr("data-id",t),$("#c-cust").parent().hide()}),i();var m=/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/;$("#c-email").on("change",function(){var a=$(this).val();m.test(a)?($(this).css("border","1px solid #ccc"),$(this).parent().next(".errorEmail").css("display","none")):($(this).css("border","1px solid red"),$(this).parent().next(".errorEmail").css("display","inline-block"))});$("#cust-add").on("click",function(){var a=s(),t=[];$("#addCustForm .form-groups").each(function(){"yes"==$(this).attr("data-isRequired")&&t.push($(this))});for(var e=0;e<t.length;e++)if(""==t[e].find("input:text").val())return void $.Alert("请填写必填项");void 0!=l?$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/set",data:{data:a},type:"POST",dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);var t=$("#mainTab",parent.document).find("currentClass").index();parent.$.reHtml(),parent.me.closeOne(t)}}):$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/save",type:"POST",dataType:"json",data:{data:a},success:function(a){if(!a.success)return void $.unLogin(a);if("customer"==u)$.Alert("创建成功！","",function(){var a=$("#mainTab",parent.document).find(".currentClass").index();parent.me.refresh2(v),parent.me.closeOne(a)});else{$.Alert("创建成功！");var t=$("#mainTab",parent.document).find(".currentClass").index();parent.$.reHtml(),parent.me.closeOne(t)}}})})})});