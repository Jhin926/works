require(["common"],function(){require(["blockUI","jqform","datetimepickerCN"],function(){function getCustomerById(){custId&&$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/detail",type:"POST",data:{data:JSON.stringify({id:custId})},dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);var t=a.data,e="",s='<i class="s-updownBg s-star2"></i>';e=t.contacts;var i=$(".status-current"),d='<label data-id="'+t.status+'" style="background-color: '+(t.statusColour||"#bbb")+';">'+(t.statusName||"无状态").substring(0,1)+'</label><span><i class="s-updownBg s-up"></i></span>';i.empty(),i.append(d),$("#f-name").val(t.name||""),$("#f-email").val(t.defaultEmail||""),$("#f-phone").val(t.phone||""),$("#f-facebook").val(t.facebook||""),$("#f-linkedIn").val(t.linkedin||""),$("#f-address").val(t.address||""),$("#f-remark").val(t.remark||""),$("#f-fax").val(t.faxes||""),$("#f-twitter").val(t.twitter||""),$("#f-page").val(t.homepage||""),$("#f-kinds").get(0).value=t.customerType,$("#f-group").get(0).value=t.customerGroupId,$("#f-country").get(0).value=t.countries,$("#f-main").val(t.mainProducts||""),$("#f-size").val(t.scale||0);for(var n="",l=0;l<t.customerTags.length;l++)n+='<span class="tag-cont" data-id="'+t.customerTags[l].tagId+'"><span class="mark ellipsis">'+t.customerTags[l].tagName+'</span><i class="close-icon"></i></span>';$("#f-tag .checked-tags").html(n);for(var r=1;r<t.starLevel;r++)s+='<i class="s-updownBg s-star2"></i>';for(r=0;r<5-t.starLevel;r++)s+='<i class="s-updownBg s-unstar2"></i>';$(".f-stars").empty().append(s);for(var l=0;l<e.length;l++)addContacts(e[l]);var o=t.customerDefinedValues;if(o.length>0)for(var c=$("#c-add"),l=0;l<o.length;l++){var u=o[l].attributeId;c.find("input[data-id="+u+"]").val(o[l].value)}other.data=t}})}function statusList(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/staff/customer/status/list",type:"POST",dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);var t=a.data,e="";$("#statuLabel").attr("data-id",t[0].id).css("backgroundColor",t[0].colour).text(t[0].name.substring(0,1));for(var s=0;s<t.length;s++){var i=t[s].name,i=i.substring(0,1);e+='<li data-id="'+t[s].id+'"><label style="background-color: '+t[s].colour+';" data-id="1">'+i+"</label></li>"}$("#statusList").empty().append(e)}})}function clientKinds(){$.ajax({url:Base.sitUrl+"/api/sys/v1/sys/dictionary/get",type:"POST",dataType:"json",data:{group:"customer.type"},success:function(a){if(!a.success)return void $.unLogin(a);for(var t=a.data,e="",s=0;s<t.length;s++)e+='<option value="'+t[s].id+'">'+t[s].value+"</option>";$("#f-kinds").empty().append(e)}})}function clientSource(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/staff/customer/source/list",type:"POST",dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);for(var t=a.data,e="",s=0;s<t.length;s++)e+='<option value="'+t[s].id+'">'+t[s].name+"</option>";$("#f-source").empty().append(e)}})}function clientTag(a){$.ajax({url:Base.sitUrl+"/api/user/v1/user/tag/list",type:"POST",dataType:"json",data:{tagType:a},success:function(t){if(!t.success)return void $.unLogin(t);if(1==a){for(var e=t.data,s="",i=0;i<e.length;i++)s+='<li data-id="'+e[i].id+'">'+e[i].name+"</li>";$(".tag-list").empty().append(s)}else contTags=t.data}})}function clientGroup(){$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/group/list",type:"POST",dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);for(var t=a.data,e="",s=0;s<t.length;s++)e+='<option value="'+t[s].id+'">'+t[s].name+"</option>";$("#f-group").empty().append(e)}})}function clientCountry(){$.ajax({url:Base.sitUrl+"/api/sys/v1/sys/countries/get",type:"POST",dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);for(var t=a.data,e="",s=0;s<t.length;s++)e+='<option value="'+t[s].id+'">'+t[s].cn+" - "+t[s].en+"</option>";var i='<option value="">请选择国家</option>';$("#f-country").empty().append(i).append(e),getCustomerById()}})}function addContacts(a){for(var t="",e="",s="",i=0;i<contTags.length;i++)s+='<li data-id="'+contTags[i].id+'">'+contTags[i].name+"</li>";$.ajax({url:Base.sitUrl+"/api/org/v1/org/staff/defined/attribute/list",data:{data:JSON.stringify({bizType:2})},dataType:"json",type:"GET"}).done(function(i){if(!i.success)return void alert(i.message);for(var d=i.data,n=1,l=0;l<d.length;l++){var r=d[l],o="";1==r.removable&&(o=1==r.required?'<div class="form-groups c-add-list"><label for="c-add'+n+'"><i>*</i>'+r.name+'</label>                                <div class="form-input"><input type="text" data-isRequired="yes" name="c-add'+n+'" data-id="'+r.id+'" data-code="'+r.code+'" id="c-add'+n+'" class="input-style"></div><div class="clear"></div></div>':'<div class="form-groups c-add-list"><label for="c-add'+n+'">'+r.name+'</label>                                <div class="form-input"><input type="text" data-isRequired="no" name="c-add'+n+'" data-id="'+r.id+'" data-code="'+r.code+'" id="c-add'+n+'" class="input-style"></div><div class="clear"></div></div>',n++,t+=o)}if(a){for(var c='<i class="s-updownBg s-star3"></i>',l=1;l<a.starLevel;l++)c+='<i class="s-updownBg s-star3"></i>';if(5-a.starLevel>0)for(var u=0;u<5-a.starLevel;u++)c+='<i class="s-updownBg s-unstar2"></i>';for(var v=a.customerContactTags,p="",l=0;l<v.length;l++)p+='<span class="tag-cont" data-id="'+v[l].id+'"><span class="mark ellipsis">'+v[l].tagName+'</span><i class="close-icon"></i></span>';var f="";f=0==a.sex?'<option value="0" selected>女</option><option value="1">男</option>':'<option value="0">女</option><option value="1" selected>男</option>';var m=$(".add-contact").length+1;e='<div class="add-contact" data-id="'+a.id+'">                    <div class="contact-title">                        <h4>联系人'+m+'</h4>                        <a href="javascript:;"><i class="s-updownBg s-dels5"></i><span>删除联系人</span></a>                        <div class="clear"></div>                    </div>                    <fieldset>                        <div class="form-groups">                            <label for="c-name'+other.index+'"><i>*</i>姓名</label>                            <div class="form-input">                                <input type="text" name="c-name'+other.index+'" class="c-name input-style" value="'+(a.name||"")+'">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-position'+other.index+'">职位</label>                            <div class="form-input">                                <input type="text" name="c-position'+other.index+'" class="c-position input-style" value="'+(a.position||"")+'">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-phone'+other.index+'">联系电话</label>                            <div class="form-input">                                <input type="text" name="c-phone'+other.index+'" class="c-phone input-style" value="'+(a.phone||"")+'">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-facebook'+other.index+'">Facebook</label>                            <div class="form-input">                                <input type="text" name="c-facebook'+other.index+'" class="c-facebook input-style" value="'+(a.facebook||"")+'">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-twitter'+other.index+'">Twitter</label>                            <div class="form-input">                                <input type="text" name="c-twitter'+other.index+'" class="c-twitter input-style" value="'+(a.twitter||"")+'">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-sex'+other.index+'">性别</label>                            <div class="form-input">                                <select type="text" name="c-sex" class="form-control">'+f+'            </select>                            </div>                            <div class="clear"></div>                        </div>                    </fieldset>                    <fieldset style="margin-right: 0px;">                        <div class="form-groups">                            <label for="c-email'+other.index+'"><i>*</i>邮箱</label>                            <div class="form-input">                                <input type="text" name="c-email'+other.index+'" class="c-email input-style" value="'+(a.email||"")+'">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label>星级</label>                            <div class="form-input">'+c+'</div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-birthday'+other.index+'">生日</label>                            <div class="form-input">                                <input type="text" name="c-birthday'+other.index+'" class="c-birthday input-style datetime-picker" value="'+(a.birthday||"")+'">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-linkin'+other.index+'">LinkedIn</label>                            <div class="form-input">                                <input type="text" name="c-linkin'+other.index+'" class="c-linkin input-style" value="'+(a.linkedin||"")+'">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-tag'+other.index+'">联系人标签</label>                            <div class="form-input">                                <div style="position: relative;">                                    <div class="checked-tags">'+p+'                                    </div>                                    <ul class="tag-list">'+s+'                                    </ul>                                </div>                            <div class="clear"></div>                        </div>                    </fieldset>                    <div class="clear"></div>                    <div class="form-other">                        <label for="f-remark">备注</label>                        <div class="form-input">                            <textarea name="f-remark" class="c-remark input-style">'+(a.remark||"")+'</textarea>                        </div>                        <div class="clear"></div>                    </div><div class="c-add">'+t+"</div></div>",other.index++,$(".box-add").append(e),$(".add-contact:last").find("input:first").focus();var g=a.contactDefinedValues;if(g.length>0)for(var h=$(".add-contact .c-add"),l=0;l<g.length;l++){var y=g[l].attributeId,b=h.find("input[data-id="+y+"]");b.length>0&&b.val(g[l].value)}}else{var m=$(".add-contact").length+1;e='<div class="add-contact" data-id="0">                    <div class="contact-title">                        <h4>联系人'+m+'</h4>                        <a href="javascript:;"><i class="s-updownBg s-dels5"></i><span>删除联系人</span></a>                        <div class="clear"></div>                    </div>                    <fieldset>                        <div class="form-groups">                            <label for="c-name'+other.index+'"><i>*</i>姓名</label>                            <div class="form-input">                                <input type="text" name="c-name'+other.index+'" class="c-name input-style">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-position'+other.index+'">职位</label>                            <div class="form-input">                                <input type="text" name="c-position'+other.index+'" class="c-position input-style">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-phone'+other.index+'">联系电话</label>                            <div class="form-input">                                <input type="text" name="c-phone'+other.index+'" class="c-phone input-style">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-facebook'+other.index+'">Facebook</label>                            <div class="form-input">                                <input type="text" name="c-facebook'+other.index+'" class="c-facebook input-style">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-twitter'+other.index+'">Twitter</label>                            <div class="form-input">                                <input type="text" name="c-twitter'+other.index+'" class="c-twitter input-style">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-sex'+other.index+'">性别</label>                            <div class="form-input">                                <select type="text" name="c-sex" class="form-control">                <option value="0">女</option>                <option value="1">男</option>            </select></div>                            <div class="clear"></div>                        </div>                    </fieldset>                    <fieldset style="margin-right: 0px;">                        <div class="form-groups">                            <label for="c-email'+other.index+'"><i>*</i>邮箱</label>                            <div class="form-input">                                <input type="text" name="c-email'+other.index+'" class="c-email input-style">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label>星级</label>                            <div class="form-input">                                <i class="s-updownBg s-star3"></i><i class="s-updownBg s-unstar2"></i><i class="s-updownBg s-unstar2"></i><i class="s-updownBg s-unstar2"></i><i class="s-updownBg s-unstar2"></i>                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-birthday'+other.index+'">生日</label>                            <div class="form-input">                                <input type="text" name="c-birthday'+other.index+'" class="c-birthday input-style datetime-picker">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-linkin'+other.index+'">LinkedIn</label>                            <div class="form-input">                                <input type="text" name="c-linkin'+other.index+'" class="c-linkin input-style">                            </div>                            <div class="clear"></div>                        </div>                        <div class="form-groups">                            <label for="c-tag'+other.index+'">联系人标签</label>                            <div class="form-input">                                <div style="position: relative;">                                    <div class="checked-tags">                                    </div>                                    <ul class="tag-list">'+s+'                                    </ul>                                </div>                            </div>                            <div class="clear"></div>                        </div>                    </fieldset>                    <div class="clear"></div>                    <div class="form-other">                        <label for="f-remark">备注</label>                        <div class="form-input">                            <textarea name="f-remark" class="c-remark input-style"></textarea>                        </div>                        <div class="clear"></div>                    </div><div class="c-add">'+t+"</div></div>",other.index++,$(".box-add").append(e),$(".add-contact:last").find("input:first").focus()}})}function start(){$("#f-name").val(""),$("#f-email").val(""),$("#f-phone").val(""),$("#f-fax").val(""),$("#f-facebook").val(""),$("#f-twitter").val(""),$("#f-linkedIn").val(""),$("#f-address").val(""),$("#f-page").val(""),$("#f-main").val(""),$("#f-remark").val(""),statusList(),clientKinds(),clientSource(),clientGroup(),clientCountry(),clientTag(1),clientTag(2)}function info(){for(var a=$("#f-name").val(),t=$("#f-email").val(),e=$("#f-phone").val(),s=$("#f-fax").val(),i=$("#f-facebook").val(),d=$("#f-twitter").val(),n=$("#f-linkedIn").val(),l=$("#f-address").val(),r=$("#f-page").val(),o=$("#f-main").val(),c=$("#f-remark").val(),u=$("fieldset .f-stars").find(".s-star2").length,v=$("#f-group").find("option:selected").val(),p=$("#f-source").find("option:selected").val(),f=$(".status-current").find("label").attr("data-id"),m=$("#f-kinds").find("option:selected").val(),g=$("#f-country").find("option:selected").val(),h=$("#f-size").val(),y="",b=$("#f-tag .tag-cont"),x=0;x<b.length;x++)y+=b.eq(x).attr("data-id")+",";y=y.substring(0,y.length-1);var k=[],C=!0;if($("#c-add input:text").each(function(){var a=$(this);if(""!=a.val()){var t={};t.attributeId=a.attr("data-id"),t.code=a.attr("data-code"),t.value=a.val(),k.push(t)}else if("yes"==a.attr("data-isRequired"))return $.Alert("请填写必填项目"),C=!1,!1}),!C)return!1;if(""==a)return void $.Alert("请填写必填项目");if($.GetLength(a)>64)return void $.Alert("名称须小于32个汉字或64个字母");var q={};return other.data&&(q=other.data,q.setType="edit",q.deleteContactIds=other.delIds.join(","),delete q.contacts),q.customerTagIds=y,q.name=a,q.defaultEmail=t,q.countries=g,q.facebook=i,q.twitter=d,q.linkedin=n,q.homepage=r,q.faxes=s,q.address=l,q.mainProducts=o,q.remark=c,q.phone=e,q.starLevel=u,q.customerGroupId=v,q.customerSource=p,q.status=f,q.customerType=m,q.customerDefinedValues=k,q.scale=h,q=JSON.stringify(q)}function addContact(){$add=$(".add-contact");for(var a="",t=0;t<$add.length;t++){for(var e=t+1,s=$add.eq(t).attr("data-id"),i=$add.eq(t).find(".c-name").val(),d=$add.eq(t).find(".c-email").val(),n=$add.eq(t).find(".c-phone").val(),l=$add.eq(t).find(".c-facebook").val(),r=$add.eq(t).find(".c-twitter").val(),o=$add.eq(t).find(".c-linkin").val(),c=$("#f-name").val(),u=$add.eq(t).find(".c-position").val(),v=$add.eq(t).find(".c-birthday").val(),p=$add.eq(t).find(".s-star3").length,f=$add.eq(t).find(".c-remark").val(),m=$("#f-country").find("option:selected").val(),g=$add.eq(t).find('select[name="c-sex"]').val(),h="",y=$(".checked-tags .tag-cont"),t=0;t<y.length;t++)h+=y.eq(t).attr("data-id")+",";h=h.substring(0,h.length-1);for(var b=$add.eq(t).find("input[name=short]").val()||"",x=$add.eq(t).find(".c-add input"),k=[],e=0;e<x.length;e++)if(""!=x.eq(e).val()){var C={};C.attributeId=x.eq(e).attr("data-id"),C.code=x.eq(e).attr("data-code"),C.value=x.eq(e).val(),k.push(C)}else if("yes"==x.eq(e).attr("data-isRequired")){isValid=!1;break}k=JSON.stringify(k),null!=custId&&""!=custId||(custId="0"),a+='{"id":"'+s+'","customerId":"'+custId+'","name":"'+i+'","email":"'+d+'","position":"'+u+'","workingCompany":"'+c+'","phone":"'+n+'","starLevel":'+p+',"birthdayString":"'+v+'","facebook":"'+l+'","twitter":"'+r+'","linkedin":"'+o+'","remark":"'+f+'","contactDefinedValues":'+k+',"countries":"'+m+'","sex":"'+g+'","shortName":"'+b+'","contactTagIds":"'+h+'"},'}return a="["+a.substring(0,a.length-1)+"]"}!function(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/staff/defined/attribute/list",data:{data:JSON.stringify({bizType:1})},dataType:"json",type:"GET",success:function(a){if(!a.success)return void alert(a.message);for(var t=a.data,e=1,s=0;s<t.length;s++){var i=t[s],d="";1==i.removable&&(d=1==i.required?'<div class="form-groups c-add-list"><label for="c-add'+e+'"><i>*</i>'+i.name+'</label><div class="form-input">                                    <input data-code="'+i.code+'" data-id="'+i.id+'" data-isRequired="yes" type="text" name="c-add'+e+'" id="c-add'+e+'" class="input-style" /></div><div class="clear"></div></div>':'<div class="form-groups c-add-list"><label for="c-add'+e+'">'+i.name+'</label><div class="form-input">                                    <input data-code="'+i.code+'" data-id="'+i.id+'" data-isRequired="no" type="text" name="c-add'+e+'" id="c-add'+e+'" class="input-style" /></div><div class="clear"></div></div>',e++,$("#c-add").prepend(d))}}})}(),$("body").on("focusin",".datetime-picker",function(){jQuery().datetimepicker&&$(this).datetimepicker({format:"yyyy-mm-dd",todayBtn:!0,language:"zh-CN",pickerPosition:"bottom-right",autoclose:!0,minView:"month"})});var custId=$.GetQueryString("id"),company=$.GetQueryString("company"),$addForm=$("#addCustForm"),contTags;$addForm.on("click",".form-input>i",function(a){var t=$(this).parent().children("i");$(this).hasClass("s-unstar2")?other.goodFn(t,$(this).index()):other.nagativeFn(t,$(this).index())}),$addForm.on("click",".status-list>.status-current>span",function(a){$.EventFn(a);var t=$(this).closest(".status-list"),e=t.children(".status-items");e.hasClass("active")?e.removeClass("active"):e.addClass("active")}),$(document).on("click",".status-list>.status-items>li",function(a){$.EventFn(a);var t=$(this).children().prop("outerHTML"),e=parseInt($(this).attr("data-id")),s=$(".status-current");t!=s.children("label").prop("outerHTML")&&(t+='<span><i class="s-updownBg s-up"></i></span>',s.empty(),s.append(t),s.find("label").attr("data-id",e),$("#statusList").removeClass("active"))}),$("#addCustForm").on("click",".checked-tags",function(){$(this).next().toggle()}),$("#addCustForm").on("click",".tag-list li",function(){var a=$(this);a.parent().hide();for(var t=a.parent().prev(".checked-tags").find(".tag-cont"),e=0;e<t.length;e++)if(a.attr("data-id")==t.eq(e).attr("data-id"))return;var s='<span class="tag-cont" data-id="'+$(this).attr("data-id")+'"><span class="mark ellipsis">'+$(this).text()+'</span><i class="close-icon"></i></span>';a.parent().prev(".checked-tags").append(s)}),$("#addCustForm").on("click",".checked-tags .mark",function(a){$.EventFn(a)}),$("#addCustForm").on("click",".checked-tags .close-icon",function(a){$.EventFn(a),$(this).parent().remove()}),$addForm.on("click",".contact-title>a",function(a){$.EventFn(a),$(this).closest(".add-contact").remove();for(var t=0;t<$(".add-contact").length;t++){var e=t+1;$(".add-contact").eq(t).find("h4").text("联系人"+e)}custId&&other.delIds.push($(this).closest(".add-contact").attr("data-id"))}),$addForm.on("click",".btn-contacts",function(a){$.EventFn(a),addContacts(null)});var other={data:null,delIds:[],index:1,goodFn:function(a,t){for(var e=0;e<a.length;e++){if(e>t)return;a.parents(".add-contact").length>0?a.eq(e).removeClass("s-unstar2").addClass("s-star3"):a.eq(e).removeClass("s-unstar2").addClass("s-star2")}},nagativeFn:function(a,t){for(var e=0;e<a.length;e++)e>t?a.parents(".add-contact").length>0?a.eq(e).removeClass("s-star3").addClass("s-unstar2"):a.eq(e).removeClass("s-star2").addClass("s-unstar2"):a.parents(".add-contact").length>0?a.eq(e).removeClass("s-unstar2").addClass("s-star3"):a.eq(e).removeClass("s-unstar2").addClass("s-star2")},mFn:function(a){for(var t=a,e=0;e<t.length;e++)(e+1)%2==0&&t.eq(e).css("margin-right",0)}};start();var data="";$("#cust-add").on("click",function(){for(var Info=info(),url=Base.sitUrl+"/api/customer/v1/customer/save",Contacts=addContact(),ContactsJson=eval("("+Contacts+")"),$add=$(".add-contact"),i=0;i<$add.length;i++)for(var getDefineds=$add.eq(i).find(".c-add input"),j=0;j<getDefineds.length;j++)if(""==getDefineds.eq(j).val()&&"yes"==getDefineds.eq(j).attr("data-isRequired"))return void $.Alert("请填写必填项目");for(var i=0;i<ContactsJson.length;i++){if(""==ContactsJson[i].name||""==ContactsJson[i].email)return void $.Alert("请填写必填项目");if($.GetLength(ContactsJson[i].name)>64)return void $.Alert("名称须小于32个汉字或64个字母")}var data=Info.substring(0,Info.length-1)+',"contacts":'+Contacts+"}";other.data&&(url=Base.sitUrl+"/api/customer/v1/customer/set"),$.ajax({url:url,type:"POST",dataType:"json",data:{data:data},success:function(a){a.success?parent.location.reload():$.unLogin(a)}})})})});