require(["common"],function(){require(["maintab","blockUI","jqform","ztree","bootstrap","angular","datetimepickerCN"],function(e){var t,a=parseInt($.GetQueryString("id")),s=$(".box-customer-detail"),i=s.find(".status-items"),n=s.find(".s-menus"),l=s.find("#groupsModal"),o=s.find("#delsModal"),d=s.find("#transfer"),r="";e.init();var c={pageSize:$.pageObj?$.pageObj.pageSize:8,currentPage:$.pageObj?$.pageObj.currentPage:1};jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({language:"zh-CN",todayBtn:1,autoclose:1,todayHighlight:1,format:"yyyy-mm-dd hh:ii",bootcssVer:3});var u=angular.module("All",[]);u.config(["$httpProvider",function(e){e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",e.defaults.transformRequest.unshift(function(e,t){var a,s=[];for(a in e)e.hasOwnProperty(a)&&s.push(encodeURIComponent(a)+"="+encodeURIComponent(e[a]));return s.join("&")})}]),u.controller("merge",["$scope","$http",function(u,p){function v(){p({method:"post",url:Base.sitUrl+"/api/customer/v1/customer/list/query",data:{data:JSON.stringify(u.pageObj)}}).success(function(e){if(!e.success)return void $.unLogin(e);u.customerList=e.data.results;var t=e.data.totalItem,a=Math.ceil(e.data.totalItem/e.data.pageSize);$.Page({total:t,_class:".customer-page",nowNum:u.pageObj.currentPage,allNum:a,callback:function(e,t){u.pageObj.currentPage=e,v()}})})}function m(e){return null==e?"":e}function f(e){$.ajax({url:Base.sitUrl+e,type:"POST",data:{keyword:t},success:function(e){var t=e.data,a="";if(t.length>5)var s=5;else var s=t.length;for(var i=0;i<s;i++)a+='<div class="the-same-as" data-fb="'+t[i].facebookId+'">                                    <img src="../images/user.jpg" alt="头像"/>                                    <span>'+t[i].name+'</span>                                    <label>                                        <i class="s-updownBg s-yes"></i>                                        <span>|</span>                                        <i class="s-updownBg s-no"></i>                                    </label>                                </div>';$("#sameorno").empty(),$("#sameorno").append(a)}})}function g(e,t){var a={customerId:e,type:t};$.ajax({url:Base.sitUrl+"/api/social/customer/info",type:"POST",data:{data:JSON.stringify(a)},success:function(e){if(!e.success)return void console.log(e.message);var a=e.data;if(null!==a&&void 0!==a&&""!==a)$(".fb-name").text(m(a.name)),$(".fb-email").text(m(a.email)),$(".fb-gender").text(m(a.gender)),$(".fb-birthday").text(m(a.birthday)),$("#sameorno").parents(".right-content").hide();else{if(1==t)var s="/api/facebook/search";else if(3==t)var s="/api/linkedIn/search";f(s),$("#sameorno").parents(".right-content").show()}}})}function h(e,t,a,s){var i={userId:e,socialId:t,type:a,isCheck:s,signType:s};$.ajax({url:Base.sitUrl+"/api/social/is/check",type:"POST",data:{data:JSON.stringify(i)},success:function(e){return e.success?($(".the-same-as").hide(),void $(".the-same-as").prev("label").hide()):void console.log(e.message)}})}u.pageObj={homepage:1,currentPage:1,lastpage:null,pageSize:10,conditions:[],keyword:""},u.customerId=a,u.choicedId="",u.customerList={},u.showGroup=!1,u.customerGroupList=[{id:"0",name:"全部分组"}],u.chiocedGroup={id:0,name:"选择分组"},u.chiocedCustomer={},u.mean={},u.meansList={},u.meansListNew={},u.changeStyle=function(e){var t=e.target;$(t).parents(".customer-list").find("div.radio").find("span.checked").removeClass("checked"),$(t).parent().addClass("checked"),u.chiocedCustomer=$(t).val(),u.chiocedCustomer==u.customerId?($.Alert("不能选择客户自己"),$(t).prop("disabled",!0),$("#btn-sure").prop("disabled",!0)):$("#btn-sure").prop("disabled",!1)},u.getList=function(){v()};var b;u.save=function(){b=u.chiocedCustomer;var e=u.customerId,t=e+","+b,a=t.split(","),s={ids:a};return b?(p({method:"post",url:Base.sitUrl+"/api/customer/v1/customer/merge/data",data:{data:JSON.stringify(s)}}).success(function(t){return t.success?void(e==t.data[0].id?(u.mean=u.meansList=t.data[0],u.mean.subId=b,u.mean.id=t.data[0].id,u.meansListNew=t.data[1]):(u.mean=u.meansList=t.data[1],u.mean.subId=b,u.mean.id=t.data[1].id,u.meansListNew=t.data[0])):void $.unLogin(t)}),$("#customer").modal("hide"),$("#customerdetail").modal("show"),void 0):void $.Alert("请先选择客户！")},u.chooseLeft=function(){u.mean=u.meansList,u.mean.name=u.meansList.name,u.mean.subId=b,u.mean.id=u.customerId,$(".leftcon ul>li span").addClass("checked"),$(".rightcon ul>li span").removeClass("checked")},u.chooseRight=function(){u.mean=u.meansListNew,u.mean.name=u.meansListNew.name,u.mean.subId=b,u.mean.id=u.customerId,$(".leftcon ul>li span").removeClass("checked"),$(".rightcon ul>li span").addClass("checked")},u.meansSend=function(){p({method:"get",url:Base.sitUrl+"/api/customer/v1/customer/merge",params:{data:JSON.stringify(u.mean)}}).success(function(e){return e.success?($.Alert("合并成功"),void parent.location.reload()):void $.unLogin(e)})},u.chioceGroup=function(e){u.chiocedGroup=e,u.showGroup=!1,u.pageObj.currentPage=1,"0"!=e.id?u.pageObj.conditions=[{filedName:"customerGroupId",operateType:"=",filedValue:e.id}]:u.pageObj.conditions=[],v()},v(),p({method:"post",url:Base.sitUrl+"/api/customer/v1/customer/group/list"}).success(function(e){return e.success?void(u.customerGroupList=u.customerGroupList.concat(e.data)):void $.unLogin(e)}),$(".screen-choiced").click(function(){$(".screen-list").toggle()}),s.on("click",".s-menus>li",function(t){$.EventFn(t);var i=$(this).index();if(s.find(".modals").removeClass("active"),0==i)e.addTab(Base.url+"/html/pop-customer-add.html?id="+a+"&v="+window.ver,"编辑客户");else if(1==i){if(o.hasClass("active"))return!1;o.addClass("active")}else if(2==i){if(l.hasClass("active"))return!1;l.addClass("active")}else if(3==i){if(d.hasClass("active"))return!1;d.addClass("active")}else 4==i&&($.EventFn(t),v(),$("#customer").modal("show"))}),s.on("click",".doc-handle",function(e){$.EventFn(e),$(".doc-handle-cont").hide(),$(this).next().show()});var y={};s.on("click",".doc-upload",function(e){y.size=$(this).attr("data-size"),y.file=$(this).attr("data-url"),y.name=$(this).attr("data-name"),$("#cloudModal").modal("show")}),$("#addCloud").click(function(){$("#cloudModal").modal("hide");var e=$.fn.zTree.getZTreeObj("treeCloud").getSelectedNodes();if(""==e)var t="0";else var t=e[0].id;var a={pid:t,type:"1",shareType:"1",operateType:"0",userType:"0"};$.extend(a,y),$.ajax({url:Base.sitUrl+"/api/disk/v1/file/save",type:"POST",dataType:"json",data:{data:JSON.stringify(a)},beforeSend:function(e){$.BlockUI()},complete:function(e,t){$.UnblockUI()},success:function(e){return e.success?void $.Alert("保存成功!","",function(){y={}}):void $.unLogin(e)}})}),s.on("click",".doc-delete",function(e){$.EventFn(e);var t=$(this).closest(".tab-content");$.ajax({url:Base.sitUrl+"/api/user/v1/document/delete",type:"POST",dataType:"json",data:{data:JSON.stringify({id:t.attr("data-id")})},success:function(e){if(!e.success)return void $.unLogin(e);t.remove();var a=parseInt($(".documentCount").text());$(".documentCount").text(--a)}})}),$("document").bind("click",function(e){$.EventFn(e),l.removeClass("active"),n.removeClass("active"),d.removeClass("active"),$(".doc-handle-cont").hide(),$(".edit-mail").hasClass("active")&&$(".edit-mail").removeClass("active").prev().addClass("active"),$(".info-overview select").hasClass("active")&&$(".info-overview select").removeClass("active").prev().removeClass("active")}),$(".info-overview select").click(function(e){$.EventFn(e)}),s.on("click","#del-ok",function(e){$.EventFn(e),w.setCustomerInfo({ids:a,setType:"delete",type:"customer"})}),s.on("click","#del-no",function(e){$.EventFn(e),$(".modals").removeClass("active")}),s.on("click",".u-group>ul>li",function(e){$.EventFn(e);var t=$(this).attr("data-id"),s=$(this).text();w.setCustomerInfo({ids:a,setType:"group",customerGroupId:t,groupName:s})}),s.on("click",".u-transfer>ul>li",function(e){$.EventFn(e);var t={ids:a,setType:"allot",userId:$(this).attr("data-id")};w.setCustomerInfo(t,null)}),s.on("click",".status-list>.status-current>span",function(e){$.EventFn(e);var t=$(this).closest(".status-list"),a=t.children(".status-items");a.hasClass("active")?a.removeClass("active"):a.addClass("active")}),s.on("click",".status-list>.status-items>li",function(e){$.EventFn(e);var t=$(this).children().prop("outerHTML"),s=parseInt($(this).children().attr("data-id")),i=$(".status-current");if(t!=i.children("label").prop("outerHTML")){t+='<span><i class="s-updownBg s-up"></i></span>',i.empty(),i.append(t),$(this).parent().removeClass("active");var n={id:a,status:s,setType:"setStatus"};w.setCustomerInfo(n)}}),s.on("click",".s-other",function(e){$.EventFn(e);var t=$(this).next("ul");t.hasClass("active")?t.removeClass("active"):t.addClass("active")}),s.on("click",".status-star>i",function(e){$.EventFn(e);var t=$(this).index()+1,s={};s.id=a,s.starLevel=t,s.setType="setStar",w.setCustomerInfo(s)}),s.on("click",".info-edit",function(t){$.EventFn(t),e.showTab(Base.url+"/html/pop-customer-add.html?id="+a+"&v="+window.ver,"编辑客户")}),s.on("mouseover",".upload-imgList>li",function(e){$.EventFn(e);var t=s.find(".upload-imgList>i.s-dels3");return!$(this).hasClass("active")&&($(this).addClass("active").siblings("li").removeClass("active"),void t.addClass("active").css({top:$(this).position().top-4,left:$(this).position().left+62}))}),s.on("change","#up-image",function(){var e=$(this).prop("files")[0];e&&w.uploadFile("img",e,$("#upload-img"))}),s.on("change","#up-files",function(){var e=$(this).prop("files")[0];e&&w.uploadFile("file",e,$("#upload-file"))}),s.on("click",".upload-imgList>i.s-dels3",function(e){$.EventFn(e);for(var t=s.find(".upload-imgList>li"),a=0;a<t.length;a++)if(t.eq(a).hasClass("active")){t.eq(a).remove(),$(this).removeClass("active");break}}),s.on("click",".list-file>li>.s-dels3",function(e){$.EventFn(e);var t=$(this).parent();t.remove(),0==s.find(".list-file>li").length&&s.find(".list-file").remove()}),s.on("click",".box-quick-menu>li",function(t){$.EventFn(t);var a=$(this).index(),i=s.find("#box-follow");if($(this).hasClass("active"))return!1;if($(this).addClass("active").siblings("li").removeClass("active"),s.find(".quick-input").removeClass("active"),i.val()&&i.val(""),0==a)s.find(".btn-sign").addClass("active"),s.find(".box-selects").removeClass("active"),s.find(".box-selects2").addClass("active"),$(".box-selects2").show();else if(1==a)s.find(".btn-sign").removeClass("active"),s.find(".list-file").remove(),s.find(".box-selects").addClass("active"),s.find(".box-selects2").removeClass("active"),s.find("#task-remind").attr("data-id",5).text("5分钟后"),s.find("#task-remind").next("ul").children("li:first").addClass("active").siblings("li").removeClass("active"),$(".box-selects2").hide(),$(".selects4").show();else if(2==a){$(".box-selects2").show(),$(".selects4").hide();var n=$(".cust-email").text();e.showTab(Base.url+"/html/pop-email-new.html?name="+n+"&showType=right&v="+window.ver,"新建邮件")}s.find(".quick-input").attr("data-type",$(this).index())}),s.on("click",".btn-decision>a",function(e){$.EventFn(e),$("#box-follow").parent("div").removeClass("active"),s.find("#box-follow").val("")}),s.on("click",".btn-publish",function(e){$.EventFn(e);var t={customerId:a},i=parseInt(s.find(".quick-input").attr("data-type")),n=s.find("#box-follow"),l=s.find(".list-file>li"),o=[];if(null==n.val()||""==$.trim(n.val()))return n.attr("placeholder","请输入需发布的内容"),$.Alert("发布内容不能为空"),!1;if(i){t.name="快速创建任务",t.description=n.val(),t.customerName=s.find(".cust-name").text(),t.remindTime=s.find("#task-remind").attr("data-id"),t.executionTimeType=1;var d=new Date;t.executionTime=$.dateObj(d.getTime()+864e5)._getDatetime()}else{for(var r=0;r<l.length;r++)o.push({attachmentType:parseInt(l.eq(r).attr("data-type")),attachment:l.eq(r).attr("data-url"),attachmentName:l.eq(r).children("span").text()});t.paramType=0;var c=$("#customerContacts").attr("data-id");t.customerContactsId=""!=c?c:0;var u=$(".fllow-time-check input").val();""!=u&&(t.followTimeString=u),t.attachments=o,t.content=n.val()}w.saveFollowOrTask(t,i),t={},i=null}),s.on("click","#box-follow",function(e){$.EventFn(e);var t=s.find(".quick-input");return!t.hasClass("active")&&void t.addClass("active")}),s.on("click",".model-select",function(e){$.EventFn(e),$(this).children("ul").toggleClass("active")}),s.on("click",".model-select>ul>li",function(e){$.EventFn(e);var t=$(this).parent().removeClass("active");t.prev("label").text($(this).text()).attr("data-id",$(this).attr("data-id")),$(this).addClass("active").siblings().removeClass("active")}),s.on("click",".show-models",function(e){$.EventFn(e);var t=$(this).attr("data-type"),a=".show-"+t;return!$(a).hasClass("active")&&(s.find(".models2").removeClass("active"),void s.find(a).addClass("active"))}),s.on("click",".models2-top>.s-dels6",function(e){$.EventFn(e),s.find(".models2").removeClass("active")}),s.on("click",".add-contact",function(t){$.EventFn(t);var s=$("#mainTab",parent.document).find(".currentClass").index();e.showTab(Base.url+"/html/pop-contacts-add.html?custId="+a+"&type=customer&index="+s+"&v="+window.ver,"添加联系人")}),s.on("click","#add_contacts",function(t){$.EventFn(t);var s=$("#mainTab",parent.document).find(".currentClass").index();e.showTab(Base.url+"/html/pop-contacts-add.html?custId="+a+"&type=customer&index="+s+"&v="+window.ver,"添加联系人")}),s.on("click",".list-concat>li>p>span>.s-dels3",function(e){$.EventFn(e);var t=$(this).closest("li"),a={setType:"delete",type:"contact"};a.ids=t.attr("data-id"),w.setCustomerInfo(a,t)}),s.on("click",".list-concat>li>p>span",function(t){$.EventFn(t);var a=$(this).closest("li").attr("data-id");e.addTab(Base.url+"/html/pop-relation-detail.html?id="+a+"&v="+window.ver,"联系人详情")}),s.on("click",".list-concat>li>p>.s-mail2",function(t){$.EventFn(t);var a=$(this).parents("li").find(".concat-mail").text();e.showTab(Base.url+"/html/pop-email-new.html?name="+a+"&showType=right&v="+window.ver,"新建邮件")}),s.on("click",".list-concat>li>p>.concat-mail,.list-concat>li>p>.s-edit2",function(e){$.EventFn(e);var t,a,i={setType:"editMail",type:"contact"};$(this).hasClass("concat-mail")?(t=$(this),a=$(this).next(".edit-mail")):(t=$(this).prevAll(".concat-mail"),a=$(this).prev(".edit-mail")),t.hasClass("active")?(s.find(".concat-mail").addClass("active").next(".edit-mail").removeClass("active"),t.removeClass("active").next(".edit-mail").addClass("active"),a.focus()):(t.addClass("active").next(".edit-mail").removeClass("active"),i.id=parseInt($(this).closest("li").attr("data-id")),i.email=$(this).prev(".edit-mail").val(),w.setCustomerInfo(i,$(this).closest("li")))}),s.on("click",".edit-overview",function(e){$.EventFn(e);var t=(s.find(".info-overview"),s.find(".overview-show")),i=s.find("#overview-source,#overview-type,#overview-group"),n={};t.hasClass("active")?(t.removeClass("active"),i.removeClass("active"),n.id=a,n.setType="editOverview",n.customerGroupId=s.find("#overview-group").val(),n.customerType=s.find("#overview-type").val(),n.customerSource=s.find("#overview-source").val(),w.setCustomerInfo(n)):(t.addClass("active"),i.addClass("active"))}),s.on("click","#tagsModal ul li",function(){var e=$(this),t=$(this).attr("data-value"),s={ids:a,tagId:t,setType:"tag"};$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/set",type:"POST",dataType:"json",data:{data:JSON.stringify(s)},success:function(t){if(!t.success)return void $.unLogin(t);$("#tagsModal").removeClass("active");var a='<li data-id="'+e.attr("data-value")+'"><span>'+e.attr("title")+'</span><i class="s-updownBg s-dels3"></i></li>';0==$(".list-label").children("li").length&&$(".list-label").empty(),$(".list-label").append(a)}})}),s.on("click",".models2-content .set-btn",function(e){$.EventFn(e);var t=$(this).parent().children("input"),i=$(this).prev(".list-follower"),n=$.errorsFn(t,"请输入内容"),l={};if(n&&t.length>0){if($(this).hasClass("add-contact"));else if($(this).hasClass("add-label")){if(l.setType="addTag",l.tagName=t.val(),t.val().length>255)return $.Alert("标签内容不得超出255个字"),!1;l.id=a,w.setCustomerInfo(l)}}else i.length>0&&(l.ids=a,l.setType="addFollower",l.userId=s.find(".list-follower>li.active").attr("data-id"),l.name=s.find(".list-follower>li.active").text(),w.setCustomerInfo(l))}),s.on("click",".list-follower>li",function(e){return $.EventFn(e),!$(this).hasClass("active")&&void $(this).addClass("active").siblings("li").removeClass("active")}),s.on("click",".list-label>li>i,.list-follow>li>span>i",function(e){$.EventFn(e);var t,a=$(this).parent(),s={};a.parent().hasClass("list-label")?(t=a,s={id:parseInt(t.attr("data-id")),setType:"delTag"}):(t=a.parent(),s={followUpUserId:parseInt(t.attr("data-id")),setType:"delFollower"}),w.setCustomerInfo(s,t),id=null,s=null,t=null}),s.on("click",".cancel-follow",function(e){var t={ids:a,setType:"unFollow"};w.setCustomerInfo(t,null)}),s.on("click",".upload-filelist>li>label>a,.doc-download",function(e){$.EventFn(e);var t=$(this).attr("data-type"),a=$(this).attr("data-name"),s=$(this).attr("data-url"),i=$(this).closest("li");if(0==t){var n={name:a,value:s};w.getFile(n)}else w.delFollowFile(i.attr("data-id"),i)}),s.on("click",".tabs-menu>li",function(e){if($.EventFn(e),$(this).hasClass("active"))return!1;var t=$(this).attr("data-type"),a=".tabs-"+t;$(this).addClass("active").siblings("li").removeClass("active"),$(a).addClass("active").siblings(".box-tab").removeClass("active"),w.timeObj.currentPage=1,w.followObj.currentPage=1,w.page.currentPage=1,w.fileObj.currentPage=1,$(".page").addClass("active"),"follow"==t?w.getCustomerRelationsList(w.followObj,"follow"):"email"==t?w.getCustomerRelationsList(w.page,"email"):"edm"==t?w.getCustomerRelationsList(w.page,"edm"):"quotation"==t?w.getCustomerRelationsList(w.page,"quotation"):"pi"==t?w.getCustomerRelationsList(w.page,"pi"):"order"==t?w.getCustomerRelationsList(w.page,"order"):"task"==t?w.getCustomerRelationsList(w.page,"task"):"timeline"==t?w.getCustomerRelationsList(w.timeObj,"timeline"):"file"==t&&w.getCustomerRelationsList(w.fileObj,"file")}),s.on("click",".info-tab>li",function(e){return $.EventFn(e),!$(this).hasClass("active")&&void $(this).addClass("active").siblings("li").removeClass("active")}),s.on("click",".tab-top>a,.trNone>a",function(t){$.EventFn(t);var s=$(this).attr("data-type"),i=parent.me.tabIdx();if("email"==s){var n=$(".cust-email").text();e.showTab(Base.url+"/html/pop-email-new.html?name="+n+"&showType=right&v="+window.ver,"新建邮件")}else"edm"==s?e.showTab(Base.url+"/html/pop-letter-new.html?&v="+window.ver,"新建营销信"):"quotation"==s?e.showTab(Base.url+"/html/pop-quotation-add.html?custId="+a+"&pIdx="+i+"&v="+window.ver,"新建报价单"):"pi"==s?e.showTab(Base.url+"/html/pop-pi-add.html?custId="+a+"&pIdx="+i+"&v="+window.ver,"新建PI"):"order"==s?e.showTab(Base.url+"/html/pop-order-add.html?custId="+a+"&pIdx="+i+"&v="+window.ver,"新建订单"):"task"==s?e.showTab(Base.url+"/html/pop-task.html?custId="+a+"&custName="+r+"&pIdx="+i+"&v="+window.ver,"新建任务"):"upload"==s?e.showTab(Base.url+"/html/pop-upload-file.html?custId="+a+"&v="+window.ver,"上传文档"):"follow"==s?e.showTab(Base.url+"/html/pop-upload.html?id="+a+"&pIdx="+i+"&v="+window.ver,"新建跟进"):e.showTab(Base.url+"/html/pop-upload.html?id="+a+"&pIdx="+i+"&v="+window.ver,"新建跟进")}),s.on("click",".tab-content",function(t){$.EventFn(t);var a=$(this).attr("data-id"),s=$(this).closest(".box-tab"),i=$(this).attr("data-type");if(s.hasClass("tabs-email")){var n=$(this).attr("data-etype");"2"==n?e.showTab(Base.url+"/html/pop-email-detailOut.html?id="+a+"&uri=/api/email/outbox/v1/detail&v="+window.ver,"邮件详情"):e.showTab(Base.url+"/html/pop-email-detail.html?id="+a+"&uri=/api/email/inbox/v1/detail&v="+window.ver,"邮件详情")}else s.hasClass("tabs-quotation")?e.showTab(Base.url+"/html/pop-quotation-detail.html?id="+a+"&v="+window.ver,"报价单详情"):s.hasClass("tabs-pi")?e.showTab(Base.url+"/html/pop-pi-detail.html?id="+a+"&v="+window.ver,"pi详情"):s.hasClass("tabs-order")?e.showTab(Base.url+"/html/pop-order-detail.html?id="+a+"&v="+window.ver,"订单详情"):s.hasClass("tabs-edm")?e.showTab(Base.url+"/html/pop-letter-detail.html?id="+a+"&v="+window.ver,"营销信详情"):s.hasClass("tabs-task")?e.showTab(Base.url+"/html/pop-detail.html?taskId="+a+"&v="+window.ver,"任务详情"):s.hasClass("tabs-time")&&i.length>0&&("email"==i?e.showTab(Base.url+"/html/pop-email-detail.html?id="+a+"&uri=/api/email/inbox/v1/detail&v="+window.ver,"邮件详情"):"quotation"==i?e.showTab(Base.url+"/html/pop-quotation-detail.html?id="+a+"&v="+window.ver,"报价单详情"):"pi"==i?e.showTab(Base.url+"/html/pop-pi-detail.html?id="+a+"&v="+window.ver,"pi详情"):"order"==i?e.showTab(Base.url+"/html/pop-order-detail.html?id="+a+"&v="+window.ver,"订单详情"):"edm"==i?e.showTab(Base.url+"/html/pop-letter-detail.html?id="+a+"&v="+window.ver,"营销信详情"):"task"==i&&e.showTab(Base.url+"/html/pop-detail.html?taskId="+a+"&v="+window.ver,"任务详情"))}),$(window).on("click",function(e){e.target.closest(".status-items")!=i[0]&&s.find(".status-items").removeClass("active"),e.target.closest(".s-menus")!=n[0]&&s.find(".s-menus").removeClass("active")});var w={info:{},list:{source:[],type:[],group:[],employee:[],status:[],currency:[],area:[]},data:{followIds:[],contactIds:[]},page:{customerId:a,type:1,id:a,pageSize:c.pageSize,currentPage:c.currentPage},timeObj:{customerId:a,pageSize:c.pageSize,currentPage:c.currentPage},followObj:{customerId:a,pageSize:c.pageSize,currentPage:c.currentPage,paramType:0},fileObj:{customerId:a,pageSize:c.pageSize,currentPage:c.currentPage},saveFollowOrTask:function(e,t){var a=Base.sitUrl+"/api/user/v1/user/followup/save";t&&(a=Base.sitUrl+"/api/task/v1/task/save"),$.ajax({url:a,type:"POST",data:{data:JSON.stringify(e)},dataType:"json",success:function(e){return e.success?($.Alert("发布成功！"),s.find("#box-follow").val(""),s.find(".list-file").remove(),s.find(".upload-imgList>li").each(function(){$(this).remove()}),s.find(".quick-input").removeClass("active"),t&&(s.find("#task-remind").attr("data-id",5).text("5分钟后"),s.find("#task-remind").next("ul").children("li:first").addClass("active").siblings("li").removeClass("active")),void $.when(w.getEmployees()).then(w.getUnits("currency")).then(w.getStatusList()).then(w.getCustomerRelationsList(w.timeObj,"timeline"))):void $.Alert("发布失败，"+e.message)}})},setCustomerInfo:function(e,t){var a=Base.sitUrl+"/api/customer/v1/customer/set";"editMail"!=e.setType&&"delete"!=e.setType||"contact"==e.type&&(a=Base.sitUrl+"/api/customer/contacts/v1/contacts/set"),$.ajax({url:a,data:{data:JSON.stringify(e)},type:"POST",dataType:"json",success:function(a){if(!a.success)return $.Alert("设置失败，"+a.message),!1;if("setStar"==e.setType){var i=s.find(".status-star"),n=(i.children("i"),e.starLevel),l=5-n,o='<i class="s-updownBg s-star2"></i>';if(n>0){for(var d=1;d<n;d++)o+='<i class="s-updownBg s-star2"></i>';for(var d=0;d<l;d++)o+='<i class="s-updownBg s-unstar2"></i>'}else for(var d=0;d<4;d++)o+='<i class="s-updownBg s-unstar2"></i>';i.empty().append(o),o=null;var r=$(".s-find",parent.document);r.length>0&&r.click()}else if("editOverview"==e.setType)s.find(".o-source").text(s.find("#overview-source>option:selected").text()),$(".cust-source").text(s.find("#overview-source>option:selected").text()),s.find(".o-type").text(s.find("#overview-type>option:selected").text()),$(".cust-type").text(s.find("#overview-type>option:selected").text()),s.find(".o-group").text(s.find("#overview-group>option:selected").text());else if("addTag"==e.setType){var c=s.find(".list-label");s.find(".models2").removeClass("active"),s.find(".models2-content>input").val(""),s.find(".list-label").append('<li data-id="'+a.data.id+'"><span>'+e.tagName+'</span><i class="s-updownBg s-dels3"></i></li>'),c.children("li").length>0&&c.children("span").remove()}else if("delTag"==e.setType)t.parent().children("li").length<=1&&t.parent().prepend("<span>无</span>"),t&&t.remove();else if("addFollower"==e.setType){var o='<li data-id="'+e.ids+'" data-user="'+e.userId+'"><i class="s-updownBg s-users2"></i><span>'+e.name+'<i class="s-updownBg s-dels3"></i></span></li>',u=s.find(".list-follow");s.find(".list-follow").append(o),s.find(".models2").removeClass("active"),u.children("li").length>0&&u.children("span").remove()}else"editMail"==e.setType?t.find(".concat-mail").text(e.email):"delete"==e.setType?"contact"==e.type?(t.remove(),0==s.find(".list-concat>li").length&&s.find(".list-concat").append("无")):$.Alert("删除成功！","",function(){parent.location.reload()}):"group"==e.setType?(s.find(".modals,.s-menus").removeClass("active"),s.find(".o-group").text(e.groupName),s.find("#overview-group").val(e.customerGroupId)):"unFollow"==e.setType||"delFollower"==e.setType||"allot"==e.setType?parent.location.reload():"setStatus"==e.setType?parent.location.reload():"allot"==e.setType}})},delFollowFile:function(e,t){$.ajax({url:Base.sitUrl+"/api/user/v1/user/followup/attach/delete",data:{id:e},type:"POST",dataType:"json",success:function(e){return e.success?void t.remove():void $.unLogin(e)}})},getAllArea:function(e){$.ajax({url:Base.sitUrl+"/api/sys/v1/sys/countries/get",type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.Alert("获取国家地区列表失败，",t.message);for(var a=t.data,i=0;i<a.length;i++)if(a[i].id==e){s.find(".top-title>label>img").attr("src","../images/country/PNG/"+a[i].id+".png"),s.find(".top-title>label>span,.cust-area").text(a[i].cn||"未设置");break}}})},getCustomerById:function(){$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/detail",data:{data:JSON.stringify({id:a})},type:"POST",async:!1,dataType:"json",success:function(e){if(!e.success)return void $.Alert("获取客户详情失败，"+e.message);var a=e.data,i=(w.list.source,w.list.group,w.list.type,w.list.employee),n=w.list.status,l=(w.list.area,""),o="",d="",r="",c="";1==a.highSeas&&$(".s-menus li:last-child").remove();var u=a.customerTags&&a.customerTags.length>0?a.customerTags:[],p=a.contacts,v=a.followUpUsers;s.find(".top-title>span");w.info=a;for(var f=e.data.contacts,g="",h="",b=0;b<f.length;b++){h=f[b].starLevel;var y="";if(h>0&&h<=5){for(var C=0;C<h;C++)y+='<i class="s-updownBg s-star2"></i>';for(var T=5-h,k=0;k<T;k++)y+='<i class="s-updownBg s-unstar2"></i>'}g+='<div class="info-content info-style con_info"><p class="info-caption">联系人</p><table class="info-table"><tbody><tr><td>姓名：</td><td class="con-name">'+m(f[b].name)+'</td></tr><tr><td>公司名称：</td><td class="con-com_name">'+m(f[b].workingCompany)+'</td></tr><tr><td>职位：</td><td class="con-position">'+m(f[b].position)+'</td></tr><tr><td>国家：</td><td class="con-country">'+m(f[b].countriesName)+'</td></tr><tr><td>邮箱：</td><td class="con-email">'+m(f[b].email)+'</td></tr><tr><td>星级</td><td class="con-star" id="con-stars"'+b+">"+y+'</td></tr><tr><td>生日</td><td class="con-date">'+m(f[b].birthday)+'</td></tr><tr><td>联系电话：</td><td class="con-phone">'+m(f[b].phone)+'</td></tr><tr><td>FaceBook：</td><td class="con-facebook">'+m(f[b].facebook)+'</td></tr><tr><td>Twitter：</td><td class="con-twitter">'+m(f[b].twitter)+'</td></tr><tr><td>Linkedin：</td><td class="con-linkedin">'+m(f[b].linkedin)+'</td></tr><tr><td>备注：</td><td class="con-remark">'+m(f[b].remark)+"</td></tr></tbody></table></div>"}$("#con-content").empty(),$("#con-content").append(g),s.find(".cust-name").text(a.name),s.find(".cust-email").text(a.defaultEmail||""),s.find(".cust-phone").text(a.phone||""),s.find(".cust-fax").text(a.faxes||""),s.find(".cust-facebook").text(a.facebook||""),s.find(".cust-twitter").text(a.twitter||""),s.find(".cust-linkedin").text(a.linkedin||""),s.find(".cust-address").text(a.address||""),s.find(".cust-homepage").text(a.homepage||""),s.find(".cust-mainProducts").text(a.mainProducts||""),s.find(".cust-remark").text(a.remark||"");for(var x=a.customerDefinedValues,B=s.find("#info-content .info-table tbody"),I=0;I<x.length;I++){var j="<tr><td>"+x[I].name+"</td><td>"+x[I].value+"</td></tr>";B.append(j)}""==a.countriesName||null==a.countriesName?s.find(".top-title>label").remove():w.getAllArea(a.countries),w.getDropdownContent("source",s.find("#overview-source"),a.customerSource),w.getDropdownContent("type",s.find("#overview-type"),a.customerType),w.getDropdownContent("group",s.find("#overview-group"),a.customerGroupId),s.find(".overview-time").text(a.createTime||"");var O=a.name||"",N=a.customerNo;O.length>80&&(O=O.slice(O.length/2)+"..."+O.slice(-(O.length/8))),$("#titleName").text(O),t=O,$("#title_num").text("【"+N+"】");for(var L=0;L<n.length;L++)if(n[L].id==a.status){var S=n[L].name;S=S.substr(0,1),s.find(".status-current").empty(),s.find(".status-current").append('<label style="background-color: '+n[L].colour+';" data-id="'+n[L].id+'">'+S+'</label><span><i class="s-updownBg s-up"></i></span>');break}if(a.starLevel>0&&a.starLevel<=5){for(var C=0;C<a.starLevel;C++)l+='<i class="s-updownBg s-star2"></i>';for(var F=5-a.starLevel,k=0;k<F;k++)l+='<i class="s-updownBg s-unstar2"></i>';s.find(".status-star").empty().append(l)}else if(a.starLevel>5){for(var C=0;C<6;C++)l+='<i class="s-updownBg s-star2"></i>';s.find(".status-star").empty().append(l)}if(u.length>0)for(var U=0;U<u.length;U++)o+='<li data-id="'+u[U].id+'"><span>'+u[U].tagName+'</span><i class="s-updownBg s-dels3"></i></li>';else o="<span>无</span>";if(s.find(".list-label").empty(),s.find(".list-label").append(o),p.length>0)for(var P=0;P<p.length;P++){var E=p[P];d+='<li data-id="'+E.id+'">                                                    <p><i class="s-updownBg s-users2"></i><span>'+E.name+'<i class="s-updownBg s-dels3"></i></span><i class="s-updownBg s-mail2"></i></p>                                                    <p><i class="s-updownBg s-mail"></i><label>邮箱：</label><span class="concat-mail active">'+(E.email||"")+'</span><input type="text" class="edit-mail" value="'+(E.email||"")+'"><i class="s-updownBg s-edit2"></i></p>                                                </li>',r+='<li data-id="'+E.id+'">'+E.name+"</li>"}else d="<span>无</span>",r="<li>无</li>";if(s.find(".contact-num").text(p.length),s.find(".list-concat").empty().append(d),$("#custContList").empty().append(r),v&&v.length>0)for(var q=0;q<v.length;q++){for(var O=v[q].userName||"匿名",A="",z=0;z<i.length;z++)if(i[z].id==v[q].userId){s.find(".list-follower>li").eq(z).remove();break}v[q].delFlag>0&&(A='<i class="s-updownBg s-dels3"></i>'),c+='<li data-id="'+v[q].id+'" data-user="'+v[q].userId+'">                                                    <i class="s-updownBg s-users2"></i>                                                    <span>'+O+A+"</span>                                                </li>"}else c="<span>无</span>";s.find(".list-follow").empty(),s.find(".list-follow").append(c);for(var C in a.statics){var M="."+C,R=a.statics[C];R>=1e4&&(R="9999+"),$(M).text(R)}}})},getTagsList:function(){$.ajax({url:Base.sitUrl+"/api/user/v1/user/tag/list",data:{tagType:1},success:function(e){for(var t=e.data,a="",s=0;s<t.length;s++)a+='<li data-value="'+t[s].id+'" title="'+t[s].name+'">'+t[s].name+"</li>";$("#tagsModal").find("ul").empty(),$("#tagsModal").find("ul").append(a)}})},getCloudNode:function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/disk/v1/folder/list/all",dataType:"json",data:{data:JSON.stringify({view:"0"})},success:function(e){if(!e.success)return void $.Alert(e.message);for(var t=e.data,a=new Array,s=0;s<t.length;s++)0==t[s].type&&a.push(t[s]);for(var i={view:{selectedMulti:!1},edit:{enable:!0,editNameSelectAll:!0},data:{simpleData:{enable:!0}},callback:{beforeDrag:!1}},n=new Array,s=0;s<a.length;s++)n[s]={id:a[s].id,pId:a[s].pid,name:a[s].name};$.fn.zTree.init($("#treeCloud"),i,n)}})},getCustomerRelationsList:function(e,t){var a=Base.sitUrl,i={data:JSON.stringify(e)};"follow"==t?(a+="/api/user/v1/user/followup/list/page",i=e):"email"==t?a+="/api/customer/v1/detail/emails":"edm"==t?a+="/api/customer/v1/detail/edms":"task"==t?(i=e,a+="/api/task/v1/task/timeline/list"):"quotation"==t?(i=e,a+="/api/quotation/v1/quotation/timeline/list"):"pi"==t?(i=e,a+="/api/pi/v1/pi/timeline/list"):"order"==t?(i=e,a+="/api/order/v1/order/timeline/list"):"timeline"==t?(i=e,a+="/api/user/v1/user/timeline/list"):"file"==t&&(a+="/api/user/v1/document/list/page"),$.ajax({url:a,data:i,
type:"POST",dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);var i=a.data.results,n=w.list.currency,l="",o="",d="empty-doc.png";if("follow"==t){if($(".followCount").text(a.data.totalItem),o="跟进",d="empty-fllow.png",i.length>0)for(var r=0;r<i.length;r++){var u=i[r].content,p=i[r].createTime,v=i[r].createUserName||"匿名",m=i[r].attachments,f="",g="";if(m.length>0){for(var h=0;h<m.length;h++){var b=m[h].attachmentName,y="http://"+m[h].attachment;1==m[h].attachmentType?g+='<li data-id="'+m[h].id+'">                                                        <label><i class="s-updownBg s-link4"></i><span>'+b+'</span></label>                                                        <label>                                                            <a href="javascript:;" data-url="'+y+'" data-name="'+b+'" download data-type="0">下载</a>                                                            <span>|</span>                                                            <a href="javascript:;" data-type="1">删除</a>                                                        </label>                                                    </li>':f+='<li><img src="'+y+'" alt="图片"></li>'}g='<ul class="upload-filelist">'+g+"</ul>",f='<ul class="upload-imglist">'+f+"</ul>"}l+='<div class="tab-content" data-id="'+i[r].id+'">                                            <label class="tab-sign"><i class="s-menuBg s-menu16"></i></label>                                            <div class="tab-style">                                                <div class="style-title"><span>'+p+"</span><span>"+v+'</span><span>创建了跟进</span></div>                                                <div class="style-content">                                                    <div class="follow-style">                                                        <p>'+u+"</p>"+f+'<div class="clear"></div>'+g+'                                                    </div>                                                </div>                                            </div>                                            <div class="clear"></div>                                        </div>'}}else if("email"==t){o="邮件",d="empty-email.png";for(var C='<i class="s-updownBg s-left2"></i>',u="",T="",r=0;r<i.length;r++)C=2==i[r].emailType?'<i class="s-updownBg s-left3"></i>':'<i class="s-updownBg s-left2"></i>',u=$.trim(i[r].content),T=i[r].subject,0==u.length&&(u="（无内容）"),0==T.length&&(T="（无主题）"),T.length>30&&(T=T.slice(0,30)+"..."),l+='<div class="tab-content" data-id="'+i[r].id+'" data-type="email" data-etype="'+i[r].emailType+'">                                            <label class="tab-sign"><i class="s-menuBg s-menu17"></i></label>                                            <div class="tab-style">                                                <div class="style-title"><span>'+i[r].sendTime.substring(0,i[r].sendTime.lastIndexOf("."))+"</span><span>"+i[r].fromName+"</span><span>给</span><span>"+i[r].toName+'</span><span>发了邮件</span></div>                                                <div class="style-content">                                                    <div class="email-style">                                                        <p><i class="s-updownBg s-dot"></i><span>'+T+"</span></p>                                                        <p>"+C+"                                                            <span>"+u+'</span>                                                        </p>                                                        <!--<label>4</label>-->                                                    </div>                                                </div>                                            </div>                                            <div class="clear"></div>                                        </div>'}else if("edm"==t){d="empty-edm.png",o="EDM";var C='<i class="s-updownBg s-left2"></i>',u="",T="";i=i;for(var r=0;r<i.length;r++)C=2==i[r].emailType?'<i class="s-updownBg s-left3"></i>':'<i class="s-updownBg s-left2"></i>',u=$.trim(i[r].content),T=i[r].subject,0==u.length&&(u="（无内容）"),0==T.length&&(T="（无主题）"),T.length>30&&(T=T.slice(0,30)+"..."),l+='<div class="tab-content" data-id="'+i[r].id+'" data-type="email">                                            <label class="tab-sign"><i class="s-menuBg s-menu17"></i></label>                                            <div class="tab-style">                                                <div class="style-title"><span>'+i[r].sendTime+"</span><span>"+i[r].fromName+"</span><span>给</span><span>"+i[r].toName+'</span><span>发了邮件</span></div>                                                <div class="style-content">                                                    <div class="email-style">                                                        <p><i class="s-updownBg s-dot"></i><span>'+T+"</span></p>                                                        <p>"+C+"                                                            <span>"+u+'</span>                                                        </p>                                                        <!--<label>4</label>-->                                                    </div>                                                </div>                                            </div>                                            <div class="clear"></div>                                        </div>'}else if("quotation"==t){d="empty-quo.png",o="报价单",$(".quotationCount").text(a.data.totalItem);for(var r=0;r<i.length;r++){for(var v=i[r].createUserName,u=i[r].name,k="",x=0;x<n.length;x++)if(n[x].id==i[r].unit){k=n[x].value;break}l+='<div class="tab-content" data-id="'+i[r].id+'" data-type="quotation">                                    <label class="tab-sign"><i class="s-menuBg s-menu10"></i></label>                                    <div class="tab-style">                                        <div class="style-title"><span>'+i[r].createTime+"</span><span>"+v+'</span><span>创建了报价单</span></div>                                        <div class="style-content">                                            <div class="quotation-style">                                                <label>'+u+"</label>                                                <p>总金额：<span>"+i[r].price+k+'</span></p>                                            </div>                                        </div>                                    </div>                                    <div class="clear"></div>                                </div>'}}else if("pi"==t){d="empty-pi.png",o="PI",$(".piCount").text(a.data.totalItem);for(var r=0;r<i.length;r++){for(var v=i[r].createUserName,u=i[r].name,k="",x=0;x<n.length;x++)if(n[x].id==i[r].unit){k=n[x].value;break}l+='<div class="tab-content" data-id="'+i[r].id+'" data-type="pi">                                    <label class="tab-sign"><i class="s-menuBg s-menu11"></i></label>                                    <div class="tab-style">                                        <div class="style-title"><span>'+i[r].createTime+"</span><span>"+v+'</span><span>创建了PI</span></div>                                        <div class="style-content">                                            <div class="quotation-style">                                                <label>'+u+"</label>                                                <p>总金额：<span>"+i[r].price+k+'</span></p>                                            </div>                                        </div>                                    </div>                                    <div class="clear"></div>                                </div>'}}else if("order"==t){d="empty-order.png",o="订单",$(".orderCount").text(a.data.totalItem);for(var r=0;r<i.length;r++){for(var v=i[r].createUserName,u=i[r].name,k="",x=0;x<n.length;x++)if(n[x].id==i[r].unit){k=n[x].value;break}l+='<div class="tab-content" data-id="'+i[r].id+'" data-type="order">                                    <label class="tab-sign"><i class="s-menuBg s-menu12"></i></label>                                    <div class="tab-style">                                        <div class="style-title"><span>'+i[r].createTime+"</span><span>"+v+'</span><span>创建了订单</span></div>                                        <div class="style-content">                                            <div class="quotation-style">                                                <label>'+u+"</label>                                                <p>总金额：<span>"+i[r].price+k+'</span></p>                                            </div>                                        </div>                                    </div>                                    <div class="clear"></div>                                </div>'}}else if("task"==t){d="empty-task.png",o="任务",$(".taskCount").text(a.data.totalItem);for(var r=0;r<i.length;r++){var B="",I="",v=i[r].name;2==i[r].status?(B="",I='<span class="red">已超时</span>'):3==i[r].status&&(B='<i class="s-updownBg s-end"></i>',I='<span class="green">已完成</span>'),v.length>25&&v.substr(0,20)+"...",l+='<div class="tab-content" data-id="'+i[r].id+'" data-type="task">                                            <label class="tab-sign"><i class="s-menuBg s-menu8"></i></label>                                            <div class="tab-style">                                                <div class="style-title"><span>'+i[r].createTime+"</span><span>"+(i[r].createUserName||"匿名")+'</span><span>创建了任务</span></div>                                                <div class="style-content">                                                    <div class="task-style">                                                        <p>'+B+I+"                                                            <label>"+v+'</label>                                                        </p>                                                    </div>                                                </div>                                            </div>                                            <div class="clear"></div>                                        </div>'}}else if("timeline"==t)for(var r=0;r<i.length;r++){var j="",O="",N="",v=i[r].createUserName||"匿名",L='<i class="s-menuBg s-menu18"></i>',u=i[r].content;1==i[r].contentType?(j="创建客户",O="customer"):2==i[r].contentType?(j="创建联系人",O="contact"):3==i[r].contentType?(j="创建跟进",L='<i class="s-menuBg s-menu16"></i>',O="follow"):4==i[r].contentType?(j="创建报价单",L='<i class="s-menuBg s-menu10"></i>',O="quotation"):5==i[r].contentType?(j="创建PI",L='<i class="s-menuBg s-menu11"></i>',O="pi"):6==i[r].contentType?(j="创建订单",L='<i class="s-menuBg s-menu12"></i>',O="order"):7==i[r].contentType?(j="创建任务",L='<i class="s-menuBg s-menu8"></i>',O="task"):8==i[r].contentType?j="创建标签":9==i[r].contentType?j="修改客户资料":10==i[r].contentType?j="修改联系人资料":11==i[r].contentType?j="修改了客户状态":12==i[r].contentType?(j="修改了报价单",L='<i class="s-menuBg s-menu10"></i>',O="follow"):13==i[r].contentType?(j="修改了PI",L='<i class="s-menuBg s-menu11"></i>',O="pi"):14==i[r].contentType?(j="修改了订单",L='<i class="s-menuBg s-menu12"></i>',O="quotation"):15==i[r].contentType?(j="修改了任务",L='<i class="s-menuBg s-menu8"></i>',O="task"):16==i[r].contentType?j="修改了客户分组":17==i[r].contentType?(j="跟进客户",L='<i class="s-menuBg s-menu16"></i>'):18==i[r].contentType?(j="取消跟进客户",L='<i class="s-menuBg s-menu16"></i>'):19==i[r].contentType?j="分享了客户":20==i[r].contentType?j="取消分享客户":21==i[r].contentType?j="转移了客户":22==i[r].contentType?(j="发邮件",L='<i class="s-menuBg s-menu17"></i>',O="email"):23==i[r].contentType?(j="发EDM",L='<i class="s-menuBg s-menu4"></i>',O="edm"):24==i[r].contentType?j="删除了客户":25==i[r].contentType?j="删除了联系人":26==i[r].contentType?(j="删除了跟进",L='<i class="s-menuBg s-menu16"></i>'):27==i[r].contentType?(j="删除了报价单",L='<i class="s-menuBg s-menu10"></i>'):28==i[r].contentType?(j="删除了PI",L='<i class="s-menuBg s-menu11"></i>'):29==i[r].contentType&&(j="删除订单",L='<i class="s-menuBg s-menu12"></i>'),N='<div class="style-title"><span>'+i[r].createTime+"</span><span>"+v+"</span><span>"+j+"</span></div>",l+='<div class="tab-content" data-id="'+i[r].id+'" data-type="'+O+'">                                            <label class="tab-sign">'+L+'</label>                                            <div class="tab-style">'+N+'<div class="style-content">'+u+'</div>                                            </div>                                            <div class="clear"></div>                                        </div>'}else if("file"==t){o="文档",$(".documentCount").text(a.data.totalItem);for(var r=0;r<i.length;r++){var S='<span class="doc-img-local"></span>',F='<li class="doc-upload" data-size="'+i[r].documentSizeOld+'" data-url="'+i[r].documentUrl+'" data-name="'+i[r].documentName+'">上传到云盘</li>';1==i[r].source&&(S='<span class="doc-img-cloud"></span>',F=""),l+='<div class="tab-content" data-id="'+i[r].id+'">                                            <label class="tab-sign"><i class="s-menuBg s-menu18"></i></label>                                            <div class="tab-style">                                                <div class="style-title">                                                <span>'+i[r].createTime+"</span><span>"+(i[r].createUserName||"匿名")+'</span><span>上传了文档</span>                                                <i class="doc-handle"></i>                                                <ul class="doc-handle-cont">                                                <li class="doc-download" data-url="'+i[r].documentUrl+'" data-name="'+i[r].documentName+'" download data-type="0">下载</li>'+F+'<li class="doc-delete">删除</li>                                                </ul>                                                </div>                                                <div class="style-content">                                                    <div class="file-style"><p>'+S+"<span>【"+i[r].documentName.substring(i[r].documentName.lastIndexOf(".")+1)+"】</span>                                                    <span>"+i[r].documentName.substring(0,i[r].documentName.lastIndexOf("."))+'</span>                                                    <span style="float: right;">'+i[r].documentSize+'</span>                                                   </p></div>                                                </div>                                            </div>                                            <div class="clear"></div>                                        </div>'}}var U=".tabs-"+t+" .tab-middle .tab-line";s.find(U).nextAll(".tab-content").remove(),""==l&&(s.find(U).nextAll(".trNone").remove(),l='<div class="trNone"><div class="trnone-info" style="margin-top: 11px;"><img src="../images/'+d+'" alt="" /><p class="trnone-text">暂无'+o+'</p></div><a href="javascript:;" class="trnone-btn btn btn-primary" data-type="'+t+'">创建'+o+"</a></div>"),s.find(U).after(l),l="","follow"==t&&s.find(".tabs-follow .tab-middle img").load(function(){$.cutImage(this,68,68)});var P=c.pageSize,E=Math.ceil(a.data.totalItem/P);return 1==E?($(".page").addClass("active"),!1):($(".page").removeClass("active"),void $.Page({total:a.data.totalItem,_class:".page",nowNum:e.currentPage,allNum:E,callback:function(e,a){var s=w.timeObj;"timeline"==t?(w.timeObj.currentPage=e,s=w.timeObj):"follow"==t?(w.followObj.currentPage=e,s=w.followObj):"file"==t?(w.fileObj.currentPage=e,s=w.fileObj):(w.page.currentPage=e,s=w.page),w.getCustomerRelationsList(s,t)}}))}})},getFile:function(e){console.log(Base.sitUrl+"/api/file/download?data="+JSON.stringify(e)),$(".doc-handle-cont").hide(),window.location.href=Base.sitUrl+"/api/file/download?data="+JSON.stringify(e)},getDropdownContent:function(e,t,a){var i="",n={};"source"==e?i=Base.sitUrl+"/api/org/v1/org/staff/customer/source/list":"group"==e?i=Base.sitUrl+"/api/customer/v1/customer/group/list":"type"==e&&(i=Base.sitUrl+"/api/sys/v1/sys/dictionary/get",n={group:"customer.type"}),i.length>0&&$.ajax({url:i,data:n,type:"POST",dataType:"json",success:function(i){if(!i.success)return void $.unLogin(i);var n=i.data,l="",o="";if(n.length>0){for(var d=0;d<n.length;d++)"type"==e?(l+='<option value="'+n[d].id+'">'+n[d].value+"</option>",n[d].id==a&&(s.find(".o-type,.cust-type").text(n[d].value),s.find("#overview-type").val(a))):("source"==e?n[d].id==a&&(s.find(".o-source,.cust-source").text(n[d].name),s.find("#overview-source").val(a)):"group"==e&&(n[d].id==a&&(s.find(".o-group,.cust-group").text(n[d].name),s.find("#overview-group").val(a)),o+='<li data-id="'+n[d].id+'">'+n[d].name+"</li>"),l+='<option value="'+n[d].id+'">'+n[d].name+"</option>");"group"==e&&(s.find(".u-group>ul").empty(),s.find(".u-group>ul").append(o)),t&&(t.empty(),t.append(l))}}})},getEmployees:function(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/staff/list",type:"POST",dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data,a="";if(w.list.employee=t,t.length>0)for(var i=0;i<t.length;i++){var n=t[i].name||"匿名";n.length>13&&(n=n.slice(0,10)+"..."),a+='<li data-id="'+t[i].id+'">'+n+"</li>"}else a="无";d.find(".u-transfer>ul").empty().append(a),s.find(".list-follower").empty().append(a)}})},getStatusList:function(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/staff/customer/status/list",type:"POST",dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);for(var t=e.data,a="",i=0;i<t.length;i++){var n=t[i].name;n=n.substr(0,1),a+='<li><label style="background-color: '+t[i].colour+';" data-id="'+t[i].id+'">'+n+"</label></li>"}w.list.status=t,s.find(".status-items").empty(),s.find(".status-items").append(a),w.getCustomerById()}})},getUnits:function(e){$.ajax({url:Base.sitUrl+"/api/sys/v1/sys/dictionary/get",data:{group:e},type:"POST",dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data;w.list.currency=t}})},uploadFile:function(e,t,a){a.ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(a){if(!a.success)return void $.Alert("上传失败,"+a.message);var i=("http://"+a.data,s.find(".list-file")),n=s.find(".btns-upload"),l="",o=0,d='<i class="s-updownBg s-link5"></i>';"file"==e&&(o=1,d='<i class="s-updownBg s-link3"></i>'),0==i.length?(l='<ul class="list-file">                                            <li data-url="'+a.data+'" data-type="'+o+'">'+d+"<span>"+t.name+'</span>                                            <i class="s-updownBg s-dels3"></i>                                        </li>                                    </ul>',n.after(l)):(l='<li data-url="'+a.data+'" data-type="'+o+'">'+d+"<span>"+t.name+'</span>                                        <i class="s-updownBg s-dels3"></i>                                    </li>',i.append(l))}}).submit(),s.find("#upload-img,#upload-file")[0].reset()}};$("#info-li").bind("click",function(){$(this).addClass("active"),$("#info-content").show(),$("#info-content").siblings(".tab-content").hide(),$(this).siblings("li").removeClass("active")}),$("#fb-li").bind("click",function(){$(this).addClass("active"),$("#fb-content").show(),$("#fb-content").siblings(".tab-content").hide(),$(this).siblings("li").removeClass("active"),g(a,1)}),$("#tw-li").bind("click",function(){$(this).addClass("active"),$("#tw-content").show(),$("#tw-content").siblings(".tab-content").hide(),$(this).siblings("li").removeClass("active")}),$("#lk-li").bind("click",function(){$(this).addClass("active"),$("#lk-content").show(),$("#lk-content").siblings(".tab-content").hide(),$(this).siblings("li").removeClass("active"),g(a,3)}),$(".detail-middle-right").on("click",".s-yes",function(){var e=$(this).parents(".the-same-as").attr("data-fb");h(a,e,1,1)}),$.when(w.getEmployees()).then(w.getUnits("currency")).then(w.getStatusList()).then(w.getCustomerRelationsList(w.timeObj,"timeline")).then(w.getTagsList()).then(w.getCloudNode())}]),angular.bootstrap(document.body,["All"])})});