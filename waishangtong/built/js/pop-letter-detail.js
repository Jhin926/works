require(["common"],function(){require(["maintab","ZeroClipboard","ueditorLang","blockUI","jqform"],function(t,e){function n(){$.ajax({url:Base.sitUrl+"/api/edm/v1/send/detail",type:"POST",dataType:"json",async:!1,data:{id:y},beforeSend:function(t){$.BlockUI()},complete:function(t,e){$.UnblockUI()},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;if($(".totalEmail").text(e.emailSum),$(".sendEmail").text(e.deliverySum),$(".openEmail").text(e.openSum),$(".backEmail").text(e.replySum),$(".sendFailedSum").text(e.sendFailedSum),$(".deliveryRate").text(e.deliveryRate+"%"),$(".replyRate").text(e.replyRate+"%"),$(".openRate").text(e.openRate+"%"),$(".failedRate").text(e.failedRate+"%"),$("#letterTitle").text(e.subject),2==e.status){var n="letterSend",a='<img src="../images/'+n+'.png" class="left" />';$("#letterTitle").parent().before(a)}else{var n="letterSending_detail",a='<img src="../images/'+n+'.png" class="left" style="width:50px"/>';$("#letterTitle").parent().before(a)}i()}})}function i(){$(".ledgement").show();var t=$("#totalEmail span").text(),e=$("#sendEmail span").text(),n=$("#openEmail span").text(),i=$("#backEmail span").text(),a=e/t*750,s=n/t*750,l=i/t*750;a>750&&(a=750),s>750&&(s=750),l>=750&&(l=750,$("#backEmail .ledgementNo").hide());var o=750-a-5,c=750-s-o-10,d=750-l-c-o-15;$("#totalEmail .ledgement").css("width","750px"),$("#sendEmail .ledgement").css("width",a+"px"),$("#sendEmail .ledgementNo").css("width",o+"px"),$("#openEmail .ledgement").css("width",s-5+"px"),$("#openEmail .ledgementNo").css("width",c+5+"px"),$("#openEmail .ledgementNo").css("right",o+5+"px"),$("#backEmail .ledgement").css("width",l+"px"),$("#backEmail .ledgementNo").css("width",d+"px"),0==a&&($("#sendEmail .ledgementNo").siblings(".ledgement").hide(),$("#openEmail .ledgementNo").hide(),$("#backEmail .ledgementNo").hide(),$("#sendEmail .ledgementNo").css("width","750px")),0==s&&o<=0&&($("#openEmail .ledgementNo").siblings(".ledgement").hide(),$("#backEmail .ledgementNo").hide(),$("#openEmail .ledgementNo").css("width","750px")),0==l&&c<=0?($("#backEmail .ledgementNo").siblings(".ledgement").hide(),$("#backEmail .ledgementNo").css("marginLeft","0"),$("#backEmail .ledgementNo").css("width","750px")):0==l&&0!==d&&0!==c&&0!==o&&($("#backEmail .ledgement").remove(),$("#backEmail .ledgementNo").css("marginLeft","0")),0==d&&$("#backEmail .ledgementNo").eq(0).remove();for(var r=0;r<$(".letter-statistics").find(".ledgement").length;r++)$(".letter-statistics").find(".ledgement").eq(r).width()<=0&&$(".letter-statistics").find(".ledgement").eq(r).hide()}function a(t){var e=t.getFullYear(),n=t.getMonth()+1,i=t.getDate(),a=t.getHours(),s=t.getMinutes(),l=t.getSeconds();return e+"-"+n+"-"+i+"   "+a+":"+s+":"+l}function s(t){return null==t?"&nbsp;-&nbsp;-":t}function l(t){$.ajax({url:Base.sitUrl+"/api/edm/v1/email/detail",type:"POST",datType:"json",data:{id:y,type:t,currentPage:k.currentPage,pageSize:k.pageSize},success:function(e){if(!e.success)return void $.unLogin(e);var n=e.data.results,i="";if(n.length<1)2==t?($(".letterSend1").attr("disabled","disabled"),$(".letterSend1").unbind("click"),$(".letterSend0").attr("disabled","disabled"),$(".letterSend0").unbind("click"),$(".letterDown").attr("disabled","disabled")):3==t?($(".letterOpen1").attr("disabled","disabled"),$(".letterOpen0").attr("disabled","true"),$(".letterOpen1").unbind("click"),$(".letterOpen0").unbind("click"),$(".letterDown").attr("disabled","disabled")):4==t?($(".letterBack0").attr("disabled","disabled"),$(".letterBack0").unbind("click"),$(".letterDown").attr("disabled","disabled")):5==t&&($(".letterFaile").attr("disabled","disabled"),$(".letterFaile").unbind("click"),$(".letterDown").attr("disabled","disabled")),i='<li class="text-center" style="margin-top:15px;background:none;">无营销信件</li>';else{$(".letterDown").attr("disabled",!1);for(var o=0;o<n.length;o++){if(o==n.length-1)var c=1;else var c=0;var d="",r="";if(1==n[o].isDelivery)var u=a(new Date(n[o].createTime));else if(0==n[o].isDelivery)var u=a(new Date(n[o].createTime));3==t&&3==n[o].isDelivery&&(r="letterSend",d="已送达"),1==t&&(1==n[o].status?r="letterSend":2==n[o].status&&(r="letterFailed")),2==t?(r="letterSend",d="已发送"):3==t?(r="letterOpen",d="已打开"+n[o].openSum+"次"):4==t?(r="letterBack",d="已回复"+n[o].replaySum+"次"):5==t&&(r="letterFailed",d="发送失败"),i+='<li data-id="'+n[o].id+'" data-edmEmailId="'+n[o].edmEmailId+'" data-num="'+c+'"><div class="liTags"><img src="../images/'+r+'.png" class="tableContUl-img"><div class="liTitle"><span class="liTime">'+v(u)+'</span><span class="liEmail"><a class="liEmailLabel" style="color:#4b73ec;">'+v(n[o].address)+'</a><span class="li_TraceLocation">'+s(n[o].lastTraceLocation)+'</span><div class="sender-condition-style" style="display: none;top:6px;left:187px;"></div></div><div class="liMain"><span class="liStaus">'+v(d)+'</span><span class="liMain_con">'+v(n[o].subject)+"</span></div></div></li>"}}$(".tableContUl").empty(),$(".tableContUl").append(i);var p=e.data.totalItem,b=k.pageSize,m=Math.ceil(p/b);k.lastpage=m,$.Page({total:p,_class:".page",nowNum:k.currentPage,allNum:m,callback:function(t,e){k.currentPage=t;var n=$(".contUl").find("li.active").attr("data-type");l(n)}})}})}function o(){var t=[];t.push(j.letter.getContent());var e=t.join("\n");return e}function c(t,e){$("#form_file").ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(e){if(!e.success)return void $.unLogin(e);var n="http://"+e.data,i='<li data-url="'+n+'" style="display: inline-block;padding: 5px 0;"><i class=""></i><span class="filesName">'+t+'</span> <span class="file-del">删除</span></li>';$("#addFiles").prepend(i)}}).submit()}function d(t,e){$("#form_file1").ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(n){if(!n.success)return void $.unLogin(n);var i="http://"+n.data,a='<li data-url="'+i+'" style="display: inline-block;padding: 5px 0;margin:0 5px;" data-size="'+(e/1024).toFixed(2)+'"><i class="pub-icon fujian-excl-iocn"></i><span class="filesName">'+t+'</span>&nbsp;&nbsp;<span style="color:#89c682;">文件上传成功！</span> <span class="file-del">删除</span></li>';$("#addFiles1").show(),$("#addFiles1").prepend(a)}}).submit()}function r(t){var e=!0,n=t.prop("files"),i=Math.round(n[0].size/1024*100)/100/1024,a=n[0].size;return i>5&&($.Alert("上传附件需小于5MB"),e=!1),{flag:e,name:n[0].name,size:a}}function u(t,e){$("#form_img").ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(t){if(!t.success)return void $.unLogin(t);var e="http://"+t.data;UE.getEditor("letterEditor").execCommand("insertimage",{src:e,width:"300",height:"auto"})}}).submit()}function p(){var t={};return $.ajax({url:Base.sitUrl+"/api/email/setting/v1/templates/search",type:"GET",success:function(t){if(!t.success)return void $.unLogin(t);for(var e=t.data,n="",i=0;i<e.length;i++)n+='<li data-value="'+e[i].value+'">'+e[i].name+"</li>";$(".add-model").empty(),$(".add-model").append(n)}}),t}function b(){var t=$("#subject").val(),e=$("#subject1").val(),n=$("#subject2").val(),i=$("#subject3").val(),a='"subject":"'+t+'","subject1":"'+e+'","subject2":"'+n+'","subject3":"'+i+'"';return a}function m(){for(var t=$("#addFiles1").find("li"),e="",n="",i=0;i<t.length;i++){var a=t.eq(i).attr("data-url"),s=t.eq(i).find(".filesName").text(),l=t.eq(i).attr("data-size"),o={fileUrl:a,filename:s,size:parseInt(l)};fileJson=JSON.stringify(o)+",",e+=fileJson}return e=e.substring(0,e.length-1),n="["+e+"]"}function v(t){return null==t||void 0==t?"":t}function f(){var t=o();t=t.replace(/"/g,"&#39;");var e=b(),n=m(),i="{"+e+',"content":"'+t+'","addressMode":2,"address":{'+x+'},"attachments":'+n+"}";return""==t?$.Alert("邮件内容不能为空"):i}function g(){$.ajax({url:Base.sitUrl+"/api/edm/v1/over/count",type:"GET",dataType:"json",success:function(t){return t.success?(null==t.data&&(t.data=0),void $("#surplusNum").text(t.data)):void $.unLogin(t)}})}function h(t){var e,n={value:t};return $.ajax({url:Base.sitUrl+"/api/email/v1/visitingcard",type:"POST",dataType:"json",async:!1,data:{data:JSON.stringify(n)},success:function(t){if(!t.success)return void $.unLogin(t);var n=t.data,i=n.status,a=n.isHighSeas,s=n.customerName,l="";switch(1==a&&(l="<span>公海</span>"),i){case 1:html2='<ul><li><div class="sender-condition"><div class="sender-condition-img"><span class="ellipsis sender-condition-name">'+n.title+'</span></div><button type="button" class="btn btn-primary btn-lg btn-block btn-blockAdd">添加为联系人</button><div class="btn-group condition-cz-btn" role="group" style="margin-left:-118px;"><button type="button" class="btn btn-default newtongxunlu">添加通讯录</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 2:html2='<ul><li><div class="sender-condition"><div class="sender-condition-img"><span class="ellipsis sender-condition-name">'+n.title+'</span></div><button type="button" class="btn btn-primary btn-lg btn-block btn-blockAdd">添加为联系人</button><div class="btn-group condition-cz-btn" role="group" style="margin-left:-118px;"><button type="button" class="btn btn-default tongxunlu">通讯录好友</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 3:html2='<ul><li data-customer="'+n.customerId+'" data-cont="'+n.customerContactsId+'"><div class="sender-condition"><div class="sender-condition-img"><span class="ellipsis sender-condition-name">'+n.title+'</span></div><div class="company-info"><i class="pub-icon ding-icon"></i><span class="ellipsis company-name name-blue">'+s+'</span></div><div class="belong-yewuy"><label>所属业务员：</label><span>'+n.salesmanName+'</span></div><button type="button" class="btn btn-primary btn-lg btn-block btn-blockDetail">查看联系人</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin">写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 4:html2='<ul><li data-customer="'+n.customerId+'"><div class="sender-condition"><div class="sender-condition-img"><span class="ellipsis sender-condition-name">'+n.title+'</span></div><div class="company-info"><i class="pub-icon ding-icon"></i><span class="ellipsis company-name name-blue">'+s+'</span></div><div class="belong-yewuy"><label>所属业务员：</label><span>'+n.salesmanName+'</span></div><button type="button" class="btn btn-primary btn-lg btn-block btn-blockAdd">添加为联系人</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin" disabled>写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 5:html2='<ul><li data-id="'+n.id+'" data-customer="'+n.customerId+'"><div class="sender-condition"><div class="sender-condition-img"><i class="pub-icon sender3-icon" style="top:0;"></i><span class="ellipsis sender-condition-name">'+n.title+'</span></div><div class="company-info"><i class="pub-icon ding-icon"></i><span class="ellipsis company-name name-blue">'+s+'</span></div><div class="belong-yewuy"><label>所属业务员：</label>'+l+'</div><button type="button" class="btn btn-primary btn-lg btn-block btn-privateCont">添加到私海</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin" disabled>写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 6:html2='<ul><li data-id="'+n.id+'" data-customer="'+n.customerId+'"><div class="sender-condition"><div class="sender-condition-img"><i class="pub-icon sender3-icon" style="top:0;"></i><span class="ellipsis sender-condition-name">'+n.title+'</span></div><div class="company-info"><i class="pub-icon ding-icon"></i><span class="ellipsis company-name name-blue">'+s+'</span></div><div class="belong-yewuy"><label>所属业务员：</label>'+l+'</div><button type="button" class="btn btn-primary btn-lg btn-block btn-privateCust">添加到私海</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin" disabled>写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 7:html2='<ul><li data-id="'+n.id+'" data-customer="'+n.customerId+'"><div class="sender-condition"><div class="sender-condition-img"><i class="pub-icon sender2-icon" style="top:0;"></i><span class="ellipsis sender-condition-name">'+n.title+'</span></div><div class="company-info"><i class="pub-icon ding-icon"></i><span class="ellipsis company-name name-blue">'+s+'</span></div><div class="belong-yewuy"><label>所属业务员：</label><span>'+n.salesmanName+'</span></div><button type="button" class="btn btn-default btn-lg btn-block btn-blockDetail btn-gray" disabled>查看联系人</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin" disabled>写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go" disabled>往来邮件</button></div></div></li></ul>';break;case 8:html2='<ul><li data-id="'+n.id+'" data-customer="'+n.customerId+'"><div class="sender-condition"><div class="sender-condition-img"><i class="pub-icon sender2-icon" style="top:0;"></i><span class="ellipsis sender-condition-name">'+n.title+'</span></div><div class="company-info"><i class="pub-icon ding-icon"></i><span class="ellipsis company-name name-blue">'+s+'</span></div><div class="belong-yewuy"><label>所属业务员：</label><span>'+n.salesmanName+'</span></div><button type="button" class="btn btn-default btn-lg btn-block btn-gray btn-blockAdd" disabled>添加联系人</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin" disabled>写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go" disabled>往来邮件</button></div></div></li></ul>'}e=html2}}),e}window.ZeroClipboard=e,t.init(),$(".letter-detail").on("click",".sender-time-icon",function(t){$.EventFn(t),$(".check-time").css("display","inline-block")}),$(".check-time").change(function(){var t=$(this).val(),e=$(this).prev().prev(),n=Number(e.attr("data-time"));e.text($.calcTime(e.text(),n,t)).attr("data-time",t)});var y=$.GetQueryString("id");$(".contUl li").eq(0).on("click",function(){$(".letterAll").css("display","inline-block"),$(".letterAll").siblings().css("display","none"),$(".letterDown").css("display","inline-block")}),$(".contUl li").eq(1).on("click",function(){$(".letterSend1").css("display","inline-block"),$(".letterSend1").siblings().css("display","none"),$(".letterSend0").css("display","inline-block"),$(".letterDown").css("display","inline-block")}),$(".contUl li").eq(2).on("click",function(){$(".letterOpen1").css("display","inline-block"),$(".letterOpen1").siblings().css("display","none"),$(".letterOpen0").css("display","inline-block"),$(".letterDown").css("display","inline-block")}),$(".contUl li").eq(3).on("click",function(){$(".letterBack0").css("display","inline-block"),$(".letterBack0").siblings().css("display","none"),$(".letterDown").css("display","inline-block")}),$(".contUl li").eq(4).on("click",function(){$(".letterFaile").css("display","inline-block"),$(".letterFaile").siblings().css("display","none"),$(".letterDown").css("display","inline-block")}),$.daochu=function(){var t=$(".contUl").find("li.active").attr("data-type");window.location.href=Base.sitUrl+"/api/edm/v1/export/contacts?id="+y+"&type="+t};var k={homepage:1,currentPage:1,lastpage:null,pageSize:10},w=["#6289FF","#35C274","#35B0C2","#FFAB17","#FF586C"];$(".contUl li").on("click",function(){var t=$(".contUl li").index(this);$(".contUl li").css("background",""),$(".contUl li").eq(t).css("background",w[t]),$(".con_icon div").hide(),$(".con_icon div").eq(t).show(),$(this).addClass("active").siblings().removeClass("active"),k.currentPage=1;var e=$(this).attr("data-type");l(e)});$(".i-left").unbind("click").on("click",function(){$("#letterContent").hide(),$("#letterStatistics").show()}),$("#letterContentBtn").on("click",function(){$("#letterContent").show(),$("#letterStatistics").hide(),$(".email-detail-main-content").attr("src",Base.sitUrl+"/html/read.html?type=3&id="+y+"&v="+window.ver)}),$.devLetterDetail=function(t){var e="";$(".detailSender").val(t.from),$("#ltContTitle").text(t.subject),$("#ltContTitle1").val(t.subject1),$("#ltContTitle2").val(t.subject2),$("#ltContTitle3").val(t.subject3),$(".sender-info-time").text(a(new Date(t.createTime)));for(var n=0;n<t.attachments.length;n++){var i=t.attachments[n].attachmentSize/1024;i=i.toFixed(2)+"MB",e+='<div class="fujian"><i class="pub-icon fujian2-icon"></i><span class="fujianName" data-url="'+t.attachments[n].attachment+'">'+t.attachments[n].attachmentName+"</span><span>("+i+')</span><a href="#" class="blue">另存为</a></div>'}$("#fujian").empty().append(e)},$(document).on("click",".fujian>a",function(){var t=$(this).parent().find(".fujianName").text(),e=$(this).parent().find(".fujianName").attr("data-url"),n={name:t,value:e};n=JSON.stringify(n),window.location.href=Base.sitUrl+"/api/file/download?data="+n}),n(),$(".contUl li").eq(0).click();var x="";$(".letterAll").on("click",function(){$("#letterStatistics").hide(),$("#secondLetter").show(),p(),g(),$.ajax({url:Base.sitUrl+"/api/edm/v1/secondary/marketing",type:"POST",dataType:"json",async:!1,data:{id:y,type:1,status:0},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;$("#emailAccountNum").text(e.length);for(var n=0;n<e.length;n++)x+='"'+e[n]+'":"",';x=x.substring(0,x.length-1)}})}),$(".letterSend1").on("click",function(){$("#letterStatistics").hide(),$("#secondLetter").show(),p(),g(),$.ajax({url:Base.sitUrl+"/api/edm/v1/secondary/marketing",type:"POST",dataType:"json",async:!1,data:{id:y,type:2,status:1},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;$("#emailAccountNum").text(e.length);for(var n=0;n<e.length;n++)x+='"'+e[n]+'":"",';x=x.substring(0,x.length-1)}})}),$(".letterSend0").on("click",function(){$("#letterStatistics").hide(),$("#secondLetter").show(),p(),g(),$.ajax({url:Base.sitUrl+"/api/edm/v1/secondary/marketing",type:"POST",dataType:"json",async:!1,data:{id:y,type:2,status:2},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;$("#emailAccountNum").text(e.length);for(var n=0;n<e.length;n++)x+='"'+e[n]+'":"",';x=x.substring(0,x.length-1)}})}),$(".letterOpen1").on("click",function(){$("#letterStatistics").hide(),$("#secondLetter").show(),p(),g(),$.ajax({url:Base.sitUrl+"/api/edm/v1/secondary/marketing",type:"POST",dataType:"json",async:!1,data:{id:y,type:3,status:1},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;$("#emailAccountNum").text(e.length);for(var n=0;n<e.length;n++)x+='"'+e[n]+'":"",';x=x.substring(0,x.length-1)}})}),$(".letterOpen0").on("click",function(){$("#letterStatistics").hide(),$("#secondLetter").show(),p(),g(),$.ajax({url:Base.sitUrl+"/api/edm/v1/secondary/marketing",type:"POST",dataType:"json",async:!1,data:{id:y,type:3,status:2},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;$("#emailAccountNum").text(e.length);for(var n=0;n<e.length;n++)x+='"'+e[n]+'":"",';x=x.substring(0,x.length-1)}})}),$(".letterBack0").on("click",function(){$("#letterStatistics").hide(),$("#secondLetter").show(),p(),g(),$.ajax({url:Base.sitUrl+"/api/edm/v1/secondary/marketing",type:"POST",dataType:"json",async:!1,data:{id:y,type:4,status:0},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;$("#emailAccountNum").text(e.length);for(var n=0;n<e.length;n++)x+='"'+e[n]+'":"",';x=x.substring(0,x.length-1)}})}),$(".letterFaile").on("click",function(){$("#letterStatistics").hide(),$("#secondLetter").show(),p(),g(),$.ajax({url:Base.sitUrl+"/api/edm/v1/secondary/marketing",type:"POST",dataType:"json",async:!1,data:{id:y,type:5,status:0},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;$("#emailAccountNum").text(e.length);for(var n=0;n<e.length;n++)x+='"'+e[n]+'":"",';x=x.substring(0,x.length-1)}})});var j={letter:null,type:null,toolbars:[["fontsize","forecolor","backcolor","|","bold","italic","|","underline","formatmatch","insertorderedlist","insertunorderedlist","justifyleft","justifyright","justifycenter","justifyjustify","|","link","unlink","inserttable","fullscreen","cleardoc","emotion","source"]],createEditor:function(){j.letter=UE.getEditor("letterEditor",{toolbars:j.toolbars,initialFrameWidth:"100%",initialFrameHeight:360})}};j.createEditor(),$("#btnOne .btn").on("click",function(){return parseInt($("#surplusNum").text())<0?void $.Alert("您的营销信不足"):($("#stepTwo").show(),$("#stepTwo").siblings(".stepBlock").hide(),$("#stepShow").empty(),$("#stepShow").append('<img src="../images/step2.png">'),void 0)}),$("#backStepTwo").on("click",function(){$("#stepOne").show(),$("#stepOne").siblings(".stepBlock").hide(),$("#stepShow").empty(),$("#stepShow").append('<img src="../images/step1.png">')}),$("#btnTwo .btn").on("click",function(){""==$("#subject").val()?$.Alert("请填写营销主题"):""==$("#subject1").val()&&""==$("#subject2").val()&&""==$("#subject3").val()?$.Alert("至少填写一个邮件主题"):($("#stepThree").show(),$("#stepThree").siblings(".stepBlock").hide(),$("#stepShow").empty(),$("#stepShow").append('<img src="../images/step3.png">'))}),$("#backStepThree").on("click",function(){$("#stepTwo").show(),$("#stepTwo").siblings(".stepBlock").hide(),$("#stepShow").empty(),$("#stepShow").append('<img src="../images/step2.png">')});var S=/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/;$(".stepCont2 input").on("keydown",function(t){var e=$(this).val();if(13==t.keyCode&&""!==e){if(S.test(e)){var n='<span class="emailAccount left"><i class="s-customer left"></i><label class="emailLabel">'+e+'</label><i class="i-emailClose"></i></span>';$(".stepCont2 input").before(n),$(".stepCont2 input").val("")}else $.Alert("邮箱格式错误");$("#copyEmail").text($(".stepCont2").find(".emailAccount ").length)}8==t.keyCode&&""==e&&$(this).prev("span").remove()}),$("#custModels>p>a").on("click",function(){$(this).addClass("active"),$(this).siblings().removeClass("active")}),$(".add-attachment").unbind("click").on("click",function(){return $("#addFiles").children("li").length>0?($.Alert("只支持一个上传文件"),!1):$("#up-files").click()}),$("#up-files").on("change",function(t){$.EventFn(t);var e=r($(this)),n=$("#up-files").val(),i=n.lastIndexOf("."),a=n.substring(i,n.length).toUpperCase();return".XLSX"!=a&&".XLS"!=a&&".TXT"!=a?($.Alert("请上传txt或excle文件"),!1):void(e.flag&&c(e.name))}),$(".add-attachment1").unbind("click").on("click",function(){return $("#up-files1").click()}),$("#up-files1").on("change",function(t){$.EventFn(t);var e=r($(this));e.flag&&d(e.name,e.size)}),$(document).on("click",".file-del",function(){$(this).parents("li").remove()}),$(".add-images").unbind("click").on("click",function(){$("input[name=upImgs]").click(),$("input[name=upImgs]").unbind("change").on("change",function(t){$.EventFn(t);var e=r($(this));e.flag&&u(e.name)})}),$(".add-tem").unbind("click").on("click",function(t){$.EventFn(t),"block"==$("#custModels").css("display")?$("#custModels").hide():$("#custModels").show()}),$("#stepThree").on("click",".add-model li",function(t){$.EventFn(t);var e=$(this).attr("data-value");UE.getEditor("letterEditor").execCommand("inserthtml",e),$("#custModels").hide()}),$(".add-cont").unbind("click").on("click",function(t){$.EventFn(t);var e="#contactname#";UE.getEditor("letterEditor").execCommand("inserthtml",e)}),$("#submit").on("click",function(){var t=f();$.ajax({url:Base.sitUrl+"/api/edm/v1/send",type:"POST",dataType:"json",data:{data:t},success:function(t){if(t.success){$("#stepFour").show(),$("#stepFour").siblings(".stepBlock").hide(),$("#stepShow").empty(),$("#stepShow").append('<img src="../images/step4.png">'),setTimeout("$.DestroyPopInPop()",5e3);var e=5;$.CountDown=function(){e>=0?(seconds=Math.floor(e%60),seconds=seconds>=10?seconds:"0"+seconds,msg=seconds,$("#setTimeout").text(msg),--e):clearInterval(timer)},timer=setInterval("$.CountDown()",1e3),setTimeout("parent.location.reload()",5500)}else $.unLogin(t)}})}),$("#addContTheme").bind("click",function(){"block"==$(".contTheme").css("display")?$(".contTheme").hide():$(".contTheme").show()}),$("#themecheckbox1").bind("click",function(){if(1==$(this).prop("checked"))$("#subject1").insertContent("#contactname#");else{var t=$("#subject1").val(),e=t.replace(/#contactname#/g,"");$("#subject1").val(e)}}),$("#themecheckbox2").bind("click",function(){if(1==$(this).prop("checked"))$("#subject2").insertContent("#contactname#");else{var t=$("#subject2").val(),e=t.replace(/#contactname#/g,"");$("#subject2").val(e)}}),$("#themecheckbox3").bind("click",function(){if(1==$(this).prop("checked"))$("#subject3").insertContent("#contactname#");else{var t=$("#subject3").val(),e=t.replace(/#contactname#/g,"");$("#subject3").val(e)}}),function(t){t.fn.extend({insertContent:function(e,n){var i=t(this)[0];if(document.selection){this.focus();var a=document.selection.createRange();a.text=e,this.focus(),a.moveStart("character",-l);var s=a.text.length;if(2==arguments.length){var l=i.value.length;a.moveEnd("character",s+n),n<=0?a.moveStart("character",s-2*n-e.length):a.moveStart("character",s-n-e.length),a.select()}}else if(i.selectionStart||"0"==i.selectionStart){var o=i.selectionStart,c=i.selectionEnd,d=i.scrollTop;i.value=i.value.substring(0,o)+e+i.value.substring(c,i.value.length),this.focus(),i.selectionStart=o+e.length,i.selectionEnd=o+e.length,i.scrollTop=d,2==arguments.length&&(i.setSelectionRange(o-n,i.selectionEnd+n),this.focus())}else this.value+=e,this.focus()}})}(jQuery),$(".tableCont").unbind("mouseenter").on("mouseenter",".liEmail",function(){var t=$(this).find(".liEmailLabel").text(),e=h(t);if($(this).parents("li").find(".sender-condition-style").empty(),$(this).parents("li").find(".sender-condition-style").append(e),"1"==$(this).parents("li").attr("data-num")){var n=$(this).find(".sender-condition-style").height()-10,i="-"+n+"px";$(this).find(".sender-condition-style").css("top",i)}$(this).parents("li").find(".sender-condition-style").show()}),$(".tableCont").on("mouseleave",".liEmail",function(){$(this).parents("li").find(".sender-condition-style").hide()}),$(".tableCont").on("click",".xiegenjin",function(e){$.EventFn(e);var n=$(this).closest("tr").find("input[name=batch]").attr("data-id");t.showTab(Base.url+"/html/pop-upload.html?id="+n+"&v="+window.ver,"写跟进")}),$(".tableCont").on("click",".newtongxunlu",function(e){$.EventFn(e);var n=$(this).closest("tr").find("input[name=batch]").attr("data-id");t.showTab(Base.url+"/html/pop-statistics-new.html?id="+n+"&v="+window.ver,"新建通讯录")}),$(".tableCont").on("click",".tongxunlu",function(e){$.EventFn(e);$(this).closest("tr").find("input[name=batch]").attr("data-id");t.showTab(Base.url+"/html/email-statistics.html?&v="+window.ver,"通讯录")}),$(".tableCont").on("click",".fayoujian",function(e){$.EventFn(e);var n=$(this).closest("tr").find("input[name=batch]").attr("data-id");t.showTab(Base.url+"/html/pop-email-new.html?type=0&id="+n+"&v="+window.ver,"发邮件")}),$(".tableCont").on("click",".btn-privateCust",function(t){$.EventFn(t);var e=$(this).closest("tr").find("input[name=batch]").attr("data-id"),n={id:e},i=$(this);$.ajax({url:Base.sitUrl+"/api/customer/v1/into/private/seas",type:"POST",dataType:"json",data:{data:JSON.stringify(n)},success:function(t){i.text("已添加到私海")}})}),$(".tableCont").on("click",".btn-privateCont",function(t){$.EventFn(t);var e=$(this).closest("tr").find("input[name=batch]").attr("data-id"),n={id:e},i=$(this);$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/into/private/seas",type:"POST",dataType:"json",data:{data:JSON.stringify(n)},success:function(t){i.text("已添加到私海")}})}),$(".tableCont").on("click",".come-go",function(e){$.EventFn(e);var n=$(this).parent().prevAll(".sender-condition-img").find(".sender-condition-name").text();t.showTab(Base.url+"/html/pop-come-go-email.html?email="+n+"&v="+window.ver,"往来邮件")}),$(".tableCont").on("click",".btn-blockAdd",function(e){$.EventFn(e);var n=$(this).parents("li").find(".liEmailLabel").text();t.showTab(Base.url+"/html/pop-contacts-add.html?name="+n+"&v="+window.ver,"添加联系人")}),$(".tableCont").on("click",".btn-blockDetail",function(e){$.EventFn(e);var n=$(this).parents("li").attr("data-cont");t.showTab(Base.url+"/html/pop-relation-detail.html?id="+n+"&v="+window.ver,"联系人详情")}),$(".tableCont").on("click",".company-name",function(e){$.EventFn(e);var n=$(this).parents("li").attr("data-customer");t.showTab(Base.url+"/html/pop-customer-detail.html?id="+n+"&v="+window.ver,"客户详情")}),$.getFrame=function(t){var e=$("html").height()-$("#header-h").height()-30;e>t?$(".email-detail-main").height(e):$(".email-detail-main").height(t)}})});