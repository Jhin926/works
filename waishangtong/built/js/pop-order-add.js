require(["common"],function(){require(["maintab","ZeroClipboard","ueditorLang","blockUI","jqform","datetimepickerCN"],function(e,t){window.ZeroClipboard=t;var a=parseInt($.GetQueryString("id")),i=parseInt($.GetQueryString("piId")),r=$.GetQueryString("type"),n=parseInt($.GetQueryString("custId")),s=Number($.GetQueryString("pIdx")),o=$("#addOrderForm");jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({language:"zh-CN",todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,format:"yyyy-mm-dd",bootcssVer:3});var d={custList:[]},l={type:1,homepage:1,currentPage:1,lastpage:null,pageSize:10},c={homepage:1,currentPage:1,lastpage:null,pageSize:10,conditions:[]};o.on("click",".form-info .info-belong>span>i.s-dels3",function(){var e=$(this).closest(".info-belong"),t=$(".downs>.dropdowns>ul>li");e.remove();for(var a=0;a<t.length;a++){var i=t.eq(a).attr("data-id");if(e.attr("data-id")==i){t.eq(a).removeClass("active");break}}var r=u.sumPrice();o.find("#order-price").val(r)}),$(".downs").on("click",function(e){$.EventFn(e)}),o.on("click",".fieldset .file-list>li>i.s-dels2",function(){$(this).parent().remove()}),o.on("click",".quo-box i.s-del2",function(e){$.EventFn(e),$(this).closest(".quo-table-info").remove();for(var t=$(this).closest("ul").attr("data-id"),a=u.data.qSEnty,i=0;i<a.length;i++)t==a[i].itemId&&a.splice(i,1);u.data.qSEnty=a,u.amountPrice($(this).closest(".quo-table-info"));var r=u.sumPrice();$(".pi-total").val("$ "+r+" USD")}),o.on("blur",".quo-box .pi-fobPrice,.quo-box .pi-quantity",function(e){$.EventFn(e),u.amountPrice($(this).closest(".quo-table-info"));var t=u.sumPrice();o.find("#order-price").val(t),$(".pi-total").val("$ "+t+" USD")}),o.on("blur",".quo-box .pi-amount",function(e){$.EventFn(e);var t=u.sumPrice();o.find("#order-price").val(t),$(".pi-total").val("$ "+t+" USD")}),o.on("click",".quo-box .quo-select",function(e){$.EventFn(e);var t=$(this).children("ul");t.hasClass("active")?t.removeClass("active"):($(".quo-select>ul").removeClass("active"),t.addClass("active"))}),o.on("click",".quo-box .quo-select>ul>li",function(e){if($.EventFn(e),!$(this).hasClass("active")){$(this).addClass("active").siblings().removeClass("active");var t=parseInt($(this).attr("data-id"));if($(this).closest(".quo-select").find("span").attr("data-id",t),$(this).closest(".quo-select").find("span").text($(this).text()),$(this).closest("ul").removeClass("active"),$(this).parent().hasClass("fob-price-unit")){u.amountPrice($(this).closest(".quo-table-info"));var a=u.sumPrice();$(".pi-total").val("$ "+a+" USD")}}}),o.on("click",".add-info",function(e){$.EventFn(e);var t=$(".countermans .dropdowns");t.hasClass("active")?t.removeClass("active"):t.addClass("active")}),o.on("input",".form-info input",function(e){$.EventFn(e);var t=$(this).val(),a=u.getCounter,i=[];if($(this).hasClass("drop-filter")){for(var r=0;r<a.length;r++)a[r].name.indexOf(t)!=-1&&i.push(a[r]);u.showCounter(i)}}),o.on("blur",".form-info input",function(e){$.EventFn(e);var t=$(this).prop("id");if("order-name"==t)$.errorsFn($(this),"请输入订单名称");else if("order-customer"==t);else if("order-payment"==t)$.errorsFn($(this),"请输入付款方式");else if("order-delivery"==t);else if("order-buy"==t)$.errorsFn($(this),"请输入交付期限");else if("order-price"==t||"order-payfor"==t){var a=$(this).val(),i="",r=/^[0-9]+([.]{1}[0-9]+){0,1}$/;a?r.test(a)?($(this).removeClass("error"),$(this).nextAll(".errors").removeClass("active")):($(this).addClass("error"),$(this).nextAll(".errors").addClass("active"),i="请输入数值",$(this).nextAll(".errors").children().text(i)):($(this).addClass("error"),$(this).nextAll(".errors").addClass("active"),i="请输入运费",$(this).nextAll(".errors").children().text(i))}else t.indexOf("order-add")>=0&&"yes"==$(this).attr("data-isRequired")&&$.errorsFn($(this),"请输入"+$(this).parent().prev().find("span").text())}),$(".downs").on("click",".dropdowns ul>li",function(e){if($.EventFn(e),!$(this).hasClass("active")){$(this).addClass("active");for(var t=$(this).attr("data-id"),a=($(".info-belong"),""),i=u.getCounter,r=u.getPercent(),n=0;n<i.length;n++)if(i[n].id==t)return a='<div class="info-belong" data-id="'+i[n].id+'">                                <!--<img src="'+i[n].headImgUrl+'" alt="头像" />-->                                <span>'+i[n].name+'<i class="s-updownBg s-dels3"></i></span>                                <input type="text" name="percent" data-val="'+r+'" value="'+r+'%" />                            </div>',$(".countermans .form-info").prepend(a),$(this).parents(".dropdowns").removeClass("active"),!1}}),o.on("click","#order-customer",function(e){$.EventFn(e),$("#customer").modal("show")}),$(".screen-choiced").click(function(){$(".screen-list").toggle()}),$(".screen-list").on("click","li",function(){$(this).parent().hide().prev().text($(this).text()),c.currentPage=1;var e=$(this).attr("data-id");"0"!=e?c.conditions=[{filedName:"customerGroupId",operateType:"=",filedValue:e}]:c.conditions=[],u.getCustomList()}),$(".screen-input-name").change(function(){""==$(this).val()?delete c.keyword:c.keyword=$(this).val()}),$(".screen-input-btn").click(function(){u.getCustomList()}),$("#btn-sure").click(function(){var e=$(".customer-list").find("input[type=radio]:checked");e.length<=0?$.Alert("请先选择客户！"):($("#order-customer").val(e.next().text()),u.getCustInfo.id=e.val(),u.getCustInfo.name=e.next().text(),$("#customer").modal("hide"))}),$("#product-input").change(function(){l.name=$.trim($(this).val())}),$(".product-screen").click(function(){u.getResourceSettings()}),$(".product-group-check select").change(function(){var e=$(this).val();""==e&&(e=0),l.productCatelog=e,u.getResourceSettings()}),$("#product-type0,#product-type1,#product-type2,#product-type3").change(function(){var e=$(this).find("option:selected").val();""==e&&(e=0),l.productType=e,u.getResourceSettings(),u.getProductsType(e,$(this))}),$("#product-sure").click(function(){var e=$(".product-list li input[type=checkbox]:checked");if(e.length>0){for(var t=0;t<e.length;t++){var a=e.eq(t).parent().attr("data-id");u.addProductItem(a)}$("#products").modal("hide")}else $.Alert("请至少选择一个产品！")}),o.on("click",".model-select",function(e){$.EventFn(e);var t=$(this).children("ul");t.hasClass("active")?t.removeClass("active"):($(".model-select").children().removeClass("active"),t.addClass("active"))}),o.on("click",".model-select>ul>li",function(e){$.EventFn(e);var t=$(this).parent(),a=t.prev("label"),i=$(this).text(),r=$(this).attr("data-id");a.attr("data-id",r),$(this).addClass("active").siblings().removeClass("active"),a.text(i),t.removeClass("active")}),o.on("click",".order-files",function(){$("#up-files").click()}),o.on("change",".fieldset #up-files,#upImgs",function(){var e=p.fileLimit($(this)),t=$("#form_file"),a=$(this).attr("data-type");e.flag&&("img"==a&&(t=$("#form_img")),p.uploadImg(e.name,t,a))}),o.on("click","i.s-img",function(){$("#upImgs").click()}),$(document.body).on("click",function(){0==$(this).closest(".quo-select").length&&$(".quo-select>ul").removeClass("active"),0==$(this).closest(".downs").length&&$(".countermans .dropdowns").removeClass("active"),0==$(this).closest(".cust-group").length&&$(".cust-group>ul").removeClass("active")}),o.on("blur",".info-belong>input",function(e){$.EventFn(e),u.getPercent();var t=$(this).val();$(this).attr("value",$(this).val()),t=t.substr(0,t.indexOf("%")),$(this).attr("data-val",t)}),o.on("click","#order-save",function(e){$.EventFn(e);var t=!0,a=$(".fieldset"),i={},r=a.find('[name="order-name"]'),n=(a.find('[name="order-price"]'),a.find('[name="order-payment"]')),s=a.find('[name="order-delivery"]'),o=a.find('[name="order-balance"]'),d=a.find('[name="order-payfor"]'),l=(a.find('[name="order-buy"]'),a.find('[name="order-customer"]')),c=a.find("#o-price"),f=a.find("#o-payfor"),v=a.find(".info-belong"),m=a.find(".quo-table-info"),h=a.find(".file-list>li"),g=[];if(t=$.errorsFn(r,"请输入订单名称"),t=$.errorsFn(n,"请输入付款方式"),t=$.errorsFn(d,"请输入运费"),t=$.errorsFn(s,"请输入交付日期"),t=$.errorsFn(o,"请输入结算日期"),t=$.errorsFn(l,"请输入购买方式"),t=$.errorsFn(l,"请选择客户"),d){var y=d.val(),b="",x=/^[0-9]+([.]{1}[0-9]+){0,1}$/;x.test(y)?($(this).removeClass("error"),$(this).nextAll(".errors").removeClass("active")):($(this).addClass("error"),$(this).nextAll(".errors").addClass("active"),b="请输入数值",$(this).nextAll(".errors").children().text(b))}c.attr("data-id")!=-1&&f.attr("data-id")!=-1||($.Alert("请选择单位"),t=!1),i.name=r.val(),i.orderNo=a.find('[name="order-no"]').val(),i.orderAmount=a.find('[name="order-price"]').val(),i.orderAmountUnit=parseInt(a.find("#o-price").attr("data-id")),i.freight=a.find('[name="order-payfor"]').val(),i.freightUnit=parseInt(a.find("#o-payfor").attr("data-id")),i.paymentMethod=a.find('[name="order-payment"]').val(),i.termOfDelivery=a.find('[name="order-buy"]').val(),i.dateOfDelivery=a.find('[name="order-delivery"]').val(),i.balanceDate=a.find('[name="order-balance"]').val(),i.customerId=u.getCustInfo.id,i.customerName=u.getCustInfo.name,i.remark=p.order.getContent(),i.productOrderDetails=[],i.productOrderSalesmans=[],i.productOrderAnnexs=[],i.sysDefinedValueEnters=[],a.find("[name^=order-add]").each(function(){if(""!=$(this).val()){var e={};e.attributeId=$(this).attr("data-id"),e.code=$(this).attr("data-code"),e.value=$(this).val(),i.sysDefinedValueEnters.push(e)}});var q=0;if($(".info-belong").each(function(){var e=$(this).children("input").val();q+=e.lastIndexOf("%")!=-1?parseInt(e.substr(0,e.lastIndexOf("%"))):parseInt(e)}),q>100&&($.Alert("分配份额不能超过100%"),t=!1),m.length>0){for(var C=u.data.qSEnty,I=0;I<C.length;I++){var P=m.eq(I),k=parseFloat(P.find('[name="pi-amount"]').val().substr(1));C[I].productName=P.find('[name="pi-name"]').val(),C[I].price=parseFloat(P.find('[name="pi-fobPrice"]').val()).toFixed(2),C[I].priceCurrency=parseInt(P.find(".punit").attr("data-id")),C[I].quantityUnit=parseInt(P.find(".qunit").attr("data-id")),C[I].orderQuantity=parseInt(P.find('[name="pi-quantity"]').val()),C[I].amount=k}i.productOrderDetails=C}else $.Alert("请添加至少一个产品"),t=!1;if(v.length>0){for(var O=0,w=0;w<v.length;w++){var P=v.eq(w),q=parseFloat((parseFloat(P.find('[name="percent"]').attr("data-val")).toFixed(2)/100).toFixed(2));O+=q,g.push({salesmanId:parseInt(P.attr("data-id")),salesmanName:P.children("span").text(),avatar:P.children("img").prop("src"),proportion:q})}O<1&&($.Alert("业务员归属比例总和需达到100%！"),t=!1),i.productOrderSalesmans=g,g=[]}else $.Alert("业务员归属比例总和需达到100%！"),t=!1;if(h.length>0){for(var F=0;F<h.length;F++){var S=h.eq(F);g.push({name:S.children("span").text(),path:S.attr("data-url")})}i.productOrderAnnexs=g,g=[]}t&&u.saveOrder(i)});var u={getCounter:[],custList:[],productList:[],getCustInfo:{},unit:{price:[],quantity:[]},data:{iSEnty:[],qSEnty:[]},count:1,getNo:function(){1!=r&&$.ajax({url:Base.sitUrl+"/api/odd/v1/order/number",type:"GET",dataType:"json",success:function(e){return e.success?void o.find("#order-no").val(e.data):void $.Alert("生成订单号失败,"+e.message)}})},getOrderDefined:function(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/staff/defined/attribute/list",data:{data:JSON.stringify({bizType:3})},dataType:"json",type:"GET",success:function(e){if(!e.success)return void alert(e.message);for(var t=e.data,a=1,i=0;i<t.length;i++){var r=t[i],n="";1==r.removable&&(n=1==r.required?'<div class="box-title"><label for="order-add'+a+'"><i>*</i><span>'+r.name+'</span></label>                                <div class="form-info"><input data-code="'+r.code+'" data-id="'+r.id+'" data-isRequired="yes" type="text" id="order-add'+a+'" name="order-add'+a+'" class="inputs" /><div class="errors"><span>请输入数值</span></div></div><div class="clear"></div></div>':'<div class="box-title"><label for="order-add'+a+'"><span>'+r.name+'</span></label>                                <div class="form-info"><input data-code="'+r.code+'" data-id="'+r.id+'" data-isRequired="no" type="text" id="order-add'+a+'" name="order-add'+a+'" class="inputs" /></div><div class="clear"></div></div>',a++,$("#order-add").prepend(n))}}})},getOrderById:function(){a&&$.ajax({url:Base.sitUrl+"/api/order/v1/order/detail",type:"POST",data:{id:a},dataType:"json",success:function(e){if(!e.success)return void $.Alert("获取订单详情失败,"+e.message);var t=e.data,a=o.find(".cust-group>ul>li"),i=(a.length,o.find("#o-price").next("ul").children("li")),n=o.find("#o-payfor").next("ul").children("li"),s=t.productOrderDetails,d="",l="";o.find("#order-name").val(t.name),o.find("#order-price").val(t.orderAmount),1==r&&o.find("#order-no").val(t.orderNo),o.find("#order-payfor").val(t.freight),o.find("#order-payment").val(t.paymentMethod),o.find("#order-buy").val(t.termOfDelivery),o.find("#order-delivery").val(t.dateOfDelivery),o.find("#order-balance").val(t.balanceDate),o.find("#order-customer").val(t.customerName),u.getCustInfo.id=t.customerId,u.getCustInfo.name=t.customerName,p.order.setContent(t.remark,!1);for(var c=0;c<i.length;c++)if(t.orderAmountUnit==i.eq(c).attr("data-id")){i.eq(c).addClass("active"),o.find("#o-price").attr("data-id",t.orderAmountUnit),o.find("#o-price").text(i.eq(c).text());break}for(var c=0;c<n.length;c++)if(t.freightUnit==n.eq(c).attr("data-id")){n.eq(c).addClass("active"),o.find("#o-payfor").attr("data-id",t.freightUnit),o.find("#o-payfor").text(i.eq(c).text());break}if(t.productOrderAnnexs.length>0)for(var f=0;f<t.productOrderAnnexs.length;f++){var v=t.productOrderAnnexs[f];d+='<li data-url="'+v.path+'"><span>'+v.name+'</span><i class="s-updownBg s-dels2 pull-right"></i></li>'}var m=t.sysDefinedValueEnters;if(m.length>0)for(var h=0;h<m.length;h++){var g=m[h].attributeId;$("input[data-id="+g+"]").val(m[h].value)}if(t.productOrderSalesmans.length>0)for(var y=0;y<t.productOrderSalesmans.length;y++){var b=t.productOrderSalesmans[y],x=100*parseFloat(b.proportion);l+='<div class="info-belong" data-id="'+b.id+'">                                                    <span>'+b.salesmanName+'<i class="s-updownBg s-dels3"></i></span>                                                    <input type="text" name="percent" data-val="'+x+'" value="'+x+'%"></div>'}o.find(".countermans .form-info").prepend(l);for(var q=0;q<s.length;q++)u.addProductItem(s[q].id,s);o.find(".file-list").empty(),o.find(".file-list").append(d)}})},getPIByid:function(){i&&$.ajax({url:Base.sitUrl+"/api/pi/v1/pi/detail",data:{id:i},type:"POST",dataType:"json",success:function(e){if(!e.success)return void $.Alert("获取失败,"+e.message);var t=e.data,a=t.productPiDetails;u.productList=a,$("#order-name").val(t.name),$("#order-payfor").val(t.freight),$("#order-payment").val(t.termOfPayment),$("#order-buy").val(t.termOfDelivery),$("#order-delivery").val(t.dateOfDelivery),$("#order-balance").val(t.balanceDate),$("#order-customer").val(t.customerName),$("#order-customer").attr("data-id",t.customerId);for(var i=0;i<a.length;i++)u.addProductItem(a[i].id)}})},saveOrder:function(e){$.ajax({url:Base.sitUrl+"/api/order/v1/order/save",data:{data:JSON.stringify(e)},type:"POST",dataType:"json",success:function(e){return e.success?void(n?$.Alert("订单保存成功！","",function(){var e=parent.me.tabIdx();parent.me.refresh2(s,"part"),parent.me.closeOne(e,!0)}):($.DestroyPopInPop(),parent.location.reload())):void $.Alert("订单保存失败,"+e.message)}})},getPercent:function(){var e=100,t=0;return $(".info-belong").each(function(){var e=$(this).children("input").val();t+=e.lastIndexOf("%")!=-1?parseInt(e.substr(0,e.lastIndexOf("%"))):parseInt(e)}),t>100?($.Alert("分配份额不能超过100%"),0):e=Math.abs(e-t)},getDicts:function(e,t){$.ajax({url:Base.sitUrl+"/api/sys/v1/sys/dictionary/get",data:{group:e},type:"POST",dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);var i=a.data,r=t.attr("id");i.length>0&&("currency"==e?u.unit.price=i:"unit"==e&&(u.unit.quantity=i),"o-price"==r||"o-payfor"==r?(u.unit.price=i,u.showDicts2(i,t.next("ul"))):u.showDicts(i,t))}})},showDicts:function(e,t){for(var a="",i=0;i<e.length;i++)a+='<li data-id="'+e[i].id+'">'+e[i].value+"</li>";t.empty().append(a)},showDicts2:function(e,t,a){for(var i="",r=0;r<e.length;r++)i+='<li data-id="'+e[r].id+'">'+e[r].value+"</li>",e[r].id==a&&t.prev("label").children("span").attr("data-id",e[r].id).text(e[r].value);t.empty().append(i)},getCounterman:function(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/principal/list",type:"GET",dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data;u.getCounter=t,u.showCounter(t)}})},showCounter:function(e){var t,a="",i=[],r=[];if($(".info-belong").each(function(){i.push(parseInt($(this).attr("data-id")))}),e.length>0)for(var n=0;n<e.length;n++){r=e[n].name,t=escape(e[n].name).indexOf("%u")<0?r.substring(0,2).toUpperCase():r.substring(0,1);e[n].avatar||"../images/user.jpg";a+=i.indexOf(e[n].id)!=-1?'<li class="active" data-id="'+e[n].id+'"><span class="useName use_name">'+t+"</span><span>"+e[n].name+"</span></li>":'<li data-id="'+e[n].id+'"><span class="useName">'+t+"</span><span>"+e[n].name+"</span></li>"}else a="无过滤信息";$(".dropdowns>ul").empty(),$(".dropdowns>ul").append(a)},getCustomList:function(){$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/list/query",type:"POST",data:{data:JSON.stringify(c)},dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data;e.data.totalItem;d.custList=t.results,u.showCustomItem(t)}})},getCustomGroups:function(e){$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/group/list",type:"GET",success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data;if(t.length>0){for(var a='<li data-id="0">全部分组</li>',i=0;i<t.length;i++)a+='<li data-id="'+t[i].id+'">'+t[i].name+"</li>";$(".screen-list").empty().append(a)}}})},showCustomItem:function(e){if(0==d.custList.length)$(".customer-list").empty().html('<p class="customer-none">没有匹配客户！</p>');else{for(var t="<ul>",a=0;a<d.custList.length;a++)t+='<li>                            <input type="radio" name="customer" value="'+d.custList[a].id+'" />                            <span>'+d.custList[a].name+"</span>                            </li>";$(".customer-list").empty().append(t)}var i=e.totalItem,r=Math.ceil(e.totalItem/e.pageSize);$.Page({total:i,_class:".customer-page",nowNum:c.currentPage,allNum:r,callback:function(e,t){c.currentPage=e,u.getCustomList()}})},sumPrice:function(){var e=0;return $(".quo-table-info").each(function(){var t=parseFloat($(this).children("li").eq(5).find(".pi-amount").val().substr(1));e+=parseFloat(t)}),parseFloat(e).toFixed(2)},amountPrice:function(e){for(var t=$(".quo-table-info"),a=0;a<t.length;a++){var i=0,r=t.eq(a).children("li"),n=e.children("li");if(t.eq(a).attr("data-id")==e.attr("data-id")&&r.eq(0).text()==n.eq(0).text()){var s=parseFloat(r.eq(3).find(".pi-fobPrice").val()),o=r.eq(3).find(".fob-price-unit").prev().children("span").text(),d=parseInt(r.eq(4).find(".pi-quantity").val()),l=r.eq(3).find(".fob-price-unit").prev().children("span");return"CNY"==o&&(s/=6.49),l.attr("data-id")==-1&&$.Alert("请选择货币单位"),i+=parseFloat(s*d),r.eq(5).find(".pi-amount").attr("data-val",i.toFixed(2)),void r.eq(5).find(".pi-amount").val("$"+i.toFixed(2))}}},addProductItem:function(e,t){var a=u.productList;t&&(a=t);for(var i={},r=0;r<a.length;r++)if(e==a[r].id){i=a[r];var n=i.productTradeInfoEnter;n&&n.hasOwnProperty("fomPriceMin")?u.data.qSEnty.push({productId:i.id,productName:i.name,price:n.fobPriceStart,priceCurrency:i.fobPriceCurrency,orderQuantity:i.minOrderQuantity,amount:0,quantityUnit:i.minOrderQuantityUnit,productPhoto:i.productPhoto||i.imgs}):u.data.qSEnty.push({productId:i.id,productName:i.productName,price:i.price,priceCurrency:i.priceCurrency,orderQuantity:i.orderQuantity,amount:i.amount,quantityUnit:i.quantityUnit,productPhoto:i.productPhoto||i.imgs});break}var s="";if(i&&i.id){var d=(i.remark,{}),l={},c="",p=i.productPhoto||i.imgs;n&&n.hasOwnProperty("fomPriceMin")?(c=i.name,d.quantity=n.minOrderQuantity||0,d.qunit=n.minOrderQuantityUnit||-1,l.price=n.fomPriceMin||0,l.punit=n.fomPriceCurrency||-1):(c=i.productName,d.quantity=i.orderQuantity||0,d.qunit=i.quantityUnit||-1,l.price=i.price||0,l.punit=i.priceCurrency||-1),s='<ul class="quo-table-info" data-id="'+i.id+'">                                <li>'+u.count+'</li>                                <li>                                    <div>                                        <input type="text" class="pi-name" name="pi-name" value="'+c+'" />                                    </div>                                </li>                                <li><img src="'+p+'" alt="图片"></li>                                <li>                                    <div>                                        <input type="text" class="pi-fobPrice" name="pi-fobPrice" value="'+l.price+'" />                                        <div class="quo-select">                                            <label><span data-id="'+d.qunit+'" class="qunit">请选择</span><i class="s-updownBg s-up3"></i></label>                                            <ul class="moq-unit"></ul>                                        </div>                                        <div class="quo-select">                                            <label><span data-id="'+l.punit+'" class="punit">请选择</span><i class="s-updownBg s-up3"></i></label>                                            <ul class="fob-price-unit"></ul>                                        </div>                                    </div>                                </li>                                <li>                                    <div>                                        <input type="text" class="pi-quantity" name="pi-quantity" value="'+d.quantity+'" />                                    </div>                                </li>                                <li>                                    <div><input type="text" class="pi-amount" name="pi-amount" data-val="0" value="$0" /></div>                                </li>                                <div class="clear"></div><i class="s-updownBg s-del2"></i>                            </ul>';var f=$(".quo-table-title"),v=f.nextAll(".quo-table-info");v.length>0?v.eq(v.length-1).after(s):f.after(s),$(".quo-table-info img").error(function(){$(this).attr("src","../images/user.jpg")}),$(".quo-table-info img").load(function(){$.cutImage(this,100,100)});var m,h=$(".quo-table-info");h.each(function(){if(i.id==$(this).attr("data-id"))return m=$(this),!1}),u.unit.quantity.length>0?u.showDicts2(u.unit.quantity,m.find(".moq-unit"),d.qunit):u.getDicts("unit",m.find(".moq-unit"),d.qunit),u.unit.price.length>0?u.showDicts2(u.unit.price,m.find(".fob-price-unit"),l.punit):u.getDicts("currency",m.find(".fob-price-unit"),l.punit),u.amountPrice($(".quo-box>.quo-table-info").eq(h.length-1));var g=u.sumPrice();$(".pi-total").val("$ "+g+" USD"),o.find("#order-price").val(g),u.count++}},getResourceSettings:function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/info/list",type:"GET",data:l,beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data.results,a="";if(null!=t&&""!=t){u.productList=t;for(var i=0;i<t.length;i++)a+='<li data-id="'+t[i].id+'"><input type="checkbox" id="checkbox'+i+'" name="model-checkbox">&nbsp;<label for="checkbox'+i+'" style="display: inline-block;margin-left: 5px;margin-top: 5px;width: 500px;text-overflow: ellipsis;overflow: hidden;white-space: nowrap;">'+t[i].name+"</label></li>"}else a+='<div class="text-center">暂无产品</div>';$("#products .product-list").empty().append(a);var r=e.data.totalItem,n=Math.ceil(r/l.pageSize);$.Page({total:r,_class:".product-page",nowNum:l.currentPage,allNum:n,callback:function(e,t){l.currentPage=e,u.getResourceSettings()}})}})},getProductsGroup:function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/catelog/list",type:"GET",dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);for(var t=e.data,a='<option value="">全部</option>',i=0;i<t.length;i++)a+='<option value="'+t[i].id+'">'+t[i].name+"</option>";$(".product-group-check select").empty().append(a)}})},getProductsType:function(e,t){$.ajax({url:Base.sitUrl+"/api/product/v1/product/type/sublist?pid="+e,type:"GET",dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);for(var a=e.data,i='<option value="">全部</option>',r=0;r<a.length;r++)i+='<option value="'+a[r].id+'">'+a[r].name+"</option>";t?t.parent().next().find("select").empty().append(i):$("#product-type0").empty().append(i)}})}},p={order:null,createEditor:function(){var e=[["emotion","fontfamily","fontsize","forecolor","backcolor","|","bold","italic","|","underline","strikethrough","|","fontborder","|","subscript","superscript","|","formatmatch","|","insertorderedlist","insertunorderedlist","justifyleft","justifyright","justifycenter","justifyjustify","|","source"]];p.order=UE.getEditor("orderEditor",{toolbars:e,initialFrameWidth:"100%",elementPathEnabled:!1,autoHeightEnabled:!1,initialFrameHeight:200})},uploadImg:function(e,t,a){t.ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI(),o.find("#form_img").eq(0)[0].reset(),o.find("#form_file").eq(0)[0].reset()},success:function(t){if(!t.success)return void $.unLogin(t);var i=t.data;if("file"==a){i.length>0&&(i=i.substr(i.indexOf("meorient/")+9));var r='<li data-url="'+i+'"><span>'+e+'</span><i class="s-updownBg s-dels2 pull-right"></i></li>';$(".file-list").append(r)}else{var n='<img src="http://'+i+'" alt="插入图片">';p.order.setContent(n,!0)}}}).submit()},fileLimit:function(e){var t=!0,a=e.prop("files"),i=Math.round(a[0].size/1024*100)/100/1024;return i>1&&($.Alert("上传附件需小于1MB"),t=!1),{flag:t,name:a[0].name}}};$.when(p.createEditor(),u.getOrderDefined()).then(u.getNo()).then(u.getDicts("currency",$("#o-price,#o-payfor"))).then(u.getCounterman()).then(u.getResourceSettings()).then(u.getOrderById()).then(u.getCustomList()).then(u.getCustomGroups()).then(u.getProductsType(0)).then(u.getProductsGroup()),u.getPIByid()})});