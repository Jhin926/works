require(["common"],function(){require(["maintab","blockUI"],function(e){var t=top.funcList;$("[data-code]").each(function(){for(var e=0;e<t.length;e++)t[e].code==$(this).attr("data-code")&&$(this).removeClass("none")}),e.init();var r=parseInt($.GetQueryString("id")),n=$("#detailOrderForm"),i=$.GetQueryString("showbtn");i||$(".order-btn-group").show(),$(".fieldset").on("click",".form-group>button",function(){var t=$(this).attr("data-type");"copy"==t?e.showTab(Base.url+"/html/pop-order-add.html?type=0&id="+r+"&v="+window.ver,"新建订单"):"export"==t?a.toExport():"del"==t&&$.modalsFn($("#delsModal"),$(this))}),n.on("click",".mclose,#btn-del-no",function(){$(".modals").removeClass("active")}),n.on("click","#btn-del-ok",function(){a.delOrder()});var a={unit:{price:[],quantity:[]},getOrdersById:function(){$.ajax({url:Base.sitUrl+"/api/order/v1/order/detail",data:{id:r},type:"POST",dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data,r=t.productOrderDetails,i=t.productOrderSalesmans,o="",d="",s=a.unit.price,l=a.unit.quantity;n.find(".order-name").text(t.name);for(var c=a.unit.price,u=0;u<c.length;u++)t.orderAmountUnit==c[u].id&&(t.orderAmountUnit_text=c[u].value);if(n.find(".order-price").text(t.orderAmount+" "+t.orderAmountUnit_text),n.find(".order-payfor").text(t.paymentMethod),n.find(".order-Deadline").text(t.termOfDelivery),n.find(".order-no").text(t.orderNo),n.find(".order-date").text(t.dateOfDelivery),n.find(".order-freight").text(t.freight),n.find(".order-customer").text(t.customerName||"匿名"),n.find(".order-payment").text(t.balanceDate||""),i.length>0){for(var u=0;u<i.length;u++){var p=i[u].avatar||"../images/user.jpg";o+='<div class="info-belong">                                                <!--<img src="'+p+'" alt="头像" />-->                                                <span>'+i[u].salesmanName+'</span>                                                <span class="belong-percent">'+100*i[u].proportion+"%</span>                                            </div>"}n.find(".box-belong").empty(),n.find(".box-belong").append(o)}if(r.length>0){o="";for(var f=0;f<r.length;f++){for(var g="",m="",v=0;v<s.length;v++)r[f].priceCurrency==s[v].id&&(g=s[v].value);for(var y=0;y<l.length;y++)r[f].quantityUnit==l[y].id&&(m=l[y].value);o+='<ul class="items-infos">                                                <li>'+(f+1)+"</li>                                                <li>"+r[f].productName+'</li>                                                <li style="padding:0"><img src="'+r[f].productPhoto+'" alt="产品图片" style="padding:0"></li>                                                <li>'+g+" "+r[f].price+"/"+m+"</li>                                                <li>"+r[f].orderQuantity+"</li>                                                <li>$"+r[f].amount+'</li>                                                <div class="clear"></div>                                            </ul>'}n.find(".items-title").after(o),n.find(".items-infos img").load(function(){$.cutImage(this,100,150)})}if(n.find(".box-desc").html(t.remark),t.productOrderAnnexs.length>0){for(var h=0;h<t.productOrderAnnexs.length;h++){var x=t.productOrderAnnexs[h];d+='<li data-url="'+x.path+'"><span>'+x.name+'</span><!--<i class="s-updownBg s-dels2 pull-right"></i>--></li>'}n.find(".file-list").append(d)}for(var b=t.sysDefinedValueEnters,u=0;u<b.length;u++){var o="<li><label>"+b[u].code+'</label><span class="order-freight">'+b[u].value+"</span></li>";n.find(".order-detail ul").append(o)}}})},toExport:function(){$.ajax({url:Base.sitUrl+"/api/export/v1/order",type:"POST",data:{id:r},dataType:"json",complete:function(e){parent.location.href=Base.sitUrl+"/api/export/v1/order?id="+r}})},delOrder:function(){$.ajax({url:Base.sitUrl+"/api/order/v1/order/batch/delete",type:"POST",data:{ids:r},dataType:"json",success:function(e){return e.success?($.DestroyPopInPop(),void parent.location.reload()):void $.Alert("删除失败，",+e.message)}})},getDicts:function(e){$.ajax({url:Base.sitUrl+"/api/sys/v1/sys/dictionary/get",data:{group:e},type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var r=t.data;r.length>0&&("currency"==e?a.unit.price=r:"unit"==e&&(a.unit.quantity=r))}})}};$.when(a.getDicts("currency"),a.getDicts("unit")).done(function(){a.getOrdersById()})})});