require(["common"],function(){require(["maintab","ZeroClipboard","ueditorLang","blockUI","jqform","datetimepickerCN"],function(t,e){window.ZeroClipboard=e;var i=parseInt($.GetQueryString("id")),a=parseInt($.GetQueryString("pId")),n=parseInt($.GetQueryString("type")),r=parseInt($.GetQueryString("custId")),o=Number($.GetQueryString("pIdx")),s=$("#addPIForm");jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({language:"zh-CN",todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,format:"yyyy-mm-dd",bootcssVer:3});var l={type:1,homepage:1,currentPage:1,lastpage:null,pageSize:10},u={homepage:1,currentPage:1,lastpage:null,pageSize:10,conditions:[]},c={piInfo:{},quoHead:[],quoFoot:[],custList:[],getCustInfo:{},productList:[],data:{iSEnty:[],qSEnty:[]},unit:{price:[],quantity:[]}};s.on("click",".form-info .model-select",function(t){$.EventFn(t);var e=$(this).children("ul");e.hasClass("active")?e.removeClass("active"):e.addClass("active")}),s.on("click",".form-info .model-select>ul>li",function(t){$.EventFn(t);var e=$(this).parent(),i=e.prev(),a=$(this).attr("data-id"),n=$(this).text(),r="",o=c.quoHead;if(e.prev("label").text(n),e.removeClass("active"),"quoHead"==i.attr("id")){for(var s=0;s<o.length;s++)if(a==o[s].id){r=o[s].content;break}r=r.replace(/&#39;/g,'"'),v.head.setContent(r,!1)}else if("quoFoot"==i.attr("id")){o=c.quoFoot;for(var s=0;s<o.length;s++)if(a==o[s].id){r=o[s].content;break}r=r.replace(/&#39;/g,'"'),v.foot.setContent(r,!1)}});var d={},p=localStorage.getItem("__userInfo");p&&(d.name=p.substr(0,p.indexOf(";")),d.id=parseInt(p.substr(p.indexOf(";")+1).substr(0,p.substr(p.indexOf(";")+1).indexOf(";")))),$("#pi-seller").val(d.name),s.on("click",".editors>i.s-img",function(){v.type=$(this).attr("data-type"),$("#upImgs").click()}),s.on("click","#btn-seal",function(t){$.EventFn(t),v.type="seal",$("#upImgs").click()}),s.on("click",".info-group>a",function(t){$.EventFn(t),s.find(".seal-img>img").remove(),$(this).removeClass("active")}),s.on("change","#upImgs",function(){v.uploadImg()}),s.on("click",".quo-box i.s-del2",function(t){$.EventFn(t),$(this).closest(".quo-table-info").remove();for(var e=$(this).closest("ul").attr("data-id"),i=c.data.qSEnty,a=0;a<i.length;a++)e==i[a].productId&&i.splice(a,1);c.data.qSEnty=i,f.amountPrice($(this).closest(".quo-table-info"));var n=f.sumPrice();$(".pi-total").val("$ "+n+" USD")}),s.on("blur",".quo-box .pi-fobPrice,.quo-box .pi-quantity",function(t){$.EventFn(t),f.amountPrice($(this).closest(".quo-table-info"));var e=f.sumPrice();$(".pi-total").val("$ "+e+" USD")}),s.on("blur",".quo-box .pi-amount",function(t){$.EventFn(t);var e=f.sumPrice();$(".pi-total").val("$ "+e+" USD")}),s.on("click",".quo-box .quo-select",function(t){$.EventFn(t);var e=$(this).children("ul");e.hasClass("active")?e.removeClass("active"):($(".quo-select>ul").removeClass("active"),e.addClass("active"))}),s.on("click",".quo-box .quo-select>ul>li",function(t){if($.EventFn(t),!$(this).hasClass("active")){$(this).addClass("active").siblings().removeClass("active");var e=parseInt($(this).attr("data-id"));if($(this).closest(".quo-select").find("span").attr("data-id",e),$(this).closest(".quo-select").find("span").text($(this).text()),$(this).closest("ul").removeClass("active"),$(this).parent().hasClass("fob-price-unit")){f.amountPrice($(this).closest(".quo-table-info"));var i=f.sumPrice();$(".pi-total").val("$ "+i+" USD")}}}),$(".form-info").on("blur",">input",function(){var t=$(this).attr("id");"pi-name"==t&&$.errorsFn($(this),"请输入PI单名称")}),s.on("click","#pi-save",function(){var t={},e=!0,a=s.find("#pi-name"),r=s.find("#custName"),o=r.attr("data-id"),l=c.data.qSEnty;if(i&&(t=c.piInfo),0==n&&delete t.id,void 0==o&&r.val(""),e=$.errorsFn(a,"请输入PI单名称"),e=$.errorsFn(r,"请选择客户"),0==s.find(".quo-table-info").length&&($.Alert("请添加产品"),e=!1),""==$("#the-seller").val())return void $.Alert("请输入PI卖家");if(""==$("#the-buyer").val())return void $.Alert("请输入PI买家");for(var u=$(".quo-table-info"),d=0;d<u.length;d++){var p=u.eq(d),l=c.data.qSEnty;l[d].productName=p.find(".pi-name").val(),l[d].price=parseFloat(p.find(".pi-fobPrice").val()),l[d].priceCurrency=parseInt(p.find(".fob-price-unit").prev().children("span").attr("data-id")),l[d].quantityUnit=parseInt(p.find(".moq-unit").prev().children("span").attr("data-id")),l[d].orderQuantity=parseInt(p.find(".pi-quantity").val()),l[d].amount=parseFloat(p.find(".pi-amount").val().substr(1))}c.data.qSEnty=l,t.name=a.val(),t.customerId=parseInt(r.attr("data-id")),t.customerName=r.val(),t.piNo=s.find(".quotation-no").text(),t.freight=s.find(".pi-freight").val(),t.termOfPayment=s.find(".pi-payment").val(),t.termOfDelivery=s.find(".pi-delivery").val(),t.dateOfDelivery=s.find(".pi-dDate").val(),t.total=f.sumPrice(),t.toAddress=s.find("#pi-addr").val(),t.seller=s.find("#pi-seller").val(),t.piDate=s.find("#pi-date").val(),t.header=v.head.getContent(),t.tail=v.foot.getContent(),t.buyerSignature=s.find("#the-buyer").val(),t.sellerSignature=s.find("#the-seller").val(),t.productPiDetails=c.data.qSEnty,$(".seal-img").find("img").length>0&&(t.companyLogo=$(".seal-img img").attr("src")),e&&f.savePI(t)}),s.on("click","#custName",function(t){$.EventFn(t),$("#customer").modal("show")}),$(".screen-choiced").click(function(){$(".screen-list").toggle()}),$(".screen-list").on("click","li",function(){$(this).parent().hide().prev().text($(this).text()),u.currentPage=1;var t=$(this).attr("data-id");"0"!=t?u.conditions=[{filedName:"customerGroupId",operateType:"=",filedValue:t}]:u.conditions=[],f.getCustomList()}),$(".screen-input-name").change(function(){""==$(this).val()?delete u.keyword:u.keyword=$(this).val()}),$(".screen-input-btn").click(function(){f.getCustomList()}),$("#btn-sure").click(function(){var t=$(".customer-list").find("input[type=radio]:checked");t.length<=0?$.Alert("请先选择客户！"):($("#custName").val(t.next().text()).attr("data-id",t.val()),$(".custName").text(t.next().text()),$("#customer").modal("hide"))}),$("#product-input").change(function(){l.name=$.trim($(this).val())}),$(".product-screen").click(function(){f.getResourceSettings()}),$(".product-group-check select").change(function(){var t=$(this).val();""==t&&(t=0),l.productCatelog=t,f.getResourceSettings()}),$("#product-type0,#product-type1,#product-type2,#product-type3").change(function(){var t=$(this).find("option:selected").val();""==t&&(t=0),l.productType=t,f.getResourceSettings(),f.getProductsType(t,$(this))}),$("#product-sure").click(function(){var t=$(".product-list li input[type=checkbox]:checked");if(t.length>0){for(var e=0;e<t.length;e++){var i=t.eq(e).parent().attr("data-id");f.addProductItem(i)}$("#products").modal("hide")}else $.Alert("请至少选择一个产品！")});var f={count:1,savePI:function(t){var e=Base.sitUrl+"/api/pi/v1/pi/save";1==n&&(e=Base.sitUrl+"/api/pi/v1/pi/edit"),$.ajax({url:e,data:{data:JSON.stringify(t)},type:"POST",dataType:"json",success:function(t){return t.success?void(r?$.Alert("PI保存成功！","",function(){var t=parent.me.tabIdx();parent.me.refresh2(o,"part"),parent.me.closeOne(t,!0)}):($.DestroyPopInPop(),parent.location.reload())):void $.Alert("pi保存失败,"+t.message)}})},getPIById:function(){i&&$.ajax({url:Base.sitUrl+"/api/pi/v1/pi/detail",data:{id:i},type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data,i=e.productPiDetails;if(delete e.createTime,delete e.updateTime,c.piInfo=e,s.find("#pi-name").val(e.name),v.head.setContent(e.header,!1),v.foot.setContent(e.tail,!1),s.find("#custName").attr("data-id",e.customerId).val(e.customerName||""),s.find(".custName").text(e.customerName||""),s.find("#pi-seller").val(e.seller),s.find("#pi-date").val(e.piDate||""),s.find("#pi-addr").val(e.toAddress),s.find(".pi-freight").val(e.freight),s.find(".pi-payment").val(e.termOfPayment),s.find(".pi-delivery").val(e.termOfDelivery),s.find(".pi-dDate").val(e.dateOfDelivery),s.find(".pi-total").val("$ "+e.total+" USD"),s.find("#the-seller").val(e.sellerSignature),s.find("#the-buyer").val(e.buyerSignature),i.length>0){for(var a=0;a<i.length;a++)f.addProductItem(i[a].id,i);for(var n=s.find(".quo-table-info"),r=0;r<i.length;r++)n.eq(r).children("li").eq(1).find(".pi-name").val(i[r].productName),n.eq(r).children("li").eq(3).find(".pi-fobPrice").val(i[r].price),n.eq(r).children("li").eq(3).find(".moq-unit").prev().children("span").attr("data-id",i[r].quantityUnit),n.eq(r).children("li").eq(4).find(".pi-quantity").val(i[r].orderQuantity),n.eq(r).children("li").eq(3).find(".fob-price-unit").prev().children("span").attr("data-id",i[r].priceCurrency),n.eq(r).children("li").eq(5).find(".pi-amount").val("$"+i[r].amount)}}})},getProductById:function(){a&&$.ajax({url:Base.sitUrl+"/api/product/v1/product/get",data:{id:a},type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.Alert("获取产品信息失败,"+t.message);var e=t.data;c.productList.push(e),f.addProductItem(a)}})},getCustomList:function(){$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/list/query",type:"POST",data:{data:JSON.stringify(u)},dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;t.data.totalItem;c.custList=e.results,f.showCustomItem(e)}})},getCustomGroups:function(t){$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/group/list",type:"GET",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;if(e.length>0){for(var i='<li data-id="0">全部分组</li>',a=0;a<e.length;a++)i+='<li data-id="'+e[a].id+'">'+e[a].name+"</li>";$(".screen-list").empty().append(i)}}})},showCustomItem:function(t){if(0==c.custList.length)$(".customer-list").empty().html('<p class="customer-none">没有匹配客户！</p>');else{for(var e="<ul>",i=0;i<c.custList.length;i++)e+='<li>                            <input type="radio" name="customer" value="'+c.custList[i].id+'" />                            <span>'+c.custList[i].name+"</span>                            </li>";$(".customer-list").empty().append(e)}var a=t.totalItem,n=Math.ceil(t.totalItem/t.pageSize);$.Page({total:a,_class:".customer-page",nowNum:u.currentPage,allNum:n,callback:function(t,e){u.currentPage=t,f.getCustomList()}})},getDicts:function(t,e){$.ajax({url:Base.sitUrl+"/api/sys/v1/sys/dictionary/get",data:{group:t},type:"POST",dataType:"json",success:function(i){if(!i.success)return void $.unLogin(i);var a=i.data;a.length>0&&("currency"==t?c.unit.price=a:"unit"==t&&(c.unit.quantity=a),f.showDicts(a,t,e))}})},showDicts:function(t,e,i){for(var a="",n=0;n<t.length;n++)a+='<li data-id="'+t[n].id+'">'+t[n].value+"</li>";i.empty(),i.append(a)},showDicts2:function(t,e){for(var i="",a=0;a<t.length;a++)i+='<li data-id="'+t[a].id+'">'+t[a].value+"</li>";e.empty().append(i)},getResourceSettings:function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/info/list",type:"GET",data:l,beforeSend:function(t){$.BlockUI()},complete:function(t,e){$.UnblockUI()},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data.results,i="";if(null!=e&&""!=e){c.productList=e;for(var a=0;a<e.length;a++)i+='<li data-id="'+e[a].id+'"><input type="checkbox" id="checkbox'+a+'" name="model-checkbox">&nbsp;<label for="checkbox'+a+'" style="display: inline-block;margin-left: 5px;margin-top: 5px;width: 500px;text-overflow: ellipsis;overflow: hidden;white-space: nowrap;">'+e[a].name+"</label></li>"}else i+='<div class="text-center">暂无产品</div>';$("#products .product-list").empty().append(i);var n=t.data.totalItem,r=Math.ceil(n/l.pageSize);$.Page({total:n,_class:".product-page",nowNum:l.currentPage,allNum:r,callback:function(t,e){l.currentPage=t,f.getResourceSettings()}})}})},getProductsGroup:function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/catelog/list",type:"GET",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);for(var e=t.data,i='<option value="">全部</option>',a=0;a<e.length;a++)i+='<option value="'+e[a].id+'">'+e[a].name+"</option>";$(".product-group-check select").empty().append(i)}})},getProductsType:function(t,e){$.ajax({url:Base.sitUrl+"/api/product/v1/product/type/sublist?pid="+t,type:"GET",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);for(var i=t.data,a='<option value="">全部</option>',n=0;n<i.length;n++)a+='<option value="'+i[n].id+'">'+i[n].name+"</option>";e?e.parent().next().find("select").empty().append(a):$("#product-type0").empty().append(a)}})},getStyle:function(t,e){var i=Base.sitUrl+"/api/pi/v1/pi/head/list";2==e&&(i=Base.sitUrl+"/api/pi/v1/pi/tail/list"),$.ajax({url:i,type:"GET",dataType:"json",success:function(i){if(!i.success)return void $.unLogin(i);var a=i.data,n="";if(a.length>0){1==e?c.quoHead=a:2==e&&(c.quoFoot=a);for(var r=0;r<a.length;r++)n+='<li data-id="'+a[r].id+'">'+a[r].name+"</li>";t.empty().append(n)}}})},sumPrice:function(){var t=0;return $(".quo-table-info").each(function(){var e=parseFloat($(this).children("li").eq(5).find(".pi-amount").val().substr(1));t+=parseFloat(e)}),parseFloat(t).toFixed(2)},amountPrice:function(t){for(var e=$(".quo-table-info"),i=0;i<e.length;i++){var a=0,n=e.eq(i).children("li"),r=t.children("li");if(e.eq(i).attr("data-id")==t.attr("data-id")&&n.eq(0).text()==r.eq(0).text()){var o=parseFloat(n.eq(3).find(".pi-fobPrice").val()),s=n.eq(3).find(".fob-price-unit").prev().children("span").text(),l=parseInt(n.eq(4).find(".pi-quantity").val()),u=n.eq(3).find(".fob-price-unit").prev().children("span");return"CNY"==s&&(o/=6.49),u.attr("data-id")==-1&&$.Alert("请选择货币单位"),a+=parseFloat(o*l),n.eq(5).find(".pi-amount").attr("data-val",a.toFixed(2)),void n.eq(5).find(".pi-amount").val("$"+a.toFixed(2))}}},addProductItem:function(t,e){var i=c.productList;e&&(i=e);for(var a={},n=0;n<i.length;n++)if(t==i[n].id){a=i[n];var r=a.productTradeInfoEnter;r&&r.fomPriceMin?c.data.qSEnty.push({productId:a.id,productName:a.name,price:r.fomPriceMin,priceCurrency:r.fomPriceCurrency,quantityUnit:r.minOrderQuantityUnit,productPhoto:a.productPhoto||a.imgs,orderQuantity:r.minOrderQuantity,remark:a.remark}):c.data.qSEnty.push({productId:a.id,productName:a.productName,price:a.price,productPhoto:a.productPhoto||a.imgs,priceCurrency:a.priceCurrency,quantityUnit:a.quantityUnit,orderQuantity:a.orderQuantity,remark:a.remark});break}var o="";if(a&&a.id){var s=a.productPhoto||a.imgs,l=0,u=-1,d=-1,p=0;r&&r.fomPriceMin?(l=r.fomPriceMin||0,u=r.minOrderQuantityUnit||-1,d=r.fomPriceCurrency||-1,p=r.minOrderQuantity||0):(l=a.price||0,d=a.priceCurrency||-1,u=a.quantityUnit||-1,p=a.orderQuantity||0),o='<ul class="quo-table-info" data-id="'+(a.productId||t)+'">                                <li>'+f.count+'</li>                                <li>                                    <div>                                        <input type="text" class="pi-name" value="'+a.name+'" />                                    </div>                                </li>                                <li><img src="'+s+'" alt="图片"></li>                                <li>                                    <div>                                        <input type="text" class="pi-fobPrice" value="'+l+'" />                                        <div class="quo-select">                                            <label><span data-id="'+u+'">请选择</span><i class="s-updownBg s-up3"></i></label>                                            <ul class="moq-unit"></ul>                                        </div>                                        <div class="quo-select">                                            <label><span data-id="'+d+'">请选择</span><i class="s-updownBg s-up3"></i></label>                                            <ul class="fob-price-unit"></ul>                                        </div>                                    </div>                                </li>                                <li>                                    <div>                                        <input type="text" class="pi-quantity" value="'+p+'" />                                    </div>                                </li>                                <li>                                    <div><input type="text" class="pi-amount" data-val="0" value="$0" /></div>                                </li>                                <div class="clear"></div><i class="s-updownBg s-del2"></i>                            </ul>';var v=$(".quo-table-title"),m=v.nextAll(".quo-table-info");m.length>0?m.eq(m.length-1).after(o):v.after(o),$(".quo-table-info img").load(function(){$.cutImage(this,100,100)}),c.unit.price.length>0?(f.showDicts2(c.unit.quantity,$(".moq-unit")),f.showDicts2(c.unit.quantity,$(".fob-quantity-unit")),f.showDicts2(c.unit.price,$(".fob-price-unit"))):(f.getDicts("unit",$(".moq-unit,.fob-quantity-unit")),f.getDicts("currency",$(".fob-price-unit")));var g=$(".quo-table-info");f.amountPrice($(".quo-box>.quo-table-info").eq(g.length-1));var h=f.sumPrice();$(".pi-total").val("$ "+h+" USD"),f.count++}},getNo:function(){$.ajax({url:Base.sitUrl+"/api/odd/v1/get",type:"GET",dataType:"json",data:{data:"{'type': 2}"},success:function(t){return t.success?void s.find(".quotation-no").text(t.data):void $.Alert("生成PIID失败,"+t.message)}})}},v={head:null,foot:null,type:null,createEditor:function(){var t=[["emotion","fontfamily","fontsize","forecolor","backcolor","|","bold","italic","|","underline","strikethrough","|","fontborder","|","subscript","superscript","|","formatmatch","|","insertorderedlist","insertunorderedlist","justifyleft","justifyright","justifycenter","justifyjustify","|","source"]];v.head=UE.getEditor("headEditor",{toolbars:t,initialFrameWidth:"100%",elementPathEnabled:!1,autoHeightEnabled:!1,initialFrameHeight:200}),v.foot=UE.getEditor("footEditor",{toolbars:t,initialFrameWidth:"100%",elementPathEnabled:!1,autoHeightEnabled:!1,initialFrameHeight:200})},uploadImg:function(t,e){e&&null==v.type,$("#form_img").ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI(),s.find("#form_img").eq(0)[0].reset()},success:function(t){if(!t.success)return void $.unLogin(t);var e="http://"+t.data;if(v.type){var i='<img src="'+e+'" alt="插入图片">';"head"==v.type?v.head.setContent(i,!0):"foot"==v.type?v.foot.setContent(i,!0):(s.find(".seal-img").append(i),s.find(".info-group>a").addClass("active"),v.initImg())}}}).submit()},initImg:function(){s.find(".seal-img>img").load(function(){$.cutImage(this,130,100)})}};$.when(v.createEditor()).then(f.getNo()).then(f.getStyle(s.find("#quoHead").next(),1)).then(f.getStyle(s.find("#quoFoot").next(),2)).then(f.getResourceSettings()).then(f.getPIById()).then(f.getCustomList()).then(f.getCustomGroups()).then(f.getProductsType(0)).then(f.getProductsGroup()),f.getProductById()})});