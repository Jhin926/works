require(["common"],function(){require(["maintab","blockUI","jqform","category","countries"],function(){var t=top.funcList;$("[data-code]").each(function(){for(var e=0;e<t.length;e++)t[e].code==$(this).attr("data-code")&&$(this).removeClass("none")});var e=parseInt($.GetQueryString("id")),a=parseInt($.GetQueryString("type")),i=$("#addProForm"),n=$("#outputForm");$(".pop-left").height(i.find(".box-form").eq(0).height()),i.on("change","input[name=upImg]",function(){var t=r.fileLimit($(this));t.flag&&r.uploadImg($("#form_img"))}),i.on("change","input[name=upImgs]",function(){var t=r.fileLimit($(this));t.flag&&r.uploadImg($("#form_img2"))}),i.on("click",".model-select",function(t){$.EventFn(t);var e=$(this).children("ul");e.hasClass("active")?e.removeClass("active"):($(".model-select>ul").removeClass("active"),e.addClass("active"))}),$("#p-group, #o-group, #fob-curr, #fob-unit, #sub-unit, #sub-time, #p-unit").next().on("click","li",function(t){$.EventFn(t);var e=$(this).attr("data-id");$(this).parent().removeClass("active").prev().attr("data-id",e).text($(this).text())}),i.on("click",".box-select .model-select>ul>li",function(t){$.EventFn(t);var e=$(this).closest(".model-select"),a=$(this).attr("data-id"),i=e.index(),n=r.subCategoryId;if($(this).parent().removeClass("active").prev().attr("data-id",a).text($(this).text()),n.splice(i,n.length-i,a),n.length<4){1==n.length?r.subCategory=category[n[0]].sub:2==n.length?r.subCategory=category[n[0]].sub[n[1]].sub:3==n.length&&(r.subCategory=category[n[0]].sub[n[1]].sub[n[2]].sub);var s=r.subCategory,l="",o=$('<div class="model-select selects4 active"><i class="s-updownBg s-up3"></i><label data-id="-1">请选择产品类型</label><ul></ul></div>');if("object"==typeof s){for(var d in s)l+='<li data-id="'+d+'">'+s[d].cn_name+"</li>";o.children("ul").append(l),e.addClass("active").nextAll().remove(),e.after(o)}else $.ajax({url:Base.sitUrl+"/api/ product/v1/product/type/param",type:"POST",dataType:"json",data:{data:JSON.stringify({id:a})},success:function(t){for(var e=t.data.replace(/FALSE/g,!1).replace(/'/g,'"'),a=JSON.parse(e),i="",n=0;n<a.bindAttrjson.length;n++)i+='<div class="form-group pro-add-param"><label for=""><span>'+a.bindAttrjson[n].data.value+'</span></label><div class="form-info"><span class="param-value">'+a.bindAttrjson[n].nodes[0].data.value+"</span></div></div>";for(var r=0;r<a.sysAttrjson.length;r++){var s="",l=a.sysAttrjson[r].data.showType,o=a.sysAttrjson[r].data.value,d=o.replace(/ /g,"-");if("input_string"==l)s='<div class="form-group pro-add-param"><label for="'+d+'"><span>'+o+'</span></label><div class="form-info"><input id="'+d+'" type="text" name="'+d+'" class="inputs long-input param-value"></div></div>';else if("input_int"==l)s='<div class="form-group pro-add-param"><label for="'+d+'"><span>'+o+'</span></label><div class="form-info"><input id="'+d+'" type="text" name="'+d+'" class="inputs long-input param-value"></div></div>';else if("list_box"==l){for(var p=a.sysAttrjson[r].nodes,u='<option value="">请选择</option>',n=0;n<p.length;n++)u+='<option value="'+p[n].data.value+'">'+p[n].data.value+"</option>";s='<div class="form-group pro-add-param"><label for="'+d+'"><span>'+o+'</span></label><div class="form-info"><div class="model-select long-input" style="border: none;"><select class="form-control param-value" style="padding: 0;">'+u+"</select></div></div></div>"}else if("check_box"==l){for(var p=a.sysAttrjson[r].nodes,u="",n=0;n<p.length;n++)u+='<label><input type="checkbox" name="'+p[n].data.value+'" value="'+p[n].data.id+'"><span style="margin-right: 10px;">'+p[n].data.value+"</span></label>";s='<div class="form-group pro-add-param"><label for="'+d+'"><span>'+o+'</span></label><div class="form-info param-value" style="max-width: 572px;">'+u+"</div></div>"}else if("country"==l){for(var c='<option data-id="-1">请选择</option>',n=0;n<countries.length;n++)c+='<option data-id="'+countries[n].id+'" value="'+$.countries[n].cn+'">'+$.countries[n].cn+"</option>";s='<div class="form-group pro-add-param"><label for="'+d+'"><span>'+o+'</span></label><div class="form-info"><div class="model-select long-input" style="border: none;"><select id="country" class="form-control param-value" style="padding: 0;">'+c+"</select></div></div></div>"}i+=s}$(".pro-add-param").remove(),$(".pro-special-style").children(".form-title").after(i)}})}}),i.on("click",".form-info .up-shows>.up-btn>.s-dels",function(){$(this).closest(".up-shows").remove()}),i.on("click",".fieldset .singles .form-info i.s-updownBg",function(){$(this).closest(".singles").remove()}),i.on("click",".fieldset .form-group .s-del",function(){var t=$(this).attr("data-id");r.count=parseInt(t),$(this).closest(".form-group").remove()}),i.on("click","#add-param",function(t){$.EventFn(t);var e='<div class="form-group singles"><label><input type="text" class="inputs short-input" id="p_'+r.count+'" placeholder="参数名称"></label><div class="form-info"><input type="text" id="input_'+r.count+'" class="inputs long-input2" placeholder="参数内容" /><i class="s-updownBg s-del" data-id="'+r.count+'"></i></div></div>';$(this).closest(".form-group").before(e),r.count++}),i.on("blur","#p-name",function(){null==$(this).val()||""==$(this).val()?$.errorsFn($(this),"请输入产品名称"):($(this).val().length>512&&$.Alert("字符数超出限制范围"),$(this).removeClass("error"),$(this).next(".errors").removeClass("active"))}),i.on("click","#pro-add",function(){var t={},n={},s=i.find('[name="p-name"]');e&&(t=r.data,a||delete t.id),t.name=s.val();var l=[];i.find(".up-shows").each(function(){l.push({url:$(this).children("img").attr("src")})}),l.length>0?t.imgs=l[0].url:t.imgs="",t.pictures=l;var o=parseInt(i.find("#p-group").attr("data-id"));o!=-1?t.productCatelog=o:t.productCatelog=1;var d=$.errorsFn(s,"请输入产品名称");0==$(".up-shows").length&&(d=$.Alert("请上传至少一张图片"));var p=$(".box-select .model-select:last-child").find("label");t.productType=p.attr("data-id"),t.typeName=p.text();var u=$(".pro-special-style").find(".pro-add-param");t.productInfo={},u.each(function(){var e,a=$(this).find("label span").text(),i=$(this).find(".param-value");a=a.replace(/ /g,"-"),i.length>0&&("SPAN"==i[0].tagName?e=i.text():"INPUT"==i[0].tagName&&"text"==i.attr("type")?e=i.val():"SELECT"==i[0].tagName&&(e=i.val()),t.productInfo[a]=e)}),t.remark=i.find('[name="p-remark"]').val(),t.description=i.find('[name="p-desc"]').val();var c=i.find(".singles"),f=[];c.length>0&&c.each(function(){var t=$(this).children("label").children("input").val(),e=$(this).children("div").children("input").val();f.push({name:t,value:e})}),t.productParameters=f,n.packagingDetails=i.find('[name="p-details"]').val(),n.minOrderQuantity=i.find('[name="p-min"]').val()||0,n.minOrderQuantityUnit=parseInt(i.find("#p-unit").attr("data-id")),n.minOrderQuantityDesc=i.find(".box-min input").val()||"",n.port=i.find('[name="p-Port"]').val();var v=[];i.find(".form-checkbox input[type=checkbox]:checked").each(function(){v.push($(this).next().text())}),n.paymentTerm=v.join(";");var m=parseInt(i.find("#fob-curr").attr("data-id"));m!=-1?n.fomPriceCurrency=m:n.fomPriceCurrency=100020,n.fomPriceMin=i.find('[name="st-price"]').val()?parseFloat(i.find('[name="st-price"]').val()).toFixed(2):0,n.fomPriceMax=i.find('[name="ed-price"]').val()?parseFloat(i.find('[name="ed-price"]').val()).toFixed(2):0;var g=parseInt(i.find("#fob-unit").attr("data-id"));g!=-1?n.unit=g:n.unit=100200,n.supplyAblility=i.find('[name="p-supply"]').val()||0;var y=parseInt(i.find("#sub-unit").attr("data-id"));y!=-1?n.supplyAblilityUnit=y:n.supplyAblilityUnit=100200;var h=parseInt(i.find("#sub-time").attr("data-id"));h!=-1?n.supplyAblilityTime=h:n.supplyAblilityTime=100402,n.supplyAblilityDesc=i.find(".box-ability input").val()||"";var b=i.find('[name="p-deli-time"]').val();b=b.replace(/\D/g,""),n.deliveryTime=b+"天",t.productTradeInfoEnter=n,d&&r.saveItem(t)}),$(".min-info>a").on("click",function(){var t='<div class="box-info">                            <input type="text" class="inputs long-input2" />                            <i class="s-updownBg s-del"></i>                        </div>';$(this).hide().after(t)}),$(".min-info").on("click","i",function(){$(this).parent().prev().show(),$(this).parent(".box-info").remove()}),n.on("click",".form-btn>button",function(t){$.EventFn(t);var e=$(this).attr("data-type");"download"==e?r.downloadOutputTemplate():"upload"==e?$("#up-files").click():"import"==e&&r.importHistory()}),n.on("change","input[name=upFiles]",function(){var t=r.fileLimit($(this));if(t.flag){r.uploadImg($("#form_file"),"upload",t.name,t.size);var e=n.find(".selects5.active");r.upObj.group=n.find("#o-group").attr("data-id"),e.each(function(){var t=$(this).children("label").attr("data-id");t!=-1&&(r.upObj.type=t)})}});var r={count:0,data:{},typeList:{},upObj:{group:"",type:"",path:"http://",taskName:"",fileName:"",fileSize:null},typeId:"",typeCount:2,subCategoryId:[],subCategory:{},saveItem:function(t){var e=Base.sitUrl+"/api/product/v1/product/save";a&&(e=Base.sitUrl+"/api/product/v1/product/edit"),$.ajax({url:e,type:"POST",dataType:"json",data:{data:JSON.stringify(t)},success:function(t){return t.success?($.DestroyPopInPop(),void parent.location.reload()):void $.unLogin(t)}})},getItemById:function(){e&&$.ajax({url:Base.sitUrl+"/api/product/v1/product/get",data:{id:e},type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data,a=e.pictures,n=e.productTradeInfoEnter;if(delete e.createTime,delete e.updateTime,r.data=e,i.find("#p-name").val(e.name),a.length>0){for(var s="",l=0;l<a.length;l++)s+='<div class="up-shows active">                                            <img src="'+a[l].url+'" alt="图片" />                                            <div class="up-btn">                                                <i class="s-updownBg s-dels"></i>                                            </div>                                        </div>';i.find(".up-all").after(s),$(".up-shows img").load(function(){$.cutImage(this,100,100)}),i.find("#p-bName").val(e.brand)}i.find("#p-min").val(n.minOrderQuantity),i.find('[name="st-price"]').val(n.fomPriceMin),i.find('[name="ed-price"]').val(n.fomPriceMax),i.find('[name="p-Port"]').val(n.port),i.find('[name="p-modelNum"]').val(e.modelNumber||""),i.find("#p-group").attr("data-id",e.productCatelog);for(var o=i.find("#p-group").next("ul").children("li"),d=0;d<o.length;d++){var p=parseInt(o.eq(d).attr("data-id"));if(p==e.productCatelog){o.eq(d).addClass("active"),i.find("#p-group").text(o.eq(d).text()),p=void 0;break}}i.find("#fob-curr").attr("data-id",n.fomPriceCurrency);for(var u=i.find("#fob-curr").next("ul").children("li"),c=0,f=u.length;c<f;c++){var p=parseInt(u.eq(c).attr("data-id"));if(p==n.fomPriceCurrency){u.eq(c).addClass("active"),i.find("#fob-curr").text(u.eq(c).text()),p=void 0,u=void 0;break}}i.find("#fob-unit,#sub-unit,#p-unit").attr("data-id",n.unit);for(var v=i.find("#fob-unit,#sub-unit,#p-unit").next("ul").children("li"),m=0,f=v.length;m<f;m++){var p=parseInt(v.eq(m).attr("data-id"));if(p==n.unit){v.eq(m).addClass("active"),i.find("#fob-unit,#sub-unit,#p-unit").text(v.eq(m).text()),p=void 0,v=void 0;break}}i.find("#sub-time").attr("data-id",n.supplyAblilityUnit);for(var g=i.find("#sub-time").next("ul").children("li"),c=0,y=g.length;c<y;c++){var p=parseInt(g.eq(c).attr("data-id"));if(p==n.supplyAblilityUnit){g.eq(c).addClass("active"),i.find("#sub-time").text(g.eq(c).text()),p=void 0,g=void 0;break}}if(n.paymentTerm.length>0&&i.find(".form-checkbox input").each(function(){n.paymentTerm.indexOf($(this).attr("data-id"))!=-1&&$(this).attr("checked","checked")}),i.find('[name="p-supply"]').val(n.supplyAblility||0),n.minOrderQuantityDesc){var h='<div class="box-info">                                            <input type="text" class="inputs long-input2" value="'+n.minOrderQuantityDesc+'" />                                            <i class="s-updownBg s-del"></i>                                        </div>';i.find(".box-min>a").after(h),i.find(".box-min>a").hide()}if(n.supplyAblilityDesc){var b='<div class="box-info">                                            <input type="text" class="inputs long-input2" value="'+n.supplyAblilityDesc+'" />                                            <i class="s-updownBg s-del"></i>                                        </div>';$(".box-ability>a").hide().after(b)}i.find('[name="p-deli-time"]').val(n.deliveryTime),i.find('[name="p-details"]').val(n.packagingDetails),i.find('[name="p-desc"]').val(e.description),i.find('[name="p-remark"]').val(e.remark),i.find("#sub-time").text(n.supplyAblilityTimeValue);var x=e.productParameters,T="";if(x&&x.length>0){for(var l=0;l<x.length;l++)T+='<div class="form-group singles">                                            <label><input type="text" class="inputs short-input" id="p_'+l+'" value="'+x[l].name+'" /></label>                                            <div class="form-info">                                                <input type="text" id="input_'+l+'" class="inputs long-input2" value="'+x[l].value+'" />                                                <i class="s-updownBg s-del" data-id="'+l+'"></i>                                            </div></div>';i.find(".pro-add-param").after(T)}r.getParentItem(e.productType)}})},uploadImg:function(t,e,a,n){t.ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI(),i.find("#form_file").eq(0)[0].reset()},success:function(t){if(!t.success)return void $.Alert(t.message+",网络超时！");if(void 0==e){for(var i=t.data.split(","),s="",l=0;l<i.length;l++){var o="http://"+i[l];s+='<div class="up-shows active">                                        <img src="'+o+'" alt="图片" />                                        <div class="up-btn">                                            <i class="s-updownBg s-dels"></i>                                        </div>                                    </div>'}var d=$(".form-info .up-shows");d.length>0?d.eq(d-1).after(s):$(".up-all").after(s),$(".up-shows img").load(function(){$.cutImage(this,100,100)})}else{r.upObj.path+=t.data,r.upObj.taskName=a,r.upObj.fileName=a,r.upObj.fileSize=n;var p=!0;""==r.upObj.type&&($.Alert("请选择导入产品类型"),p=!1),""==r.upObj.group&&($.Alert("请选择导入的产品分组"),p=!1),p&&(r.uploadProductTable(r.upObj),r.upObj.path="http://")}}}).submit()},getProGroup:function(t){$.ajax({url:Base.sitUrl+"/api/product/v1/product/catelog/list",type:"GET",dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);for(var a=e.data,i='<li data-id="-1">请选择</li>',n=0;n<a.length;n++)i+='<li data-id="'+a[n].id+'">'+a[n].name+"</li>";t.next("ul").empty().append(i)}})},getProType:function(t){var e="",a=t.parent(".model-select");for(var i in category)e+='<li data-id="'+i+'">'+category[i].cn_name+"</li>",t.next("ul").empty().append(e),a.addClass("active")},getParentItem:function(t){$.ajax({url:Base.sitUrl+"/api/product/v1/product/type/parent/search",data:{id:t},type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;e&&(r.getChildItem(null,e.pid,{id:e.id,name:e.name}),r.getParentItem(e.pid))}})},getChildItem:function(t,e,a){$.ajax({url:Base.sitUrl+"/api/product/v1/product/type/sublist",data:{pid:e},type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var i=t.data;i.length>0&&(void 0==r.typeList[e]&&(a.list=i,r.typeList[e]=a),0==e&&r.getAllContactType())}})},getDicts:function(t){$.ajax({url:Base.sitUrl+"/api/sys/v1/sys/dictionary/get",data:{group:t},type:"POST",dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);var a=e.data,n="";if("currency"==t){for(var r=0;r<a.length;r++)n+='<li data-id="'+a[r].id+'">'+a[r].value+"</li>";i.find("#fob-curr").next("ul").empty().append(n)}else if("unit"==t){for(var r=0;r<a.length;r++)n+='<li data-id="'+a[r].id+'">'+a[r].value+"</li>";i.find("#p-unit,#fob-unit,#sub-unit").next("ul").empty().append(n)}else if("supply.ability.time"==t){for(var r=0;r<a.length;r++)n+='<li data-id="'+a[r].id+'">'+a[r].value+"</li>";i.find("#sub-time").next("ul").empty().append(n)}else if("payment.method"==t){for(var r=0;r<a.length;r++)n+='<label><input type="checkbox" name="payment" data-id="'+a[r].id+'"><span>'+a[r].value+"</span></label>";i.find(".form-checkbox").empty().append(n)}}})},getAllContactType:function(){var t="",e="#p-type",a=1,i=r.typeList;for(var n in i){for(var s=i[n].list,l=0;l<s.length;l++)t+=s[l].id==i[n].id?'<li data-id="'+s[l].id+'" class="active">'+s[l].name+"</li>":'<li data-id="'+s[l].id+'">'+s[l].name+"</li>",l==s.length-1&&(0!=n&&(e="#p-type"+a),$(e).attr("data-id",i[n].id).text(i[n].name),$(e).next("ul").empty().append(t),$(e).closest(".model-select").addClass("active"));t="",a++}r.typeList={}},fileLimit:function(t){var e=!0,a=t.prop("files"),i=$(".up-shows").length,n=parseInt(i)+parseInt(a.length);i>=6&&($.Alert("最多允许上传6张图片"),e=!1),a.length>6&&($.Alert("最多允许上传6张图片"),e=!1),n>6&&($.Alert("最多允许上传6张图片"),e=!1),0==a.length&&(e=!1);for(var r=0;r<a.length;r++){var s=Math.round(a[r].size/1024*100)/100/1024;s>1&&($.Alert("上传图片需小于1MB"),e=!1)}return{flag:e,name:a[0].name,size:s}},downloadOutputTemplate:function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/template/download",type:"GET",dataType:"json",complete:function(){window.location.href=Base.sitUrl+"/api/product/v1/product/template/download"}})},uploadProductTable:function(t){var e={productCatelog:t.group,productType:t.type,path:t.path,taskName:t.taskName,fileName:t.fileName,fileSize:t.fileSize};e=JSON.stringify(e),$.ajax({url:Base.sitUrl+"/api/product/v1/product/import",data:{data:e},type:"POST",dataType:"json",success:function(t){t.success||$.unLogin(t)}})},importHistory:function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/import/history",type:"GET",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data,a="",i=$(".table-import>tbody");if(0!=e.length)for(var n=0;n<e.length;n++){var r=$.dateObj(e[n].createTime)._getDatetime(),s="未分组",l="&nbsp;";a+="<tr>                                            <td>"+e[n].fileName+"</td>                                            <td>"+r+"</td>                                            <td>"+s+"</td>                                            <td>"+l+"</td>                                            <td>"+e[n].productSum+'</td>                                            <td><a href="javascript:;" data-id="'+e[n].id+'">删除</a></td>                                        </tr>'}else a+='<tr><td colspan="6">无导入历史</td></tr>';i.empty().append(a)}})},delImportHistory:function(t,e){$.ajax({url:Base.sitUrl+"/api/product/v1/product/import/delete",type:"POST",data:{id:e},dataType:"json",success:function(t){t.success||$.unLogin(t)}})}};$(".table-import").on("click","tbody tr td:last-child",function(){$.Confirm("确认删除？","",function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/import/delete",type:"POST",data:{id:$(this).find("a").attr("data-id")},dataType:"json",success:function(t){t.success||$.unLogin(t)}})})}),r.getProType(i.find("#p-type,#o-type")),r.getProGroup(i.find("#p-group,#o-group")),r.getItemById(),r.getDicts("currency"),r.getDicts("unit"),r.getDicts("supply.ability.time"),r.getDicts("payment.method")})});