require(["common"],function(){require(["maintab","blockUI"],function(t){var e=top.funcList;$("[data-code]").each(function(){for(var t=0;t<e.length;t++)e[t].code==$(this).attr("data-code")&&$(this).removeClass("none")}),t.init();var n=parseInt($.GetQueryString("id")),a=$(".box-product-detail"),o=a.find(".pro-infos").length;a.find(".pro-infos").eq(o-1).css("border-bottom","none"),a.on("click","#page-copy",function(){document.getElementById("copy-info").select(),document.execCommand("Copy")}),a.on("click","#page-look",function(){window.open(c.online)}),a.on("click","#pro-group",function(){$.modalsFn($("#groupsModal"),$(this)),$(".u-group>ul>li").length>0||c.getGroups($(".u-group>ul"))}),a.on("click",".mclose,#btn-del-no",function(){$(".modals").removeClass("active")}),a.on("click",".u-group>ul>li",function(){var t=$(this).attr("data-id");c.changeGroup(n,t),$(".modals").removeClass("active")}),a.on("click","#btn-del-ok",function(){c.deletePro()}),a.on("click",".box-btn>button",function(){var i=$(this).attr("data-type");"edit"==i?t.showTab(Base.url+"/html/pop-product-add.html?type=1&id="+n+"&v="+window.ver,"编辑产品"):"copy"==i?t.showTab(Base.url+"/html/pop-product-add.html?type=0&id="+n+"&v="+window.ver,"新建产品"):"quotation"==i?t.showTab(Base.url+"/html/pop-quotation-add.html?pId="+n+"&v="+window.ver,"新建报价"):"del"==i?$.modalsFn($("#delsModal"),$(this)):"pi"==i?t.showTab(Base.url+"/html/pop-pi-add.html?pId="+n+"&v="+window.ver,"新建pi"):"email"==i?t.showTab(Base.url+"/html/pop-email-new.html?showType=right&modelType=99&ids="+n+"&v="+window.ver,"新建邮件"):"export"==i&&c.toExport()}),a.on("change","#pro-date",function(t){$.EventFn(t);var i=$(this).val();c.statistics(i)}),$(".tab-title>ul>li").on("click",function(){$(this).index();r.tabChange($(this))}),a.find(".pro-box-info").scroll(function(){var t={a1:$("#a_1>.pro-titles"),a2:$("#a_2>.pro-titles"),a3:$("#a_3>.pro-titles"),a4:$("#a_4>.pro-titles")},i={a1:t.a1.offset().top-$(this).offset().top,a2:t.a2.offset().top-$(this).offset().top,a3:t.a3.offset().top-$(this).offset().top,a4:t.a4.offset().top-$(this).offset().top,a1H:$("#a_1").height(),a2H:$("#a_2").height(),a3H:$("#a_3").height(),a4H:$("#a_4").height()};i.a4&&i.a4>=0&&i.a4<150?r.tabChange($(".tab-title>ul>li").eq(3)):i.a3>=0&&i.a3<=150?r.tabChange($(".tab-title>ul>li").eq(2)):i.a2>=0&&i.a2<=150?r.tabChange($(".tab-title>ul>li").eq(1)):i.a1>=0&&i.a1<=150&&r.tabChange($(".tab-title>ul>li").eq(0))}),$(window).resize(function(t){$.EventFn(t),r.first=$("#a_1").offset().top});var r={first:$("#a_1").offset().top,tabChange:function(t){t.hasClass("active")||(t.addClass("active").siblings().removeClass("active"),$(".tab-title>ul .on").css({left:t.position().left}),0==t.index()&&$(".tab-title>ul .on").css({left:t.position().left+5}))}},l={array:[],count:0,leg:0,timer:null,highlight:function(t){$(".show-img>#show_img").attr("src",l.array[l.count]),t?t.addClass("s-circle").removeClass("s-circle2").siblings("li").addClass("s-circle2").removeClass("s-circle"):(l.count>=4?$(".show-img li").eq(0).animate({marginLeft:-55*(l.count-3)+"px"},0):$(".show-img li").eq(0).animate({marginLeft:0},0),$(".show-img>ul.img-link>li").eq(l.count).addClass("s-circle").removeClass("s-circle2").siblings("li").addClass("s-circle2").removeClass("s-circle"),l.leg==l.count?l.count=0:l.count++)},imgCenter:function(){for(var t=$(".show-img>img"),i=0;i<t.length;i++){var e=-(parseInt(t.eq(i).width())/2),n=-(parseInt(t.eq(i).height())/2);t.eq(i).css({"margin-left":e,"margin-top":n})}}};$(".show-img").on("click",">ul>li",function(){$(this).hasClass("s-circle")||(l.count=$(this).index(),l.highlight($(this)))}),$(".show-img").on("mouseover",">ul>li",function(){clearInterval(l.timer)}),$(".show-img").on("mouseout",">ul>li",function(){l.count>=l.leg?l.count=0:0==l.count&&l.count++,l.timer=setInterval(function(){l.highlight()},3500)});var s=0;$("#img_left").on("click",function(){clearInterval(l.timer),s<$(".show-img li").length-4&&s>=0&&(s++,$(".show-img li").eq(0).animate({marginLeft:-55*s+"px"},300,function(){l.timer=setInterval(function(){l.highlight()},3500)}))}),$("#img_right").on("click",function(){clearInterval(l.timer),s<=$(".show-img li").length-4&&s>0&&(s--,$(".show-img li").eq(0).animate({marginLeft:-55*s+"px"},300,function(){l.timer=setInterval(function(){l.highlight()},3500)}))});var c={unit:{price:[],quantity:[],time:[]},online:"",getItemById:function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/get",data:{id:n},type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;if(e&&e.pictures&&e.pictures.length>0){for(var o="",r=[],s=0,u=e.pictures;s<u.length;s++)r.push(u[s].url);for(r.length>0&&$(".show-img>img").attr("src",r[0]),l.array=r,l.leg=r.length-1,i=0;i<r.length;i++)o+=0==i?'<li class="s-circle" style="background-image: url('+r[i]+')"></li>':'<li class="s-circle2" style="background-image: url('+r[i]+')"></li>';$(".show-img>ul.img-link").empty().append(o),0==l.leg?clearInterval(l.timer):l.timer=setInterval(function(){l.highlight()},3500)}var d=$(".show-img li").length;d>4?$(".switch_cn").show():$(".switch_cn").hide();for(var p=e.name,f=e.id>0?"【"+e.productNo+"】":"",g=e.productTradeInfoEnter,h=c.unit.price,m=c.unit.quantity,v=c.unit.time,y="",b="",x="",w="",T="",C=0;C<h.length;C++)if(g.fomPriceCurrency==h[C].id){y=h[C].value;break}for(var k=0;k<m.length;k++)g.supplyAblilityUnit==m[k].id&&(b=m[k].value),g.minOrderQuantityUnit==m[k].id&&(x=m[k].value),g.supplyAblilityUnit==m[k].id&&(w=m[k].value);for(var q=0;q<v.length;q++)(g.supplyAblilityTime=v[q].id)&&(T=v[q].value);for(var I=c.unit.quantity,B=0;B<I.length;B++)I[B].id==g.unit&&(g.unit_text=I[B].value);if($(".fobPrice").text("$ "+g.fomPriceMin+" - "+g.fomPriceMax+"/"+g.unit_text),$(".minOrder").text(g.minOrderQuantity+" "+x),$(".supplyAbility").text(g.supplyAblility+" "+g.supplyAblilityTimeValue),$(".g-port").text(g.port||""),$(".paymentTerms").text(g.paymentTerm),g){if(g.minOrderQuantityDesc)var _="("+g.minOrderQuantityDesc+")";else var _="";if(g.supplyAblilityDesc)var P="("+g.supplyAblilityDesc+")";else var P="";c.online=Base.sitUrl+"/api/product/preview/"+$.getUser().id+"/"+n,a.find("#copy-info").val(c.online),a.find(".form-title>label").text(f+p),a.find(".brandName").text(e.brand||""),a.find(".deliveryTime").text(g.deliveryTime||""),a.find(".p-remark").text(e.remark||""),a.find(".info-no").text(e.productNo||"");var U=JSON.parse(e.productInfo),j="";for(var L in U)""!=U[L]&&"请选择"!=U[L]&&(j+="<tr><td>"+L+"</td><td>"+U[L]+"</td></tr>");$("#pro-information tbody").append(j),a.find(".info-pd").text(g.packagingDetails||""),a.find(".info-dt").text(g.deliveryTime||""),a.find(".info-moq").text(g.minOrderQuantity+" "+x+" "+_),a.find(".info-fp").text(g.fomPriceMin+"-"+g.fomPriceMax+y),a.find(".info-port").text(g.port||""),a.find(".p-descs").text(e.description||""),a.find(".p-remark").text(e.remark||""),a.find(".info-description").text(e.description||""),a.find(".info-ability").text(g.supplyAblility+" "+g.supplyAblilityTimeValue+" "+P)}var O=[{id:0,val:"全部"}],D=(new Date).getFullYear(),A="";O.push({id:D,val:"今年"});for(var B=1;B<3;B++)O.push({id:D-B,val:D-B+"年"});for(var S=0;S<O.length;S++)A+='<option value="'+O[S].id+'">'+O[S].val+"</option>";a.find("#pro-date").empty(),a.find("#pro-date").append(A),c.statistics(0)}})},getDicts:function(t){$.ajax({url:Base.sitUrl+"/api/sys/v1/sys/dictionary/get",type:"POST",data:{group:t},dataType:"json",success:function(i){if(!i.success)return void $.unLogin(i);var e=i.data;e.length>0&&("currency"==t?c.unit.price=e:"unit"==t?c.unit.quantity=e:"supply.ability.time"==t&&(c.unit.time=e))}})},toExport:function(){$.ajax({url:Base.sitUrl+"/api/export/v1/product",type:"POST",data:{id:n,year:0},dataType:"json",complete:function(t){return t.success?void(parent.location.href=Base.sitUrl+"/api/export/v1/product?id="+n+"&year=0"):void $.unLogin(t)}})},getGroups:function(t){$.ajax({url:Base.sitUrl+"/api/product/v1/product/catelog/list",type:"GET",dataType:"json",success:function(i){if(!i.success)return void $.unLogin(i);for(var e="",n=i.data,a=0;a<n.length;a++)e+='<li data-id="'+n[a].id+'">'+n[a].name+"</li>";t.empty(),t.append(e)}})},statistics:function(t){$.ajax({url:Base.sitUrl+"/api/product/v1/product/statistics/get",type:"POST",data:{year:t,productId:n},dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var i=t.data;a.find(".quotationCount").text(i.quotationStatistics),a.find(".piCount").text(i.piStatistics)}})},changeGroup:function(t,i){$.ajax({url:Base.sitUrl+"/api/product/v1/product/catelog/edit",data:{id:t,productCatelog:i},type:"POST",dataType:"json",success:function(t){return t.success?void location.reload():void $.unLogin(t,"分组失败,")}})},deletePro:function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/delete",data:{id:n},type:"POST",dataType:"json",success:function(t){return t.success?($.DestroyPopInPop(),void parent.location.reload()):void $.unLogin(t)}})},print:function(t){var i=$("#copy-info").val();$("#copy-info").attr("maxlength",i.length),html2canvas($("html"),{onrendered:function(i){t.attr("href",i.toDataURL())}})}};$.when(c.getDicts("unit")).then(c.getDicts("currency")).then(c.getDicts("supply.ability.time")).done(c.getItemById())})});