require(["common"],function(){require(["maintab","ZeroClipboard","ueditorLang","blockUI","jqform","datetimepickerCN"],function(t,e){window.ZeroClipboard=e;var i=parseInt($.GetQueryString("id")),a=parseInt($.GetQueryString("pId")),n=parseInt($.GetQueryString("type")),o=parseInt($.GetQueryString("custId")),r=Number($.GetQueryString("pIdx")),s=$("#addQuoForm");jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({language:"zh-CN",todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,format:"yyyy-mm-dd",bootcssVer:3});var u=localStorage.getItem("__userInfo"),c={};u&&(c.id=parseInt(u.substr(u.indexOf(";")+1)),c.name=u.substr(0,u.indexOf(";")));var d={type:1,homepage:1,currentPage:1,lastpage:null,pageSize:10},l={homepage:1,currentPage:1,lastpage:null,pageSize:10,conditions:[]},p={quoInfo:{},quoHead:[],quoFoot:[],custList:[],getCustInfo:{},productList:[],data:{iSEnty:[],qSEnty:[]},unit:{price:[],quantity:[]}};s.on("blur",".form-info #q-name,.form-info #custName",function(t){$.EventFn(t),"q-name"==$(this).attr("id")?$.errorsFn($(this),"报价单名称不能为空"):"custName"==$(this).attr("id")}),s.on("click",".model-select",function(t){$.EventFn(t);var e=$(this).children("ul");e.hasClass("active")?e.removeClass("active"):e.addClass("active")}),s.on("click",".model-select>ul>li",function(t){$.EventFn(t);var e=$(this).parent(),i=e.prev("label"),a=$(this).text(),n=$(this).attr("data-id");if(i.attr("data-id",n),$(this).addClass("active").siblings().removeClass("active"),i.text(a),e.removeClass("active"),"quoHead"==i.attr("id")){for(var o=p.quoHead,r="",s=0;s<o.length;s++)if(n==o[s].id){r=o[s].content;break}r=r.replace(/&#39;/g,'"'),m.head.setContent(r,!1)}else if("quoFoot"==i.attr("id")){for(var o=p.quoFoot,r="",s=0;s<o.length;s++)if(n==o[s].id){r=o[s].content;break}r=r.replace(/&#39;/g,'"'),m.foot.setContent(r,!1)}}),$("#quo-seller").val(c.name),$(".quo-add-price").append('<input type="checkbox" id="quo-add-sumPrice" /><span>不生成总价</span>'),$(".quo-add-price").on("click",">input",function(){$(this).attr("checked")?($(this).attr("checked",!1),$(".quo-add-price").prevAll().removeAttr("style")):($(this).attr("checked",!0),$(".quo-add-price").prevAll().hide())}),s.on("dblclick",".quo-sum-price",function(t){$.EventFn(t),$(this).hasClass("active")||($(".edit-quoSumPrice").val($(this).text()),$(".edit-quoSumPrice").addClass("active"),$(this).addClass("active"))}),s.on("keydown",".edit-quoSumPrice",function(t){var e=t||window.event;e.stopPropagation(),this.size=this.value.length+2}),s.on("keypress",".edit-quoSumPrice",function(t){var e=t||window.event;e.stopPropagation(),13!=e.keyCode&&13!=e.charCode||($(".quo-sum-price").text($(this).val()),$(this).removeClass("active"),$(".quo-sum-price").removeClass("active"))}),s.on("click","#headEditor>i.s-img,#footEditor>.s-img",function(t){$.EventFn(t),m.type=$(this).attr("data-type"),$("#upImgs").click()}),s.on("change","#upImgs",function(t){$.EventFn(t),m.uploadImg()}),s.on("click",".quo-box i.s-del2",function(t){$.EventFn(t),$(this).closest(".quo-table-info").remove();for(var e=$(this).closest("ul").attr("data-id"),i=$(".quo-table-info").length,i=p.data.qSEnty,a=0;a<i.length;a++)e==i[a].productId&&i.splice(a,1);p.data.qSEnty=i;var n=f.sumPrice();$(".quo-sum-price").text(n)}),s.on("change",".quo-box .quo-table-info>li>div>select",function(t){$.EventFn(t);$(this).attr("id"),$(this).val(),$(this).find("option:selected").text()}),s.on("blur",".quo-box .quo-moq,.quo-box .quo-fobPrice",function(t){$.EventFn(t);var e=f.sumPrice();$(".quo-sum-price").text(e)}),s.on("click",".quo-box .quo-select",function(t){$.EventFn(t);var e=$(this).children("ul");e.hasClass("active")?e.removeClass("active"):(e.addClass("active"),0==e.children("li").length&&(e.hasClass("moq-unit")?f.showDicts2(p.unit.quantity,$(".moq-unit")):e.hasClass("fob-price-unit")?f.showDicts2(p.unit.price,$(".fob-price-unit")):e.hasClass("fob-quantity-unit")&&f.showDicts2(p.unit.quantity,$(".fob-quantity-unit"))))}),s.on("click",".quo-box .quo-select>ul>li",function(t){if($.EventFn(t),!$(this).hasClass("active")){$(this).addClass("active").siblings().removeClass("active");var e=parseInt($(this).attr("data-id"));if($(this).closest(".quo-select").find("span").attr("data-id",e),$(this).closest(".quo-select").find("span").text($(this).text()),$(this).closest("ul").removeClass("active"),$(this).parent().hasClass("fob-price-unit")){var i=f.sumPrice();$(".quo-sum-price").text(i)}}}),s.on("click","#quo-save",function(t){$.EventFn(t);var e={},a=!0,n=s.find("#q-name"),o=s.find("#custName"),r=s.find(".quo-sum-price"),u=s.find(".quo-table-info").length,c=p.data.qSEnty;a=$.errorsFn(n,"客户名称不能为空"),a=$.errorsFn(o,"请选择客户"),u||($.Alert("请添加产品"),a=!1),i&&(e=p.quoInfo),e.name=n.val(),e.customerId=o.attr("data-id"),e.customerName=o.val(),e.quotationNo=s.find(".quotation-no").text(),e.quotationDate=s.find("#quo-date").val(),r.attr("style")?(e.totalPrice=0,e.generateTotalPrice=0):(e.totalPrice=parseInt(r.text()),e.generateTotalPrice=parseInt(r.text())),e.totalPriceUnit=1,e.toAddress=s.find("#quo-addr").val(),e.seller=s.find("#quo-seller").val(),e.header=m.head.getContent(),e.tail=m.foot.getContent(),s.find(".quo-table-info").each(function(t){var e=$(this);c[t].productName=e.find(".quo-name").val(),c[t].fobPrice=e.find(".quo-fobPrice").val()?parseFloat(e.find(".quo-fobPrice").val()):0,c[t].fobPriceCurrency=parseInt(e.find(".fob-price-unit").prev().children("span").attr("data-id")),c[t].orderQuantity=e.find(".quo-moq").val()?parseInt(e.find(".quo-moq").val()):0,c[t].remark=e.find(".quo-remark").val()}),p.data.qSEnty=c,e.productQuotationProductEnters=c,a&&f.saveQuotation(e)}),$(".screen-choiced").click(function(){$(".screen-list").toggle()}),$(".screen-list").on("click","li",function(){$(this).parent().hide().prev().text($(this).text()),l.currentPage=1;var t=$(this).attr("data-id");"0"!=t?l.conditions=[{filedName:"customerGroupId",operateType:"=",filedValue:t}]:l.conditions=[],f.getCustomList()}),$(".screen-input-name").change(function(){""==$(this).val()?delete l.keyword:l.keyword=$(this).val()}),$(".screen-input-btn").click(function(){f.getCustomList()}),$("#btn-sure").click(function(){var t=$(".customer-list").find("input[type=radio]:checked");t.length<=0?$.Alert("请先选择客户！"):($("#custName").val(t.next().text()),$("#custName").attr("data-id",t.val()),$(".custName").text(t.next().text()),$("#customer").modal("hide"))}),$("#product-input").change(function(){d.name=$.trim($(this).val())}),$(".product-screen").click(function(){f.getResourceSettings()}),$(".product-group-check select").change(function(){var t=$(this).val();""==t&&(t=0),d.productCatelog=t,f.getResourceSettings()}),$("#product-type0,#product-type1,#product-type2,#product-type3").change(function(){var t=$(this).find("option:selected").val();""==t&&(t=0),d.productType=t,f.getResourceSettings(),f.getProductsType(t,$(this))}),$("#product-sure").click(function(){var t=$(".product-list li input[type=checkbox]:checked");if(t.length>0){for(var e=0;e<t.length;e++){var i=t.eq(e).parent().attr("data-id");f.addProductItem(i)}$("#products").modal("hide")}else $.Alert("请至少选择一个产品！")});var f={count:1,detailData:null,getNo:function(){$.ajax({url:Base.sitUrl+"/api/odd/v1/get",type:"GET",data:{data:"{'type': 3}"},dataType:"json",success:function(t){return t.success?void s.find(".quotation-no").text(t.data):void $.Alert("生成报价ID失败,"+t.message)}})},saveQuotation:function(t){var e=Base.sitUrl+"/api/quotation/v1/quotation/save";1==n&&(e=Base.sitUrl+"/api/quotation/v1/quotation/edit"),$.ajax({url:e,data:{data:JSON.stringify(t)},type:"POST",dataType:"json",success:function(t){return t.success?void(o?$.Alert("报价单保存成功！","",function(){var t=parent.me.tabIdx();parent.me.refresh2(r,"part"),parent.me.closeOne(t,!0)}):($.DestroyPopInPop(),parent.location.reload())):void $.Alert("报价单保存失败,"+t.message)}})},getQuoInfoById:function(){i&&$.ajax({url:Base.sitUrl+"/api/quotation/v1/quotation/get",data:{id:i},type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data,i="";e&&e.quotationDate&&(i=$.dateObj(e.quotationDate)._getDatetime3()),delete e.createTime,delete e.updateTime,p.quoInfo=e,s.find("#q-name").val(e.name),s.find(".quotation-no").val(e.quotationNo),s.find("#custName").val(e.customerName),s.find("#custName").attr("data-id",e.customerId),s.find(".custName").text(e.customerName),s.find("#quo-date").val(i),s.find("#quo-addr").val(e.toAddress),s.find(".quo-sum-price").text(e.totalPrice);var a="<p></p><p></p>";m.head.setContent(a,!1),m.foot.setContent(a,!1),m.head.setContent(e.header,!0),m.foot.setContent(e.tail,!0);var n,o=e.productQuotationProductEnters;if(0!=o.length)for(var r=0;r<o.length;r++)f.addProductItem(o[r].id,o),n=$(".quo-table-info"),n.eq(r).children("li").eq(1).find(".quo-name").val(o[r].productName),n.eq(r).children("li").eq(3).find(".quo-moq").val(o[r].orderQuantity),n.eq(r).children("li").eq(3).find(".moq-unit").prev().children("span").text(o[r].minQuantityUnitName),n.eq(r).children("li").eq(3).find(".moq-unit").prev().children("span").attr("data-id",o[r].orderQuantityUnit),n.eq(r).children("li").eq(4).find(".quo-fobPrice").val(o[r].fobPrice),n.eq(r).children("li").eq(4).find(".fob-price-unit").prev().children("span").attr("data-id",o[r].fobPriceCurrency),n.eq(r).children("li").eq(4).find(".fob-quantity-unit").prev().children("span").attr("data-id",o[r].orderQuantityUnit),n.eq(r).children("li").eq(5).find(".quo-remark").val(o[r].remark)}})},getProductById:function(){a&&$.ajax({url:Base.sitUrl+"/api/product/v1/product/get",data:{id:a},type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.Alert("获取产品信息失败,"+t.message);var e=t.data;p.productList.push(e),f.addProductItem(a)}})},getCustomList:function(){$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/list/query",type:"POST",data:{data:JSON.stringify(l)},dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;t.data.totalItem;p.custList=e.results,f.showCustomItem(e)}})},getCustomGroups:function(t){$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/group/list",type:"GET",success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data;if(e.length>0){for(var i='<li data-id="0">全部分组</li>',a=0;a<e.length;a++)i+='<li data-id="'+e[a].id+'">'+e[a].name+"</li>";$(".screen-list").empty().append(i)}}})},getDicts:function(t,e){$.ajax({url:Base.sitUrl+"/api/sys/v1/sys/dictionary/get",data:{group:t},type:"POST",dataType:"json",success:function(i){if(!i.success)return void $.unLogin(i);var a=i.data;a.length>0&&("currency"==t?p.unit.price=a:"unit"==t&&(p.unit.quantity=a),f.showDicts(a,t,e))}})},showDicts:function(t,e,i){for(var a="",n=0;n<t.length;n++)a+='<li data-id="'+t[n].id+'">'+t[n].value+"</li>";var o=$(".quo-table-info:last .moq-unit"),r=$(".quo-table-info:last .fob-quantity-unit"),s=$(".quo-table-info:last .fob-price-unit"),u={unit:o.selector.split(" ")[1],price:s.selector.split(" ")[1],punit:r.selector.split(" ")[1]};i.selector.indexOf(",")!=-1&&1==e?(i.selector.indexOf(u.unit)!=-1&&1==e&&(o.prev("label").children("span").attr("data-id",t[0].id),o.prev("label").children("span").text(t[0].name),o.empty(),o.append(a)),i.selector.indexOf(u.punit)!=-1&&1==e&&(r.prev("label").children("span").attr("data-id",t[0].id),r.prev("label").children("span").text(t[0].name),r.empty(),r.append(a))):i.selector.indexOf(u.price)!=-1&&0==e&&(s.prev("label").children("span").attr("data-id",t[0].id),s.prev("label").children("span").text(t[0].name),s.empty(),s.append(a))},showDicts2:function(t,e){for(var a="",n=0;n<t.length;n++)a+='<li data-id="'+t[n].id+'">'+t[n].value+"</li>";e.empty(),e.append(a),i&&t.length>0&&(e.prev("label").children("span").attr("data-id",t[0].id),e.prev("label").children("span").text(t[0].value))},getResourceSettings:function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/info/list",type:"GET",data:d,beforeSend:function(t){$.BlockUI()},complete:function(t,e){$.UnblockUI()},success:function(t){if(!t.success)return void $.unLogin(t);var e=t.data.results,i="";if(null!=e&&""!=e){p.productList=e;for(var a=0;a<e.length;a++)i+='<li data-id="'+e[a].id+'"><input type="checkbox" id="checkbox'+a+'" name="model-checkbox">&nbsp;<label for="checkbox'+a+'" style="display: inline-block;margin-left: 5px;margin-top: 5px;width: 500px;text-overflow: ellipsis;overflow: hidden;white-space: nowrap;">'+e[a].name+"</label></li>"}else i+='<div class="text-center">暂无产品</div>';$("#products .product-list").empty().append(i);var n=t.data.totalItem,o=Math.ceil(n/d.pageSize);$.Page({total:n,_class:".product-page",nowNum:d.currentPage,allNum:o,callback:function(t,e){d.currentPage=t,f.getResourceSettings()}})}})},getProductsGroup:function(){$.ajax({url:Base.sitUrl+"/api/product/v1/product/catelog/list",type:"GET",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);for(var e=t.data,i='<option value="">全部</option>',a=0;a<e.length;a++)i+='<option value="'+e[a].id+'">'+e[a].name+"</option>";$(".product-group-check select").empty().append(i)}})},getProductsType:function(t,e){$.ajax({url:Base.sitUrl+"/api/product/v1/product/type/sublist?pid="+t,type:"GET",dataType:"json",success:function(t){if(!t.success)return void $.unLogin(t);for(var i=t.data,a='<option value="">全部</option>',n=0;n<i.length;n++)a+='<option value="'+i[n].id+'">'+i[n].name+"</option>";e?e.parent().next().find("select").empty().append(a):$("#product-type0").empty().append(a)}})},getStyle:function(t,e){var i=Base.sitUrl+"/api/quotation/v1/quotation/head/list";2==e&&(i=Base.sitUrl+"/api/quotation/v1/quotation/tail/list"),$.ajax({url:i,type:"GET",dataType:"json",success:function(i){if(!i.success)return void $.unLogin(i);var a=i.data,n="";if(a.length>0){1==e?p.quoHead=a:2==e&&(p.quoFoot=a);for(var o=0;o<a.length;o++)n+='<li data-id="'+a[o].id+'">'+a[o].name+"</li>";t.empty().append(n)}}})},sumPrice:function(){var t=0;return $(".quo-table-info").each(function(){if(isNaN($(this).find(".quo-fobPrice").val())||isNaN($(this).find(".quo-moq").val()))return void $.Alert("请输入正数");var e=parseFloat($(this).find(".quo-fobPrice").val()),i=parseInt($(this).find(".quo-moq").val()),a=$(this).find(".fob-price-unit").prev("label").children("span").text();"CNY"==a&&(e/=6.49),t+=parseFloat(e*i)}),parseFloat(t).toFixed(2)},showCustomItem:function(t){if(0==p.custList.length)$(".customer-list").empty().html('<p class="customer-none">没有匹配客户！</p>');else{for(var e="<ul>",i=0;i<p.custList.length;i++)e+='<li>                            <input type="radio" name="customer" value="'+p.custList[i].id+'" />                            <span>'+p.custList[i].name+"</span>                            </li>";$(".customer-list").empty().append(e)}var a=t.totalItem,n=Math.ceil(t.totalItem/t.pageSize);$.Page({total:a,_class:".customer-page",nowNum:l.currentPage,allNum:n,callback:function(t,e){l.currentPage=t,f.getCustomList()}})},addProductItem:function(t,e){var a=p.productList;e&&(a=e);for(var n={},o=0;o<a.length;o++)if(t==a[o].id){n=a[o];var r=n.productTradeInfoEnter;r&&r.fomPriceMin?p.data.qSEnty.push({productId:n.id,productName:n.name,productPhoto:n.productPhoto||n.imgs,fobPrice:r.fomPriceMin,fobPriceCurrency:r.fomPriceCurrency,orderQuantity:r.minOrderQuantity,orderQuantityUnit:r.minOrderQuantityUnit,remark:n.remark}):p.data.qSEnty.push({productId:n.id,productName:n.name,productPhoto:n.productPhoto||n.imgs,fobPrice:n.fobPrice,fobPriceCurrency:n.fobPriceCurrency,orderQuantity:n.orderQuantity,orderQuantityUnit:n.orderQuantityUnit,remark:n.remark});break}var s="";if(n&&n.id){var u=n.remark,c={},d={},l="",m=n.productPhoto||n.imgs;r&&r.fomPriceMin?(l=n.name,c.quantity=r.minOrderQuantity||0,c.qunit=r.minOrderQuantityUnit||-1,d.price=r.fomPriceMin||0,d.punit=r.fomPriceCurrency||-1):(l=n.productName||"",c.quantity=n.orderQuantity||0,c.qunit=n.orderQuantityUnit||-1,d.price=n.fobPrice||0,d.punit=n.fobPriceCurrency||-1),s='<ul class="quo-table-info" data-id="'+n.id+'">                                <li>'+f.count+'</li>                                <li>                                    <div>                                        <input type="text" class="quo-name" value="'+l+'"/>                                    </div>                                </li>                                <li><img src="'+m+'" alt="图片"></li>                                <li>                                    <div>                                        <input type="text" class="quo-moq" value="'+c.quantity+'" data-unit="'+c.qunit+'" />                                    </div>                                </li>                                <li>                                    <div>                                        <input type="text" class="quo-fobPrice" value="'+d.price+'" data-type="'+d.punit+'" />                                        <div class="quo-select">                                            <label><span data-id="-1">请选择</span><i class="s-updownBg s-up3"></i></label>                                            <ul class="fob-price-unit"></ul>                                        </div>                                        <div class="quo-select">                                            <label><span data-id="-1">请选择</span><i class="s-updownBg s-up3"></i></label>                                            <ul class="fob-quantity-unit"></ul>                                        </div>                                    </div>                                </li>                                <li>                                    <div><input type="text" class="quo-remark" value="'+u+'" /></div>                                </li>                                <div class="clear"></div><i class="s-updownBg s-del2"></i>                            </ul>';var v=$(".quo-table-title"),h=$(".quo-table-title").nextAll(".quo-table-info");h.length>0?h.eq(h.length-1).after(s):v.after(s),f.count++,$(".quo-table-info img").error(function(){$(this).attr("src","../images/user.jpg")}),$(".quo-table-info img").load(function(){$.cutImage(this,100,100)}),0!=p.unit.quantity.length&&0!=p.unit.price.length||(f.getDicts("unit",$(".moq-unit,.fob-quantity-unit")),f.getDicts("currency",$(".fob-price-unit"))),i&&(f.showDicts2(p.unit.quantity,$(".moq-unit")),f.showDicts2(p.unit.quantity,$(".fob-quantity-unit")),f.showDicts2(p.unit.price,$(".fob-price-unit")));var g=f.sumPrice();$(".quo-sum-price").text(g)}}},m={head:null,foot:null,type:null,createEditor:function(){var t=[["emotion","fontfamily","fontsize","forecolor","backcolor","|","bold","italic","|","underline","strikethrough","|","fontborder","|","subscript","superscript","|","formatmatch","|","insertorderedlist","insertunorderedlist","justifyleft","justifyright","justifycenter","justifyjustify","|","source"]];m.head=UE.getEditor("headEditor",{toolbars:t,initialFrameWidth:"100%",elementPathEnabled:!1,autoHeightEnabled:!1,initialFrameHeight:200}),m.foot=UE.getEditor("footEditor",{toolbars:t,initialFrameWidth:"100%",elementPathEnabled:!1,autoHeightEnabled:!1,initialFrameHeight:200})},uploadImg:function(){m.type&&$("#form_img").ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(t){if(!t.success)return void $.unLogin(t);var e="http://"+t.data,i='<img src="'+e+'" alt="插入图片">';"head"==m.type?m.head.setContent(i,!0):m.foot.setContent(i,!0)}}).submit()}};$.when(m.createEditor()).then(f.getNo()).then(f.getStyle(s.find("#quoHead").next(),1)).then(f.getStyle(s.find("#quoFoot").next(),2)).then(f.getResourceSettings()).then(f.getQuoInfoById()).then(f.getCustomList()).then(f.getCustomGroups()).then(f.getProductsType(0)).then(f.getProductsGroup()),f.getProductById()})});