require(["common"],function(){require(["maintab","blockUI","jqform"],function(a){var e=$.GetQueryString("id");a.init(),$("#con-add").on("click",function(){var a=t.currentData,e=$("#name"),s=$("#email");a.headImgUrl=$("#headImg").attr("src"),a.position=$("#position").val(),a.name=e.val(),a.email=$("#email").val(),a.cellphone=$("#phone").val();var r='<div class="errors">                            <span></span>                        </div>',n=!0;null==e.val()||""==e.val()?(e.hasClass("error")||(e.addClass("error"),e.after(r),e.next(".errors").addClass("active"),e.next(".errors").children("span").text("请输入昵称")),n=!1):(e.removeClass("error"),e.next(".errors").removeClass("active")),null==s.val()||""==s.val()?(s.hasClass("error")||(s.addClass("error"),s.after(r),s.next(".errors").addClass("active"),s.next(".errors").children("span").text("请输入邮箱")),n=!1):(s.removeClass("error"),s.next(".errors").removeClass("active"));var o=$("#company").attr("data-id");o&&(a.customerId=o),n&&(console.log(a),t.saveRelatives(a))}),$("input[name=upfile]").on("change",function(){var a=$(this).val(),e=["jpg","gif","bmp","png","jpeg"],s=a.substring(a.lastIndexOf(".")+1).toLocaleLowerCase(),r=$(".head-tools").nextAll(".errors");if(e.indexOf(s)==-1)r.addClass("active");else{r.removeClass("active");var n=this.files[0].size;if(n>1048576)return r.addClass("active"),void r.children("span").text("图片不能大于1MB");t.uploadImg()}}),$("#company").on("click",function(a){$.EventFn(a),$(".company-list").addClass("active")}),$("#company").on("blur",function(){var a=$("#company");null!=a.val()&&""!=a.val()&&t.getCheckCompany(a.val())}),$(".company-list").on("click",">li",function(a){$.EventFn(a);var e=$(this).attr("data-id");$("#company").val($(this).text()),$("#company").attr("data-id",e),$(".company-list").removeClass("active")});var t={currentData:{},getAllCompany:function(){$.AjaxFun({data:{_mt:"customer_getPageSimpleCustomersByBlock",block:-1},success:function(a){if(!a.success)return void $.unLogin(a);var e=a.data.result;if(e.length>0){for(var t="",s=$(".company-list"),r=0;r<e.length;r++)t+='<li data-id="'+e[r].id+'">'+e[r].name+"</li>";s.append(t)}}})},getRelativesById:function(a){$.AjaxFun({data:{_mt:"relatives_getRelativesById",id:a||-1},success:function(e){if(!e.success)return void $.unLogin(e);t.currentData=e.data;for(var s=e.data,r=s.customerExtraEntityList,n="",o=0;o<r.length;o++){var i="",l=r[o];1==l.isNecessary&&(i='<span class="active">*</span>'),n+='<div class="form-group"><label for="extra_'+o+'" class="col-xs-2 control-label">'+i+l.resourceSettingName+'</label><div class="col-xs-10"><input type="text" class="form-control" id="extra_'+o+'" /></div></div>'}var c=$("fieldset>.form-group").length;if($("fieldset>.form-group").eq(c-1).after(n),a){var s=e.data;$("#con-add").text("修改"),$("#headImg").attr("src",s.headImgUrl||"../images/user.jpg"),$("#name").val(s.name),$("#position").val(s.position),s.customerEntity&&s.customerEntity.name&&($("#company").val(s.customerEntity.name),$("#remark").val(s.customerEntity.remark||"--")),$("#email").val(s.email),$("#phone").val(s.cellphone)}}})},saveRelatives:function(a){$.AjaxFun({data:{_mt:"relatives_saveRelatives",relativesEntity:JSON.stringify(a)},success:function(a){return a.success?($.DestroyPopInPop(),void parent.location.reload()):void $.unLogin(a)}})},uploadImg:function(){$("#uploadImg form").ajaxForm({url:Base.sitUrl+"/file/upload.jhtml",beforeSend:function(){$.BlockUI()},success:function(a){if(!a.success)return void $.unLogin(a);var e="http://"+a.data;$("#headImg").attr("src",e),$.UnblockUI()}}).submit()},getCheckCompany:function(e){$.AjaxFun({data:{_mt:"customer_checkCustomerIsExists",customerId:-1,customerName:e},success:function(e){return e.success?void(e.data||a.showOnAlikeTab("pop-customer-detail",Base.url+"/html/pop-customer-add.html?company="+$("#company").val()+"&v="+window.ver,"新建客户")):void $.unLogin(e)}})}};t.getRelativesById(e),t.getAllCompany()})});