require(["common"],function(){require(["maintab","blockUI","jqform","ztree","datetimepickerCN"],function(e){function t(){var e="";return $.ajax({url:Base.sitUrl+"/api/sys/v1/sys/countries/get",type:"POST",dataType:"json",async:!1,success:function(t){e+=JSON.stringify(t.data)}}),e}function a(e){return null==e?"":e}function s(e){$.ajax({url:Base.sitUrl+e,type:"POST",data:{keyword:l},success:function(e){var t=e.data,a="";if(t.length>5)var s=5;else var s=t.length;for(var i=0;i<s;i++)a+='<div class="the-same-as" data-fb="'+t[i].facebookId+'">                                    <img src="../images/user.jpg" alt="头像"/>                                    <span>'+t[i].name+'</span>                                    <label>                                        <i class="s-updownBg s-yes"></i>                                        <span>|</span>                                        <i class="s-updownBg s-no"></i>                                    </label>                                </div>';$("#sameorno").empty(),$("#sameorno").append(a)}})}function i(e,t){var i={customerId:e,type:t};$.ajax({url:Base.sitUrl+"/api/social/customer/info",type:"POST",data:{data:JSON.stringify(i)},success:function(e){if(!e.success)return void console.log(e.message);var i=e.data;if(null!==i&&void 0!==i&&""!==i)$(".fb-name").text(a(i.name)),$(".fb-email").text(a(i.email)),$(".fb-gender").text(a(i.gender)),$(".fb-birthday").text(a(i.birthday)),$("#sameorno").parents(".right-content").hide();else{if(1==t)var n="/api/facebook/search";else if(3==t)var n="/api/linkedIn/search";s(n),$("#sameorno").parents(".right-content").show()}}})}function n(e,t,a,s){var i={userId:e,socialId:t,type:a,isCheck:s,signType:s};$.ajax({url:Base.sitUrl+"/api/social/is/check",type:"POST",data:{data:JSON.stringify(i)},success:function(e){return e.success?($(".the-same-as").hide(),void $(".the-same-as").prev("label").hide()):void console.log(e.message)}})}var l,o,d,c=$.GetQueryString("id"),r=$(".box-customer-detail"),p=r.find(".s-menus"),u=(r.find("#groupsModal"),r.find("#delsModal")),v="";e.init(),jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({language:"zh-CN",todayBtn:1,autoclose:1,todayHighlight:1,format:"yyyy-mm-dd hh:ii",bootcssVer:3});var m={pageSize:$.pageObj?$.pageObj.pageSize:8,currentPage:$.pageObj?$.pageObj.currentPage:8};r.on("click",".tab-content",function(t){$.EventFn(t);var a=$(this).attr("data-id"),s=$(this).closest(".box-tab"),i=$(this).attr("data-type");$(this).attr("data-userid"),$(top.document).find("#pageLeftUserName").attr("data-id");if(s.hasClass("tabs-email")){var n=$(this).attr("data-etype");"2"==n?e.showTab(Base.url+"/html/pop-email-detailOut.html?id="+a+"&uri=/api/email/outbox/v1/detail&v="+window.ver,"邮件详情"):e.showTab(Base.url+"/html/pop-email-detail.html?id="+a+"&uri=/api/email/inbox/v1/detail&v="+window.ver,"邮件详情")}else if(s.hasClass("tabs-quotation"))e.showTab(Base.url+"/html/pop-quotation-detail.html?id="+a+"&v="+window.ver,"报价单详情");else if(s.hasClass("tabs-pi"))e.showTab(Base.url+"/html/pop-pi-detail.html?id="+a+"&v="+window.ver,"pi详情");else if(s.hasClass("tabs-order"))e.showTab(Base.url+"/html/pop-order-detail.html?id="+a+"&v="+window.ver,"订单详情");else if(s.hasClass("tabs-edm"))e.showTab(Base.url+"/html/pop-letter-detail.html?id="+a+"&v="+window.ver,"营销信详情");else if(s.hasClass("tabs-task"))e.showTab(Base.url+"/html/pop-detail.html?taskId="+a+"&v="+window.ver,"任务详情");else if(s.hasClass("tabs-time")&&i.length>0)if("email"==i){var n=$(this).attr("data-etype");"2"==n?e.showTab(Base.url+"/html/pop-email-detailOut.html?id="+a+"&uri=/api/email/outbox/v1/detail&v="+window.ver,"邮件详情"):e.showTab(Base.url+"/html/pop-email-detail.html?id="+a+"&uri=/api/email/inbox/v1/detail&v="+window.ver,"邮件详情")}else"quotation"==i?e.showTab(Base.url+"/html/pop-quotation-detail.html?id="+a+"&v="+window.ver,"报价单详情"):"pi"==i?e.showTab(Base.url+"/html/pop-pi-detail.html?id="+a+"&v="+window.ver,"pi详情"):"order"==i?e.showTab(Base.url+"/html/pop-order-detail.html?id="+a+"&v="+window.ver,"订单详情"):"edm"==i?e.showTab(Base.url+"/html/pop-letter-detail.html?id="+a+"&v="+window.ver,"营销信详情"):"task"==i&&e.showTab(Base.url+"/html/pop-detail.html?taskId="+a+"&v="+window.ver,"任务详情")}),r.on("click",".status-star>i",function(e){$.EventFn(e);var t=$(this).index()+1,a={};a.id=c,a.starLevel=t,a.setType="setStar",g.setRelationInfo(a)}),r.on("click",".s-other",function(e){$.EventFn(e);var t=$(this).next("ul");t.hasClass("active")?t.removeClass("active"):t.addClass("active")}),r.on("click",".s-menus>li",function(t){$.EventFn(t);var a=$(this).index();if(r.find(".modals").removeClass("active"),0==a)e.showTab(Base.url+"/html/pop-contacts-add.html?id="+c+"&v="+window.ver,"编辑联系人");else if(1==a){if(u.hasClass("active"))return!1;u.addClass("active")}}),r.on("click",".doc-handle",function(e){$.EventFn(e),$(".doc-handle-cont").hide(),$(this).next().show()}),r.on("click",".doc-delete",function(e){$.EventFn(e);var t=$(this).closest(".tab-content");$.ajax({url:Base.sitUrl+"/api/user/v1/document/delete",type:"POST",dataType:"json",data:{data:JSON.stringify({id:t.attr("data-id")})},success:function(e){if(!e.success)return void $.unLogin(e);t.remove();var a=parseInt($(".documentCount").text());$(".documentCount").text(--a)}})});var f={};r.on("click",".doc-upload",function(e){f.size=$(this).attr("data-size"),f.file=$(this).attr("data-url"),f.name=$(this).attr("data-name"),$("#cloudModal").modal("show")}),$("#addCloud").click(function(){$("#cloudModal").modal("hide");var e=$.fn.zTree.getZTreeObj("treeCloud").getSelectedNodes();if(""==e)var t="0";else var t=e[0].id;var a={pid:t,type:"1",shareType:"1",operateType:"0",userType:"0"};$.extend(a,f),$.ajax({url:Base.sitUrl+"/api/disk/v1/file/save",type:"POST",dataType:"json",data:{data:JSON.stringify(a)},beforeSend:function(e){$.BlockUI()},complete:function(e,t){$.UnblockUI()},success:function(e){return e.success?void $.Alert("保存成功!","",function(){f={}}):void $.unLogin(e)}})}),$("body").bind("click",function(e){$.EventFn(e),$(".doc-handle-cont").hide()}),r.on("click","#del-ok",function(e){$.EventFn(e),g.setRelationInfo({ids:c,setType:"delete"})}),r.on("click",".edit-overview",function(e){var t=r.find(".info-overview"),a=t.find(".overview-show"),s=t.find(">li>input"),i={};a.hasClass("active")?(a.removeClass("active"),s.removeClass("active"),i.id=c,i.setType="editOverview",i.phone=r.find(".overview-phone").val(),i.email=r.find(".overview-email").val(),g.setRelationInfo(i)):(a.addClass("active"),s.addClass("active"))}),r.on("click",".info-overview>li>.s-mail2",function(t){$.EventFn(t);var a=$(this).parent().find(".o-email").text();e.showTab(Base.url+"/html/pop-email-new.html?name="+a+"&showType=right&v="+window.ver,"回复邮件")}),$(window).on("click",function(e){e.target.closest(".s-menus")!=p[0]&&r.find(".s-menus").removeClass("active")}),r.on("click",".box-quick-menu>li",function(t){$.EventFn(t);var a=$(this).index(),s=r.find("#box-follow");if($(this).hasClass("active"))return!1;if($(this).addClass("active").siblings("li").removeClass("active"),r.find(".quick-input").removeClass("active"),s.val()&&s.val(""),0==a)r.find(".btn-sign").addClass("active"),r.find(".box-selects").removeClass("active"),r.find(".box-selects2").addClass("active");else if(1==a)r.find(".btn-sign").removeClass("active"),r.find(".list-file").remove(),r.find(".box-selects").addClass("active"),r.find(".box-selects2").removeClass("active"),r.find("#task-remind").attr("data-id",5).text("5分钟后"),r.find("#task-remind").next("ul").children("li:first").addClass("active").siblings("li").removeClass("active");else if(2==a){var i=$(".o-email").text();e.showTab(Base.url+"/html/pop-email-new.html?name="+i+"&showType=right&v="+window.ver,"新建邮件")}r.find(".quick-input").attr("data-type",$(this).index())}),r.on("click","#box-follow",function(e){$.EventFn(e);var t=r.find(".quick-input");return!t.hasClass("active")&&void t.addClass("active")}),r.on("click",".show-models",function(e){$.EventFn(e);var t=$(this).attr("data-type"),a=".show-"+t;return!$(a).hasClass("active")&&(r.find(".models2").removeClass("active"),void r.find(a).addClass("active"))}),r.on("click",".models2-top>.s-dels6",function(e){$.EventFn(e),r.find(".models2").removeClass("active")}),r.on("click",".models2-content .set-btn",function(e){$.EventFn(e);var t=$(this).parent().children("input"),a=$(this).prev(".list-follower"),s=$.errorsFn(t,"请输入内容"),i={};if(s&&t.length>0){if(i.setType="addTag",i.tagName=t.val(),t.val().length>255)return $.Alert("标签内容不得超出255个字"),!1;i.id=c,g.setRelationInfo(i)}else a.length>0&&(i.ids=c,i.setType="addFollower",i.userId=r.find(".list-follower>li.active").attr("data-id"),i.name=r.find(".list-follower>li.active").text(),g.setRelationInfo(i))}),r.on("click",".list-follower>li",function(e){return $.EventFn(e),!$(this).hasClass("active")&&void $(this).addClass("active").siblings("li").removeClass("active")}),r.on("click",".list-label>li>i,.list-follow>li>span>i",function(e){$.EventFn(e);var t,a=$(this).parent(),s={};a.parent().hasClass("list-label")?(t=a,s={id:parseInt(t.attr("data-id")),setType:"delTag"}):(t=a.parent(),s={followUpUserId:parseInt(t.attr("data-id")),setType:"delFollower"}),g.setRelationInfo(s,t),id=null,s=null,t=null}),r.on("click",".cancel-follow",function(e){var t={ids:c,setType:"unFollow"};g.setRelationInfo(t,null)}),r.on("change","#up-image",function(){var e=$(this).prop("files")[0];e&&g.uploadFile("img",e,$("#upload-img"))}),r.on("change","#up-files",function(){var e=$(this).prop("files")[0];e&&g.uploadFile("file",e,$("#upload-file"))}),r.on("click",".upload-imgList>i.s-dels3",function(e){$.EventFn(e);for(var t=r.find(".upload-imgList>li"),a=0;a<t.length;a++)if(t.eq(a).hasClass("active")){t.eq(a).remove(),$(this).removeClass("active");break}}),r.on("click",".list-file>li>.s-dels3",function(e){$.EventFn(e);var t=$(this).parent();t.remove(),0==r.find(".list-file>li").length&&r.find(".list-file").remove()}),r.on("click",".model-select",function(e){$.EventFn(e);var t=$(this).children("ul");t.hasClass("active")?t.removeClass("active"):($(".model-select>ul").removeClass("active"),t.addClass("active"))}),r.on("click",".upload-filelist>li>label>a, .doc-download",function(e){$.EventFn(e);var t=$(this).attr("data-type"),a=$(this).attr("data-name"),s=$(this).attr("data-url"),i=$(this).closest("li");if(0==t){var n={name:a,value:s};g.getFile(n)}else g.delFollowFile(i.attr("data-id"),i)}),r.on("click",".model-select>ul>li",function(e){$.EventFn(e);var t=$(this).parent(),a=t.prev("label"),s=$(this).text(),i=$(this).attr("data-id");a.attr("data-id",i),$(this).addClass("active").siblings().removeClass("active"),a.text(s),t.removeClass("active")}),r.on("click",".btn-decision>a",function(e){$.EventFn(e),$("#box-follow").parent("div").removeClass("active"),r.find("#box-follow").val("")}),r.on("click",".btn-publish",function(e){$.EventFn(e);var t={customerId:o,customerContactsId:c},a=parseInt(r.find(".quick-input").attr("data-type")),s=r.find("#box-follow"),i=r.find(".list-file>li"),n=[];if(null==s.val()||""==$.trim(s.val()))return s.attr("placeholder","请输入需发布的内容"),$.Alert("发布内容不能为空"),!1;if(a){t.name="快速创建任务",t.description=s.val(),t.remindTime=r.find("#task-remind").attr("data-id"),t.executionTimeType=1;var l=new Date;t.executionTime=$.dateObj(l.getTime()+864e5)._getDatetime()}else{for(var d=0;d<i.length;d++)n.push({attachmentType:parseInt(i.eq(d).attr("data-type")),attachment:i.eq(d).attr("data-url"),attachmentName:i.eq(d).children("span").text()});t.paramType=1,t.attachments=n,t.content=s.val()}g.saveFollowOrTask(t,a),t={},a=null}),r.on("click",".tabs-menu>li",function(e){if($.EventFn(e),$(this).hasClass("active"))return!1;var t=$(this).attr("data-type"),a=".tabs-"+t;$(this).addClass("active").siblings("li").removeClass("active"),$(a).addClass("active").siblings(".box-tab").removeClass("active"),g.timeObj.currentPage=1,g.followObj.currentPage=1,g.page.currentPage=1,g.fileObj.currentPage=1,$(".page").addClass("active"),"follow"==t?g.getRelationsList(g.followObj,"follow"):"email"==t?g.getRelationsList(g.page,"email"):"edm"==t?g.getRelationsList(g.page,"edm"):"quotation"==t?g.getRelationsList(g.page,"quotation"):"pi"==t?g.getRelationsList(g.page,"pi"):"order"==t?g.getRelationsList(g.page,"order"):"task"==t?g.getRelationsList(g.page,"task"):"timeline"==t?g.getRelationsList(g.timeObj,"timeline"):"file"==t&&g.getRelationsList(g.fileObj,"file")}),r.on("click",".tab-top>a,.trNone>a",function(t){$.EventFn(t);var a=$(this).attr("data-type"),s=parent.me.tabIdx();"email"==a?e.showTab(Base.url+"/html/pop-email-new.html?name="+$(".o-email").text()+"&showType=right&v="+window.ver,"新建邮件"):"edm"==a?e.showTab(Base.url+"/html/pop-letter-new.html?&v="+window.ver,"新建营销信"):"quotation"==a?e.showTab(Base.url+"/html/pop-quotation-add.html?custId="+o+"&contId="+s+"&pIdx="+s+"&v="+window.ver,"新建报价单"):"pi"==a?e.showTab(Base.url+"/html/pop-pi-add.html?custId="+o+"&contId="+s+"&pIdx="+s+"&v="+window.ver,"新建PI"):"order"==a?e.showTab(Base.url+"/html/pop-order-add.html?custId="+o+"&contId="+s+"&pIdx="+s+"&v="+window.ver,"新建订单"):"task"==a?e.showTab(Base.url+"/html/pop-task.html?custId="+o+"&contId="+c+"&contName="+v+"&v="+window.ver,"新建任务"):"upload"==a?e.showTab(Base.url+"/html/pop-upload-file.html?custId="+o+"&contId="+c+"&v="+window.ver,"上传文档"):"follow"==a?e.showTab(Base.url+"/html/pop-upload-cont.html?id="+c+"&pIdx="+parent.me.tabIdx()+"&v="+window.ver,"新建跟进"):e.showTab(Base.url+"/html/pop-upload-cont.html?id="+c+"&pIdx="+parent.me.tabIdx()+"&v="+window.ver,"新建跟进")}),r.on("click",".info-edit",function(t){$.EventFn(t),e.showTab(Base.url+"/html/pop-contacts-add.html?id="+c+"&v="+window.ver,"编辑联系人")});var g={page:{contactsId:c,id:c,type:2,pageSize:m.pageSize,currentPage:m.currentPage},timeObj:{customerContactsId:c,pageSize:m.pageSize,currentPage:m.currentPage},followObj:{customerContactsId:c,pageSize:m.pageSize,currentPage:m.currentPage,paramType:1},fileObj:{customerContactsId:c,pageSize:m.pageSize,currentPage:m.currentPage},list:{employee:[]},info:{},setRelationInfo:function(e,t){$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/set",type:"POST",data:{data:JSON.stringify(e)},dataType:"json",success:function(a){if(!a.success)return void $.Alert("设置失败，"+a.message);if("setStar"==e.setType){var s=r.find(".status-star"),i=(s.children("i"),e.starLevel),n=5-i,l='<i class="s-updownBg s-star3"></i>';if(i>0){for(var o=1;o<i;o++)l+='<i class="s-updownBg s-star3"></i>';for(var o=0;o<n;o++)l+='<i class="s-updownBg s-unstar2"></i>'}else for(var o=0;o<4;o++)l+='<i class="s-updownBg s-unstar2"></i>';s.empty().append(l),l=null}else if("editOverview"==e.setType)r.find(".o-phone,.con-phone").text(e.phone||""),r.find(".o-email,.con-email").text(e.email||"");else if("addTag"==e.setType){var d=r.find(".list-label");r.find(".models2").removeClass("active"),r.find(".models2-content>input").val(""),r.find(".list-label").append('<li data-id="'+a.data.id+'"><span>'+e.tagName+'</span><i class="s-updownBg s-dels3"></i></li>'),d.children("li").length>0&&d.children("span").remove()}else if("addFollower"==e.setType){var l='<li data-id="'+e.ids+'" data-user="'+e.userId+'"><i class="s-updownBg s-users2"></i><span>'+e.name+'<i class="s-updownBg s-dels3"></i></span></li>',c=r.find(".list-follow");r.find(".list-follow").append(l),r.find(".models2").removeClass("active"),c.children("li").length>0&&c.children("span").remove()}else"delTag"==e.setType?t&&t.remove():"unFollow"!=e.setType&&"delFollower"!=e.setType||parent.location.reload()}})},saveFollowOrTask:function(e,t){var a=Base.sitUrl+"/api/user/v1/user/followup/save";t&&(a=Base.sitUrl+"/api/task/v1/task/save"),$.ajax({url:a,type:"POST",data:{data:JSON.stringify(e)},dataType:"json",success:function(e){return e.success?($.Alert("发布成功！"),r.find("#box-follow").val(""),r.find(".list-file").remove(),r.find(".upload-imgList>li").each(function(){$(this).remove()}),t&&(r.find("#task-remind").attr("data-id",5).text("5分钟后"),r.find("#task-remind").next("ul").children("li:first").addClass("active").siblings("li").removeClass("active")),g.getEmployees(),g.getRelationInfo(),g.getUnits(),void g.getRelationsList(g.timeObj,"timeline")):void $.Alert("发布失败，"+e.message)}})},getRelationsList:function(e,t){var a=Base.sitUrl,s={data:JSON.stringify(e)};"follow"==t?(a+="/api/user/v1/user/followup/list/page",s=e):"email"==t?a+="/api/customer/contacts/v1/detail/emails":"edm"==t?a+="/api/customer/contacts/v1/detail/edms":"task"==t?(s=e,a+="/api/task/v1/task/timeline/list"):"quotation"==t?(s=e,a+="/api/quotation/v1/quotation/timeline/list"):"pi"==t?(s=e,a+="/api/pi/v1/pi/timeline/list"):"order"==t?(s=e,a+="/api/order/v1/order/timeline/list"):"timeline"==t?(s=e,a+="/api/user/v1/user/timeline/list"):"file"==t&&(a+="/api/user/v1/document/list/page"),$.ajax({url:a,data:s,type:"POST",dataType:"json",success:function(a){if(!a.success)return void $.unLogin(a);var s=a.data.results,i=g.list.currency,n="",l="",o="empty-doc.png";if("follow"==t){$(".followCount").text(a.data.totalItem),l="跟进",o="empty-fllow.png";for(var d=0;d<s.length;d++){var c=s[d].content,p=s[d].createTime,u=g.info.name||"匿名",v=s[d].attachments,f="",h="";if(v.length>0){for(var b=0;b<v.length;b++){var y=v[b].attachmentName,w="http://"+v[b].attachment;1==v[b].attachmentType?h+='<li data-id="'+v[b].id+'">                                                        <label><i class="s-updownBg s-link4"></i><span>'+y+'</span></label>                                                        <label>                                                            <a href="javascript:;" data-url="'+w+'" data-name="'+y+'" download data-type="0">下载</a>                                                            <span>|</span>                                                            <a href="javascript:;" data-type="1">删除</a>                                                        </label>                                                    </li>':f+='<li><img src="'+w+'" alt="图片"></li>'}h='<ul class="upload-filelist">'+h+"</ul>",f='<ul class="upload-imglist">'+f+"</ul>"}n+='<div class="tab-content" data-id="'+s[d].id+'">                                            <label class="tab-sign"><i class="s-menuBg s-menu16"></i></label>                                            <div class="tab-style">                                                <div class="style-title"><span>'+p+"</span><span>"+u+'</span><span>创建了跟进</span></div>                                                <div class="style-content">                                                    <div class="follow-style">                                                        <p>'+c+"</p>"+f+'<div class="clear"></div>'+h+'                                                    </div>                                                </div>                                            </div>                                            <div class="clear"></div>                                        </div>'}}else if("email"==t){l="邮件",o="empty-email.png",$(".emailCount").text(a.data.totalItem);for(var T='<i class="s-updownBg s-left2"></i>',c="",k="",d=0;d<s.length;d++)T=2==s[d].emailType?'<i class="s-updownBg s-left3"></i>':'<i class="s-updownBg s-left2"></i>',c=$.trim(s[d].content),k=s[d].subject,0==c.length&&(c="（无内容）"),0==k.length&&(k="（无主题）"),k.length>30&&(k=k.slice(0,30)+"..."),n+='<div class="tab-content" data-id="'+s[d].id+'" data-type="email" data-etype="'+s[d].emailType+'">                                            <label class="tab-sign"><i class="s-menuBg s-menu17"></i></label>                                            <div class="tab-style">                                                <div class="style-title"><span>'+s[d].sendTime+"</span><span>"+s[d].fromName+"</span><span>给</span><span>"+s[d].toName+'</span><span>发了邮件</span></div>                                                <div class="style-content">                                                    <div class="email-style">                                                        <p><i class="s-updownBg s-dot"></i><span>'+k+"</span></p>                                                        <p>"+T+"                                                            <span>"+c+'</span>                                                        </p>                                                        <!--<label>4</label>-->                                                    </div>                                                </div>                                            </div>                                            <div class="clear"></div>                                        </div>'}else if("edm"==t){o="empty-edm.png",l="EDM",$(".edmCount").text(a.data.totalItem);var T='<i class="s-updownBg s-left2"></i>',c="",k="";s=s;for(var d=0;d<s.length;d++)T=2==s[d].emailType?'<i class="s-updownBg s-left3"></i>':'<i class="s-updownBg s-left2"></i>',c=$.trim(s[d].content),k=s[d].subject,0==c.length&&(c="（无内容）"),0==k.length&&(k="（无主题）"),k.length>30&&(k=k.slice(0,30)+"..."),n+='<div class="tab-content" data-id="'+s[d].id+'" data-type="email">                                            <label class="tab-sign"><i class="s-menuBg s-menu17"></i></label>                                            <div class="tab-style">                                                <div class="style-title"><span>'+s[d].sendTime+"</span><span>"+s[d].fromName+"</span><span>给</span><span>"+s[d].toName+'</span><span>发了邮件</span></div>                                                <div class="style-content">                                                    <div class="email-style">                                                        <p><i class="s-updownBg s-dot"></i><span>'+k+"</span></p>                                                        <p>"+T+"                                                            <span>"+c+'</span>                                                        </p>                                                        <!--<label>4</label>-->                                                    </div>                                                </div>                                            </div>                                            <div class="clear"></div>                                        </div>'}else if("quotation"==t){o="empty-quo.png",l="报价单",$(".quotationCount").text(a.data.totalItem);for(var d=0;d<s.length;d++){for(var p=s[d].createTime,u=s[d].createUserName,c=s[d].name,B="",x=0;x<i.length;x++)if(i[x].id==s[d].unit){B=i[x].value;break}n+='<div class="tab-content" data-id="'+s[d].id+'" data-type="quotation" data-userId ="'+s[d].createUser+'">                                    <label class="tab-sign"><i class="s-menuBg s-menu10"></i></label>                                    <div class="tab-style">                                        <div class="style-title"><span>'+p+"</span><span>"+u+'</span><span>创建了报价单</span></div>                                        <div class="style-content">                                            <div class="quotation-style">                                                <label>'+c+"</label>                                                <p>总金额：<span>"+s[d].price+B+'</span></p>                                            </div>                                        </div>                                    </div>                                    <div class="clear"></div>                                </div>'}}else if("pi"==t){o="empty-pi.png",l="PI",$(".piCount").text(a.data.totalItem);for(var d=0;d<s.length;d++){for(var p=s[d].createTime,u=s[d].createUserName,c=s[d].name,B="",x=0;x<i.length;x++)if(i[x].id==s[d].unit){B=i[x].value;break}n+='<div class="tab-content" data-id="'+s[d].id+'" data-type="pi" data-userId ="'+s[d].createUser+'">                                    <label class="tab-sign"><i class="s-menuBg s-menu11"></i></label>                                    <div class="tab-style">                                        <div class="style-title"><span>'+p+"</span><span>"+u+'</span><span>创建了PI</span></div>                                        <div class="style-content">                                            <div class="quotation-style">                                                <label>'+c+"</label>                                                <p>总金额：<span>"+s[d].price+B+'</span></p>                                            </div>                                        </div>                                    </div>                                    <div class="clear"></div>                                </div>'}}else if("order"==t){o="empty-order.png",l="订单",$(".orderCount").text(a.data.totalItem);for(var d=0;d<s.length;d++){for(var p=s[d].createTime,u=s[d].createUserName,c=s[d].name,B="",x=0;x<i.length;x++)if(i[x].id==s[d].unit){B=i[x].value;break}n+='<div class="tab-content" data-id="'+s[d].id+'" data-type="order" data-userId ="'+s[d].createUser+'">                                    <label class="tab-sign"><i class="s-menuBg s-menu12"></i></label>                                    <div class="tab-style">                                        <div class="style-title"><span>'+p+"</span><span>"+u+'</span><span>创建了订单</span></div>                                        <div class="style-content">                                            <div class="quotation-style">                                                <label>'+c+"</label>                                                <p>总金额：<span>"+s[d].price+B+'</span></p>                                            </div>                                        </div>                                    </div>                                    <div class="clear"></div>                                </div>'}}else if("task"==t){o="empty-task.png",l="任务",$(".taskCount").text(a.data.totalItem);for(var d=0;d<s.length;d++){var C=$.dateObj(s[d].createTime)._getDatetime(),I="",O="",u=s[d].name;2==s[d].status?(I="",O='<span class="red">已超时</span>'):3==s[d].status&&(I='<i class="s-updownBg s-end"></i>',O='<span class="green">已完成</span>'),u.length>25&&u.substr(0,20)+"...",n+='<div class="tab-content" data-id="'+s[d].id+'" data-type="task">                                            <label class="tab-sign"><i class="s-menuBg s-menu8"></i></label>                                            <div class="tab-style">                                                <div class="style-title"><span>'+C+"</span><span>"+(s[d].createUserName||"匿名")+'</span><span>创建了任务</span></div>                                                <div class="style-content">                                                    <div class="task-style">                                                        <p>'+I+O+"                                                            <label>"+u+'</label>                                                        </p>                                                    </div>                                                </div>                                            </div>                                            <div class="clear"></div>                                        </div>'}}else if("timeline"==t)for(var d=0;d<s.length;d++){var j="",N="",U="",u=s[d].createUserName||"匿名",F='<i class="s-menuBg s-menu18"></i>',c=s[d].content;1==s[d].contentType?(j="创建客户",N="customer"):2==s[d].contentType?(j="创建联系人",N="contact"):3==s[d].contentType?(j="创建跟进",F='<i class="s-menuBg s-menu16"></i>',N="follow"):4==s[d].contentType?(j="创建报价单",F='<i class="s-menuBg s-menu10"></i>',N="quotation"):5==s[d].contentType?(j="创建PI",F='<i class="s-menuBg s-menu11"></i>',N="pi"):6==s[d].contentType?(j="创建订单",F='<i class="s-menuBg s-menu12"></i>',N="order"):7==s[d].contentType?(j="创建任务",F='<i class="s-menuBg s-menu8"></i>',N="task"):8==s[d].contentType?j="创建标签":9==s[d].contentType?j="修改客户资料":10==s[d].contentType?j="修改联系人资料":11==s[d].contentType?j="修改了客户状态":12==s[d].contentType?(j="修改了报价单",F='<i class="s-menuBg s-menu10"></i>',N="follow"):13==s[d].contentType?(j="修改了PI",F='<i class="s-menuBg s-menu11"></i>',N="pi"):14==s[d].contentType?(j="修改了订单",F='<i class="s-menuBg s-menu12"></i>',N="quotation"):15==s[d].contentType?(j="修改了任务",F='<i class="s-menuBg s-menu8"></i>',N="task"):16==s[d].contentType?j="修改了客户分组":17==s[d].contentType?(j="跟进客户",F='<i class="s-menuBg s-menu16"></i>'):18==s[d].contentType?(j="取消跟进客户",F='<i class="s-menuBg s-menu16"></i>'):19==s[d].contentType?j="分享了客户":20==s[d].contentType?j="取消分享客户":21==s[d].contentType?j="转移了客户":22==s[d].contentType?(j="发邮件",F='<i class="s-menuBg s-menu17"></i>',N="email"):23==s[d].contentType?(j="发EDM",F='<i class="s-menuBg s-menu4"></i>',N="edm"):24==s[d].contentType?j="删除了客户":25==s[d].contentType?j="删除了联系人":26==s[d].contentType?(j="删除了跟进",F='<i class="s-menuBg s-menu16"></i>'):27==s[d].contentType?(j="删除了报价单",F='<i class="s-menuBg s-menu10"></i>'):28==s[d].contentType?(j="删除了PI",F='<i class="s-menuBg s-menu11"></i>'):29==s[d].contentType&&(j="删除订单",F='<i class="s-menuBg s-menu12"></i>'),U='<div class="style-title"><span>'+s[d].createTime+"</span><span>"+u+"</span><span>"+j+"</span></div>",n+='<div class="tab-content" data-id="'+s[d].id+'" data-type="'+N+'">                                            <label class="tab-sign">'+F+'</label>                                            <div class="tab-style">'+U+'<div class="style-content">'+c+'</div>                                            </div>                                            <div class="clear"></div>                                        </div>'}else if("file"==t){l="文档",$(".documentCount").text(a.data.totalItem);for(var d=0;d<s.length;d++){var S='<span class="doc-img-local"></span>',P='<li class="doc-upload" data-size="'+s[d].documentSizeOld+'" data-url="'+s[d].documentUrl+'" data-name="'+s[d].documentName+'">上传到云盘</li>';1==s[d].source&&(S='<span class="doc-img-cloud"></span>',P=""),n+='<div class="tab-content" data-id="'+s[d].id+'">                                            <label class="tab-sign"><i class="s-menuBg s-menu18"></i></label>                                            <div class="tab-style">                                                <div class="style-title">                                                <span>'+s[d].createTime+"</span><span>"+(s[d].createUserName||"匿名")+'</span><span>上传了文档</span>                                                <i class="doc-handle"></i>                                                <ul class="doc-handle-cont">                                                <li class="doc-download" data-url="'+s[d].documentUrl+'" data-name="'+s[d].documentName+'" download data-type="0">下载</li>'+P+'<li class="doc-delete">删除</li>                                    </ul>                                    </div>                                    <div class="style-content">                                        <div class="file-style"><p>'+S+"<span>【"+s[d].documentName.substring(s[d].documentName.lastIndexOf(".")+1)+"】</span>                                                    <span>"+s[d].documentName.substring(0,s[d].documentName.lastIndexOf("."))+'</span>                                                    <span style="float: right;">'+s[d].documentSize+'</span>                                                   </p></div>                                                </div>                                            </div>                                            <div class="clear"></div>                                        </div>'}}var q=".tabs-"+t+" .tab-middle .tab-line";r.find(q).nextAll(".tab-content").remove(),""==n&&(r.find(q).nextAll(".trNone").remove(),n='<div class="trNone"><div class="trnone-info" style="margin-top: 11px;"><img src="../images/'+o+'" alt="" /><p class="trnone-text">暂无'+l+'</p></div><a href="javascript:;" class="trnone-btn btn btn-primary" data-type="'+t+'">创建'+l+"</a></div>"),r.find(q).after(n),"follow"==t&&r.find(".tabs-follow .tab-middle img").load(function(){$.cutImage(this,68,68)});var E=m.pageSize,L=Math.ceil(a.data.totalItem/E);
return 1==L?($(".page").addClass("active"),!1):($(".page").removeClass("active"),void $.Page({_class:".page",nowNum:e.currentPage,allNum:L,callback:function(e,a){var s=g.timeObj;"timeline"==t?(g.timeObj.currentPage=e,s=g.timeObj):"follow"==t?(g.followObj.currentPage=e,s=g.followObj):"file"==t?(g.fileObj.currentPage=e,s=g.fileObj):(g.page.currentPage=e,s=g.page),g.getRelationsList(s,t)}}))}})},getCloudNode:function(){$.ajax({type:"POST",url:Base.sitUrl+"/api/disk/v1/folder/list/all",dataType:"json",data:{data:JSON.stringify({view:"0"})},success:function(e){if(!e.success)return void $.Alert(e.message);for(var t=e.data,a=new Array,s=0;s<t.length;s++)0==t[s].type&&a.push(t[s]);for(var i={view:{selectedMulti:!1},edit:{enable:!0,editNameSelectAll:!0},data:{simpleData:{enable:!0}},callback:{beforeDrag:!1}},n=new Array,s=0;s<a.length;s++)n[s]={id:a[s].id,pId:a[s].pid,name:a[s].name};$.fn.zTree.init($("#treeCloud"),i,n)}})},getFile:function(e){console.log(Base.sitUrl+"/api/file/download?data="+JSON.stringify(e)),$(".doc-handle-cont").hide(),window.location.href=Base.sitUrl+"/api/file/download?data="+JSON.stringify(e)},delFollowFile:function(e,t){$.ajax({url:Base.sitUrl+"/api/user/v1/user/followup/attach/delete",data:{id:e},type:"POST",dataType:"json",success:function(e){return e.success?void t.remove():void $.unLogin(e)}})},getRelationInfo:function(){$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/contacts/detail",type:"POST",data:{data:JSON.stringify({id:c})},dataType:"json",success:function(e){if(!e.success)return void $.Alert("获取联系人详情失败，"+e.message);var a=JSON.parse(t()),s=e.data;o=s.customerId,d=s.id,g.fileObj.customerId=s.customerId;var i=s.customerContactTags&&s.customerContactTags.length>0?s.customerContactTags:[],n=g.list.employee,c=s.followUpUsers,p="",u="",m="";g.info=s;for(var f=0;f<a.length;f++)if(s.countries==a[f].id){r.find(".top-title>label>img").attr("src","../images/country/PNG/"+a[f].id+".png"),r.find(".top-title>label>span,.cust-area").text(a[f].cn||"未设置"),s.countries=a[f].cn;break}if(0==s.countries){var h="none";s.countries="中国"}l=v=s.name,r.find(".overview-time").text(s.createTime),r.find(".o-phone").text(s.phone||""),r.find(".o-email").text(s.email||""),r.find(".overview-phone").val(s.phone||""),r.find(".overview-email").val(s.email||""),r.find(".overview-position").text(s.position||"无职位"),r.find(".con-user").text(s.name||""),r.find(".con-countries").empty(),r.find(".con-countries").append('<img src="../images/country/PNG/'+s.countries+'.png" alt="国家" style="display:'+h+'" />');for(var f=0;f<s.contacts.length;f++){var b=' <span style="cursor: pointer;" data-id="'+s.contacts[f].id+'">'+s.contacts[f].name+"</span> ,";f==s.contacts.length-1&&(b=b.substring(0,b.length-1)),r.find(".con-name").append(b)}r.find(".con-position,.relation-position").text(s.position||"无职位"),r.find(".con-company,.relation-company").text(s.workingCompany||""),r.find(".con-company").attr("data-id",s.customerId),r.find(".re-status").text(s.customer.statusName||""),r.find(".con-email").text(s.email||""),r.find(".con-birth").text(s.birthday||""),r.find(".con-phone").text(s.phone||""),r.find(".con-facebook").text(s.facebook||""),r.find(".con-twitter").text(s.twitter||""),r.find(".con-linkedin").text(s.linkedin||""),r.find(".con-remark").text(s.remark||""),r.find(".top-title>span").text(s.name||"");for(var y=s.contactDefinedValues,w=r.find("#info-content .info-table tbody"),f=0;f<y.length;f++){var T="<tr><td>"+y[f].name+"</td><td>"+y[f].value+"</td></tr>";w.append(T)}if(s.starLevel>0&&s.starLevel<=5){for(var k=0;k<s.starLevel;k++)m+='<i class="s-updownBg s-star3"></i>';for(var B=5-s.starLevel,x=0;x<B;x++)m+='<i class="s-updownBg s-unstar2"></i>';r.find(".status-star").empty().append(m)}else if(s.starLevel>5){for(var k=0;k<6;k++)m+='<i class="s-updownBg s-star3"></i>';r.find(".status-star").empty().append(m)}if(i.length>0)for(var C=0;C<i.length;C++)p+='<li data-id="'+i[C].id+'"><span>'+i[C].tagName+'</span><i class="s-updownBg s-dels3"></i></li>';else p="<span>无</span>";if(r.find(".list-label").empty(),r.find(".list-label").append(p),c&&c.length>0)for(var I=0;I<c.length;I++){for(var O=c[I].userName||"匿名",j="",N=0;N<n.length;N++)if(n[N].id==c[I].userId){r.find(".list-follower>li").eq(N).remove();break}c[I].userId!=s.followUpUser?(c[I].delFlag>0&&(j='<i class="s-updownBg s-dels3"></i>'),u+='<li data-id="'+c[I].id+'" data-user="'+c[I].userId+'">                                                    <i class="s-updownBg s-users2"></i>                                                    <span>'+O+j+"</span>                                                </li>"):(r.find(".cancel-follow").addClass("active"),r.find(".s-menus").append("<li>取消跟进</li>"))}else u="<span>无</span>";r.find(".list-follow").empty(),r.find(".list-follow").append(u);for(var k in s.statics){var U="."+k;$(U).text(s.statics[k])}}}),$(".contact-img img").each(function(){$.cutImage(this,68,68)})},getEmployees:function(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/staff/list",type:"POST",dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data,a="";if(g.list.employee=t,t.length>0)for(var s=0;s<t.length;s++){var i=t[s].name||"匿名";i.length>13&&(i=i.slice(0,10)+"..."),a+='<li data-id="'+t[s].id+'">'+i+"</li>"}else a="无";r.find(".list-follower").empty().append(a)}})},getUnits:function(e){$.ajax({url:Base.sitUrl+"/api/sys/v1/sys/dictionary/get",data:{group:e},type:"POST",dataType:"json",success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data;g.list.currency=t}})},uploadFile:function(e,t,a){a.ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(a){if(!a.success)return void $.Alert("上传失败,"+a.message);var s=("http://"+a.data,r.find(".list-file")),i=r.find(".btns-upload"),n="",l=0,o='<i class="s-updownBg s-link5"></i>';"file"==e&&(l=1,o='<i class="s-updownBg s-link3"></i>'),0==s.length?(n='<ul class="list-file">                                            <li data-url="'+a.data+'" data-type="'+l+'">'+o+"<span>"+t.name+'</span>                                            <i class="s-updownBg s-dels3"></i>                                        </li>                                    </ul>',i.after(n)):(n='<li data-url="'+a.data+'" data-type="'+l+'">'+o+"<span>"+t.name+'</span>                                        <i class="s-updownBg s-dels3"></i>                                    </li>',s.append(n))}}).submit(),r.find("#upload-img,#upload-file")[0].reset()}};g.getEmployees(),g.getRelationInfo(),g.getUnits(),g.getRelationsList(g.timeObj,"timeline"),g.getCloudNode(),$("#info-li").bind("click",function(){$(this).addClass("active"),$("#info-content").show(),$("#info-content").siblings(".tab-content").hide(),$(this).siblings("li").removeClass("active")}),$("#fb-li").bind("click",function(){$(this).addClass("active"),$("#fb-content").show(),$("#fb-content").siblings(".tab-content").hide(),$(this).siblings("li").removeClass("active"),i(c,1)}),$("#tw-li").bind("click",function(){$(this).addClass("active"),$("#tw-content").show(),$("#tw-content").siblings(".tab-content").hide(),$(this).siblings("li").removeClass("active")}),$("#lk-li").bind("click",function(){$(this).addClass("active"),$("#lk-content").show(),$("#lk-content").siblings(".tab-content").hide(),$(this).siblings("li").removeClass("active"),i(c,3)}),$(".detail-middle-right").on("click",".s-yes",function(){var e=$(this).parents(".the-same-as").attr("data-fb");n(o,e,1,1)}),$(".con-company").on("click",function(){var t=$(this).attr("data-id");e.showTab(Base.sitUrl+"/html/pop-customer-detail.html?id="+t,"客户详情")}),$(".con-name").on("click","span",function(t){$.EventFn(t);var a=$(this).attr("data-id");c!=a&&e.showTab(Base.sitUrl+"/html/pop-relation-detail.html?id="+a,"联系人详情")})})});