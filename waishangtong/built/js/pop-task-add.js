require(["common"],function(){require(["maintab","angular","angularAnimate","datetimepickerCN"],function(e){e.init(),jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({format:"yyyy-mm-dd hh:ii",language:"zh-CN",todayBtn:1,autoclose:1,bootcssVer:3});var t=Number($.GetQueryString("pIdx")),a=$.GetQueryString("type"),s=$.GetQueryString("emailName"),r=($.GetQueryString("custId"),$.GetQueryString("contId")),n=$.GetQueryString("contName"),i=$.GetQueryString("id"),o=angular.module("All",[]);o.config(["$httpProvider",function(e){e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",e.defaults.transformRequest.unshift(function(e,t){var a,s=[];for(a in e)e.hasOwnProperty(a)&&s.push(encodeURIComponent(a)+"="+encodeURIComponent(e[a]));return s.join("&")})}]),o.controller("task",["$scope","$http",function(e,o){function u(){o({method:"post",url:Base.sitUrl+"/api/customer/v1/customer/list/query",data:{data:JSON.stringify(e.pageObj)}}).success(function(t){if(!t.success)return void $.unLogin(t);e.customerList=t.data.results;var a=t.data.totalItem,s=Math.ceil(t.data.totalItem/t.data.pageSize);$.Page({total:a,_class:".customer-page",nowNum:e.pageObj.currentPage,allNum:s,callback:function(t,a){e.pageObj.currentPage=t,u()}})})}e.pageObj={homepage:1,currentPage:1,lastpage:null,pageSize:10,conditions:[],keyword:""},e.chargerList=[],e.customerList=[],e.showGroup=!1,e.customerGroupList=[{id:"0",name:"全部分组"}],e.chiocedGroup={id:0,name:"选择分组"},e.isEml="email"==a,e.emailName=s,e.isCont=!!r,e.contName=n,e.reminds=[{value:"0",name:"无"},{value:"1",name:"事件发生时"},{value:"2",name:"5分钟前"},{value:"3",name:"15分钟前"},{value:"4",name:"30分钟前"},{value:"5",name:"1小时前"},{value:"6",name:"2小时前"},{value:"7",name:"1天前"},{value:"8",name:"1周前"}],e.repeats=[{value:"1",name:"不重复"},{value:"2",name:"每天"},{value:"3",name:"每周"},{value:"4",name:"每月"},{value:"5",name:"每年"}],e.stopTypes=[{value:"0",name:"永不"},{value:"1",name:"按时间选择"}],e.saveUrl="/api/task/v1/task/modify",e.task={name:"",customer:{},charger:{},startTime:"",endTime:"",repeat:e.repeats[0].value,remind:e.reminds[0].value,stopType:e.stopTypes[0].value,stopTime:"",depict:""},e.save=function(){if(""==e.task.name||e.task.customer=={}||e.task.charger=={}||e.task.startTime=={}||e.task.endTime=={})return void $.Alert("必填项不能为空！");var a={name:e.task.name,customerId:e.task.customer.id,customerName:e.task.customer.name,executionTime:e.task.startTime,executionTimeType:3,fullDay:0,principalId:e.task.charger.id,principalName:e.task.charger.name,description:e.task.depict,remindTime:e.task.remind,startDate:e.task.startTime,endDate:e.task.endTime,repeat:e.task.repeat};"1"!=e.task.repeat&&(a.endRepeat=e.task.stopType,"0"!=e.task.stopType&&(a.endRepeatTime=e.task.stopTime)),o({method:"post",url:Base.sitUrl+e.saveUrl,data:{data:JSON.stringify(a)}}).success(function(e){e.success?$.Alert("新建任务成功！","",function(){var e=parent.me.tabIdx();parent.me.refresh2(t,"part"),parent.me.closeOne(e,!0)}):$.unLogin(e)})},e.chioceGroup=function(t){e.chiocedGroup=t,e.showGroup=!1,e.pageObj.currentPage=1,"0"!=t.id?e.pageObj.conditions=[{filedName:"customerGroupId",operateType:"=",filedValue:t.id}]:e.pageObj.conditions=[],u()},e.changeStyle=function(t){var a=t.target;$(a).parents(".customer-list").find("div.radio").find("span.checked").removeClass("checked"),$(a).parent().addClass("checked"),e.task.customer=JSON.parse($(a).val())},e.custList=function(){u()},o({method:"post",url:Base.sitUrl+"/api/org/v1/org/principal/list"}).success(function(t){return t.success?void(e.chargerList=t.data):void $.unLogin(t)}),u(),o({method:"post",url:Base.sitUrl+"/api/customer/v1/customer/group/list"}).success(function(t){return t.success?void(e.customerGroupList=e.customerGroupList.concat(t.data)):void $.unLogin(t)}),null!=i&&o({method:"post",url:Base.sitUrl+"/api/task/v1/task/particulars",params:{data:{id:i}}}).success(function(t){if(!t.success)return void $.unLogin(t);var a=t.data;e.task.name=a.name,e.task.customer.name=a.customerName,e.task.customer.id=a.customerId,e.task.charger.id=a.principalId,e.task.charger.name=a.principalName,e.task.startTime=a.startDate,e.task.endTime=a.endDate,e.task.repeat=a.repeat,e.task.stopType=a.endRepeat,e.task.stopTime=a.endRepeatTime,e.task.remind=a.remindTime,e.task.depict=a.description})}]),angular.bootstrap(document.body,["All"])})});