require(["common"],function(){require(["maintab","blockUI","datetimepickerCN"],function(t){function e(t,e,a){for(var i="",s=0;s<a.length;s++){var r=a[s],n=r.substr(0,r.lastIndexOf(":"));i+='<option value="'+n+'">'+r+"</option>"}"ap"==t&&"am"==e?($("#hours").empty(),$("#hours").append(i)):"ap"==e||"ap"==t&&"pm"==e||"ap2"==t&&"am"==e?($("#hours").empty(),$("#hours2").empty(),$("#hours").append(i),$("#hours2").append(i)):"ap2"==t&&"pm"==e&&($("#hours2").empty(),$("#hours2").append(i))}var a=$.GetQueryString("type"),i=$.GetQueryString("taskType"),s=$.GetQueryString("dateTime"),r=$.GetQueryString("emailName"),n=parseInt($.GetQueryString("id")),o=parseInt($.GetQueryString("taskId")),c=$.GetQueryString("contactsId"),p=Number($.GetQueryString("pIdx"));"email"==a&&($("#emailName").val(r),$("#emailNameShow").show()),$.ajax({url:Base.sitUrl+"/api/org/v1/org/principal/list",type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.Alert(t.message);for(var e=t.data,a=0;a<e.length;a++){var i='<option data-id="'+e[a].id+'">'+e[a].name+"</option>";$("#principal").append(i)}}}),$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/assign/list",type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.Alert(t.message);var e=t.data;if(n||c){for(var a=0;a<e.length;a++)if(n==e[a].id){$("#customerInput").attr({"data-id":e[a].id,disabled:!0}).val(e[a].name),$(".customerList").css({border:"none",padding:0});break}}else for(var a=0;a<e.length;a++){var i='<div class="customerLi" data-id="'+e[a].id+'">'+e[a].name+"</div>";$("#customer").append(i)}}}),$("#customerInput").click(function(t){$.EventFn(t),"none"==$(".customerList").css("display")?$(".customerList").show():$(".customerList").hide()}),$("body").click(function(){$(".customerList").hide()}),$(".customerList").click(function(t){$.EventFn(t)}),$(".customerSearch").on("input",function(t){$("#c-cust").parent().show();var e=$(this).val(),a=e.length;$(this).attr("data-id","");for(var i=$("#customer").find("div").length,s=0;s<i;s++){var r=$("#customer").find("div").eq(s).text(),n=r.substring(0,a);n!==e?$("#customer").find("div").eq(s).hide():$("#customer").find("div").eq(s).show()}}),$("#customer").on("click",".customerLi",function(){var t=$(this).attr("data-id"),e=$(this).text();$("#customerInput").attr("data-id",t),$("#customerInput").val(e),$(".customerList").hide()}),$("#repeat").on("click",function(){"不重复"==$("#repeat option:selected").text()?$("#noRepeat").attr("disabled",!0):$("#noRepeat").attr("disabled",!1)}),$("#noRepeat").on("click",function(){"chooseTime"==$("#noRepeat option:selected").val()&&$(".time_hide").show()}),$("#task-add").on("click",function(){if($.GetLength($("#taskName").val())>64)return void $.Alert("任务名称不超过64个字母或32个汉字");""!=$(".time_hide input").val()&&$(".time_hide").hide();var t={name:$("#taskName").val(),customerId:$("#customerInput").attr("data-id"),customerName:$("#customerInput").val(),executionTimeType:3,fullDay:0,principalId:$("#principal option:selected").attr("data-id"),principalName:$("#principal").val(),description:$("#description").val(),remindTime:$("#warn option:selected").attr("value"),end_repeat:$("#noRepeat option:selected").val(),startDate:$("#stratTime").val(),endDate:$("#endTime").val(),end_repeat_time:$("#chooseTime").val(),repeat:$("#repeat option:selected").val()};if(""==$("#taskName").val()||""==$("#customerInput").val()||""==$("#principal").val())return void $.Alert("内容不能为空！");if(o)var e="/api/task/v1/task/edit",t={id:o,name:$("#taskName").val(),customerId:$("#customerInput").attr("data-id"),customerName:$("#customerInput").val(),principalId:$("#principal option:selected").attr("data-id"),principalName:$("#principal").val(),description:$("#description").val(),remindTime:$("#warn option:selected").attr("value"),startDate:$("#stratTime").val(),endDate:$("#endTime").val()};else var e="/api/task/v1/task/save";c&&(t.contactsId=c),n&&(t.customerId=n),$.ajax({url:Base.sitUrl+e,type:"POST",dataType:"json",data:{data:JSON.stringify(t)},success:function(t){t.success?$.Alert("新建任务成功！","",function(){var t=parent.me.tabIdx();parent.me.refresh2(p,"part"),parent.me.closeOne(t,!0)}):$.Alert(t.message)}})});var a=($.GetQueryString("id"),$.GetQueryString("type"));jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({format:"yyyy-mm-dd hh:mm:ss",todayBtn:!1,language:"zh-CN",pickerPosition:"top-left",autoclose:!0}),$("input[name=cycle]").on("click",function(){$(this).attr("checked",!$(this).attr("checked"))}),$(".check-box").hide();var d=[{am:{hs:["01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00"]}},{pm:{hs:["13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","24:00"]}}];$("#taskType").change(function(){1==$(this).val()?$(".startTime").show().next(".check-box").hide():$(".startTime").hide().next(".check-box").show()}),$("#ap,#ap2").change(function(){"ap"==$(this).attr("id")&&"pm"==$(this).val()?($("#ap2").val($(this).val()),e($(this).attr("id"),"pm",d[1].pm.hs)):"ap2"==$(this).attr("id")&&"am"==$(this).val()?($("#ap").val($(this).val()),e($(this).attr("id"),"am",d[0].am.hs)):"ap"==$(this).attr("id")&&"am"==$(this).val()?e($(this).attr("id"),"am",d[0].am.hs):"ap2"==$(this).attr("id")&&"pm"==$(this).val()&&e($(this).attr("id"),"pm",d[1].pm.hs)});e("ap","ap",d[0].am.hs),$("#task-cancel").on("click",function(){$.DestroyPopInPop()}),$(document).ready(function(){i&&($("#startTime").val(s),$("#taskName").val(r)),o&&$.ajax({url:Base.sitUrl+"/api/task/v1/task/detail",type:"POST",dataType:"json",data:{id:o},success:function(t){var a=t.data;if($("#task-add").text("修改"),$("#startTime").val(a.executionTime),$("#taskName").val(a.name),$("#description").val(a.description),$("#customerInput").attr("data-id",a.customerId),$("#customerInput").val(a.customerName),$("#principal option[data-id="+a.principalId+"]").attr("selected",!0),$("#warn option[value="+a.remindTime+"]").attr("selected",!0),a.executionTimeResult){for(var i=a.executionTimeResult.weeks.split(","),s=0;s<i.length;s++)for(var r=0;r<$(".checkcycle").find("label").length;r++)i[s]==$(".checkcycle").find("label").eq(r).find("input").attr("data-id")&&($(".checkcycle").find("label").eq(r).find("span").addClass("checked"),$(".checkcycle").find("label").eq(r).find("input[type=checkbox]").attr("checked",!0));var n=a.executionTimeResult.startTime,o=a.executionTimeResult.endTime,c=n.substring(0,2),p=n.substring(3,5),l=o.substring(0,2),m=o.substring(3,5);parseInt(c)>12&&parseInt(l)>12?(e($("#ap").attr("id"),"pm",d[1].pm.hs),e($("#ap2").attr("id"),"pm",d[1].pm.hs)):parseInt(c)<=12&&parseInt(l)<=12?(e($("#ap").attr("id"),"am",d[0].am.hs),e($("#ap2").attr("id"),"am",d[0].am.hs)):parseInt(c)>12&&parseInt(l)<=12?(e($("#ap").attr("id"),"pm",d[1].pm.hs),e($("#ap2").attr("id"),"am",d[0].am.hs)):parseInt(c)<=12&&parseInt(l)>12&&(e($("#ap2").attr("id"),"pm",d[1].pm.hs),e($("#ap").attr("id"),"am",d[0].am.hs)),$("#minutes").val(p),$("#minutes2").val(m),parseInt(c)>12?($("#ap option[value=pm]").attr("selected",!0),$("#hours option[value="+c+"]").attr("selected",!0)):($("#ap option[value=am]").attr("selected",!0),$("#hours option[value="+c+"]").attr("selected",!0)),parseInt(l)>12?($("#ap2 option[value=pm]").attr("selected",!0),$("#hours2 option[value="+l+"]").attr("selected",!0)):($("#ap2 option[value=am]").attr("selected",!0),$("#hours2 option[value="+l+"]").prop("selected",!0)),$("#taskType option[value=2]").attr("selected",!0),$(".check-box").show(),$(".startTime").hide()}else $("#startTime").val(a.executionTime)}})})})});