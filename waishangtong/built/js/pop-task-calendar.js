require(["common"],function(){require(["maintab","blockUI","jqueryUI","calendar"],function(maintab,fullCalendar){function task(year,month){var listJson="";return $.ajax({url:Base.sitUrl+"/api/task/v1/task/list",type:"GET",dataType:"json",async:!1,data:{viewType:1,year:year,month:month},beforeSend:function(e){$.BlockUI()},complete:function(e,t){$.UnblockUI()},success:function(e){if(!e.success)return void $.unLogin(e);var t=e.data.results;if(t.length>0){for(var a=0;a<t.length;a++){if(1==t[a].status)var n="#ffdfb6",r="#946b1d";else if(2==t[a].status)var n="#ffdedc",r="#da0000";else if(3==t[a].status)var n="#d3f1c4",r="#179e01";if("2"==t[a].executionTime.substring(0,1))listJson+='{title:"'+t[a].name+'",start:"'+t[a].executionTime.substring(0,10)+'",principalName:"'+t[a].principalName+'",createUserName:"'+t[a].createUserName+'",executionTime:"'+t[a].executionTime+'",customerName:"'+t[a].customerName+'",id:"'+t[a].id+'",color:"'+n+'",textColor:"'+r+'"},';else if(null!==t[a].dates&&""!==t[a].dates)for(var i=0;i<t[a].dates.length;i++)listJson+='{title:"'+t[a].name+'",start:"'+t[a].dates[i]+'",principalName:"'+t[a].principalName+'",createUserName:"'+t[a].createUserName+'",executionTime:"'+t[a].executionTime+'",customerName:"'+t[a].customerName+'",id:"'+t[a].id+'",color:"'+n+'",textColor:"'+r+'"},'}listJson=listJson.substring(0,listJson.length-1),listJson="["+listJson+"]"}}}),eval("("+listJson+")")}function calendar(e,t,a){$("#calendar").fullCalendar({header:{left:"prev",center:"title",right:"next"},weekMode:"liquid",firstDay:0,year:t,month:a,events:e,eventClick:function(e,t,a,n){$.EventFn(n);var n=n||window.event,r=n.clientX-200,i=n.clientY+15;r<0&&(r=10),$("#card").attr("data-id",e.id),$("#cardTitle").text(e.title),$("#cardtime").text(e.executionTime),$("#cardprincipalName").text(e.principalName),$("#cardcreateUserName").text(e.createUserName),$("#customerName").text(e.customerName),$("#card").css("top",i),$("#card").css("left",r),$("#card").show()},dayClick:function(e,t,a,n){var r=$.fullCalendar.formatDate(e,"yyyy-MM-dd hh:mm:ss");$("#card").hide(),maintab.showTab(Base.url+"/html/pop-task.html?taskType=1&dateTime="+r+"&v="+window.ver,"新建任务")}}),$.disNone=function(){},$.disBlock=function(){},$("#taskList").bind("click",function(){window.location.href=Base.url+"/html/crm-task.html?&v="+window.ver}),$("#taskCalendar").bind("click",function(){window.location.href=Base.url+"/html/pop-task-calendar.html?&v="+window.ver})}maintab.init();var thisYear=(new Date).getFullYear(),thisMonth=(new Date).getMonth()+1,Month=(new Date).getMonth(),eventsJson=task(thisYear,thisMonth);$("body").click(function(e){$.EventFn(e),$("#card").hide()}),$("#addTask").bind("click",function(){$("#card").hide()}),$("#card").bind("click",function(e){$.EventFn(e),$("#card").show()}),$("#more").bind("click",function(e){$.EventFn(e);var t=$("#card").attr("data-id");$("#cardTitle").text(""),$("#cardtime").text(""),$("#cardprincipalName").text(""),$("#cardcreateUserName").text(""),$("#card").hide(),maintab.showTab(Base.url+"/html/pop-detail.html?taskId="+t+"&v="+window.ver,"任务详情")}),$("#edit").bind("click",function(e){$.EventFn(e),$("#card").hide();var t=$("#card").attr("data-id");maintab.showTab(Base.url+"/html/pop-task.html?taskId="+t+"&v="+window.ver,"修改任务")}),calendar(eventsJson,thisYear,Month),$(document).find(".fc-header-left").unbind("click").on("click",function(){var e=$(".fc-header-center").find("h2").text(),t=e.substring(0,4),a=e.substring(5,7);t=parseInt(t),a=parseInt(a),eventsData=task(t,a),$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",eventsData)}),$(document).find(".fc-header-right").unbind("click").on("click",function(){var e=$(".fc-header-center").find("h2").text(),t=e.substring(0,4),a=e.substring(5,7);t=parseInt(t),a=parseInt(a),eventsData=task(t,a),$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",eventsData)}),$.reTask=function(){var e=$(".fc-header-center").find("h2").text(),t=e.substring(0,4),a=e.substring(5,7);t=parseInt(t),a=parseInt(a),eventsData=task(t,a),$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",eventsData)}})});