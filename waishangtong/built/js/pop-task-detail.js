require(["common"],function(){require(["maintab","blockUI","angular","datetimepickerCN"],function(t){function e(t){return null==t?"":t}function a(t){var e=t.getFullYear(),a=t.getMonth()+1,n=t.getDate(),i=t.getHours(),s=t.getMinutes(),o=t.getSeconds();return e+"-"+a+"-"+n+"   "+i+":"+s+":"+o}function n(t){var e="";if(1==$("#taskType option:selected").attr("value"))e+=$("#startTime").val();else{var a="";if($(".checkcycle").find("input[name=cycle]:checked").length<1)return void $.Alert("请选择周期");for(var n=0;n<$(".checkcycle").find("input[name=cycle]:checked").length;n++)a+=$(".checkcycle").find("input[name=cycle]:checked").eq(n).attr("data-id");var i=$("#hours option:selected").val()+":"+$("#minutes").val(),s=$("#hours2 option:selected").val()+":"+$("#minutes2").val();if(e+=a+" "+i+" - "+s,$("#hours option:selected").val()>$("#hours2 option:selected").val())return void $.Alert("周期选择错误！");if($("#hours option:selected").val()==$("#hours2 option:selected").val()&&$("#minutes").val()>$("#minutes2").val())return void $.Alert("周期选择错误！")}var o={id:t,name:$("#taskName").val(),customerId:$("#customer option:selected").attr("data-id"),customerName:$("#customer").val(),principalId:$("#principal option:selected").attr("data-id"),principalName:$("#principal").val(),description:$("#description").val(),remindTime:$("#warn option:selected").attr("value"),executionTimeType:$("#taskType option:selected").attr("value"),executionTime:e};return""==$("#taskName").val()||""==$("#customer").val()||""==$("#principal").val()?void $.Alert("内容不能为空！"):void $.ajax({url:Base.sitUrl+"/api/task/v1/task/edit",type:"POST",dataType:"json",data:{data:JSON.stringify(o)},success:function(t){return t.success?(t.success?(parent.location.reload(),$.DestroyPopInPop()):$.Alert(result.message),$.DestroyPopInPop(),void parent.location.reload()):void $.unLogin(t)}})}var i=$.GetQueryString("taskId"),s=0;t.init(),jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({format:"yyyy-mm-dd hh:ii",todayBtn:!1,language:"zh-CN",startDate:new Date,pickerPosition:"top-left",autoclose:!0});var o=angular.module("All",[]);o.controller("task_detail",["$scope","$http",function(n,s){function o(){$.BlockUI(),s({method:"post",url:Base.sitUrl+"/api/task/v1/task/particulars",params:{data:{id:n.userId}}}).success(function(t){if($.UnblockUI(),!t.success)return void $.unLogin(t);var i=t.data,s=a(new Date(i.createTime));if(1==i.status){$(".i-status").hide();var o='<span class="overtime" style="display:inline-block"></span>';$("#task-title").before(o),$("#completeTask").show()}else if(2==i.status){$(".i-status").hide();var o='<span class="overtime" style="display:inline-block"></span>';$("#task-title").before(o),$("#completeTask").show()}else if(3==i.status)$(".i-status").addClass("complete");else{$(".i-status").hide();var o='<span class="overtime" style="display:inline-block"></span>';$("#task-title").before(o),$("#completeTask").show()}0==i.remindTime&&(i.remindTime="无"),1==i.remindTime&&(i.remindTime="事件发生时"),2==i.remindTime&&(i.remindTime="5分钟前"),3==i.remindTime&&(i.remindTime="15分钟前"),4==i.remindTime&&(i.remindTime="30分钟前"),5==i.remindTime&&(i.remindTime="1个小时前"),6==i.remindTime&&(i.remindTime="2个小时前"),7==i.remindTime&&(i.remindTime="1天前"),8==i.remindTime&&(i.remindTime="1周前"),1==i.repeat?i.repeat="不重复":2==i.repeat?i.repeat="每天":3==i.repeat?i.repeat="每周":4==i.repeat?i.repeat="每月":5==i.repeat&&(i.repeat="每年"),1==i.end_repeat&&(i.end_repeat="永不"),1==i.status?(i.status="未完成",$(".info_con h5").css("background","#7596FD")):2==i.status?(i.status="已超时",$(".info_con h5").css("background","#FF726B")):3==i.status&&(i.status="已完成",$(".info_con h5").css("background","#33BF7B"));var l=i.visitingCard.customerStatusColour;if($("span.s-status").css("background",l),n.taskTitle+=e(i.name),n.id+=e(i.visitingCard.customerId),n.email+=e(i.visitingCard.email),n.description+=e(i.description),n.startDate+=e(i.startDate),n.principalName+=e(i.principalName),i.end_repeat_time?n.end_repeat_time+=e(i.endRepeatTime):n.end_repeat_time+="无",n.end_repeat+=e(i.end_repeat),n.remindTime+=e(i.remindTime),n.createTime+=e(i.createTime),n.status+=e(i.status),n.repeat+=e(i.repeat),n.customerName+=e(i.customerName),n.executionTime+=e(i.executionTime),n.customerName=e(i.visitingCard.customerName),n.card_title=e(i.visitingCard.title),i.visitingCard.title?n.card_word=e(i.visitingCard.title.substring(0,1)):n.card_word="",n.customerStatusName=e(i.visitingCard.customerStatusName),$("#taskName").val(e(i.name)),$("#customer option[value="+i.customerName+"]").attr("selected","selected"),$("#principal option[value="+i.principalName+"]").attr("selected","selected"),$("#noRepeat option[value="+i.end_repeat+"]").attr("selected","selected"),$("#repeat option[value="+i.repeat+"]").attr("selected","selected"),$("span.data-st").text(e(s)),$("#stratTime").val(e(i.startDate)),$("#endTime").val(e(i.endDate)),i.executionTimeResult){for(var d=i.executionTimeResult.weeks.split(","),r=0;r<d.length;r++)for(var c=0;c<$(".checkcycle").find("label").length;c++)d[r]==$(".checkcycle").find("label").eq(c).find("input").attr("data-id")&&($(".checkcycle").find("label").eq(c).find("span").addClass("checked"),$(".checkcycle").find("label").eq(c).find("input[type=checkbox]").attr("checked",!0));var u=i.executionTimeResult.startTime,p=i.executionTimeResult.endTime,m=u.substring(0,2),b=u.substring(3,5),v=p.substring(0,2),g=p.substring(3,5);parseInt(m)>12&&parseInt(v)>12?(hFn($("#ap").attr("id"),"pm",ha[1].pm.hs),hFn($("#ap2").attr("id"),"pm",ha[1].pm.hs)):parseInt(m)<=12&&parseInt(v)<=12?(hFn($("#ap").attr("id"),"am",ha[0].am.hs),hFn($("#ap2").attr("id"),"am",ha[0].am.hs)):parseInt(m)>12&&parseInt(v)<=12?(hFn($("#ap").attr("id"),"pm",ha[1].pm.hs),hFn($("#ap2").attr("id"),"am",ha[0].am.hs)):parseInt(m)<=12&&parseInt(v)>12&&(hFn($("#ap2").attr("id"),"pm",ha[1].pm.hs),hFn($("#ap").attr("id"),"am",ha[0].am.hs)),$("#minutes").val(b),$("#minutes2").val(g),parseInt(m)>12?($("#ap option[value=pm]").attr("selected",!0),$("#hours option[value="+m+"]").attr("selected",!0)):($("#ap option[value=am]").attr("selected",!0),$("#hours option[value="+m+"]").attr("selected",!0)),parseInt(v)>12?($("#ap2 option[value=pm]").attr("selected",!0),$("#hours2 option[value="+v+"]").attr("selected",!0)):($("#ap2 option[value=am]").attr("selected",!0),$("#hours2 option[value="+v+"]").prop("selected",!0)),$("#taskType option[value=2]").attr("selected",!0),$(".check-box").show(),$(".startTime").hide()}else $("#startTime").val(i.executionTime);$("#warn option[value="+i.remindTime+"]").attr("selected","selected"),$("#description").val(e(i.description));var h=i.visitingCard.status,y=i.visitingCard.isHighSeas,f=i.visitingCard.customerName;userimg="";var k="",T="";if(1==y&&(k="<span>公海</span>"),null==i.visitingCard.customerContactsName||void 0==i.visitingCard.customerContactsName)var C="";else var C=i.visitingCard.customerContactsName.substring(0,1);switch(h){case 1:userimg='<i class="pub-icon sender4-icon"></i>',T='<ul><li data-id="'+i.id+'" data-email="'+i.visitingCard.email+'"><div class="sender-condition"><div class="sender-condition-img"><span class="ellipsis sender-condition-name">'+i.visitingCard.title+'</span></div><button type="button" class="btn btn-primary btn-lg btn-block btn-blockAdd">添加为联系人</button><div class="btn-group condition-cz-btn" role="group" style="margin-left:-118px;"><button type="button" class="btn btn-default newtongxunlu">添加通讯录</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 2:userimg='<i class="pub-icon sender4-icon"></i>',T='<ul><li data-id="'+i.id+'" data-email="'+i.visitingCard.email+'"><div class="sender-condition"><div class="sender-condition-img"><span class="ellipsis sender-condition-name">'+i.visitingCard.title+'</span></div><button type="button" class="btn btn-primary btn-lg btn-block btn-blockAdd">添加为联系人</button><div class="btn-group condition-cz-btn" role="group" style="margin-left:-118px;"><button type="button" class="btn btn-default tongxunlu">通讯录好友</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 3:userimg='<i class="pub-icon sender1-icon"></i>',T='<ul><li data-id="'+i.id+'" data-customer="'+i.visitingCard.customerId+'" data-cont="'+i.visitingCard.customerContactsId+'" data-email="'+i.visitingCard.email+'"><div class="sender-condition"><div class="sender-condition-img"><span class="ellipsis sender-condition-name">'+i.visitingCard.title+'</span></div><div class="company-info"><span class="s-status" style="background-color: '+i.visitingCard.customerStatusColour+';">'+C+'</span><span class="ellipsis company-name name-blue">'+f+'</span></div><div class="belong-yewuy"><label>所属业务员：</label><span>'+i.visitingCard.salesmanName+'</span></div><button type="button" class="btn btn-primary btn-lg btn-block btn-blockDetail">查看联系人</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin">写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 4:userimg='<i class="pub-icon sender1-icon"></i>',T='<ul><li data-id="'+i.id+'" data-customer="'+i.visitingCard.customerId+'" data-email="'+i.visitingCard.email+'"><div class="sender-condition"><div class="sender-condition-img"><span class="ellipsis sender-condition-name">'+i.visitingCard.title+'</span></div><div class="company-info"><span class="s-status" style="background-color: '+i.visitingCard.customerStatusColour+';">'+C+'</span><span class="ellipsis company-name name-blue">'+f+'</span></div><div class="belong-yewuy"><label>所属业务员：</label><span>'+i.visitingCard.salesmanName+'</span></div><button type="button" class="btn btn-primary btn-lg btn-block btn-scanCust">查看客户</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin" disabled>写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 5:userimg='<i class="pub-icon sender3-icon"></i>',T='<ul><li data-id="'+i.id+'" data-customer="'+i.visitingCard.customerId+'" data-email="'+i.visitingCard.email+'"><div class="sender-condition"><div class="sender-condition-img"><i class="pub-icon sender3-icon" style="top:0;"></i><span class="ellipsis sender-condition-name">'+i.visitingCard.title+'</span></div><div class="company-info"><span class="s-status" style="background-color: '+i.visitingCard.customerStatusColour+';">'+C+'</span><span class="ellipsis company-name name-blue">'+f+'</span></div><div class="belong-yewuy"><label>所属业务员：</label>'+k+'</div><button type="button" class="btn btn-primary btn-lg btn-block btn-privateCont">添加到私海</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin" disabled>写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 6:userimg='<i class="pub-icon sender3-icon"></i>',T='<ul><li data-id="'+i.id+'" data-customer="'+i.visitingCard.customerId+'" data-email="'+i.visitingCard.email+'"><div class="sender-condition"><div class="sender-condition-img"><i class="pub-icon sender3-icon" style="top:0;"></i><span class="ellipsis sender-condition-name">'+i.visitingCard.title+'</span></div><div class="company-info"><span class="s-status" style="background-color: '+i.visitingCard.customerStatusColour+';">'+C+'</span><span class="ellipsis company-name name-blue">'+f+'</span></div><div class="belong-yewuy"><label>所属业务员：</label>'+k+'</div><button type="button" class="btn btn-primary btn-lg btn-block btn-privateCust">添加到私海</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin" disabled>写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go">往来邮件</button></div></div></li></ul>';break;case 7:userimg='<i class="pub-icon sender2-icon"></i>',T='<ul><li data-id="'+i.id+'" data-customer="'+i.visitingCard.customerId+'" data-email="'+i.visitingCard.email+'"><div class="sender-condition"><div class="sender-condition-img"><i class="pub-icon sender2-icon" style="top:0;"></i><span class="ellipsis sender-condition-name">'+i.visitingCard.title+'</span></div><div class="company-info"><span class="s-status" style="background-color: '+i.visitingCard.customerStatusColour+';">'+C+'</span><span class="ellipsis company-name name-blue">'+f+'</span></div><div class="belong-yewuy"><label>所属业务员：</label><span>'+i.visitingCard.salesmanName+'</span></div><button type="button" class="btn btn-default btn-lg btn-block btn-blockDetail btn-gray" disabled>查看联系人</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin" disabled>写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go" disabled>往来邮件</button></div></div></li></ul>';break;case 8:userimg='<i class="pub-icon sender2-icon"></i>',T='<ul><li data-id="'+i.id+'" data-customer="'+i.visitingCard.customerId+'" data-email="'+i.visitingCard.email+'"><div class="sender-condition"><div class="sender-condition-img"><i class="pub-icon sender2-icon" style="top:0;"></i><span class="ellipsis sender-condition-name">'+i.visitingCard.title+'</span></div><div class="company-info"><span class="s-status" style="background-color: '+i.visitingCard.customerStatusColour+';">'+C+'</span><span class="ellipsis company-name name-blue">'+f+'</span></div><div class="belong-yewuy"><label>所属业务员：</label><span>'+i.visitingCard.salesmanName+'</span></div><button type="button" class="btn btn-default btn-lg btn-block btn-gray btn-blockAdd" disabled>添加联系人</button><div class="btn-group condition-cz-btn" role="group"><button type="button" class="btn btn-default xiegenjin" disabled>写跟进</button><button type="button" class="btn btn-default fayoujian">发邮件</button><button type="button" class="btn btn-default come-go" disabled>往来邮件</button></div></div></li></ul>'}o=T,$(".sender-condition-style").empty(),$(".sender-condition-style").append(o)})}n.userId=i,n.description="",n.taskTitle="",n.startDate="",n.endDate="",n.customerName="",n.principalName="",n.status="",n.end_repeat_time="",n.remindTime="",n.createTime="",n.executionTime="",n.repeat="",n.customerName="",n.customerStatusName="",n.card_title="",n.card_word="",n.id="",n.email="",n.end_repeat="",o(i),$(".box-left").on("click",".xiegenjin",function(e){$.EventFn(e);var a=n.id;t.showTab(Base.url+"/html/pop-upload.html?type=1&id="+a+"&v="+window.ver,"写跟进")}),$(".box-left").on("click",".btn-blockDetail",function(e){$.EventFn(e);var a=n.id;t.showTab(Base.url+"/html/pop-relation-detail.html?id="+a+"&v="+window.ver,"联系人详情")}),$(".box-left").on("click",".fayoujian",function(e){$.EventFn(e);var a=n.id;t.showTab(Base.url+"/html/pop-email-new.html?showType=right&type=0&id="+a+"&v="+window.ver,"发邮件")}),$(".box-left").on("click",".come-go",function(e){$.EventFn(e);var a=n.email,i=a.search(/\;/);a=a.substring(0,i),t.showTab(Base.url+"/html/pop-come-go-email.html?email="+a+"&v="+window.ver,"往来邮件")})}]),$("#ap,#ap2").change(function(){"ap"==$(this).attr("id")&&"pm"==$(this).val()?($("#ap2").val($(this).val()),hFn($(this).attr("id"),"pm",ha[1].pm.hs)):"ap2"==$(this).attr("id")&&"am"==$(this).val()?($("#ap").val($(this).val()),hFn($(this).attr("id"),"am",ha[0].am.hs)):"ap"==$(this).attr("id")&&"am"==$(this).val()?hFn($(this).attr("id"),"am",ha[0].am.hs):"ap2"==$(this).attr("id")&&"pm"==$(this).val()&&hFn($(this).attr("id"),"pm",ha[1].pm.hs)});$(".boxs").on("click","#taskChange",function(){$(this).closest(".boxs").hide().siblings(".boxs").show(),$("#editForm").show(),$(this).hasClass("fa-pencil-square-o")&&(cuFn(s),headFn(0),$("#cusType").get(0).selectedIndex=s)}),$("#taskChange").on("click",function(){$.ajax({url:Base.sitUrl+"/api/org/v1/org/principal/list",type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.Alert(t.message);for(var e=t.data,a=0;a<e.length;a++){var n='<option data-id="'+e[a].id+'">'+e[a].name+"</option>";$("#principal").append(n)}}}),$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/assign/list",type:"POST",dataType:"json",success:function(t){if(!t.success)return void $.Alert(t.message);for(var e=t.data,a=0;a<e.length;a++){var n='<option data-id="'+e[a].id+'">'+e[a].name+"</option>";$("#customer").append(n)}}})}),$("#cusType").on("change",function(){cuFn($(this).val())}),$("#cusType").on("change",function(){}),$("#cusType,#headType").on("click",function(t){var e=t||window.event;e.stopPropagation()});$("#completeTask").on("click",function(){$.Confirm("确认完成任务？","",function(){$.ajax({url:Base.sitUrl+"/api/task/v1/task/sign",type:"POST",dataType:"json",data:{id:i,status:3},success:function(t){return t.success?(t.success?(parent.location.reload(),$.DestroyPopInPop()):$.Alert(t.message),$.DestroyPopInPop(),void parent.location.reload()):void $.Alert(t.message)}})})}),$("#openDel").on("click",function(){$("#delModal").modal("show")}),$("#delModal").delegate(".delOne","click",function(t){$.ajax({url:Base.sitUrl+"/api/task/v1/task/delete",type:"POST",dataType:"json",data:{ids:i},success:function(t){return t.success?(t.success?(parent.location.reload(),$.DestroyPopInPop()):$.Alert(t.message),$.DestroyPopInPop(),void parent.location.reload()):void $.Alert(t.message)}})}),$(document).on("click",".overtime",function(t){$.EventFn(t);var e=$(this);$.ajax({url:Base.sitUrl+"/api/task/v1/task/sign",type:"POST",dataType:"json",data:{id:i,status:3},success:function(t){return t.success?($(e).addClass("i-status complete"),$(e).removeClass("overtime"),getTaskDetail(i),void parent.$.reQuey()):void $.unLogin(t)}})}),$("#taskBubSave").on("click",function(t){var e=t||window.event;e.preventDefault(),n(i),$(".complete").length>0&&$.ajax({url:Base.sitUrl+"/api/task/v1/task/sign",type:"POST",dataType:"json",data:{id:i,status:1},success:function(t){return t.success?(getTaskDetail(i),void parent.$.reQuey()):void $.unLogin(t)}})}),$("#taskBubCencle").on("click",function(t){var e=t||window.event;e.preventDefault(),$("#editForm").hide(),$(".detailBox").show().siblings(".boxs").hide()}),$(".sender-condition-style").on("click",".xiegenjin",function(e){$.EventFn(e);var a=$(this).parents("li").attr("data-id");t.showTab(Base.url+"/html/pop-upload.html?id="+a+"&v="+window.ver,"写跟进")}),$(".sender-condition-style").on("click",".newtongxunlu",function(e){$.EventFn(e);var a=$(this).parents("li").attr("data-id");t.showTab(Base.url+"/html/pop-statistics-new.html?id="+a+"&v="+window.ver,"新建通讯录")}),$(".sender-condition-style").on("click",".tongxunlu",function(e){$.EventFn(e);$(this).parents("li").attr("data-id");t.showTab(Base.url+"/html/email-statistics.html?&v="+window.ver,"通讯录")}),$(".sender-condition-style").on("click",".fayoujian",function(t){$.EventFn(t);var e=$(this).parents("li").attr("data-email");$("#mainIframe",parent.parent.document).attr("src",Base.url+"/html/pop-email-new.html?typeTask=1&emailTask="+e+"&v="+window.ver)}),$(".sender-condition-style").on("click",".btn-privateCust",function(t){$.EventFn(t);var e=$(this).parents("li").attr("data-id"),a={id:e},n=$(this);$.ajax({url:Base.sitUrl+"/api/customer/v1/into/private/seas",type:"POST",dataType:"json",data:{data:JSON.stringify(a)},success:function(t){n.text("已添加到私海")}})}),$(".sender-condition-style").on("click",".btn-privateCont",function(t){$.EventFn(t);var e=$(this).parents("li").attr("data-id"),a={id:e},n=$(this);$.ajax({url:Base.sitUrl+"/api/customer/contacts/v1/into/private/seas",type:"POST",dataType:"json",data:{data:JSON.stringify(a)},success:function(t){n.text("已添加到私海")}})}),$(".sender-condition-style").on("click",".come-go",function(e){$.EventFn(e);var a=$(this).parent().prevAll(".sender-condition-img").find(".sender-condition-name").text();t.showTab(Base.url+"/html/pop-come-go-email.html?email="+a+"&v="+window.ver,"往来邮件")}),$(".sender-condition-style").on("click",".btn-blockAdd",function(e){$.EventFn(e);var a=$(".detailSender").val();t.showTab(Base.url+"/html/pop-contacts-add.html?name="+a+"&v="+window.ver,"添加联系人")}),$(".sender-condition-style").on("click",".btn-blockDetail",function(e){$.EventFn(e);var a=$(this).parents("li").attr("data-cont");t.showTab(Base.url+"/html/pop-relation-detail.html?id="+a+"&v="+window.ver,"联系人详情")}),$(".sender-condition-style").on("click",".company-name,.btn-scanCust",function(e){$.EventFn(e);var a=$(this).parents("li").attr("data-customer");t.showTab(Base.url+"/html/pop-customer-detail.html?id="+a+"&v="+window.ver,"客户详情")}),angular.bootstrap(document.body,["All"])})});