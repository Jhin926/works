require(["common"],function(){require(["jqform"],function(){var e=$(".box-upload"),t=parseInt($.GetQueryString("id")),a=Number($.GetQueryString("pIdx"));e.on("change","#up-files,#up-image",function(t){$.EventFn(t);var a=$(this).prop("files")[0],i=$(this).attr("name"),l="img",s=e.find("#upload-img");a&&("upFiles"==i&&(l="file",s=e.find("#upload-file")),n.uploadFile(l,a,s))}),e.on("click",".list-file .s-dels3",function(e){$.EventFn(e),$(this).parent().remove(),0==$(".list-file>li").length&&$(".list-file").remove()}),e.on("click","button:first-child",function(a){$.EventFn(a);var i=e.find("#box-follow"),l=[],s=$(".list-file>li"),r={};if(null!=i.val()||""!=i.val()){for(var o=0;o<s.length;o++)l.push({attachmentType:s.eq(o).attr("data-type"),attachment:s.eq(o).attr("data-url"),attachmentName:s.eq(o).children("span").text()});r.customerId=0,r.paramType=1,r.customerContactsId=t,r.attachments=l,r.content=i.val(),n.addFollow(r)}});var n={addFollow:function(e){$.ajax({url:Base.sitUrl+"/api/user/v1/user/followup/save",type:"POST",data:{data:JSON.stringify(e)},dataType:"json",success:function(e){return e.success?void $.Alert("新建跟进成功！","",function(){var e=$("#mainTab",parent.document).find(".currentClass").index();parent.me.refresh2(a,"part"),parent.me.closeOne(e,!0)}):void $.Alert("创建失败，"+e.message)}})},uploadFile:function(e,t,a){a.ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(a){if(!a.success)return void $.Alert("上传失败,"+a.message);var n=("http://"+a.data,""),i=$(".btns-upload"),l=$(".list-file"),s=1;"img"==e&&(s=0),0==l.length?(n='<ul class="list-file">                                            <li data-url="'+a.data+'" data-type="'+s+'">                                            <i class="s-updownBg s-link3"></i>                                            <span>'+t.name+'</span>                                            <i class="s-updownBg s-dels3"></i>                                        </li>                                    </ul>',i.after(n)):(n='<li data-url="'+a.data+'" data-type="'+s+'">                                        <i class="s-updownBg s-link3"></i>                                        <span>'+t.name+'</span>                                        <i class="s-updownBg s-dels3"></i>                                    </li>',l.append(n)),$(".up-form")[0].reset()}}).submit()}}})});