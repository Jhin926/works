require(["common"],function(){require(["jqform","datetimepickerCN"],function(){var t=$(".box-upload"),e=parseInt($.GetQueryString("id")),a=parseInt($.GetQueryString("type")),i=parseInt($.GetQueryString("contId")),n=Number($.GetQueryString("pIdx"));t.on("change","#up-files,#up-image",function(e){$.EventFn(e);var a=$(this).prop("files")[0],i=$(this).attr("name"),n="img",l=t.find("#upload-img");a&&("upFiles"==i&&(n="file",l=t.find("#upload-file")),s.uploadFile(n,a,l))}),jQuery().datetimepicker&&$(".datetime-picker").datetimepicker({language:"zh-CN",todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,format:"yyyy-mm-dd hh:ii",bootcssVer:3}),$.ajax({url:Base.sitUrl+"/api/customer/v1/customer/detail",type:"POST",data:{data:JSON.stringify({id:e})},success:function(t){t.success||$.Alert(t.message);var e=t.data.contacts,a="";if(""!=e)for(var i=0;i<e.length;i++)a+='<option data-id="'+e[i].id+'">'+e[i].name+"</option>";else a+="<option>无</option>";$("#custContList2").empty().append(a)}}),t.on("click",".list-file .s-dels3",function(t){$.EventFn(t),$(this).parent().remove(),0==$(".list-file>li").length&&$(".list-file").remove()}),t.on("click","button:first-child",function(n){$.EventFn(n);var l=t.find("#box-follow"),o=[],r=$(".list-file>li"),c={};if(""==l.val())return void $.Alert("请填写内容");if(null!=l.val()||""!=l.val()){for(var u=0;u<r.length;u++)o.push({attachmentType:r.eq(u).attr("data-type"),attachment:r.eq(u).attr("data-url"),attachmentName:r.eq(u).children("span").text()});var d=$(".fllow-time-check input").val(),p=$("#custContList2").find("option:selected").val();""!=d&&(c.followTimeString=d),1==a?(c.paramType=1,c.customerId=null,c.customerContactsId=i,c.attachments=o,c.content=l.val(),c.name=p,c.followTimeString=d):(c.paramType=0,c.customerId=e,c.customerContactsId=i,c.attachments=o,c.content=l.val(),c.name=p,c.followTimeString=d),s.addFollow(c)}}),t.on("click","button:last-child",function(t){t.preventDefault();var e=$("#mainTab",parent.document).find("currentClass").index();parent.me.closeOne(e)});var s={addFollow:function(t){$.ajax({url:Base.sitUrl+"/api/user/v1/user/followup/save",type:"POST",data:{data:JSON.stringify(t)},dataType:"json",success:function(t){return t.success?void $.Alert("新建跟进成功！","",function(){var t=$("#mainTab",parent.document).find(".currentClass").index();parent.me.refresh2(n,"part"),parent.me.closeOne(t,!0)}):void $.Alert("创建失败，"+t.message)}})},uploadFile:function(t,e,a){a.ajaxForm({url:Base.sitUrl+"/api/file/upload",beforeSend:function(){$.BlockUI()},complete:function(){$.UnblockUI()},success:function(a){if(!a.success)return void $.Alert("上传失败,"+a.message);var i=("http://"+a.data,""),n=$(".btns-upload"),s=$(".list-file"),l=1;"img"==t&&(l=0),0==s.length?(i='<ul class="list-file">                                            <li data-url="'+a.data+'" data-type="'+l+'">                                            <i class="s-updownBg s-link3"></i>                                            <span>'+e.name+'</span>                                            <i class="s-updownBg s-dels3"></i>                                        </li>                                    </ul>',n.after(i)):(i='<li data-url="'+a.data+'" data-type="'+l+'">                                        <i class="s-updownBg s-link3"></i>                                        <span>'+e.name+'</span>                                        <i class="s-updownBg s-dels3"></i>                                    </li>',s.append(i)),$(".up-form")[0].reset()}}).submit()}}})});