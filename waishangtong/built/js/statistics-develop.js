require(["common"],function(){require(["maintab","blockUI","jqform"],function(e){function a(){for(var e=new Date,a=e.getFullYear(),t=(e.getMonth(),""),n="",i=2e3;i<=a;i++)t+="<option value="+i+">"+i+"年</option>";for(var i=1;i<13;i++)n+='<option value="'+i+'">'+i+"月</option>";$(".years").empty(),$(".years").append(t),$(".years").find("option[value="+a+"]").attr("selected",!0),$(".month").empty(),$(".month").append('<option value="0">全部</option>'),$(".month").append(n)}function t(e,a){var t;return $.ajax({url:Base.sitUrl+"/api/edm/v1/marketing/statistics",type:"POST",dataType:"json",async:!1,data:{year:e,month:a},success:function(e){return e.success?void(t=e.data):void $.unLogin(e)}}),t}function n(e){null==e?($("#sendNum").text("0"),$("#deliveryNum").text("0"),$("#openNum").text("0"),$("#replyNum").text("0")):($("#sendNum").text(e.sendNum),$("#deliveryNum").text(e.deliveryNum),$("#openNum").text(e.openNum),$("#replyNum").text(e.replyNum))}function i(e){if(null==e){var a='<img src="../../images/statisticsNone.png">';$("#chart1").empty(),$("#chart1").append(a)}else{var t=e.sendNum,n=e.deliveryNum,i=e.openNum,s=echarts.init(document.getElementById("chart1")),r={tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c}"},legend:{data:["营销发送条数","营销送达数","营销打开数"]},calculable:!0,series:[{name:"漏斗图",type:"funnel",left:"10%",top:60,bottom:60,width:"80%",min:0,max:t,minSize:"1%",maxSize:"80%",sort:"descending",gap:2,label:{normal:{show:!0,position:"right"},emphasis:{textStyle:{fontSize:20}}},labelLine:{normal:{length:10,lineStyle:{width:1,type:"solid"}}},itemStyle:{normal:{borderColor:"#fff",borderWidth:1}},data:[{value:t,name:"营销发送条数"},{value:n,name:"营销送达数"},{value:i,name:"营销打开数"}]}]};s.setOption(r)}}function s(){$.ajax({url:Base.sitUrl+"/api/edm/v1/open/sort",type:"GET",dataType:"json",success:function(e){var a=e.data;if(""==a){var t='<img src="../../images/statisticsNone.png">';$(".chartTable").empty(),$(".chartTable").append(t)}else{for(var n="",i=0;i<a.length;i++){var s=i+1;n+='<li><span class="circleTop">'+s+"</span><span>"+a[i].name+'</span><span class="moneyTop">'+a[i].count+"</span></li>"}$(".chartTable").empty(),$(".chartTable").append(n),a.length>4&&$("#down").show()}}})}function r(e,a){var t={year:e,month:a};$.ajax({url:Base.sitUrl+"/api/edm/v1/marketing/statistics",type:"POST",dataType:"json",async:!1,data:{data:JSON.stringify(t)},success:function(e){if(!e.success)return void $.unLogin(e);var a=e.data;i(a),n(a)}})}function o(e,a){$.ajax({url:Base.sitUrl+"/api/edm/v1/send/statistics",type:"POST",dataType:"json",data:{year:e,month:a},success:function(e){if(!e.success)return void $.unLogin(e);var a=e.data;if(""==a){var t='<img src="../../images/statisticsNone.png">';$("#chart2").empty(),$("#chart2").append(t)}else{for(var n=new Array,i=0;i<12;i++){if(void 0!==a[i])var s=a[i].month;else var s="0";"1"==s||"2"==s||"3"==s||"4"==s||"5"==s||"6"==s||"7"==s||"8"==s||"9"==s||"10"==s||"11"==s||"12"==s?n.push(a[i].count):n.push(0)}for(var r=new Array,i=0;i<a.length;i++)r.push(a[i].customerNum);if(r.length<=12)for(var i=r.length;i<12;i++)r.push(0);var o=Math.max.apply(null,r),l=Math.round(.2*o);l<1&&(l=1);var p=echarts.init(document.getElementById("chart2")),d={tooltip:{trigger:"axis"},legend:{data:["营销发送数"]},xAxis:[{type:"category",axisLabel:{interval:0},data:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"]}],yAxis:[{type:"value",name:"营销发送数",min:0,max:o,interval:l,axisLabel:{formatter:"{value}"}}],series:[{name:"营销发送数",type:"line",data:n}]};p.setOption(d)}}})}function l(e,a){$.ajax({url:Base.sitUrl+"/api/edm/v1/send/statistics",type:"POST",dataType:"json",data:{year:e,month:a},success:function(e){if(!e.success)return void $.unLogin(e);var a=e.data;if(""==a){var t='<img src="../../images/statisticsNone.png">';$("#chart2").empty(),$("#chart2").append(t)}else{for(var n=new Array,i=new Array,s=0;s<a.length;s++)i.push(a[s].dateTime.substring(7,a[s].dateTime.length)),n.push(a[s].count);var r=Math.max.apply(null,n),o=.2*r,l=echarts.init(document.getElementById("chart2")),p={tooltip:{trigger:"axis"},legend:{data:["营销发送数"]},xAxis:[{type:"category",data:i}],yAxis:[{type:"value",name:"营销发送数",min:0,max:r,interval:o,axisLabel:{formatter:"{value}"}}],series:[{name:"营销发送数",type:"line",data:n}]};l.setOption(p)}}})}function p(e,a){$.ajax({url:Base.sitUrl+"/api/edm/v1/send/sort",type:"POST",dataType:"json",data:{year:e,month:a},success:function(e){var a=e.data.results;if(!e.success)return void $.unLogin(e);if(""==a){var t='<img src="../../images/statisticsNone.png">';$("#devSendRank .ulTop").empty(),$("#devSendRank .ulTop").append(t)}else{for(var n="",i=0;i<a.length;i++){var s=i+1;n+='<li><span class="circleTop">'+s+"</span><span>"+a[i].name+'</span><span class="moneyTop">'+a[i].count+"</span></li>"}$("#devSendRank .ulTop").empty(),$("#devSendRank .ulTop").append(n);var r=e.data.totalItem,o=r,l=c.pageSize,p=Math.ceil(o/l);c.lastpage=p,$(".i-content-wrapper").stop().animate({scrollTop:0},500)}}})}var d=(new Date).getFullYear(),u=t(d,0),c={homepage:1,currentPage:1,lastpage:null,pageSize:10};$("#up a").bind("click",function(){$(this).parents(".bodyRight").find("ul li").eq(0).animate({marginTop:"+=48px"}),$("#down").show(),"-48px"==$(this).parents(".bodyRight").find("ul li").eq(0).css("marginTop")&&$(this).parent().hide()}),$("#down a").bind("click",function(){$(this).parents(".bodyRight").find("ul li").eq(0).animate({marginTop:"-=48px"}),$("#up").show();var e="-"+48*(chartDataJson.length-6)+"px";$(this).parents(".bodyRight").find("ul li").eq(0).css("marginTop")==e&&$(this).parent().hide()}),$("#devSendRank .years").on("change",function(){var e=$(this).val(),a=$("#devSendRank .month").val();p(e,a)}),$("#devSendRank .month").on("change",function(){var e=$(this).val(),a=$("#devSendRank .years").val();p(a,e)}),$("#devletterNum .years").on("change",function(){var e=$(this).val(),a=$("#devletterNum .month").val();r(e,a)}),$("#devletterNum .month").on("change",function(){var e=$(this).val(),a=$("#devletterNum .years").val();r(a,e)}),$("#devSendS .years").on("change",function(){var e=$(this).val(),a=$("#devSendS .month").val();0==a?o(e,a):l(e,a)}),$("#devSendS .month").on("change",function(){var e=$(this).val();$("#devSendS .years").val();0==e?o(d,e):l(d,e)}),a(),i(u),n(u),s(),o(d,0),p(d,0)})});